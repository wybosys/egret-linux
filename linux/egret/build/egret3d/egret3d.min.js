var __extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},egret3d;!function(t){var e=function(){function t(){this.averageFPS=0,this.averageDelay=0,this.delayNumber=0,this.countFrame=30}return t.prototype.update=function(t,e){return this.delayNumber+=e-1,0==this.countFrame--&&(this.countFrame=30,this.averageDelay=Math.floor(this.delayNumber/this.countFrame),this.averageFPS=Math.floor(1e3/this.averageDelay),this.averageFPS=Math.min(this.averageFPS,60),this.delayNumber=0)," "+this.averageFPS.toString()+" fps/"+this.averageDelay.toString()+" delay"},t.fps=16.6666,t}(),i=function(){function t(){}return t.initState=function(){t.use=!0,t._info=document.createElement("div"),t._time=document.createElement("div"),t._dataInfo=document.createElement("div"),t._info.style.fontSize="14px",t._info.style.backgroundColor="rgba(158,158,158,0.3)",t._info.style.width="200px",t._info.style.fontFamily="Corbel",t._dataInfo.style.fontFamily="12px",t._dataInfo.style.fontSize="12px",t._dataInfo.style.backgroundColor="rgba(158,158,158,0.3)",t._dataInfo.style.width="200px",t._dataInfo.style.fontFamily="Corbel",t._info.onselect=null,t._time.onselect=null,t._dataInfo.onselect=null,document.body.appendChild(t._info),document.body.appendChild(t._time),document.body.appendChild(t._dataInfo),t._info.style.color="lightblue",t._time.style.color="lightblue",t._dataInfo.style.color="lightblue",t._info.innerText=" Egret3D Graphics "},t.showTime=function(e,i){t.use||t.initState(),t._time.innerText=t.fpsInfo.update(e,i)},t.showDataInfo=function(){for(var e=[],i=0;i<arguments.length;i++)e[i-0]=arguments[i];t.use||t.initState();var a;for(a in e)e[a]&&(this.info+=e[a].toString()+"\r	")},t.show=function(){t._dataInfo.innerText=this.info,this.info=" "},t.use=!1,t.fpsInfo=new e,t}();t.Egret3DState=i}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.diffuse=0]="diffuse",t[t.normal=1]="normal",t[t.specular=2]="specular",t[t.color=3]="color",t[t.shadow=4]="shadow"}(t.TextureMethodType||(t.TextureMethodType={}));t.TextureMethodType;!function(t){t[t.start_vertex=0]="start_vertex",t[t.local_vertex=1]="local_vertex",t[t.global_vertex=2]="global_vertex",t[t.end_vertex=3]="end_vertex",t[t.start_fragment=4]="start_fragment",t[t.materialsource_fragment=5]="materialsource_fragment",t[t.diffuse_fragment=6]="diffuse_fragment",t[t.normal_fragment=7]="normal_fragment",t[t.matCap_fragment=8]="matCap_fragment",t[t.specular_fragment=9]="specular_fragment",t[t.shadow_fragment=10]="shadow_fragment",t[t.lighting_fragment=11]="lighting_fragment",t[t.multi_end_fragment=12]="multi_end_fragment",t[t.end_fragment=13]="end_fragment"}(t.ShaderPhaseType||(t.ShaderPhaseType={}));t.ShaderPhaseType}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.u=0,this.v=0,this.u=t,this.v=e}return t}();t.UV=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.equals=function(t){return this.x==t.x&&this.y==t.y},t.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,void(this.y*=e)}throw"Cannot divide by zero length."},t.prototype.offset=function(t,e){this.x+=t,this.y+=e},t.prototype.subtract=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.toString=function(){return"[Point] (x="+this.x+", y="+this.y+")"},t.distance=function(t,e){var i=e.x-t.x,a=e.y-t.y;return Math.sqrt(i*i+a*a)},t}();t.Point=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.x=0,this.y=0,this.z=0,this.w=0,this.x=t,this.y=e,this.z=i,this.w=a}return Object.defineProperty(t.prototype,"a",{get:function(){return this.w},set:function(t){this.w=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"r",{get:function(){return this.x},set:function(t){this.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"g",{get:function(){return this.y},set:function(t){this.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"b",{get:function(){return this.z},set:function(t){this.z=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y+this.z*this.z},enumerable:!0,configurable:!0}),t.prototype.add=function(e){return new t(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},t.prototype.crossProduct=function(e){return new t(this.y*e.z-this.z*e.y,this.z*e.x-this.x*e.z,this.x*e.y-this.y*e.x,1)},t.prototype.decrementBy=function(t){this.x-=t.x,this.y-=t.y,this.z-=t.z},t.distance=function(t,e){var i=t.x-e.x,a=t.y-e.y,r=t.z-e.z;return Math.sqrt(i*i+a*a+r*r)},t.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.equals=function(t,e){return void 0===e&&(e=!1),this.x==t.x&&this.y==t.y&&this.z==t.z&&(!e||this.w==t.w)},t.prototype.incrementBy=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},t.prototype.divide=function(e){return e instanceof t?new t(this.x/e.x,this.y/e.y,this.z/e.z):(this.x=this.x/e,this.y=this.y/e,this.z=this.z/e,this)},t.prototype.negate=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},t.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,this.y*=e,void(this.z*=e)}},t.prototype.scaleBy=function(t){this.x*=t,this.y*=t,this.z*=t},t.prototype.setTo=function(t,e,i,a){void 0===a&&(a=1),this.x=t,this.y=e,this.z=i,this.w=a},t.prototype.subtract=function(e,i){return void 0===i&&(i=null),i||(i=new t),i.setTo(this.x-e.x,this.y-e.y,this.z-e.z),i},t.prototype.multiply=function(e,i){void 0===i&&(i=null),i||(i=new t);var a=this.x,r=this.y,n=this.z,o=e.x,s=e.y,h=e.z;return i.setTo(a*o,r*s,n*h),i},t.prototype.divided=function(e,i){void 0===i&&(i=null),i||(i=new t);var a=this.x,r=this.y,n=this.z,o=e.x,s=e.y,h=e.z;return i.setTo(a/o,r/s,n/h),i},t.prototype.lerp=function(t,e,i){var a=t.x,r=t.y,n=t.z,o=t.w,s=e.x,h=e.y,l=e.z,u=e.w;this.x=(s-a)*i+a,this.y=(h-r)*i+r,this.z=(l-n)*i+n,this.w=(u-o)*i+o},t.prototype.toString=function(){return"<"+this.x+", "+this.y+", "+this.z+">"},t.prototype.parsing=function(t){var e=t.split(" ");e.length<3||(this.x=parseFloat(e[0]),this.y=parseFloat(e[1]),this.z=parseFloat(e[2]))},t.X_AXIS=new t(1,0,0),t.Y_AXIS=new t(0,1,0),t.Z_AXIS=new t(0,0,1),t}();t.Vector3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=32),void 0===a&&(a=32),this.x=0,this.y=0,this.width=0,this.height=0,this.x=t,this.y=e,this.width=i,this.height=a}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t.prototype.inner=function(t,e){return t<this.x||t>this.x+this.width||e<this.y||e>this.y+this.height?!1:!0},t}();t.Rectangle=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=1),this.x=0,this.y=0,this.z=0,this.w=1,this.x=t,this.y=e,this.z=i,this.w=a}return Object.defineProperty(e.prototype,"magnitude",{get:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},enumerable:!0,configurable:!0}),e.prototype.multiply=function(t,e){var i=t.w,a=t.x,r=t.y,n=t.z,o=e.w,s=e.x,h=e.y,l=e.z;this.w=i*o-a*s-r*h-n*l,this.x=i*s+a*o+r*l-n*h,this.y=i*h-a*l+r*o+n*s,this.z=i*l+a*h-r*s+n*o},e.prototype.multiplyVector=function(t,i){void 0===i&&(i=null),null===i&&(i=new e);var a=t.x,r=t.y,n=t.z;return i.w=-this.x*a-this.y*r-this.z*n,i.x=this.w*a+this.y*n-this.z*r,i.y=this.w*r-this.x*n+this.z*a,i.z=this.w*n+this.x*r-this.y*a,i},e.prototype.fromAxisAngle=function(t,e){e*=Math.PI/180;var i=.5*e,a=Math.sin(i);this.w=Math.cos(i),this.x=t.x*a,this.y=t.y*a,this.z=t.z*a,this.normalize()},e.prototype.toAxisAngle=function(t){var e=this.x*this.x+this.y*this.y+this.z*this.z,i=0;return e>0?(i=2*Math.acos(this.w),e=1/Math.sqrt(e),t.x=this.x*e,t.y=this.y*e,t.z=this.z*e):(i=0,t.x=1,t.y=0,t.z=0),i/=Math.PI/180},e.prototype.slerp=function(t,e,i){var a=t.w,r=t.x,n=t.y,o=t.z,s=e.w,h=e.x,l=e.y,u=e.z,c=a*s+r*h+n*l+o*u;if(0>c&&(c=-c,s=-s,h=-h,l=-l,u=-u),.95>c){var d=Math.acos(c),p=1/Math.sin(d),f=Math.sin(d*(1-i))*p,_=Math.sin(d*i)*p;this.w=a*f+s*_,this.x=r*f+h*_,this.y=n*f+l*_,this.z=o*f+u*_}else{this.w=a+i*(s-a),this.x=r+i*(h-r),this.y=n+i*(l-n),this.z=o+i*(u-o);var m=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z);this.w*=m,this.x*=m,this.y*=m,this.z*=m}},e.prototype.lerp=function(t,e,i){var a,r=t.w,n=t.x,o=t.y,s=t.z,h=e.w,l=e.x,u=e.y,c=e.z;0>r*h+n*l+o*u+s*c&&(h=-h,l=-l,u=-u,c=-c),this.w=r+i*(h-r),this.x=n+i*(l-n),this.y=o+i*(u-o),this.z=s+i*(c-s),a=1/Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z),this.w*=a,this.x*=a,this.y*=a,this.z*=a},e.prototype.fromEulerAngles=function(e,i,a){e*=t.MathUtil.DEGREES_TO_RADIANS,i*=t.MathUtil.DEGREES_TO_RADIANS,a*=t.MathUtil.DEGREES_TO_RADIANS;var r=.5*e,n=.5*i,o=.5*a,s=Math.cos(r),h=Math.sin(r),l=Math.cos(n),u=Math.sin(n),c=Math.cos(o),d=Math.sin(o);return this.w=s*l*c+h*u*d,this.x=h*l*c-s*u*d,this.y=s*u*c+h*l*d,this.z=s*l*d-h*u*c,this},e.prototype.toEulerAngles=function(e){void 0===e&&(e=null),null===e&&(e=new t.Vector3D),e.x=Math.atan2(2*(this.w*this.x+this.y*this.z),1-2*(this.x*this.x+this.y*this.y));var i=2*(this.w*this.y-this.z*this.x);return i=t.MathUtil.clampf(i,-1,1),e.y=Math.asin(i),e.z=Math.atan2(2*(this.w*this.z+this.x*this.y),1-2*(this.y*this.y+this.z*this.z)),e.x/=t.MathUtil.DEGREES_TO_RADIANS,e.y/=t.MathUtil.DEGREES_TO_RADIANS,e.z/=t.MathUtil.DEGREES_TO_RADIANS,e},e.prototype.normalize=function(t){void 0===t&&(t=1);var e=t/Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);this.x*=e,this.y*=e,this.z*=e,this.w*=e},e.prototype.toString=function(){return"{x:"+this.x+" y:"+this.y+" z:"+this.z+" w:"+this.w+"}"},e.prototype.toMatrix3D=function(e){void 0===e&&(e=null);var i=t.MathUtil.RAW_DATA_CONTAINER,a=2*this.x*this.y,r=2*this.x*this.z,n=2*this.x*this.w,o=2*this.y*this.z,s=2*this.y*this.w,h=2*this.z*this.w,l=this.x*this.x,u=this.y*this.y,c=this.z*this.z,d=this.w*this.w;return i[0]=l-u-c+d,i[4]=a-h,i[8]=r+s,i[12]=0,i[1]=a+h,i[5]=-l+u-c+d,i[9]=o-n,i[13]=0,i[2]=r-s,i[6]=o+n,i[10]=-l-u+c+d,i[14]=0,i[3]=0,i[7]=0,i[11]=0,i[15]=1,e?(e.copyRawDataFrom(i),e):new t.Matrix4_4(new Float32Array(i))},e.prototype.fromMatrix=function(e){var i=e.decompose(t.Orientation3D.QUATERNION)[1];this.x=i.x,this.y=i.y,this.z=i.z,this.w=i.w},e.prototype.inverse=function(t){void 0===t&&(t=null),t||(t=new e);var i=this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z;if(i>0){var a=1/i;t.w=this.w*a,t.x=-this.x*a,t.y=-this.y*a,t.z=-this.z*a}return t},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)},e.prototype.transformVector=function(e,i){void 0===i&&(i=null);var a,r,n,o,s=e.x,h=e.y,l=e.z;return null===i&&(i=new t.Vector3D),o=-this.x*s-this.y*h-this.z*l,a=this.w*s+this.y*l-this.z*h,r=this.w*h-this.x*l+this.z*s,n=this.w*l+this.x*h-this.y*s,i.x=-o*this.x+a*this.w-r*this.z+n*this.y,i.y=-o*this.y+a*this.z+r*this.w-n*this.x,i.z=-o*this.z-a*this.y+r*this.x+n*this.w,i},e.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w},e}();t.Quaternion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.AXIS_ANGLE="axisAngle",t.EULER_ANGLES="eulerAngles",t.QUATERNION="quaternion",t}();t.Orientation3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=i,this.d=a}return e.prototype.setTo=function(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=i,this.d=a},e.prototype.fromPoints=function(t,e,i){var a=e.x-t.x,r=e.y-t.y,n=e.z-t.z,o=i.x-t.x,s=i.y-t.y,h=i.z-t.z;this.a=r*h-n*s,this.b=n*o-a*h,this.c=a*s-r*o,this.d=-(this.a*t.x+this.b*t.y+this.c*t.z)},e.prototype.fromNormalAndPoint=function(t,e){this.a=t.x,this.b=t.y,this.c=t.z,this.d=-(this.a*e.x+this.b*e.y+this.c*e.z)},e.prototype.normalize=function(){var t=Math.sqrt(this.a*this.a+this.b*this.b+this.c*this.c);if(t>0){var e=1/t;this.a*=e,this.b*=e,this.c*=e,this.d*=e}return t},e.prototype.distance=function(t){return this.a*t.x+this.b*t.y+this.c*t.z+this.d},e.prototype.classifyPoint=function(e,i){void 0===i&&(i=.01);var a=this.distance(e);return-i>a?t.PlaneClassification.BACK:a>i?t.PlaneClassification.FRONT:t.PlaneClassification.INTERSECT},e.prototype.toString=function(){return"Plane3D [a:"+this.a+", b:"+this.b+", c:"+this.c+", d:"+this.d+"]"},e.ALIGN_ANY=0,e.ALIGN_XY_AXIS=1,e.ALIGN_YZ_AXIS=2,e.ALIGN_XZ_AXIS=3,e}();t.Plane3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){void 0===t&&(t=null),t?this.rawData=t:this.rawData=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}return e.prototype.lookAt=function(t,e,i){var a=e.subtract(t);a.normalize();var r=i.crossProduct(a);r.normalize();var n=a.crossProduct(r);this.rawData[0]=r.x,this.rawData[1]=n.x,this.rawData[2]=a.x,this.rawData[3]=0,this.rawData[4]=r.y,this.rawData[5]=n.y,this.rawData[6]=a.y,this.rawData[7]=0,this.rawData[8]=r.z,this.rawData[9]=n.z,this.rawData[10]=a.z,this.rawData[11]=0,this.rawData[12]=-r.dotProduct(t),this.rawData[13]=-n.dotProduct(t),this.rawData[14]=-a.dotProduct(t),this.rawData[15]=1},e.prototype.multiply=function(t){var i=this.rawData,a=t.rawData,r=e.helpMatrix;r[0]=i[0]*a[0]+i[1]*a[4]+i[2]*a[8]+i[3]*a[12],r[1]=i[0]*a[1]+i[1]*a[5]+i[2]*a[9]+i[3]*a[13],r[2]=i[0]*a[2]+i[1]*a[6]+i[2]*a[10]+i[3]*a[14],r[3]=i[0]*a[3]+i[1]*a[7]+i[2]*a[11]+i[3]*a[15],r[4]=i[4]*a[0]+i[5]*a[4]+i[6]*a[8]+i[7]*a[12],r[5]=i[4]*a[1]+i[5]*a[5]+i[6]*a[9]+i[7]*a[13],r[6]=i[4]*a[2]+i[5]*a[6]+i[6]*a[10]+i[7]*a[14],r[7]=i[4]*a[3]+i[5]*a[7]+i[6]*a[11]+i[7]*a[15],r[8]=i[8]*a[0]+i[9]*a[4]+i[10]*a[8]+i[11]*a[12],r[9]=i[8]*a[1]+i[9]*a[5]+i[10]*a[9]+i[11]*a[13],r[10]=i[8]*a[2]+i[9]*a[6]+i[10]*a[10]+i[11]*a[14],r[11]=i[8]*a[3]+i[9]*a[7]+i[10]*a[11]+i[11]*a[15],r[12]=i[12]*a[0]+i[13]*a[4]+i[14]*a[8]+i[15]*a[12],r[13]=i[12]*a[1]+i[13]*a[5]+i[14]*a[9]+i[15]*a[13],r[14]=i[12]*a[2]+i[13]*a[6]+i[14]*a[10]+i[15]*a[14],r[15]=i[12]*a[3]+i[13]*a[7]+i[14]*a[11]+i[15]*a[15];for(var n=0;16>n;n++)this.rawData[n]=r[n]},e.prototype.perspectiveB=function(t,e,i,a){var r=Math.tan(t*Math.PI/360)*i,n=r*e;return this.frustum(-n,n,-r,r,i,a)},e.prototype.frustum=function(t,e,i,a,r,n){var o=this.rawData;return o[0]=2*r/(e-t),o[1]=0,o[2]=(e+t)/(e-t),o[3]=0,o[4]=0,o[5]=2*r/(a-i),o[6]=(a+i)/(a-i),o[7]=0,o[8]=0,o[9]=0,o[10]=-(n+r)/(n-r),o[11]=-2*n*r/(n-r),o[12]=0,o[13]=0,o[14]=-1,o[15]=0,this},e.prototype.perspective=function(t,e,i,a){var r=t*(Math.PI/180),n=Math.tan((Math.PI-r)/2),o=n/e;this.rawData[0]=o,this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=n,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=a/(a-i),this.rawData[11]=1,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=-i*a/(a-i),this.rawData[15]=0},e.prototype.ortho=function(t,e,i,a){this.rawData[0]=2/t,this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=2/e,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=1/(a-i),this.rawData[11]=0,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=i/(i-a),this.rawData[15]=1},e.prototype.orthoOffCenter=function(t,e,i,a,r,n){this.rawData[0]=2/(e-1),this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[5]=2/(a-i),this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=1/(n-r),this.rawData[11]=0,this.rawData[12]=(1+e)/(1-e),this.rawData[13]=(a+i)/(i-a),this.rawData[14]=r/(r-n),this.rawData[15]=1},e.prototype.append=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],n=this.rawData[1],o=this.rawData[5],s=this.rawData[9],h=this.rawData[13],l=this.rawData[2],u=this.rawData[6],c=this.rawData[10],d=this.rawData[14],p=this.rawData[3],f=this.rawData[7],_=this.rawData[11],m=this.rawData[15],v=t.rawData[0],g=t.rawData[4],y=t.rawData[8],x=t.rawData[12],D=t.rawData[1],b=t.rawData[5],w=t.rawData[9],T=t.rawData[13],P=t.rawData[2],S=t.rawData[6],C=t.rawData[10],A=t.rawData[14],E=t.rawData[3],L=t.rawData[7],M=t.rawData[11],F=t.rawData[15];this.rawData[0]=e*v+n*g+l*y+p*x,this.rawData[1]=e*D+n*b+l*w+p*T,this.rawData[2]=e*P+n*S+l*C+p*A,this.rawData[3]=e*E+n*L+l*M+p*F,this.rawData[4]=i*v+o*g+u*y+f*x,this.rawData[5]=i*D+o*b+u*w+f*T,this.rawData[6]=i*P+o*S+u*C+f*A,this.rawData[7]=i*E+o*L+u*M+f*F,this.rawData[8]=a*v+s*g+c*y+_*x,this.rawData[9]=a*D+s*b+c*w+_*T,this.rawData[10]=a*P+s*S+c*C+_*A,this.rawData[11]=a*E+s*L+c*M+_*F,this.rawData[12]=r*v+h*g+d*y+m*x,this.rawData[13]=r*D+h*b+d*w+m*T,this.rawData[14]=r*P+h*S+d*C+m*A,this.rawData[15]=r*E+h*L+d*M+m*F},e.prototype.add=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],n=this.rawData[1],o=this.rawData[5],s=this.rawData[9],h=this.rawData[13],l=this.rawData[2],u=this.rawData[6],c=this.rawData[10],d=this.rawData[14],p=this.rawData[3],f=this.rawData[7],_=this.rawData[11],m=this.rawData[15],v=t.rawData[0],g=t.rawData[4],y=t.rawData[8],x=t.rawData[12],D=t.rawData[1],b=t.rawData[5],w=t.rawData[9],T=t.rawData[13],P=t.rawData[2],S=t.rawData[6],C=t.rawData[10],A=t.rawData[14],E=t.rawData[3],L=t.rawData[7],M=t.rawData[11],F=t.rawData[15];return this.rawData[0]=e+v,this.rawData[1]=n+D,this.rawData[2]=l+P,this.rawData[3]=p+E,this.rawData[4]=i+g,this.rawData[5]=o+b,this.rawData[6]=u+S,this.rawData[7]=f+L,this.rawData[8]=a+y,this.rawData[9]=s+w,this.rawData[10]=c+C,this.rawData[11]=_+M,this.rawData[12]=r+x,this.rawData[13]=h+T,this.rawData[14]=d+A,this.rawData[15]=m+F,this},e.prototype.sub=function(t){var e=this.rawData[0],i=this.rawData[4],a=this.rawData[8],r=this.rawData[12],n=this.rawData[1],o=this.rawData[5],s=this.rawData[9],h=this.rawData[13],l=this.rawData[2],u=this.rawData[6],c=this.rawData[10],d=this.rawData[14],p=this.rawData[3],f=this.rawData[7],_=this.rawData[11],m=this.rawData[15],v=t.rawData[0],g=t.rawData[4],y=t.rawData[8],x=t.rawData[12],D=t.rawData[1],b=t.rawData[5],w=t.rawData[9],T=t.rawData[13],P=t.rawData[2],S=t.rawData[6],C=t.rawData[10],A=t.rawData[14],E=t.rawData[3],L=t.rawData[7],M=t.rawData[11],F=t.rawData[15];return this.rawData[0]=e-v,this.rawData[1]=n-D,this.rawData[2]=l-P,this.rawData[3]=p-E,this.rawData[4]=i-g,this.rawData[5]=o-b,this.rawData[6]=u-S,this.rawData[7]=f-L,this.rawData[8]=a-y,this.rawData[9]=s-w,this.rawData[10]=c-C,this.rawData[11]=_-M,this.rawData[12]=r-x,this.rawData[13]=h-T,this.rawData[14]=d-A,this.rawData[15]=m-F,this},e.prototype.mult=function(t){return this.rawData[0]*=t,this.rawData[1]*=t,this.rawData[2]*=t,this.rawData[3]*=t,this.rawData[4]*=t,this.rawData[5]*=t,this.rawData[6]*=t,this.rawData[7]*=t,this.rawData[8]*=t,this.rawData[9]*=t,this.rawData[10]*=t,this.rawData[11]*=t,this.rawData[12]*=t,this.rawData[13]*=t,this.rawData[14]*=t,this.rawData[15]*=t,this},e.prototype.rotation=function(e,i,a){this.appendRotation(e,t.Vector3D.X_AXIS),this.appendRotation(i,t.Vector3D.Y_AXIS),this.appendRotation(a,t.Vector3D.Z_AXIS)},e.prototype.appendRotation=function(i,a){var r,n,o=(e.getAxisRotation(a.x,a.y,a.z,i),t.MathUtil.CALCULATION_MATRIX),s=i*t.MathUtil.DEGREES_TO_RADIANS;r=Math.sin(s),n=Math.cos(s),1==a.x&&(o.rawData[0]=1,o.rawData[1]=0,o.rawData[2]=0,o.rawData[3]=0,o.rawData[4]=0,o.rawData[5]=n,o.rawData[6]=r,o.rawData[7]=0,o.rawData[8]=0,o.rawData[9]=-r,o.rawData[10]=n,o.rawData[7]=0,o.rawData[12]=0,o.rawData[13]=0,o.rawData[14]=0,o.rawData[15]=1),1==a.y&&(o.rawData[0]=n,o.rawData[1]=0,o.rawData[2]=-r,o.rawData[3]=0,o.rawData[4]=0,o.rawData[5]=1,o.rawData[6]=0,o.rawData[7]=0,o.rawData[8]=r,o.rawData[9]=0,o.rawData[10]=n,o.rawData[11]=0,o.rawData[12]=0,o.rawData[13]=0,o.rawData[14]=0,o.rawData[15]=1),1==a.z&&(o.rawData[0]=n,o.rawData[1]=r,o.rawData[2]=0,o.rawData[3]=0,o.rawData[4]=-r,o.rawData[5]=n,o.rawData[6]=0,o.rawData[7]=0,o.rawData[8]=0,o.rawData[9]=0,o.rawData[10]=1,o.rawData[11]=0,o.rawData[12]=0,o.rawData[13]=0,o.rawData[14]=0,o.rawData[15]=1),this.append(o)},e.prototype.appendScale=function(t,e,i){this.rawData[0]=t,this.rawData[1]=0,this.rawData[2]=0,this.rawData[4]=0,this.rawData[5]=e,this.rawData[6]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[10]=i},e.prototype.appendTranslation=function(t,e,i){this.rawData[12]+=t,this.rawData[13]+=e,this.rawData[14]+=i},e.prototype.clone=function(){var t=new e;return t.copyFrom(this),t},e.prototype.copyColumnFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x,this.rawData[1]=e.y,this.rawData[2]=e.z,this.rawData[3]=e.w;break;case 1:this.rawData[4]=e.x,this.rawData[5]=e.y,this.rawData[6]=e.z,this.rawData[7]=e.w;break;case 2:this.rawData[8]=e.x,this.rawData[9]=e.y,this.rawData[10]=e.z,this.rawData[11]=e.w;break;case 3:this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=e.w}},e.prototype.copyRowTo=function(t,e){switch(t){case 0:e.x=this.rawData[0],e.y=this.rawData[1],e.z=this.rawData[2],e.w=this.rawData[3];break;case 1:e.x=this.rawData[4],e.y=this.rawData[5],e.z=this.rawData[6],e.w=this.rawData[7];break;case 2:e.x=this.rawData[8],e.y=this.rawData[9],e.z=this.rawData[10],e.w=this.rawData[11];break;case 3:e.x=this.rawData[12],e.y=this.rawData[13],e.z=this.rawData[14],e.w=this.rawData[15]}},e.prototype.copyFrom=function(t){for(var e=t.rawData.length,i=0;e>i;i++)this.rawData[i]=t.rawData[i];return this},e.prototype.copyRawDataFrom=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!1),i&&this.transpose();for(var a=t.length-e,r=0;a>r;r++)this.rawData[r]=t[r+e];i&&this.transpose()},e.prototype.copyRawDataTo=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!1),i&&this.transpose();for(var a=this.rawData.length,r=0;a>r;r++)t[r+e]=this.rawData[r];i&&this.transpose()},e.prototype.copyColFrom=function(t,e){switch(t){case 0:this.rawData[0]=e.x,this.rawData[4]=e.y,this.rawData[8]=e.z,this.rawData[12]=e.w;break;case 1:this.rawData[1]=e.x,this.rawData[5]=e.y,this.rawData[9]=e.z,this.rawData[13]=e.w;break;case 2:this.rawData[2]=e.x,this.rawData[6]=e.y,this.rawData[10]=e.z,this.rawData[14]=e.w;break;case 3:this.rawData[3]=e.x,this.rawData[7]=e.y,this.rawData[11]=e.z,this.rawData[15]=e.w;break;default:new Error("no more raw!")}},e.prototype.copyColTo=function(t,e){switch(t){case 0:e.x=this.rawData[0],e.y=this.rawData[4],e.z=this.rawData[8],e.w=this.rawData[12];break;case 1:e.x=this.rawData[1],e.y=this.rawData[5],e.z=this.rawData[9],e.w=this.rawData[13];break;case 2:e.x=this.rawData[2],e.y=this.rawData[6],e.z=this.rawData[10],e.w=this.rawData[14];break;case 3:e.x=this.rawData[3],e.y=this.rawData[7],e.z=this.rawData[11],e.w=this.rawData[15];break;default:new Error("no more raw!")}},e.prototype.copyToMatrix3D=function(t){t.rawData=this.rawData.slice(0)},e.prototype.decompose=function(i,a){void 0===i&&(i="eulerAngles"),void 0===a&&(a=null);var r=t.MathUtil.CALCULATION_QUATERNION,n=a?a:[new t.Vector3D,new t.Vector3D,new t.Vector3D];this.copyRawDataTo(e.helpMatrix.rawData);var o=e.helpMatrix.rawData,s=n[0];s.x=o[12],s.y=o[13],s.z=o[14],o[12]=0,o[13]=0,o[14]=0;var h=n[2];h.x=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]),h.y=Math.sqrt(o[4]*o[4]+o[5]*o[5]+o[6]*o[6]),h.z=Math.sqrt(o[8]*o[8]+o[9]*o[9]+o[10]*o[10]),o[0]*(o[5]*o[10]-o[6]*o[9])-o[1]*(o[4]*o[10]-o[6]*o[8])+o[2]*(o[4]*o[9]-o[5]*o[8])<0&&(h.z=-h.z),o[0]/=h.x,o[1]/=h.x,o[2]/=h.x,o[4]/=h.y,o[5]/=h.y,o[6]/=h.y,o[8]/=h.z,o[9]/=h.z,o[10]/=h.z;var l=n[1];switch(i){case t.Orientation3D.AXIS_ANGLE:l.w=Math.acos((o[0]+o[5]+o[10]-1)/2);var u=Math.sqrt((o[6]-o[9])*(o[6]-o[9])+(o[8]-o[2])*(o[8]-o[2])+(o[1]-o[4])*(o[1]-o[4]));l.x=(o[6]-o[9])/u,l.y=(o[8]-o[2])/u,l.z=(o[1]-o[4])/u;break;case t.Orientation3D.QUATERNION:var c=o[0]+o[5]+o[10];c>0?(l.w=Math.sqrt(1+c)/2,l.x=(o[6]-o[9])/(4*l.w),l.y=(o[8]-o[2])/(4*l.w),l.z=(o[1]-o[4])/(4*l.w)):o[0]>o[5]&&o[0]>o[10]?(l.x=Math.sqrt(1+o[0]-o[5]-o[10])/2,l.w=(o[6]-o[9])/(4*l.x),l.y=(o[1]+o[4])/(4*l.x),l.z=(o[8]+o[2])/(4*l.x)):o[5]>o[10]?(l.y=Math.sqrt(1+o[5]-o[0]-o[10])/2,l.x=(o[1]+o[4])/(4*l.y),l.w=(o[8]-o[2])/(4*l.y),l.z=(o[6]+o[9])/(4*l.y)):(l.z=Math.sqrt(1+o[10]-o[0]-o[5])/2,l.x=(o[8]+o[2])/(4*l.z),l.y=(o[6]+o[9])/(4*l.z),l.w=(o[1]-o[4])/(4*l.z));break;case t.Orientation3D.EULER_ANGLES:var c=o[0]+o[5]+o[10];c>0?(r.w=Math.sqrt(1+c)/2,r.x=(o[6]-o[9])/(4*r.w),r.y=(o[8]-o[2])/(4*r.w),r.z=(o[1]-o[4])/(4*r.w)):o[0]>o[5]&&o[0]>o[10]?(r.x=Math.sqrt(1+o[0]-o[5]-o[10])/2,r.w=(o[6]-o[9])/(4*r.x),r.y=(o[1]+o[4])/(4*r.x),r.z=(o[8]+o[2])/(4*r.x)):o[5]>o[10]?(l.y=Math.sqrt(1+o[5]-o[0]-o[10])/2,r.x=(o[1]+o[4])/(4*r.y),r.w=(o[8]-o[2])/(4*r.y),r.z=(o[6]+o[9])/(4*r.y)):(r.z=Math.sqrt(1+o[10]-o[0]-o[5])/2,r.x=(o[8]+o[2])/(4*r.z),r.y=(o[6]+o[9])/(4*r.z),r.w=(o[1]-o[4])/(4*r.z)),r.toEulerAngles(l)}return n.push(s),n.push(l),n.push(h),n},e.prototype.deltaTransformVector=function(e,i){void 0===i&&(i=null),i||(i=new t.Vector3D);var a=e.x,r=e.y,n=e.z;return i.x=a*this.rawData[0]+r*this.rawData[4]+n*this.rawData[8],i.y=a*this.rawData[1]+r*this.rawData[5]+n*this.rawData[9],i.z=a*this.rawData[2]+r*this.rawData[6]+n*this.rawData[10],i.w=a*this.rawData[3]+r*this.rawData[7]+n*this.rawData[11],i},e.prototype.identity=function(){this.rawData[1]=0,this.rawData[2]=0,this.rawData[3]=0,this.rawData[4]=0,this.rawData[6]=0,this.rawData[7]=0,this.rawData[8]=0,this.rawData[9]=0,this.rawData[11]=0,this.rawData[12]=0,this.rawData[13]=0,this.rawData[14]=0,this.rawData[0]=1,this.rawData[5]=1,this.rawData[10]=1,this.rawData[15]=1},e.prototype.fill=function(t){this.rawData[1]=t,this.rawData[2]=t,this.rawData[3]=t,this.rawData[4]=t,this.rawData[6]=t,this.rawData[7]=t,this.rawData[8]=t,this.rawData[9]=t,this.rawData[11]=t,this.rawData[12]=t,this.rawData[13]=t,this.rawData[14]=t,this.rawData[0]=t,this.rawData[5]=t,this.rawData[10]=t,this.rawData[15]=t},e.prototype.invers33=function(){var t=this.rawData[5]*this.rawData[10]-this.rawData[9]*this.rawData[6],e=this.rawData[8]*this.rawData[6]-this.rawData[4]*this.rawData[10],i=this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5],a=this.rawData[9]*this.rawData[2]-this.rawData[1]*this.rawData[10],r=this.rawData[0]*this.rawData[10]-this.rawData[8]*this.rawData[2],n=this.rawData[8]*this.rawData[1]-this.rawData[0]*this.rawData[9],o=this.rawData[1]*this.rawData[6]-this.rawData[5]*this.rawData[2],s=this.rawData[4]*this.rawData[2]-this.rawData[0]*this.rawData[6],h=this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1],l=this.rawData[0]*t+this.rawData[4]*a+this.rawData[8]*o;if(Math.abs(l)>1e-11){var u=1/l;this.rawData[0]=u*t,this.rawData[4]=u*e,this.rawData[8]=u*i,this.rawData[1]=u*a,this.rawData[5]=u*r,this.rawData[9]=u*n,this.rawData[2]=u*o,this.rawData[6]=u*s,this.rawData[10]=u*h}},e.prototype.invert=function(){var t=this.determinant,e=Math.abs(t)>1e-11;if(e){t=1/t;var i=this.rawData[0],a=this.rawData[4],r=this.rawData[8],n=this.rawData[12],o=this.rawData[1],s=this.rawData[5],h=this.rawData[9],l=this.rawData[13],u=this.rawData[2],c=this.rawData[6],d=this.rawData[10],p=this.rawData[14],f=this.rawData[3],_=this.rawData[7],m=this.rawData[11],v=this.rawData[15];this.rawData[0]=t*(s*(d*v-p*m)-h*(c*v-p*_)+l*(c*m-d*_)),this.rawData[1]=-t*(o*(d*v-p*m)-h*(u*v-p*f)+l*(u*m-d*f)),this.rawData[2]=t*(o*(c*v-p*_)-s*(u*v-p*f)+l*(u*_-c*f)),this.rawData[3]=-t*(o*(c*m-d*_)-s*(u*m-d*f)+h*(u*_-c*f)),this.rawData[4]=-t*(a*(d*v-p*m)-r*(c*v-p*_)+n*(c*m-d*_)),this.rawData[5]=t*(i*(d*v-p*m)-r*(u*v-p*f)+n*(u*m-d*f)),this.rawData[6]=-t*(i*(c*v-p*_)-a*(u*v-p*f)+n*(u*_-c*f)),this.rawData[7]=t*(i*(c*m-d*_)-a*(u*m-d*f)+r*(u*_-c*f)),this.rawData[8]=t*(a*(h*v-l*m)-r*(s*v-l*_)+n*(s*m-h*_)),this.rawData[9]=-t*(i*(h*v-l*m)-r*(o*v-l*f)+n*(o*m-h*f)),this.rawData[10]=t*(i*(s*v-l*_)-a*(o*v-l*f)+n*(o*_-s*f)),this.rawData[11]=-t*(i*(s*m-h*_)-a*(o*m-h*f)+r*(o*_-s*f)),this.rawData[12]=-t*(a*(h*p-l*d)-r*(s*p-l*c)+n*(s*d-h*c)),this.rawData[13]=t*(i*(h*p-l*d)-r*(o*p-l*u)+n*(o*d-h*u)),this.rawData[14]=-t*(i*(s*p-l*c)-a*(o*p-l*u)+n*(o*c-s*u)),this.rawData[15]=t*(i*(s*d-h*c)-a*(o*d-h*u)+r*(o*c-s*u))}return e},e.prototype.makeTransform=function(e,i,a){a.toMatrix3D(t.MathUtil.CALCULATION_MATRIX),this.rawData[0]=t.MathUtil.CALCULATION_MATRIX.rawData[0]*i.x,this.rawData[1]=t.MathUtil.CALCULATION_MATRIX.rawData[1]*i.y,this.rawData[2]=t.MathUtil.CALCULATION_MATRIX.rawData[2]*i.z,this.rawData[3]=0,this.rawData[4]=t.MathUtil.CALCULATION_MATRIX.rawData[4]*i.x,this.rawData[5]=t.MathUtil.CALCULATION_MATRIX.rawData[5]*i.y,this.rawData[6]=t.MathUtil.CALCULATION_MATRIX.rawData[6]*i.z,this.rawData[7]=0,this.rawData[8]=t.MathUtil.CALCULATION_MATRIX.rawData[8]*i.x,this.rawData[9]=t.MathUtil.CALCULATION_MATRIX.rawData[9]*i.y,this.rawData[10]=t.MathUtil.CALCULATION_MATRIX.rawData[10]*i.z,this.rawData[11]=0,this.rawData[12]=e.x,this.rawData[13]=e.y,this.rawData[14]=e.z,this.rawData[15]=1},e.prototype.recompose=function(e){return t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(e[1].x,e[1].y,e[1].z),this.makeTransform(e[0],e[2],t.MathUtil.CALCULATION_QUATERNION),!0},e.prototype.transformVector=function(e,i){void 0===i&&(i=null),i||(i=new t.Vector3D);var a=e.x,r=e.y,n=e.z;return i.x=a*this.rawData[0]+r*this.rawData[4]+n*this.rawData[8]+this.rawData[12],i.y=a*this.rawData[1]+r*this.rawData[5]+n*this.rawData[9]+this.rawData[13],i.z=a*this.rawData[2]+r*this.rawData[6]+n*this.rawData[10]+this.rawData[14],i.w=a*this.rawData[3]+r*this.rawData[7]+n*this.rawData[11]+this.rawData[15],i},e.prototype.transformVector4=function(e,i){void 0===i&&(i=null),i||(i=new t.Vector3D);var a=e.x,r=e.y,n=e.z,o=e.w;return i.x=a*this.rawData[0]+r*this.rawData[4]+n*this.rawData[8]+o*this.rawData[12],i.y=a*this.rawData[1]+r*this.rawData[5]+n*this.rawData[9]+o*this.rawData[13],i.z=a*this.rawData[2]+r*this.rawData[6]+n*this.rawData[10]+o*this.rawData[14],i.w=a*this.rawData[3]+r*this.rawData[7]+n*this.rawData[11]+o*this.rawData[15],i},e.prototype.mat3TransformVector=function(e,i){void 0===i&&(i=null),i||(i=new t.Vector3D);var a=e.x,r=e.y,n=e.z;return i.x=a*this.rawData[0]+r*this.rawData[4]+n*this.rawData[8],i.y=a*this.rawData[1]+r*this.rawData[5]+n*this.rawData[9],i.z=a*this.rawData[2]+r*this.rawData[6]+n*this.rawData[10],i},e.prototype.transformPlane=function(i){var a=new e;a.copyFrom(this),a.invert(),a.transpose();var r=new t.Vector3D(i.a,i.b,i.c,i.d);r.copyFrom(a.transformVector(r));var n=new t.Plane3D;return n.a=r.x,n.b=r.y,n.c=r.z,n.d=r.w/Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z),n},e.prototype.transpose=function(){for(var t=0;t<e.helpMatrix.rawData.length;t++)e.helpMatrix.rawData[t]=this.rawData[t];this.rawData[1]=e.helpMatrix.rawData[4],this.rawData[2]=e.helpMatrix.rawData[8],this.rawData[3]=e.helpMatrix.rawData[12],this.rawData[4]=e.helpMatrix.rawData[1],this.rawData[6]=e.helpMatrix.rawData[9],this.rawData[7]=e.helpMatrix.rawData[13],this.rawData[8]=e.helpMatrix.rawData[2],this.rawData[9]=e.helpMatrix.rawData[6],this.rawData[11]=e.helpMatrix.rawData[14],this.rawData[12]=e.helpMatrix.rawData[3],this.rawData[13]=e.helpMatrix.rawData[7],this.rawData[14]=e.helpMatrix.rawData[11]},e.getAxisRotation=function(t,i,a,r){var n,o,s=new e,h=r*(Math.PI/180),l=Math.cos(h),u=Math.sin(h),c=1-l;return s.rawData[0]=l+t*t*c,s.rawData[5]=l+i*i*c,s.rawData[10]=l+a*a*c,n=t*i*c,o=a*u,s.rawData[1]=n+o,s.rawData[4]=n-o,n=t*a*c,o=i*u,s.rawData[8]=n+o,s.rawData[2]=n-o,n=i*a*c,o=t*u,s.rawData[9]=n-o,s.rawData[6]=n+o,s
},Object.defineProperty(e.prototype,"determinant",{get:function(){return(this.rawData[0]*this.rawData[5]-this.rawData[4]*this.rawData[1])*(this.rawData[10]*this.rawData[15]-this.rawData[14]*this.rawData[11])-(this.rawData[0]*this.rawData[9]-this.rawData[8]*this.rawData[1])*(this.rawData[6]*this.rawData[15]-this.rawData[14]*this.rawData[7])+(this.rawData[0]*this.rawData[13]-this.rawData[12]*this.rawData[1])*(this.rawData[6]*this.rawData[11]-this.rawData[10]*this.rawData[7])+(this.rawData[4]*this.rawData[9]-this.rawData[8]*this.rawData[5])*(this.rawData[2]*this.rawData[15]-this.rawData[14]*this.rawData[3])-(this.rawData[4]*this.rawData[13]-this.rawData[12]*this.rawData[5])*(this.rawData[2]*this.rawData[11]-this.rawData[10]*this.rawData[3])+(this.rawData[8]*this.rawData[13]-this.rawData[12]*this.rawData[9])*(this.rawData[2]*this.rawData[7]-this.rawData[6]*this.rawData[3])},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"position",{get:function(){return new t.Vector3D(this.rawData[12],this.rawData[13],this.rawData[14])},set:function(t){this.rawData[12]=t.x,this.rawData[13]=t.y,this.rawData[14]=t.z},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return new t.Vector3D(this.rawData[0],this.rawData[5],this.rawData[10])},enumerable:!0,configurable:!0}),e.prototype.toString=function(){return"matrix3d("+Math.round(1e3*this.rawData[0])/1e3+","+Math.round(1e3*this.rawData[1])/1e3+","+Math.round(1e3*this.rawData[2])/1e3+","+Math.round(1e3*this.rawData[3])/1e3+","+Math.round(1e3*this.rawData[4])/1e3+","+Math.round(1e3*this.rawData[5])/1e3+","+Math.round(1e3*this.rawData[6])/1e3+","+Math.round(1e3*this.rawData[7])/1e3+","+Math.round(1e3*this.rawData[8])/1e3+","+Math.round(1e3*this.rawData[9])/1e3+","+Math.round(1e3*this.rawData[10])/1e3+","+Math.round(1e3*this.rawData[11])/1e3+","+Math.round(1e3*this.rawData[12])/1e3+","+Math.round(1e3*this.rawData[13])/1e3+","+Math.round(1e3*this.rawData[14])/1e3+","+Math.round(1e3*this.rawData[15])/1e3+")"},e.prototype.lerp=function(t,e,i){this.copyFrom(e).sub(t).mult(i).add(t)},e.helpMatrix=new e,e}();t.Matrix4_4=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.eyeSpace=1,this.eyePosition=new t.Vector3D,this.eyeRotation=new t.Vector3D(0,1,0),this.eyeFocalLength=180,this.leftPos=new t.Vector3D,this.rightPos=new t.Vector3D,this.targetPos=new t.Vector3D(0,0,this.eyeFocalLength),this.lookAtPos=new t.Vector3D,this.quaternion=new t.Quaternion,this.dir=new t.Vector3D,this.leftEyeMatrix=new t.Matrix4_4,this.rightEyeMatrix=new t.Matrix4_4}return e.prototype.update=function(e){e.globalOrientation.transformVector(t.Vector3D.X_AXIS,this.dir),this.dir.normalize(),this.leftEyeMatrix.copyFrom(e.modelMatrix),this.rightEyeMatrix.copyFrom(e.modelMatrix);var i=.5*this.eyeSpace;this.leftEyeMatrix.appendTranslation(-this.dir.x*i,-this.dir.y*i,-this.dir.z*i),this.rightEyeMatrix.appendTranslation(this.dir.x*i,this.dir.y*i,this.dir.z*i)},e}();t.EyesMatrix=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.BACK=0,t.FRONT=1,t.IN=0,t.OUT=1,t.INTERSECT=2,t}();t.PlaneClassification=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.quaternion2matrix=function(i,a){void 0===a&&(a=null);var r=i.x,n=i.y,o=i.z,s=i.w,h=r*r,l=r*n,u=r*o,c=r*s,d=n*n,p=n*o,f=n*s,_=o*o,m=o*s,v=e.RAW_DATA_CONTAINER;return v[0]=1-2*(d+_),v[1]=2*(l+m),v[2]=2*(u-f),v[4]=2*(l-m),v[5]=1-2*(h+_),v[6]=2*(p+c),v[8]=2*(u+f),v[9]=2*(p-c),v[10]=1-2*(h+d),v[3]=v[7]=v[11]=v[12]=v[13]=v[14]=0,v[15]=1,a?(a.copyRawDataFrom(v),a):new t.Matrix4_4(new Float32Array(v))},e.getForward=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(2,i),i.normalize(),i},e.getUp=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(1,i),i.normalize(),i},e.getRight=function(e,i){return void 0===i&&(i=null),null===i&&(i=new t.Vector3D(0,0,0)),e.copyRowTo(0,i),i.normalize(),i},e.compare=function(t,i){var a=e.RAW_DATA_CONTAINER,r=i.rawData;t.copyRawDataTo(a);for(var n=0;16>n;++n)if(a[n]!=r[n])return!1;return!0},e.reflection=function(i,a){void 0===a&&(a=null),null===a&&(a=new t.Matrix4_4);var r=i.a,n=i.b,o=i.c,s=i.d,h=e.RAW_DATA_CONTAINER,l=-2*r*n,u=-2*r*o,c=-2*n*o;return h[0]=1-2*r*r,h[4]=l,h[8]=u,h[12]=-2*r*s,h[1]=l,h[5]=1-2*n*n,h[9]=c,h[13]=-2*n*s,h[2]=u,h[6]=c,h[10]=1-2*o*o,h[14]=-2*o*s,h[3]=0,h[7]=0,h[11]=0,h[15]=1,a.copyRawDataFrom(h),a},e.getTranslation=function(e,i){return void 0===i&&(i=null),i||(i=new t.Vector3D),e.copyRowTo(3,i),i},e.clampf=function(t,e,i){if(e>i){var a=e;e=i,i=a}return e>t?e:i>t?t:i},e.ScreenToPosition=function(t,e,i){return(t+.5*e)/i*2-1},e.PositionToScreen=function(t,e,i){return.5*(t+1)*i-.5*e},e.RADIANS_TO_DEGREES=180/Math.PI,e.DEGREES_TO_RADIANS=Math.PI/180,e.RAW_DATA_CONTAINER=new Float32Array(16),e.CALCULATION_MATRIX=new t.Matrix4_4,e.CALCULATION_QUATERNION=new t.Quaternion,e.CALCULATION_VECTOR3D=new t.Vector3D,e}();t.MathUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=new t.Vector3D),void 0===i&&(i=new t.Vector3D),this.origin=new t.Vector3D,this.dir=new t.Vector3D,this.invViewMat=new t.Matrix4_4,this.origin.copyFrom(e),this.dir.copyFrom(i)}return e.prototype.IntersectTriangle=function(t,e,i,a){void 0===a&&(a=null);var r,n=e.subtract(t),o=i.subtract(t),s=this.dir.crossProduct(o),h=n.dotProduct(s);if(h>0?r=this.origin.subtract(t):(r=t.subtract(this.origin),h=-h),1e-4>h)return!1;var l=r.dotProduct(s);if(null!=a&&(a[1]=l),0>l||l>h)return!1;var u=r.crossProduct(n),c=this.dir.dotProduct(u);if(null!=a&&(a[2]=c),0>c||l+c>h)return!1;var d=o.dotProduct(u),p=1/h;return d*=p,l*=p,c*=p,null!=a&&(a[0]=d,a[1]=l,a[2]=c),0>d?!1:!0},e.prototype.IntersectMeshEx=function(t,e,i){return this.IntersectMesh(t.geometry.verticesData,t.geometry.indexData,t.geometry.vertexAttLength,t.geometry.indexData.length/3,e,t.modelMatrix,i)},e.prototype.IntersectMesh=function(e,i,a,r,n,o,s){var h=new Array;h.push(new t.Vector3D),h.push(new t.Vector3D),h.push(new t.Vector3D);var l=new Array;l.push(new t.Vector3D),l.push(new t.Vector3D),l.push(new t.Vector3D);var u=new Array,c=new t.Vector3D,d=new t.Vector3D,p=new t.Vector3D;u.push(c),u.push(d),u.push(p);var f=new t.Vector3D,_=new t.Point,m=new Array;m.push(0),m.push(0),m.push(0);for(var v=-1,g=Number.MAX_VALUE,y=0,x=0,D=0;r>D;++D){for(var b=0;3>b;++b){var w=i[3*D+b];f.setTo(e[a*w+0],e[a*w+1],e[a*w+2]),f.copyFrom(o.transformVector(f)),u[b].x=f.x,u[b].y=f.y,u[b].z=f.z}this.IntersectTriangle(c,d,p,m)&&m[0]<g&&(v=D,g=m[0],y=m[1],x=m[2])}if(r>v&&v>=0){for(var D=0;3>D;++D){var w=i[3*v+D];f.setTo(e[a*w+0],e[a*w+1],e[a*w+2]),h[D].copyFrom(f),n>0&&(_.x=e[a*w+0+n],_.y=e[a*w+1+n],l[D].x=_.x,l[D].y=_.y),f.copyFrom(o.transformVector(f)),u[D].x=f.x,u[D].y=f.y,u[D].z=f.z}var T=d.subtract(c);T.scaleBy(y);var P=p.subtract(c);return P.scaleBy(x),s.globalPosition.copyFrom(c.add(T.add(P))),T=h[1].subtract(h[0]),T.scaleBy(y),P=h[2].subtract(h[0]),P.scaleBy(x),s.localPosition.copyFrom(h[0].add(T.add(P))),n>0&&(T=l[1].subtract(l[0]),T.scaleBy(y),P=l[2].subtract(l[0]),P.scaleBy(x),s.uv.copyFrom(l[0].add(T.add(P)))),!0}return!1},e.prototype.CalculateAndTransformRay=function(t,e,i,a,r,n){this.reset(),this.dir.x=(2*r/t-1)/a.rawData[0],this.dir.y=(-2*n/e+1)/a.rawData[5],this.dir.z=1,this.invViewMat.copyFrom(i),this.origin.copyFrom(this.invViewMat.transformVector(this.origin)),this.dir.copyFrom(this.invViewMat.deltaTransformVector(this.dir)),this.dir.normalize()},e.prototype.reset=function(){this.origin.setTo(0,0,0),this.dir.setTo(0,0,0)},e}();t.Ray=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t,e,i,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=255),this.a=255,this.r=255,this.g=255,this.b=255,this.a=a,this.r=t,this.g=e,this.b=i}return e.white=function(){return new e(255,255,255,255)},e.black=function(){return new e(0,0,0,255)},e.red=function(){return new e(255,0,0,255)},e.green=function(){return new e(0,255,0,255)},e.blue=function(){return new e(0,0,255,255)},e.prototype.getColor=function(e){return void 0===e&&(e=t.ContextConfig.ColorFormat_RGBA8888),e==t.ContextConfig.ColorFormat_RGB565?0:e==t.ContextConfig.ColorFormat_RGBA5551?0:e==t.ContextConfig.ColorFormat_RGBA4444?0:this.r<<24|this.g<<16|this.b<<8|this.a},e.prototype.lerp=function(t,e,i){this.a=i*(e.a-t.a)+t.a,this.r=i*(e.r-t.r)+t.r,this.g=i*(e.g-t.g)+t.g,this.b=i*(e.b-t.b)+t.b,this.a=Math.floor(this.a),this.r=Math.floor(this.r),this.g=Math.floor(this.g),this.b=Math.floor(this.b)},e.prototype.copyFrom=function(t){this.a=t.a,this.r=t.r,this.g=t.g,this.b=t.b},e.prototype.setTo=function(t,e,i,a){void 0===t&&(t=255),void 0===e&&(e=255),void 0===i&&(i=255),void 0===a&&(a=255),this.a=t,this.r=e,this.g=i,this.b=a},e.createColor=function(t){var i=new e;return i.setColorARGB(t),i},e.prototype.setColorARGB=function(t){this.a=t/16777216,this.a>>=0,this.r=16711680&t,this.r>>=16,this.g=65280&t,this.g>>=8,this.b=255&t},e.prototype.randomColor=function(t,e,i){if(void 0===i&&(i=!1),i){var a=Math.random();this.a=t.a+(e.a-t.a)*a,this.r=t.r+(e.r-t.r)*a,this.g=t.g+(e.g-t.g)*a,this.b=t.b+(e.b-t.b)*a}else this.a=t.a+(e.a-t.a)*Math.random(),this.r=t.r+(e.r-t.r)*Math.random(),this.g=t.g+(e.g-t.g)*Math.random(),this.b=t.b+(e.b-t.b)*Math.random();this.a=Math.floor(this.a),this.r=Math.floor(this.r),this.g=Math.floor(this.g),this.b=Math.floor(this.b)},e}();t.Color=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.colors=[],this.times=[]}return e.prototype.lerpColor=function(e,i){void 0===i&&(i=null),0>e?e=0:e>1&&(e=1),null==i&&(i=new t.Color);for(var a=0,r=this.times.length-1;r>a;a++)if(e>=this.times[a]&&e<this.times[a+1]){e=(e-this.times[a])/(this.times[a+1]-this.times[a]),i.lerp(this.colors[a],this.colors[a+1],e);break}return i},e}();t.ColorGradients=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.vexData=new Array,this.indexData=new Array,this.vexLength=3,this.matrix=new t.Matrix4_4,this.temp=new t.Vector3D,this.owner=e}return Object.defineProperty(e.prototype,"transform",{get:function(){return this.owner?this.owner.modelMatrix:this.matrix},enumerable:!0,configurable:!0}),e.prototype.pointIntersect=function(t){return!1},e.prototype.intersect=function(t,e){return void 0===e&&(e=null),!0},e.prototype.clone=function(){var t=new e(this.owner);return t.copyVertex(this),t},e.prototype.calculateTransform=function(){for(var t=0;t<this.vexData.length;t+=3)this.temp.setTo(this.vexData[t],this.vexData[t+1],this.vexData[t+2]),this.transform.transformVector(this.temp,this.temp),this.vexData[t+0]=this.temp.x,this.vexData[t+1]=this.temp.y,this.vexData[t+2]=this.temp.z},e.prototype.copyVertex=function(t){for(var e=0;e<t.vexData.length;++e)this.vexData[e]=t.vexData[e];for(var e=0;e<t.indexData.length;++e)this.indexData[e]=t.indexData[e];this.vexLength=t.vexLength},e.prototype.createChild=function(){this.childBound=new e(this.owner)},e.prototype.inBound=function(t){return!0},e.prototype.updateAABB=function(){},e}();t.Bound=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){void 0===t&&(t=!1),this.data=[],this.list=new Array,t&&(this.list=new Array)}return t.prototype.isHas=function(t){return this.data[t]?!0:!1},t.prototype.getValue=function(t){return this.data[t]},t.prototype.getList=function(){return this.list},t.prototype.add=function(t,e){this.data[t]=e,this.list&&this.list.push(e)},t.prototype.remove=function(t){if(this.list){var e=this.list.indexOf(this.data[t]);-1!=e&&this.list.splice(e)}delete this.data[t]},t.prototype.dispose=function(){delete this.data,delete this.list},t}();t.HashMap=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===i&&(i=null),void 0===a&&(a=new t.Vector3D),void 0===r&&(r=new t.Vector3D),e.call(this,i),this.min=new t.Vector3D,this.max=new t.Vector3D,this.width=0,this.heigth=0,this.depth=0,this.volume=0,this.center=new t.Vector3D,this.radius=0,this.min.copyFrom(a),this.max.copyFrom(r),this.calculateBox()}return __extends(i,e),i.prototype.copyFrom=function(t){this.min.copyFrom(t.min),this.max.copyFrom(t.max),this.calculateBox()},i.prototype.fillBox=function(t,e){this.min.copyFrom(t),this.max.copyFrom(e),this.calculateBox()},i.prototype.pointIntersect=function(t){return t.x<=this.max.x&&t.x>=this.min.x&&t.y<=this.max.y&&t.y>=this.min.y&&t.z<=this.max.z&&t.z>=this.min.z?!0:!1},i.prototype.intersectAABBs=function(t,e){return void 0===e&&(e=null),this.min.x>t.max.x?!1:this.max.x<t.min.x?!1:this.min.y>t.max.y?!1:this.max.y<t.min.y?!1:this.min.z>t.max.z?!1:this.max.z<t.min.z?!1:(null!=e&&(e.min.x=Math.max(this.min.x,t.min.x),e.max.x=Math.min(this.max.x,t.max.x),e.min.y=Math.max(this.min.y,t.min.y),e.max.y=Math.min(this.max.y,t.max.y),e.min.z=Math.max(this.min.z,t.min.z),e.max.z=Math.min(this.max.z,t.max.z),e.calculateBox()),!0)},i.prototype.intersect=function(t,e){return void 0===e&&(e=null),this._box0?(this._box0.copyVertex(this),this._box0.owner=this.owner):this._box0=this.clone(),this._box0.calculateTransform(),this._box0.updateAABB(),this._box1?(this._box1.copyVertex(this),this._box1.owner=t.owner):this._box1=t.clone(),this._box1.calculateTransform(),this._box1.updateAABB(),this._box0.intersectAABBs(this._box1,e)},i.prototype.toString=function(){return"BoundBox [min:("+this.min.x+", "+this.min.y+", "+this.min.z+") max:("+this.max.x+", "+this.max.y+", "+this.max.z+")]"},i.prototype.calculateBox=function(){this.vexData.length=0,this.indexData.length=0;var t=this.max.subtract(this.min);this.vexData.push(this.min.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z),this.vexData.push(this.min.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z+t.z),this.vexData.push(this.min.x+t.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z+t.z),this.vexData.push(this.min.x+t.x),this.vexData.push(this.min.y),this.vexData.push(this.min.z),this.vexData.push(this.max.x-t.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z-t.z),this.vexData.push(this.max.x-t.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z),this.vexData.push(this.max.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z),this.vexData.push(this.max.x),this.vexData.push(this.max.y),this.vexData.push(this.max.z-t.z),this.indexData.push(0,4,7,0,7,3,2,6,5,2,5,1,4,5,6,4,6,7,0,3,2,0,2,1,0,1,5,0,5,4,3,7,6,3,6,2),this.width=this.max.x-this.min.x,this.heigth=this.max.y-this.min.y,this.depth=this.max.z-this.min.z,this.volume=this.width*this.heigth*this.depth;var e=this.max.subtract(this.min);e.scaleBy(.5),this.radius=e.length,this.center.copyFrom(this.min);var i=this.center.add(e);this.center.copyFrom(i)},i.prototype.inBound=function(t){return t.inBox(this)},i.prototype.updateAABB=function(){this.min.copyFrom(new t.Vector3D(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this.max.copyFrom(new t.Vector3D(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE));for(var e=0;e<this.vexData.length;e+=this.vexLength)this.max.x<this.vexData[e]&&(this.max.x=this.vexData[e]),this.max.y<this.vexData[e+1]&&(this.max.y=this.vexData[e+1]),this.max.z<this.vexData[e+2]&&(this.max.z=this.vexData[e+2]),this.min.x>this.vexData[e]&&(this.min.x=this.vexData[e]),this.min.y>this.vexData[e+1]&&(this.min.y=this.vexData[e+1]),this.min.z>this.vexData[e+2]&&(this.min.z=this.vexData[e+2])},i.prototype.createChild=function(){this.childBound=new i(this.owner);var e=new t.Vector3D,a=new t.Vector3D;e.x=this.center.x+this.width/4,e.y=this.center.y+this.heigth/4,e.z=this.center.z+this.depth/4,a.x=this.center.x-this.width/4,a.y=this.center.y-this.heigth/4,a.z=this.center.z-this.depth/4,this.childBound.fillBox(a,e)},i.prototype.clone=function(){var t=new i(this.owner);return t.copyVertex(this),t.width=this.width,t.heigth=this.heigth,t.depth=this.depth,t.min.copyFrom(this.min),t.max.copyFrom(this.max),t.volume=this.volume,t.center.copyFrom(this.center),t.radius=this.radius,t},i}(t.Bound);t.BoundBox=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.prototype.calcBezierY=function(t,e,i){for(var a,r,n,o,s=0;3>s;s++)if(i>=t[s].x&&i<=t[s+1].x){a=t[s],r=e[s],n=t[s+1],o=e[s+1];break}return i=(i-a.x)/(n.x-a.x),this.cubic_bezier(a.y,r.y,o.y,n.y,i)},t.prototype.calcBezierX=function(t,e,i){for(var a,r,n,o,s=0;3>s;s++)if(i>=t[s].x&&i<=t[s+1].x){a=t[s],r=e[s],n=t[s+1],o=e[s+1];break}return i=(i-a.x)/(n.x-a.x),this.cubic_bezier(a.x,r.x,o.x,n.x,i)},t.prototype.cubic_bezier=function(t,e,i,a,r){return t=this.mix(t,e,r),e=this.mix(e,i,r),i=this.mix(i,a,r),t=this.mix(t,e,r),e=this.mix(e,i,r),t=this.mix(t,e,r)},t.prototype.cubic_bezier2=function(t,e,i,a,r){var n=1-r,o=n*n,s=o*n,h=r*r,l=h*r,u=t*s+3*e*r*o+3*i*h*n+a*l;return u},t.prototype.mix=function(t,e,i){return t*(1-i)+e*i},t}();t.BezierCurve=e;var i=function(){function i(){this.posPoints=[],this.ctrlPoints=[]}return i.prototype.calc=function(t){var e=i.calc.calcBezierY(this.posPoints,this.ctrlPoints,t);return e},i.prototype.merge=function(){for(var t=new Float32Array(4*i.SegCount*2),e=0,a=2*i.SegCount;a>e;e++)t[4*e+0]=this.posPoints[e].x,t[4*e+1]=this.posPoints[e].y,t[4*e+2]=this.ctrlPoints[e].x,t[4*e+3]=this.ctrlPoints[e].y;return t},i.prototype.scaleBy=function(t){if(0!=this.posPoints.length){if(this.posPoints)for(var e=0,i=this.posPoints.length;i>e;e++)this.posPoints[e].y*=t;if(this.ctrlPoints)for(var e=0,i=this.ctrlPoints.length;i>e;e++)this.ctrlPoints[e].y*=t}},i.prototype.trySampler=function(){for(var t=0,e=this.posPoints.length;e>t;t++)if(0!=this.posPoints[t].y||0!=this.ctrlPoints[t].y)return this.doSampler();return null},i.prototype.sampler=function(){return this.doSampler()},i.prototype.pushSameValue=function(t){for(var e=10,a=new Float32Array(e*i.SegCount+2+1),r=0,n=i.SegCount*i.SegCount+2;n>r;r++)a[r]=t;return a[n+2]=1,a},i.prototype.doSampler=function(){var t,e,a,r=[],n=[],o=0,s=0,h=9;for(e=0,a=i.SegCount;a>e;e++){r.push(this.posPoints[2*e].y),o=this.posPoints[2*e].x,s=this.posPoints[2*e+1].x,t=(s-o)/h,n.push(t);for(var l=1;h>l;l++)r.push(this.calc(o+t*l));r.push(this.posPoints[2*e+1].y)}var u=new Float32Array(r.length+n.length);for(e=0,a=r.length;a>e;e++)u[e]=r[e];for(var l=0,a=n.length;a>l;e++,l++)u[e]=n[l];return u},i.prototype.validate=function(){null==this.posPoints&&(this.posPoints=[]),null==this.ctrlPoints&&(this.ctrlPoints=[]);var e=0,a=0;for(e=this.posPoints.length/2,a=i.SegCount;a>e;e++)this.posPoints.push(new t.Point(0,0)),this.posPoints.push(new t.Point(1,0));for(e=this.ctrlPoints.length/2,a=i.SegCount;a>e;e++)this.ctrlPoints.push(new t.Point(0,0)),this.ctrlPoints.push(new t.Point(1,0))},i.compressFloats=function(t,e){t.length%2==1&&t.push(0);var a=0;a+=5*i.SegCount,a+=2,a+=1,a+=i.SegCount;var r,n,o=new Float32Array(a),s=4096,h=s-1,l=[];l.length=t.length;var u,c=-Number.MAX_VALUE,d=Number.MAX_VALUE;for(r=0,n=t.length;n>r;r++)u=l[r]=t[r],c=Math.max(u,c),d=Math.min(u,d);var p=c-d;if(p>0){var f=0;for(r=0,n=l.length;n>r;r++)f=l[r],f-=d,f/=p,f*=h,l[r]=Math.floor(f);var _,m;for(r=0,n=l.length/2;n>r;r++)_=l[2*r],m=l[2*r+1],o[r]=_+m/s;o[r]=d,r++,o[r]=p,r++,o[r]=0,r++}else{for(r=0,n=l.length/2;n>r;r++)o[r]=d;o[r]=d,r++,o[r]=p,r++,o[r]=1,r++}for(var v=0,n=i.SegCount;n>v;r++,v++)o[r]=e[v];return o},i.SegCount=2,i.calc=new e,i}();t.BezierData=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.m44=new t.Matrix4_4,this.vec4=new Float32Array(4)}return e.prototype.reset=function(){this.m44.identity(),this.vec4.fill(0)},e}();t.ColorTransform=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.localPosition=new t.Vector3D,this.globalPosition=new t.Vector3D,this.uv=new t.Vector3D}return e}();t.PickResult=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.time=0,this.delay=0,this.eventType=t,this.data=e}return t.ENTER_FRAME="enter_frame",t.RESIZE="resize",t}();t.Event3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i){void 0===e&&(e=null),void 0===i&&(i=null),t.call(this,e,i)}return __extends(e,t),e.EVENT_PLAY_COMPLETE="event_play_complete",e}(t.Event3D);t.PropertyAnimEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i){void 0===e&&(e=null),void 0===i&&(i=null),t.call(this,e,i)}return __extends(e,t),e.EVENT_PLAY_COMPLETE="event_play_complete",e.EVENT_FRAME_CHANGE="event_frame_change",e}(t.Event3D);t.SkeletonAnimationEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Mouse_Left=0]="Mouse_Left",t[t.Mouse_Mid=1]="Mouse_Mid",t[t.Mouse_Right=2]="Mouse_Right"}(t.MouseCode||(t.MouseCode={}));var e=(t.MouseCode,function(t){function e(){t.apply(this,arguments),this.mouseCode=0}return __extends(e,t),e.MOUSE_CLICK="onMouseClick",e.MOUSE_DOWN="onMouseDown",e.MOUSE_UP="onMouseUp",e.MOUSE_MOVE="onMouseMove",e.MOUSE_OVER="onMouseOver",e.MOUSE_WHEEL="onMouseWheel",e}(t.Event3D));t.MouseEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.TOUCH_MOVE="onTouchMove",e.TOUCH_START="onTouchStart",e.TOUCH_END="onTouchEnd",e}(t.Event3D);t.TouchEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.PICK_CLICK="onPickClick",e.PICK_DOWN="onPickDown",e.PICK_UP="onPickUp",e.PICK_MOVE="onPickMove",e.PICK_WHEEL="onPickWheel",e}(t.Event3D);t.PickEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Key_BackSpace=8]="Key_BackSpace",t[t.Key_Tab=9]="Key_Tab",t[t.Key_Clear=12]="Key_Clear",t[t.Key_Enter=13]="Key_Enter",t[t.Key_Shift_L=16]="Key_Shift_L",t[t.Key_Control_L=17]="Key_Control_L",t[t.Key_Alt_L=18]="Key_Alt_L",t[t.Key_Pause=19]="Key_Pause",t[t.Key_CapsLock=20]="Key_CapsLock",t[t.Key_Escape=21]="Key_Escape",t[t.Key_Space=32]="Key_Space",t[t.Key_Prior=33]="Key_Prior",t[t.Key_Next=34]="Key_Next",t[t.Key_End=35]="Key_End",t[t.Key_Home=36]="Key_Home",t[t.Key_Left=37]="Key_Left",t[t.Key_Up=38]="Key_Up",t[t.Key_Right=39]="Key_Right",t[t.Key_Down=40]="Key_Down",t[t.Key_Select=41]="Key_Select",t[t.Key_Print=42]="Key_Print",t[t.Key_Execute=43]="Key_Execute",t[t.Key_Insert=45]="Key_Insert",t[t.Key_Delete=46]="Key_Delete",t[t.Key_Help=47]="Key_Help",t[t.Key_0=48]="Key_0",t[t.Key_1=49]="Key_1",t[t.Key_2=50]="Key_2",t[t.Key_3=51]="Key_3",t[t.Key_4=52]="Key_4",t[t.Key_5=53]="Key_5",t[t.Key_6=54]="Key_6",t[t.Key_7=55]="Key_7",t[t.Key_8=56]="Key_8",t[t.Key_9=57]="Key_9",t[t.Key_A=65]="Key_A",t[t.Key_B=66]="Key_B",t[t.Key_C=67]="Key_C",t[t.Key_D=68]="Key_D",t[t.Key_E=69]="Key_E",t[t.Key_F=70]="Key_F",t[t.Key_G=71]="Key_G",t[t.Key_H=72]="Key_H",t[t.Key_I=73]="Key_I",t[t.Key_J=74]="Key_J",t[t.Key_K=75]="Key_K",t[t.Key_L=76]="Key_L",t[t.Key_M=77]="Key_M",t[t.Key_N=78]="Key_N",t[t.Key_O=79]="Key_O",t[t.Key_P=80]="Key_P",t[t.Key_Q=81]="Key_Q",t[t.Key_R=82]="Key_R",t[t.Key_S=83]="Key_S",t[t.Key_T=84]="Key_T",t[t.Key_U=85]="Key_U",t[t.Key_V=86]="Key_V",t[t.Key_W=87]="Key_W",t[t.Key_X=88]="Key_X",t[t.Key_Y=89]="Key_Y",t[t.Key_Z=90]="Key_Z",t[t.Key_KP_0=96]="Key_KP_0",t[t.Key_KP_1=97]="Key_KP_1",t[t.Key_KP_2=98]="Key_KP_2",t[t.Key_KP_3=99]="Key_KP_3",t[t.Key_KP_4=100]="Key_KP_4",t[t.Key_KP_5=101]="Key_KP_5",t[t.Key_KP_6=102]="Key_KP_6",t[t.Key_KP_7=103]="Key_KP_7",t[t.Key_KP_8=104]="Key_KP_8",t[t.Key_KP_9=105]="Key_KP_9",t[t.Key_Multiply=106]="Key_Multiply",t[t.Key_Add=107]="Key_Add",t[t.Key_Separator=108]="Key_Separator",t[t.Key_Subtract=109]="Key_Subtract",t[t.Key_Decimal=110]="Key_Decimal",t[t.Key_Divide=111]="Key_Divide",t[t.Key_F1=112]="Key_F1",t[t.Key_F2=113]="Key_F2",t[t.Key_F3=114]="Key_F3",t[t.Key_F4=115]="Key_F4",t[t.Key_F5=116]="Key_F5",t[t.Key_F6=117]="Key_F6",t[t.Key_F7=118]="Key_F7",t[t.Key_F8=119]="Key_F8",t[t.Key_F9=120]="Key_F9",t[t.Key_F10=121]="Key_F10",t[t.Key_F11=122]="Key_F11",t[t.Key_F12=123]="Key_F12",t[t.Key_F13=124]="Key_F13",t[t.Key_F14=125]="Key_F14",t[t.Key_F15=126]="Key_F15",t[t.Key_F16=127]="Key_F16",t[t.Key_F17=128]="Key_F17",t[t.Key_F18=129]="Key_F18",t[t.Key_F19=130]="Key_F19",t[t.Key_F20=131]="Key_F20",t[t.Key_F21=132]="Key_F21",t[t.Key_F22=133]="Key_F22",t[t.Key_F23=134]="Key_F23",t[t.Key_F24=135]="Key_F24",t[t.Key_Num_Lock=136]="Key_Num_Lock",t[t.Key_Scroll_Lock=137]="Key_Scroll_Lock"}(t.KeyCode||(t.KeyCode={}));var e=(t.KeyCode,function(t){function e(){t.apply(this,arguments),this.keyCode=0}return __extends(e,t),e.KEY_CLICK="onKeyClick",e.KEY_DOWN="onKeyDown",e.KEY_UP="onKeyUp",e}(t.Event3D));t.KeyEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Portrait_Primary=0]="Portrait_Primary",t[t.Portrait_Secondary=180]="Portrait_Secondary",t[t.Landscape_Primary=-90]="Landscape_Primary",t[t.Landscape_Secondary=90]="Landscape_Secondary"}(t.Orientation||(t.Orientation={}));var e=(t.Orientation,function(t){function e(){t.apply(this,arguments)}return __extends(e,t),Object.defineProperty(e.prototype,"orientation",{get:function(){var t=window.orientation;return t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"acceleration",{get:function(){return this._acceleration},set:function(t){this._acceleration=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"accelerationIncludingGravity",{get:function(){return this._accelerationIncludingGravity},set:function(t){this._accelerationIncludingGravity=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationRate",{get:function(){return this._rotationRate},set:function(t){this._rotationRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"absolute",{get:function(){return this._absolute},set:function(t){this._absolute=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this._alpha},set:function(t){this._alpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"beta",{get:function(){return this._beta},set:function(t){this._beta=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gamma",{get:function(){return this._gamma},set:function(t){this._gamma=t},enumerable:!0,configurable:!0}),e.ORIENTATION_CHANGE="onOrientationChange",e.DEVICE_MOTION="onDeviceMotion",e.DEVICE_ORIENTATION="onDeviceOrientation",e}(t.Event3D));t.OrientationEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.LOADER_COMPLETE="onLoadComplete",e.LOADER_PROGRESS="onLoadProgress",e.LOADER_ERROR="onLoadError",e}(t.Event3D);t.LoaderEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.PARSER_COMPLETE="onParserComplete",e}(t.Event3D);t.ParserEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments)}return __extends(e,t),e.EMIT_PARTICLE_BIRTH="EMIT_PARTICLE_BIRTH",e.EMIT_PARTICLE_DEATH="EMIT_PARTICLE_DEATH",e}(t.Event3D);t.ParticleEvent3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.listeners={}}return t.prototype.dispatchEvent=function(t){var e=this.listeners[t.eventType];if(null!=e){e=e.slice();for(var i=0;i<e.length;i++){var a=e[i];try{a.handler.call(a.thisObject,t)}catch(r){window.console&&console.error(r.stack)}}}},t.prototype.addEventListener=function(t,e,a,r){void 0===r&&(r=0),null==this.listeners[t]&&(this.listeners[t]=[]);var n=new i(t,a,e,r);return n.id=++i.event_id_count,this.listeners[t].push(n),this.listeners[t].sort(function(t,e){return e.priolity-t.priolity}),n.id},t.prototype.removeEventListener=function(t,e,i){if(this.hasEventListener(t,i,e))for(var a=0;a<this.listeners[t].length;a++){var r=this.listeners[t][a];if(r.equalCurrentListener(t,i,e))return r.handler=null,r.thisObject=null,void this.listeners[t].splice(a,1)}},t.prototype.removeEventListenerAt=function(t){for(var e in this.listeners)for(var i=0;i<this.listeners[e].length;i++){var a=this.listeners[e][i];if(a.id==t)return a.handler=null,a.thisObject=null,void this.listeners[e].splice(i,1)}},t.prototype.clearEventListener=function(){this.listeners={}},t.prototype.containEventListener=function(t){return null==this.listeners[t]?!1:this.listeners[t].length>0},t.prototype.hasEventListener=function(t,e,i){if(null==this.listeners[t])return!1;for(var a=0;a<this.listeners[t].length;a++){var r=this.listeners[t][a];if(r.equalCurrentListener(t,e,i))return!0}return!1},t}();t.EventDispatcher=e;var i=function(){function t(t,e,i,a){void 0===t&&(t=null),void 0===e&&(e=null),void 0===i&&(i=null),void 0===a&&(a=0),this.type=t,this.thisObject=e,this.handler=i,this.priolity=a}return t.prototype.equalCurrentListener=function(t,e,i){return this.type==t&&this.thisObject==e&&this.handler==i?!0:!1},t.event_id_count=0,t}()}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this._retRenderList=new Array,this._canvas=e,this._pickEvent3d=new t.PickEvent3D,t.Input.addEventListener(t.MouseEvent3D.MOUSE_CLICK,this.onMouseClick,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.onMouseDown,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.onMouseUp,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.onMouseMove,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.onTouchDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.onTouchUp,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.onTouchMove,this)}return Object.defineProperty(e.prototype,"_view3ds",{get:function(){return this._canvas.view3Ds},enumerable:!0,configurable:!0}),e.prototype.onClear=function(){this._canvas=null},e.prototype.onClearListeners=function(){},e.prototype.sendEvent=function(e,i,a){var r=this._canvas;if(r)for(var n=0;n<this._view3ds.length;n++){var o=this._view3ds[n];if(o.entityCollect&&o.entityCollect.mousePickList){var s=o.entityCollect.mousePickList,h=t.Picker.pickObject3DList(r,o,s,!1,this._retRenderList),l=h.length;if(!(0>=l)){for(var u=null,c=Number.MAX_VALUE,d=0,p=null,f=!1,_=0;l>_;_++)p=h[_],d=t.Vector3D.distance(p.globalPosition,o.camera3D.globalPosition),c>d&&(c=d,u=h[_]),p.mouseChilder&&(f=p.mouseChilder);if(h.length>0)if(1==h.length&&u)u.dispatchEvent(a.call(this,i,e,u));else if(f)if(h=t.Picker.pickObject3DList(r,o,h,!0,this._retRenderList),c=Number.MAX_VALUE,l=h.length,0>=l)u&&u.dispatchEvent(a.call(this,i,e,u));else{u=null;for(var _=0;l>_;_++)p=h[_],d=t.Vector3D.distance(p.globalPosition,o.camera3D.globalPosition),c>d&&(c=d,u=h[_]);u&&u.dispatchEvent(a.call(this,i,e,u))}else u&&u.dispatchEvent(a.call(this,i,e,u))}}}},e.prototype.initPickEvent3D=function(t,e,i){return this._pickEvent3d.eventType=t,this._pickEvent3d.target=i,this._pickEvent3d.data=e,this._pickEvent3d.pickResult=i.pickResult,this._pickEvent3d},e.prototype.onTouchMove=function(e){this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D)},e.prototype.onTouchUp=function(e){this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D)},e.prototype.onTouchDown=function(e){this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D)},e.prototype.onMouseClick=function(e){this.sendEvent(e,t.PickEvent3D.PICK_CLICK,this.initPickEvent3D)},e.prototype.onMouseDown=function(e){this.sendEvent(e,t.PickEvent3D.PICK_DOWN,this.initPickEvent3D)},e.prototype.onMouseUp=function(e){this.sendEvent(e,t.PickEvent3D.PICK_UP,this.initPickEvent3D)},e.prototype.onMouseMove=function(e){this.sendEvent(e,t.PickEvent3D.PICK_MOVE,this.initPickEvent3D)},e}();t.EventManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.index=0,this.shadersName=new Array,this.endShadername="",this.stateChange=!1,this.maxBone=0,this.shaderType=-1,this.shaderType=t}return e.prototype.addUseShaderName=function(t){this.shadersName.push(t)},e.prototype.addEndShaderName=function(t){this.endShadername=t},e.prototype.getShader=function(e){if(""!=this.endShadername){var i=this.shadersName.indexOf(this.endShadername);
-1==i&&this.shadersName.push(this.endShadername)}return t.ShaderUtil.instance.fillShaderContent(this,this.shadersName,e)},e}();t.ShaderBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.varName="",this.name="",this.key="",this.valueType="",this.value="",this.activeTextureIndex=-1,this.index=-1,this.level="",this.size=0,this.dataType=0,this.normalized=!1,this.stride=0,this.offset=0,this.offsetIndex=0,this.offsetBytes=0}return t.prototype["var"]=function(t){return this.level+" "+this.valueType+" "+name+"."+t},t.prototype.use=function(t){return void 0===t&&(t=""),""!=t?this.name+"."+t:this.name},t.prototype.clone=function(){var e=new t;return e.name=this.name,e.valueType=this.valueType,e.level=this.level,e.varName=this.varName,e.value=this.value,e},t.prototype.computeVarName=function(){var t=this.name.indexOf("[");t>=0?this.varName=this.name.substr(0,t):this.varName=this.name},t}();t.VarRegister=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="attribute",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Attribute=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t}();t.AttributeType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i,a){t.call(this),this.name=e,this.computeVarName(),this.key="const",this.valueType=i,this.value=a}return __extends(e,t),e}(t.VarRegister);t.ConstVar=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.name=e,this.computeVarName(),this.key="sampler2D"}return __extends(e,t),e}(t.VarRegister);t.Sampler2D=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.name=e,this.computeVarName(),this.key="samplerCube"}return __extends(e,t),e}(t.VarRegister);t.Sampler3D=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.TmpVar=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="uniform",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Uniform=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.bool="bool",t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.bvec2="bvec2",t.bvec3="bvec3",t.bvec4="bvec4",t.ivec2="ivec2",t.ivec3="ivec3",t.ivec4="ivec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t.sampler2D="sampler2D",t.sampleCube="sampleCube",t}();t.UniformType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.attribute_position="attribute_position",t.attribute_normal="attribute_normal",t.attribute_tangent="attribute_tangent",t.attribute_vertexColor="attribute_vertexColor",t.attribute_uv0="attribute_uv0",t.attribute_uv1="attribute_uv1",t.varying_pos="varying_pos",t.varying_normal="varying_normal",t.varying_tangent="varying_tangent",t.varying_color="varying_color",t.varying_uv0="varying_uv0",t.varying_uv1="varying_uv1",t.varying_globalPos="varying_globalPos",t.varying_lightDir="varying_lightDir",t.varying_eye="varying_eye",t.uniform_floatv_0="uniform_floatv_0",t.uniform_floatv_1="uniform_floatv_1",t.uniform_floatv_2="uniform_floatv_2",t.uniform_iv_0="uniform_iv_0",t.uniform_iv_1="uniform_iv_1",t.uniform_iv_2="uniform_iv_2",t.uniform_bv_0="uniform_bv_0",t.uniform_bv_1="uniform_bv_1",t.uniform_bv_2="uniform_bv_2",t.uniform_vec2fv_0="uniform_vec2fv_0",t.uniform_vec2fv_1="uniform_vec2fv_1",t.uniform_vec2fv_2="uniform_vec2fv_2",t.uniform_vec3fv_0="uniform_vec3fv_0",t.uniform_vec3fv_1="uniform_vec3fv_1",t.uniform_vec3fv_2="uniform_vec3fv_2",t.uniform_vec4fv_0="uniform_vec4fv_0",t.uniform_vec4fv_1="uniform_vec4fv_1",t.uniform_vec4fv_2="uniform_vec4fv_2",t.uniform_vec2iv_0="uniform_vec2iv_0",t.uniform_vec2iv_1="uniform_vec2iv_1",t.uniform_vec2iv_2="uniform_vec2iv_2",t.uniform_vec3iv_0="uniform_vec3iv_0",t.uniform_vec3iv_1="uniform_vec3iv_1",t.uniform_vec3iv_2="uniform_vec3iv_2",t.uniform_vec4iv_0="uniform_vec4iv_0",t.uniform_vec4iv_1="uniform_vec4iv_1",t.uniform_vec4iv_2="uniform_vec4iv_2",t.uniform_vec2bv_0="uniform_vec2bv_0",t.uniform_vec2bv_1="uniform_vec2bv_1",t.uniform_vec2bv_2="uniform_vec2bv_2",t.uniform_vec3bv_0="uniform_vec3bv_0",t.uniform_vec3bv_1="uniform_vec3bv_1",t.uniform_vec3bv_2="uniform_vec3bv_2",t.uniform_vec4bv_0="uniform_vec4bv_0",t.uniform_vec4bv_1="uniform_vec4bv_1",t.uniform_vec4bv_2="uniform_vec4bv_2",t.uniform_modelMatrix="uniform_modelMatrix",t.uniform_projectionMatrix="uniform_projectionMatrix",t.uniform_normalMatrix="uniform_normalMatrix",t.uniform_eye="uniform_eye",t.uniform_lightDir="uniform_lightDir",t.texture2D_0="texture2D_0",t.texture2D_1="texture2D_1",t.texture2D_2="texture2D_2",t.texture2D_3="texture2D_3",t.texture2D_4="texture2D_4",t}();t.VarConstName=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e,i){t.call(this),this.name=e,this.computeVarName(),this.key="varying",this.valueType=i}return __extends(e,t),e}(t.VarRegister);t.Varying=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(t){function e(e){t.call(this),this.name=e,this.computeVarName(),this.key="#extension"}return __extends(e,t),e}(t.VarRegister);t.Extension=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){}return t.bool="bool",t["int"]="int",t["float"]="float",t.vec2="vec2",t.vec3="vec3",t.vec4="vec4",t.bvec2="bvec2",t.bvec3="bvec3",t.bvec4="bvec4",t.ivec2="ivec2",t.ivec3="ivec3",t.ivec4="ivec4",t.mat2="mat2",t.mat3="mat3",t.mat4="mat4",t.sampler2D="sampler2D",t.sampleCube="sampleCube",t}();t.VaryingType=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.lib={alphaMask_fs:"uniform sampler2D maskTexture ; \nvoid main(void){ \nfloat maskAlpha = texture2D( maskTexture , uv_0 ).x; \nif(maskAlpha * diffuseColor.w < 0.001){ \ndiscard; \n} \nmaterialSource.alpha *= maskAlpha; \n} \n",AOMap_fs:"uniform sampler2D aoTexture ; \nuniform float aoPower ; \nvoid main(void){ \nfloat ao = texture2D( aoTexture , varying_uv1 ).x ; \ndiffuseColor.xyz *= (ao * aoPower) ; \n} \n",baseShadowPass_fs:"varying vec2 varying_uv0; \nvarying vec4 varying_ViewPose; \nvarying vec4 varying_color; \nvec4 outColor ; \nvec2 uv_0; \nvoid main() { \nuv_0 = varying_uv0; \n} \n",baseShadowPass_vs:"attribute vec3 attribute_position; \nattribute vec2 attribute_uv0; \nattribute vec4 attribute_color; \nuniform mat4 uniform_ModelViewMatrix ; \nuniform mat4 uniform_ProjectionMatrix ; \nvarying vec4 varying_ViewPose; \nvarying vec2 varying_uv0; \nvarying vec4 varying_color; \nvec3 e_position = vec3(0.0, 0.0, 0.0); \nvec4 outPosition ; \nvoid main(void){ \ne_position = attribute_position; \nvarying_color = attribute_color; \nvarying_uv0 = attribute_uv0; \n} \n",base_fs:"#extension GL_OES_standard_derivatives : enable \nvarying vec3 varying_eyeNormal  ; \nvarying vec2 varying_uv0; \nvarying vec4 varying_ViewPose; \nvarying vec4 varying_color; \nvarying vec3 varying_ViewDir ; \nuniform mat4 uniform_ViewMatrix ; \nvec4 outColor ; \nvec4 diffuseColor ; \nvec4 specularColor ; \nvec4 ambientColor; \nvec4 light ; \nvec3 normal; \nvec2 uv_0; \nvec3 flatNormals(vec3 pos) { \nvec3 fdx = dFdx(pos); \nvec3 fdy = dFdy(pos); \nreturn normalize(cross(fdx, fdy)); \n} \nvoid main() { \ndiffuseColor  = vec4(1.0,1.0,1.0,1.0); \nspecularColor = vec4(0.0,0.0,0.0,0.0); \nambientColor  = vec4(0.0,0.0,0.0,0.0); \nlight         = vec4(1.0,1.0,1.0,1.0); \nnormal = normalize(varying_eyeNormal) ; \nuv_0 = varying_uv0; \n} \n",base_vs:"attribute vec3 attribute_position; \nattribute vec3 attribute_normal; \nattribute vec4 attribute_color; \nattribute vec2 attribute_uv0; \nvec3 e_position = vec3(0.0, 0.0, 0.0); \nuniform mat4 uniform_ModelViewMatrix ; \nuniform mat4 uniform_ProjectionMatrix ; \nuniform vec3 uniform_eyepos ; \nvarying vec4 varying_ViewPose; \nvarying vec3 varying_eyeNormal  ; \nvarying vec2 varying_uv0; \nvarying vec4 varying_color; \nvarying vec3 varying_ViewDir ; \nvec4 outPosition ; \nvoid main(void){ \ne_position = attribute_position; \nvarying_color = attribute_color; \nvarying_uv0 = attribute_uv0; \n} \n",bezier:"vec2 quadratic_bezier(vec2 A, vec2 B, vec2 C, float t) \n{ \nvec2 D = mix(A, B, t); \nvec2 E = mix(B, C, t); \nreturn mix(D, E, t); \n} \nvec2 cubic_bezier(vec2 A, vec2 B, vec2 C, vec2 D, float t) \n{ \nvec2 E = mix(A, B, t); \nvec2 F = mix(B, C, t); \nvec2 G = mix(C, D, t); \nreturn quadratic_bezier(E, F, G, t); \n} \n",bloom_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nvoid main() \n{ \nvec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y); \nfloat dx = 1.0/float(1024.0); \nfloat dy = 1.0/float(1024.0); \nvec4 outColor ; \nvec4 color = outColor = texture2D(diffuseTexture,uv.xy); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(dx*3.0,0.0)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(0.0,dy)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(dx*3.0,dy)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(0.0,dy*2.0)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(dx*3.0,dy*2.0)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(0.0,dy*3.0)); \ncolor += texture2D(diffuseTexture,uv.xy+vec2(dx*3.0,dy*3.0)); \ncolor /= 8.0; \nvec4 cout = vec4(0.0,0.0,0.0,0.0); \nfloat lum = color.x * 0.3 + color.y *0.59 + color.z * 0.11; \nvec4 p = color*(lum/0.1); \np /= vec4(vec4(1.0,1.0,1.0,0.0)+p); \nfloat luml = (p.x+p.y+p.z)/3.0; \nif (luml > 0.8) \n{ \ncout = color ; \n} \ngl_FragColor = cout ; \n} \n",colorGradients_fs:"varying vec4 varying_pos; \nuniform float uniform_colorGradientsSource[10] ; \nvoid main(void){ \nvec3 posStart = vec3(uniform_colorGradientsSource[0], uniform_colorGradientsSource[1], uniform_colorGradientsSource[2]); \nvec3 posEnd = vec3(uniform_colorGradientsSource[3], uniform_colorGradientsSource[4], uniform_colorGradientsSource[5]); \nvec4 color = vec4(uniform_colorGradientsSource[6], uniform_colorGradientsSource[7], uniform_colorGradientsSource[8], uniform_colorGradientsSource[9]); \ncolor.w = color.w * clamp((varying_pos.y - posStart.y) / (posEnd.y - posStart.y), 0.0, 1.0); \ndiffuseColor.xyz = clamp(diffuseColor.xyz / diffuseColor.w,0.0,1.0); \ndiffuseColor.xyz = diffuseColor.xyz * (1.0 - color.w) + color.xyz * color.w; \n} \n  \n",colorTransform_fs:"uniform vec4 uniform_colorTransformVec4 ; \nuniform mat4 uniform_colorTransformM44 ; \nvoid main(){ \ndiffuseColor = uniform_colorTransformM44 * diffuseColor; \ndiffuseColor = diffuseColor + uniform_colorTransformVec4; \n} \n",color_fragment:"vec4 diffuseColor ; \nvoid main() { \nif( diffuseColor.w == 0.0 ){ \ndiscard; \n} \ndiffuseColor = vec4(1.0, 1.0, 1.0, 1.0); \nif( diffuseColor.w <= materialSource.cutAlpha ){ \ndiscard; \n}else \ndiffuseColor.xyz *= diffuseColor.w ; \n} \n",combin_fs:"uniform sampler2D colorTexture; \nvoid main(void){ \n} \n",cube_fragment:"uniform samplerCube diffuseTexture ; \nvarying vec3 varying_pos; \nvec4 diffuseColor ; \nvoid main() { \nif( diffuseColor.w == 0.0 ){ \ndiscard; \n} \nvec3 uvw = normalize(varying_pos.xyz); \ndiffuseColor = vec4(textureCube(diffuseTexture, uvw.xyz)); \nif( diffuseColor.w <= materialSource.cutAlpha ){ \ndiscard; \n}else \ndiffuseColor.xyz *= diffuseColor.w ; \n} \n",cube_vertex:"varying vec3 varying_pos; \nvoid main(void){ \nvarying_pos =  e_position; \n}  \n",detail_Bending_vs:"uniform float uniformTime[4] ; \nvoid main(void){ \ne_position = attribute_position; \nvarying_uv0 = attribute_uv0; \nvarying_color = attribute_color; \nvec4 curve = SmoothTriangleWave(vec4(sin(uniformTime[0]*0.001),1.0,1.0,1.0)); \ne_position.xyz += curve.x * vec3(1.0,0.5,0.0) * ( attribute_color.xyz) ; \n} \n",diffuseShadowPass_fs:"uniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvoid main() { \ndiffuseColor = varying_color ; \nif( diffuseColor.w == 0.0 ){ \ndiscard; \n} \ndiffuseColor = texture2D(diffuseTexture , uv_0 ); \nif( diffuseColor.w <= 0.3 ){ \ndiscard; \n} \n} \n",diffuse_fragment:"uniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvoid main() { \ndiffuseColor = texture2D(diffuseTexture , uv_0 ); \nif( diffuseColor.w <= materialSource.cutAlpha ){ \ndiscard; \n} \n} \n",diffuse_vertex:"attribute vec3 attribute_normal; \nattribute vec4 attribute_color; \nvarying vec3 varying_ViewDir ; \nuniform mat4 uniform_NormalMatrix; \nvoid main(void){ \nmat3 normalMatrix = mat3(uniform_NormalMatrix); \nvarying_eyeNormal = normalize(normalMatrix * -attribute_normal); \nvarying_ViewPose = vec4(normalMatrix*e_position, 1.0) ; \nvarying_ViewDir = normalize(normalMatrix * (uniform_eyepos.xyz - e_position)) ; \noutPosition = uniform_ModelViewMatrix * vec4(e_position, 1.0) ; \nvarying_color = attribute_color; \n} \n",directLight_fragment:"const int max_directLight = 0 ; \nuniform float uniform_directLightSource[6*max_directLight] ; \nvarying vec3 varying_ViewDir; \nuniform mat4 uniform_NormalMatrix; \nstruct DirectLight{ \nvec3 direction; \nvec3 diffuse; \n}; \nvoid calculateDirectLight( MaterialSource materialSource ){ \nfloat lambertTerm , specular ; \nvec3 N = normal; \nfor(int i = 0 ; i < max_directLight ; i++){ \nDirectLight directLight ; \ndirectLight.direction = vec3(uniform_directLightSource[i*6+0],uniform_directLightSource[i*6+1],uniform_directLightSource[i*6+2]); \ndirectLight.diffuse = vec3(uniform_directLightSource[i*6+3],uniform_directLightSource[i*6+4],uniform_directLightSource[i*6+5]); \nvec3 lightDir = -normalize(directLight.direction); \nlight += LightingBlinnPhong(normalize(lightDir),vec3(1.0,1.0,1.0),normal,-varying_ViewDir,0.5); \n} \n} \nvoid main() { \ncalculateDirectLight( materialSource ); \n} \n",endShadowPass_fs:"void main() { \nif(varying_color.w<=0.0){ \ndiscard; \n} \noutColor.x =  outColor.y = outColor.z = varying_ViewPose.z/varying_ViewPose.w  ; \noutColor.w = 1.0 ; \ngl_FragColor = outColor ; \n} \n",endShadowPass_vs:"void main() { \noutPosition = uniform_ProjectionMatrix * outPosition ; \nvarying_ViewPose = outPosition ; \ngl_Position = outPosition ; \n} \n                       \n",end_fs:"vec4 diffuseColor ; \nvec4 specularColor ; \nvec4 ambientColor; \nvec4 light ; \nvoid main() { \noutColor.xyz = light.xyz * diffuseColor.xyz * materialSource.diffuse * varying_color.xyz; \noutColor.w = materialSource.alpha * diffuseColor.w * varying_color.w; \noutColor.xyz *= outColor.w; \ngl_FragColor = outColor; \n} \n",end_vs:"vec4 endPosition ; \nuniform float uniform_materialSource[20]; \nvoid main() { \ngl_PointSize = 50.0; \ngl_PointSize = uniform_materialSource[18]; \ngl_Position = uniform_ProjectionMatrix * outPosition ; \n} \n                       \n",environmentDiffuse_vertex:"void main(){ \n} \n",environmentMapping_fragment:"uniform samplerCube environmentMapTex ; \nuniform float reflectValue; \nvoid main(){ \nvec3 r = reflect(-normalize(varying_ViewDir),  normal  ); \nvec4 reflectiveColor = textureCube(environmentMapTex,r.xyz); \ndiffuseColor.xyz = mix( diffuseColor.xyz,reflectiveColor.xyz, specularColor.y + reflectValue ); \n} \n          \n",expFog_fs:"struct Fog{ \nvec3 fogColor  ; \nfloat globalDensity ; \nvec3 distance ; \n}; \nvarying vec4 varying_pos; \nuniform float uniform_globalFog[7]; \nvoid main(void){ \nFog fog; \nfog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \nfog.globalDensity = uniform_globalFog[3]; \nfog.distance = vec2(uniform_globalFog[4], uniform_globalFog[5]); \nfloat d = distance(uniform_eyepos,varying_pos.xyz); \nfloat distFog = max( 0.0 , d - fog.distance.x )* fog.distance.y; \nfloat fogFactor = (1.0-exp( -distFog * 0.000001 * fog.globalDensity )) ; \ndiffuseColor.xyz = mix( diffuseColor.xyz  , fog.fogColor , min(fogFactor,1.0) ); \n} \n  \n",expHeightFog_fs:"struct Fog{ \nvec3 fogColor  ; \nfloat globalDensity ; \nfloat fogStartDistance ; \nfloat fogHeightStart ; \nfloat fogAlpha ; \n}; \nvarying vec4 varying_pos; \nuniform float uniform_globalFog[7]; \nvec3 applyFog( float yDistance, vec3  vpos , Fog fog ) \n{ \nfloat d = distance(uniform_eyepos,varying_pos.xyz); \nfloat distFog = max( 0.0 , d - fog.fogStartDistance ) ; \nfloat yFog = max(0.0, (vpos.y - fog.fogHeightStart - yDistance) )  ; \nfloat fogAmount =  1.0-(exp(-distFog * fog.globalDensity )) + (exp(-yFog * fog.globalDensity )); \nreturn mix( diffuseColor.xyz,fog.fogColor, clamp(fogAmount,0.0,fog.fogAlpha) ); \n} \nvoid main(void){ \nFog fog; \nfog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \nfog.globalDensity = uniform_globalFog[3]; \nfog.fogStartDistance = uniform_globalFog[4] ; \nfog.fogHeightStart = uniform_globalFog[5] ; \nfog.fogAlpha = uniform_globalFog[6] ; \nfloat yd = uniform_eyepos.y - varying_pos.y ; \ndiffuseColor.xyz = applyFog( yd , varying_pos.xyz , fog ); \n} \n  \n",flatNormal_fs:"#extension GL_OES_standard_derivatives : enable \nvec3 flatNormal(vec3 pos){ \nvec3 fdx = dFdx(pos); \nvec3 fdy = dFdy(pos); \nreturn normalize(cross(fdx, fdy)); \n} \n",gamma_fs:"const float gamma = 2.2; \nfloat toLinear_float_v1(float v) { \nreturn pow(v, gamma); \n} \nvec2 toLinear_vec2_v1(vec2 v) { \nreturn pow(v, vec2(gamma)); \n} \nvec3 toLinear_vec3_v1(vec3 v) { \nreturn pow(v, vec3(gamma)); \n} \nvec4 toLinear_vec4_v1(vec4 v) { \nreturn vec4(toLinear_vec3_v1(v.rgb), v.a); \n} \nfloat toGamma_float_v2(float v) { \nreturn pow(v, 1.0 / gamma); \n} \nvec2 toGamma_vec2_v2(vec2 v) { \nreturn pow(v, vec2(1.0 / gamma)); \n} \nvec3 toGamma_vec3_v2(vec3 v) { \nreturn pow(v, vec3(1.0 / gamma)); \n} \nvec4 toGamma_vec4_v2(vec4 v) { \nreturn vec4(toGamma_vec3_v2(v.rgb), v.a); \n} \nvec4 textureLinear(sampler2D uTex, vec2 uv) { \nreturn toLinear_vec4_v1(texture2D(uTex, uv)); \n} \n",gaussian_H_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nvoid main() \n{ \nvec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y); \nfloat d = 1.0/float(1024.0); \nvec4 color = vec4(0.0,0.0,0.0,0.0); \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-8.0*d,0.0))* 0.001; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-7.0*d,0.0))* 0.105; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-6.0*d,0.0))* 0.217; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-5.0*d,0.0))* 0.344; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-4.0*d,0.0))* 0.492; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-3.0*d,0.0))* 0.55; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-2.0*d,0.0))* 0.69; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(-1.0*d,0.0))* 0.70; \ncolor +=     texture2D(diffuseTexture,uv.xy) * 1.0; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(1.0*d,0.0)) * 0.70; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(2.0*d,0.0)) * 0.69; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(3.0*d,0.0)) * 0.55; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(4.0*d,0.0)) * 0.492; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(5.0*d,0.0)) * 0.344; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(6.0*d,0.0)) * 0.217; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(7.0*d,0.0)) * 0.105; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(8.0*d,0.0)) * 0.001; \ncolor /= 8.0; \ngl_FragColor = color ; \n} \n",gaussian_V_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nuniform sampler2D colorTexture; \nvoid main() \n{ \nvec2 uv = vec2(varying_uv0.x,1.0-varying_uv0.y); \nfloat d = 1.0/float(1024.0); \nvec4 color = vec4(0.0,0.0,0.0,0.0); \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-8.0*d)) * 0.001; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-7.0*d)) * 0.105; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-6.0*d)) * 0.217; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-5.0*d)) * 0.344; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-4.0*d)) * 0.492; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-3.0*d)) * 0.55; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-2.0*d)) * 0.69; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0,-1.0*d)) * 0.70; \ncolor +=     texture2D(diffuseTexture,uv.xy) * 1.0; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 1.0*d)) * 0.70; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 2.0*d)) * 0.69; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 3.0*d)) * 0.55; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 4.0*d)) * 0.492; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 5.0*d)) * 0.344; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 6.0*d)) * 0.217; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 7.0*d)) * 0.105; \ncolor +=     texture2D(diffuseTexture,uv.xy+vec2(0.0, 8.0*d)) * 0.001; \ncolor /= 8.0; \ngl_FragColor = color + texture2D(colorTexture,uv.xy); \n} \n",hud_cull_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nuniform vec2 uv_scale; \nvoid main(void) { \nvec2 uv_0 = varying_uv0; \nuv_0 *= uv_scale; \nvec4 color = texture2D(diffuseTexture, varying_uv0); \nfloat mask = 1.0; \nfloat f = uv_scale.y - varying_uv0.y; \nif (varying_uv0.y < uv_scale.y){ \nif(f < 0.03 && f > 0.0){ \nmask =1.0 - (f / 0.03 * 0.9 + 0.1); \n} \nelse{ \nmask = 0.1; \n} \n} \ncolor.xyz *= mask; \ngl_FragColor  = color; \n} \n",hud_H_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nvoid main(void) { \nvec2 uv = vec2(varying_uv0.x ,1.0-varying_uv0.y); \nvec4 color = texture2D(diffuseTexture, uv); \ngl_FragColor  = color; \n} \n",hud_vs:"attribute vec3 attribute_position; \nattribute vec2 attribute_uv0; \nvarying  vec2 varying_uv0; \nuniform  mat4 uniform_ViewProjectionMatrix; \nvoid main(void) { \nvec4 pos = vec4(attribute_position, 1.0); \ngl_Position = uniform_ViewProjectionMatrix * pos; \nvarying_uv0 = attribute_uv0; \n} \n",hud_V_fs:"varying vec2 varying_uv0; \nuniform sampler2D diffuseTexture; \nvoid main(void) { \nvec4 color = texture2D(diffuseTexture, varying_uv0); \ngl_FragColor  = color; \n} \n",lightingBase_fs:"vec4 LightingBlinnPhong(vec3 lightDir, vec3 lightColor , vec3 normal , vec3 viewDir, float atten){ \nvec3 ambient = materialSource.ambient ; \nfloat NdotL = clamp(dot (normal, lightDir),0.0,1.0); \nvec3 diffuse = lightColor.xyz * NdotL ; \nvec3 h = normalize (lightDir + normalize(viewDir)); \nfloat nh = clamp(dot (normal, h),0.0,1.0); \nfloat specPower = pow (nh, materialSource.shininess ) * materialSource.specularScale ; \nvec3 specular = lightColor.xyz * specPower * materialSource.specular ; \nspecularColor.xyz += specular; \nvec4 c; \nc.rgb = (diffuse+specular+ambient) * (atten * 2.0 ); \nc.a = materialSource.alpha + (specPower * atten); \nreturn c; \n} \nvoid main(void) { \nlight.xyzw = vec4(0.0,0.0,0.0,1.0) ; \n} \n",lightMapSpecularPower_fs:"uniform sampler2D lightTexture ; \nvarying vec2 varying_uv1 ; \nvec4 decode_hdr( vec4 data ){ \nvec4 res = data ; \nres.xyz *= pow(2.0,data.w * 256.0 - 128.0); \nreturn res ; \n} \nvoid main(void){ \nvec4 lightmap = texture2D( lightTexture , varying_uv1 ); \nlightmap.xyz = decode_hdr(lightmap).xyz; \nlightmap.xyz = pow( 1.0 * lightmap.xyz, vec3(0.80)) ; \ndiffuseColor.xyz *= lightmap.xyz ; \nspecularColor.xyz *= lightmap.xyz ; \n} \n",lightMap_fs:"uniform sampler2D lightTexture ; \nvarying vec2 varying_uv1 ; \nvec4 decode_hdr( vec4 data ){ \nvec4 res = data ; \nres.xyz *= pow(2.0,data.w * 256.0 - 128.0); \nreturn res ; \n} \nvoid main(void){ \nvec4 lightmap = texture2D( lightTexture , varying_uv1 ); \nlightmap.xyz = decode_hdr(lightmap).xyz; \nlightmap.xyz = pow( 1.0 * lightmap.xyz, vec3(0.80)) ; \ndiffuseColor.xyz *= lightmap.xyz ; \n} \n",lineFog:"struct Fog{ \nvec3 fogColor  ; \nfloat globalDensity ; \nfloat fogStartDistance ; \nfloat fogFarDistance ; \nfloat fogAlpha ; \n}; \nvarying vec4 varying_pos; \nuniform float uniform_globalFog[7]; \nvoid main(void){ \nFog fog; \nfog.fogColor = vec3(uniform_globalFog[0],uniform_globalFog[1],uniform_globalFog[2]); \nfog.globalDensity = uniform_globalFog[3]; \nfog.fogStartDistance = uniform_globalFog[4] ; \nfog.fogFarDistance = uniform_globalFog[5] ; \nfog.fogAlpha = uniform_globalFog[6] ; \nfloat d = varying_pos.z ; \nfloat distFog = max( 0.0 , d -  fog.fogStartDistance ) ; \ndiffuseColor.xyz = mix( diffuseColor.xyz,fog.fogColor, clamp(distFog/fog.fogFarDistance,0.0,1.0) * fog.fogAlpha ) ; \n} \n",matCapPass_vs:"varying vec2 capCoord ; \nvoid main(void){ \ncapCoord.x = dot(normalMatrix[0].xyz,normal); \ncapCoord.y = dot(normalMatrix[1].xyz,normal); \ncapCoord = capCoord * 0.5 + 0.5; \nambientColor.xyz +=  + capCoord.xyz * 2.0 - 1.0 ; \n} \n",matCap_TextureAdd_fs:"uniform sampler2D matcapTexture; \nuniform mat4 uniform_NormalMatrix; \nvoid main() { \nvec4 capCoord ; \ncapCoord.x = -normal.x; \ncapCoord.y = normal.y; \ncapCoord.xy = capCoord.xy * 0.5 + 0.5; \ncapCoord = texture2D(matcapTexture , capCoord.xy ) * 2.0 - 1.0 ; \nambientColor.xyz += capCoord.xyz ; \n} \n",matCap_TextureMult_fs:"uniform sampler2D matcapTexture; \nuniform mat4 uniform_NormalMatrix; \nvoid main() { \nvec4 capCoord ; \ncapCoord.x = -normal.x; \ncapCoord.y = normal.y; \ncapCoord.xy = capCoord.xy * 0.5 + 0.5; \ncapCoord = texture2D(matcapTexture , capCoord.xy ) ; \ndiffuseColor.xyz *= capCoord.xyz * 2.0 ; \n} \n",materialSource_fs:"struct MaterialSource{ \nvec3 diffuse; \nvec3 ambient; \nvec3 specular; \nfloat alpha; \nfloat cutAlpha; \nfloat shininess; \nfloat roughness; \nfloat albedo; \nvec4 uvRectangle; \nfloat specularScale; \nfloat normalScale; \n}; \nuniform float uniform_materialSource[20] ; \nMaterialSource materialSource ; \nvoid main(){ \nmaterialSource.diffuse.x = uniform_materialSource[0]; \nmaterialSource.diffuse.y = uniform_materialSource[1]; \nmaterialSource.diffuse.z = uniform_materialSource[2]; \nmaterialSource.ambient.x = uniform_materialSource[3]; \nmaterialSource.ambient.y = uniform_materialSource[4]; \nmaterialSource.ambient.z = uniform_materialSource[5]; \nmaterialSource.specular.x = uniform_materialSource[6]; \nmaterialSource.specular.y = uniform_materialSource[7]; \nmaterialSource.specular.z = uniform_materialSource[8]; \nmaterialSource.alpha = uniform_materialSource[9]; \nmaterialSource.cutAlpha = uniform_materialSource[10]; \nmaterialSource.shininess = uniform_materialSource[11]; \nmaterialSource.specularScale = uniform_materialSource[12]; \nmaterialSource.albedo = uniform_materialSource[13]; \nmaterialSource.uvRectangle.x = uniform_materialSource[14]; \nmaterialSource.uvRectangle.y = uniform_materialSource[15]; \nmaterialSource.uvRectangle.z = uniform_materialSource[16]; \nmaterialSource.uvRectangle.w = uniform_materialSource[17]; \nmaterialSource.normalScale = uniform_materialSource[19]; \nuv_0 = varying_uv0.xy * materialSource.uvRectangle.zw + materialSource.uvRectangle.xy ; \n} \n",mulUvRoll_fs:"uniform float mulUvRoll[4] ; \nuniform sampler2D diffuseTexture; \nuniform sampler2D diffuseTexture1; \nvec4 diffuseColor ; \nvec2 uv_1; \nvoid main() { \nuv_1 = varying_uv0; \nuv_0.xy += vec2(mulUvRoll[0],mulUvRoll[1]); \nuv_1.xy += vec2(mulUvRoll[2],mulUvRoll[3]); \ndiffuseColor = texture2D(diffuseTexture , uv_0 ) * texture2D(diffuseTexture1 , uv_1 ); \ndiffuseColor.xyz = clamp(diffuseColor.xyz / diffuseColor.w,0.0,1.0); \n} \n",normalMap_fragment:"uniform sampler2D normalTexture; \nvarying vec2 varying_uv0        ; \nmat3 TBN ; \nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \nvec3 dp1 = dFdx(p); \nvec3 dp2 = dFdy(p); \nvec2 duv1 = dFdx(uv); \nvec2 duv2 = dFdy(uv); \nvec3 dp2perp = cross(dp2, N); \nvec3 dp1perp = cross(N, dp1); \nvec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \nvec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \nfloat invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \nreturn mat3(T * invmax, B * invmax, N); \n} \nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) { \nmat3 TBN = cotangentFrame(N, -V, texcoord); \nreturn normalize(TBN * map); \n} \nvoid main(){ \nvec3 normalTex = texture2D(normalTexture,uv_0).xyz *2.0 - 1.0; \nnormalTex.y *= -1.0; \nnormal.xyz = tbn( normalTex.xyz , normal.xyz , normalize(varying_ViewPose.xyz) , uv_0 ) ; \n} \n",particle_bezier:"vec2 bzData[20]; \nconst float Tiny = 0.0001; \nvoid dcpBezier(float bezierData[22], float tTotal) \n{ \nfloat timeNow = 0.0; \nfloat time1 = bezierData[20] * tTotal; \nfloat time2 = bezierData[21] * tTotal; \nfor(int i = 0; i < 20; i ++){ \nbzData[i].x = timeNow; \nbzData[i].y = bezierData[i]; \nif(i <= 9){ \ntimeNow += time1; \n}else if(i >= 11){ \ntimeNow += time2; \n} \n} \nbzData[10].x = bzData[9].x; \n} \nfloat calcBezierArea(float tCurrent){ \nfloat res = 0.0; \nfloat v0; \nfloat v1; \nfloat t0; \nfloat t1; \nfloat deltaTime = 0.0; \nfloat a_deltaTime; \nfor(int i = 0; i < 19; i ++){ \nv0 = bzData[i].y; \nv1 = bzData[i + 1].y; \nt0 = bzData[i].x; \nt1 = bzData[i + 1].x; \ndeltaTime = t1 - t0; \nif(deltaTime > Tiny) \n{ \na_deltaTime = 0.5 * (v1 - v0); \nif(tCurrent >= t1){ \nres += deltaTime * (v0 + a_deltaTime); \n}else{ \ndeltaTime = tCurrent - t0; \nres += deltaTime * (v0 + a_deltaTime); \nbreak; \n} \n} \n} \nreturn res; \n} \nfloat calcOneBezierArea(float bezierData[22], float tCurrent, float tTotal){ \ndcpBezier(bezierData, tTotal); \nreturn calcBezierArea(tCurrent); \n} \nfloat calcBezierSize(float tCurrent){ \nfloat res = 0.0; \nfloat y0; \nfloat y1; \nfloat t0; \nfloat t1; \nfloat deltaTime = 0.0; \nfloat v; \nfor(int i = 0; i < 19; i ++){ \ny0 = bzData[i].y; \ny1 = bzData[i + 1].y; \nt0 = bzData[i].x; \nt1 = bzData[i + 1].x; \ndeltaTime = t1 - t0; \nif(deltaTime > Tiny) \n{ \nif(tCurrent <= t1){ \nv = (y1 - y0) / deltaTime; \ndeltaTime = tCurrent - t0; \nres = y0 + v * deltaTime; \nbreak; \n} \n} \n} \nreturn res; \n} \nfloat calcOneBezierSize(float bezierData[22], float tCurrent, float tTotal){ \ndcpBezier(bezierData, tTotal); \nreturn calcBezierSize(tCurrent); \n} \n",particle_color_fs:"uniform float uniform_colorTransform[40]; \nvec3 unpack_color(float rgb_data) \n{ \nvec3 res; \nres.z = fract( rgb_data ); \nrgb_data -= res.z; \nrgb_data = rgb_data/256.0; \nres.y = fract( rgb_data ); \nrgb_data -= res.y; \nres.x = rgb_data/256.0; \nreturn res; \n} \nvoid main() { \nfloat startColor ; \nfloat startSegment ; \nfloat nextColor ; \nfloat nextSegment ; \nfloat startAlpha; \nfloat nextAlpha; \nfloat progress = varying_particleData.x/varying_particleData.y; \nconst int maxColorCount = 20; \nfor( int i = 1 ; i < maxColorCount ; i++ ){ \nif( progress >= fract(uniform_colorTransform[i+maxColorCount-1]) ){ \nstartColor = uniform_colorTransform[i-1] ; \nstartSegment = fract(uniform_colorTransform[i+maxColorCount-1]) ; \nnextColor = uniform_colorTransform[i]; \nnextSegment = fract(uniform_colorTransform[i+maxColorCount]) ; \nstartAlpha = uniform_colorTransform[i+maxColorCount-1] - startSegment; \nnextAlpha = uniform_colorTransform[i+maxColorCount] - nextSegment; \n}else{ \nbreak; \n} \n} \nfloat len = nextSegment - startSegment ; \nfloat ws = ( progress - startSegment ) / len ; \nglobalColor = mix(vec4(unpack_color(startColor).xyz,startAlpha / 256.0),vec4(unpack_color(nextColor).xyz, nextAlpha / 256.0),ws) ; \nglobalColor.w = clamp(globalColor.w,0.0,1.0); \n} \n",particle_color_vs:"float particle(  ParticleData curParticle ){ \n} \n",particle_diffuse_fragment:"uniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvec4 globalColor = vec4(1.0, 1.0, 1.0, 1.0); \nvoid calcUVCoord(){ \n} \nvoid main() { \nif( diffuseColor.w == 0.0 ){ \ndiscard; \n} \ncalcUVCoord(); \ndiffuseColor = texture2D(diffuseTexture , uv_0 ); \nif( diffuseColor.w <= materialSource.cutAlpha ){ \ndiscard; \n} \n} \n",particle_end:"float particle( ParticleData curParticle ){ \nreturn 1.0 ; \n} \nmat4 buildModelMatrix(vec4 quat, vec3 scale, vec3 position) \n{ \nmat4 ret = mat4( \nvec4(scale.x, 0.0, 0.0, 0.0), \nvec4(0.0, scale.y, 0.0, 0.0), \nvec4(0.0, 0.0, scale.z, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n); \nret = buildMat4Quat(quat) * ret; \nret[3][0] = position.x; \nret[3][1] = position.y; \nret[3][2] = position.z; \nreturn ret; \n} \nvec3 calcParticleMove(vec3 distanceXYZ){ \nif(velocityLimitVec2.y > TrueOrFalse){ \nvec3 temp = distanceXYZ * distanceXYZ; \nfloat distanceCurrent = sqrt(temp.x + temp.y + temp.z); \nfloat distanceLimit = velocityLimitVec2.x; \nif(distanceLimit < 0.0001){ \nreturn vec3(0.0); \n} \nif(distanceCurrent > distanceLimit){ \ndistanceXYZ *= distanceLimit / distanceCurrent; \n} \n} \nreturn distanceXYZ; \n} \nmat4 getRenderModeMatrix(mat4 cameraMatrix, mat4 modelMatrix){ \nreturn cameraMatrix; \n} \nvoid updateStretchedBillBoard(vec4 startPos, vec4 newPos){ \n} \nvoid main(void) { \nif(discard_particle > TrueOrFalse){ \noutPosition = vec4(0.0,0.0,0.0,0.0); \n}else{ \nvec3 position_emitter = attribute_offsetPosition; \nvec3 velocityLocalVec3 = velocityBaseVec3 * currentTime; \nvec3 velocityWorldVec3 = vec3(0.0,0.0,0.0); \nvec3 velocityMultiVec3 = vec3(0.0,0.0,0.0); \nif(particleStateData.velocityOverWorldSpace < TrueOrFalse){ \nvelocityLocalVec3 += velocityOverVec3; \n}else{ \nvelocityWorldVec3 += velocityOverVec3; \n} \nif(particleStateData.velocityForceWorldSpace < TrueOrFalse){ \nvelocityLocalVec3 += velocityForceVec3; \n}else{ \nvelocityWorldVec3 += velocityForceVec3; \n} \nif(particleStateData.worldSpace > TrueOrFalse){ \n}else{ \nfollowTargetPosition.x = particleStateData.positionX; \nfollowTargetPosition.y = particleStateData.positionY; \nfollowTargetPosition.z = particleStateData.positionZ; \nfollowTargetRotation.x = particleStateData.rotationX; \nfollowTargetRotation.y = particleStateData.rotationY; \nfollowTargetRotation.z = particleStateData.rotationZ; \nfollowTargetRotation.w = particleStateData.rotationW; \n} \nmat4 followRotQuat = buildMat4Quat(followTargetRotation); \nvelocityLocalVec3 = (followRotQuat * vec4(velocityLocalVec3, 1.0)).xyz; \nmat4 modelMatrix = buildModelMatrix(followTargetRotation, followTargetScale, followTargetPosition); \nposition_emitter = (modelMatrix * vec4(position_emitter, 1.0)).xyz; \nvelocityMultiVec3 = velocityLocalVec3 + velocityWorldVec3; \nvelocityMultiVec3 = calcParticleMove(velocityMultiVec3); \nvelocityMultiVec3.y -= 4.9 * currentTime * currentTime * particleStateData.gravity; \nvec3 origPosition = position_emitter; \nposition_emitter += velocityMultiVec3; \nupdateStretchedBillBoard(vec4(origPosition, 1.0), vec4(position_emitter, 1.0)); \nmat4 billboardMatrix = getRenderModeMatrix(uniform_cameraMatrix, modelMatrix); \noutPosition = billboardMatrix * localPosition; \noutPosition.xyz += position_emitter.xyz; \noutPosition = uniform_ViewMatrix * outPosition; \n} \nvarying_posZ = outPosition.z; \ngl_Position = uniform_ProjectionMatrix * outPosition ; \n} \n	 \n",particle_end_fs:"uniform float uniform_particleFsData[3]; \nvoid main() { \nfloat blendMode = uniform_particleFsData[2]; \noutColor.xyz = diffuseColor.xyz * materialSource.diffuse * varying_color.xyz * globalColor.xyz; \noutColor.w = materialSource.alpha * diffuseColor.w * varying_color.w * globalColor.w; \noutColor.xyz *= outColor.w; \noutColor = clamp(outColor, 0.0, 1.0); \ngl_FragColor = outColor; \n} \n",particle_end_vs:"float particle( ParticleData curParticle ){ \nreturn 1.0 ; \n} \nmat4 buildModelMatrix(vec4 quat, vec3 scale, vec3 position) \n{ \nmat4 ret = mat4( \nvec4(scale.x, 0.0, 0.0, 0.0), \nvec4(0.0, scale.y, 0.0, 0.0), \nvec4(0.0, 0.0, scale.z, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n); \nret = buildMat4Quat(quat) * ret; \nret[3][0] = position.x; \nret[3][1] = position.y; \nret[3][2] = position.z; \nreturn ret; \n} \nvec3 calcParticleMove(vec3 distanceXYZ){ \nif(velocityLimitVec2.y > TrueOrFalse){ \nvec3 temp = distanceXYZ * distanceXYZ; \nfloat distanceCurrent = sqrt(temp.x + temp.y + temp.z); \nfloat distanceLimit = velocityLimitVec2.x; \nif(distanceLimit < Tiny){ \nreturn vec3(0.0); \n} \nif(distanceCurrent > distanceLimit){ \ndistanceXYZ *= distanceLimit / distanceCurrent; \n} \n} \nreturn distanceXYZ; \n} \nmat4 getRenderModeMatrix(mat4 cameraMatrix, mat4 modelMatrix){ \nreturn cameraMatrix; \n} \nfloat updateStretchedBillBoard(vec4 startPos, vec4 newPos){ \nreturn 1.0; \n} \nvoid main(void) { \nif(discard_particle > TrueOrFalse){ \noutPosition = vec4(0.0,0.0,0.0,0.0); \n}else{ \nvec3 position_emitter = attribute_offsetPosition; \nvec3 velocityLocalVec3 = velocityBaseVec3 * currentTime; \nvec3 velocityWorldVec3 = vec3(0.0,0.0,0.0); \nvec3 velocityMultiVec3 = vec3(0.0,0.0,0.0); \nif(particleStateData.velocityOverWorldSpace < TrueOrFalse){ \nvelocityLocalVec3 += velocityOverVec3; \n}else{ \nvelocityWorldVec3 += velocityOverVec3; \n} \nif(particleStateData.velocityForceWorldSpace < TrueOrFalse){ \nvelocityLocalVec3 += velocityForceVec3; \n}else{ \nvelocityWorldVec3 += velocityForceVec3; \n} \nif(particleStateData.worldSpace > TrueOrFalse){ \n}else{ \nfollowTargetPosition.x = particleStateData.positionX; \nfollowTargetPosition.y = particleStateData.positionY; \nfollowTargetPosition.z = particleStateData.positionZ; \nfollowTargetRotation.x = particleStateData.rotationX; \nfollowTargetRotation.y = particleStateData.rotationY; \nfollowTargetRotation.z = particleStateData.rotationZ; \nfollowTargetRotation.w = particleStateData.rotationW; \n} \nmat4 followRotQuat = buildMat4Quat(followTargetRotation); \nvelocityLocalVec3 = (followRotQuat * vec4(velocityLocalVec3, 1.0)).xyz; \nmat4 modelMatrix = buildModelMatrix(followTargetRotation, followTargetScale, followTargetPosition); \nposition_emitter = (modelMatrix * vec4(position_emitter, 1.0)).xyz; \nvelocityMultiVec3 = velocityLocalVec3 + velocityWorldVec3; \nvelocityMultiVec3 = calcParticleMove(velocityMultiVec3); \nvelocityMultiVec3.y -= 4.9 * currentTime * currentTime * particleStateData.gravity; \nvec3 origPosition = position_emitter; \nposition_emitter += velocityMultiVec3; \nfloat dirEnable = updateStretchedBillBoard(vec4(origPosition, 1.0), vec4(position_emitter, 1.0)); \nif(dirEnable > TrueOrFalse){ \nmat4 billboardMatrix = getRenderModeMatrix(uniform_cameraMatrix, modelMatrix); \noutPosition = billboardMatrix * localPosition; \noutPosition.xyz += position_emitter.xyz; \noutPosition = uniform_ViewMatrix * outPosition; \n}else{ \noutPosition = vec4(0.0,0.0,0.0,0.0); \n} \n} \ngl_Position = uniform_ProjectionMatrix * outPosition ; \n} \n	 \n",particle_follow_vs:"attribute vec3 attribute_followPosition ; \nattribute vec4 attribute_followRotation ; \nattribute vec3 attribute_followScale; \nfloat particle(  ParticleData curParticle ){ \nfollowTargetPosition = attribute_followPosition; \nfollowTargetRotation = attribute_followRotation; \n} \n	 \n",particle_fs:"uniform vec2 uniform_fadeOutParticleData; \nvarying float varying_posZ; \nvoid fadeOutParticleByZ(){ \nif(varying_posZ > uniform_fadeOutParticleData.x){ \ndiscard; \n} \nfloat fadeAlpha = (uniform_fadeOutParticleData.x - varying_posZ) / uniform_fadeOutParticleData.x; \nfadeAlpha = clamp(fadeAlpha, 0.0, 1.0); \nfadeAlpha *= fadeAlpha; \noutColor.w *= fadeAlpha; \nif( diffuseColor.w <= materialSource.cutAlpha ){ \ndiscard; \n} \n} \n",particle_rm_billboard:"mat4 getRenderModeMatrix(mat4 cameraMatrix, mat4 modelMatrix) { \nmat4 matrix = mat4( \ncameraMatrix[0], \ncameraMatrix[1], \ncameraMatrix[2], \nvec4(0.0, 0.0, 1.0, 1.0)); \nreturn matrix; \n} \n",particle_rm_mesh:"mat4 getRenderModeMatrix(mat4 cameraMatrix, mat4 modelMatrix) { \nreturn mat4( \nvec4(1.0, 0.0, 0.0, 0.0), \nvec4(0.0, 1.0, 0.0, 0.0), \nvec4(0.0, 0.0, 1.0, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n); \n} \n",particle_rm_stretched:"mat4 getRenderModeMatrix(mat4 cameraMatrix, mat4 modelMatrix) { \nmat4 matrix = mat4( \ncameraMatrix[0], \ncameraMatrix[1], \ncameraMatrix[2], \nvec4(0.0, 0.0, 1.0, 1.0)); \nreturn matrix; \n} \nfloat updateStretchedBillBoard(vec4 startPos, vec4 newPos){ \nvec3 dirVector = newPos.xyz - startPos.xyz; \nfloat lengthScale = particleStateData.lengthScale; \nfloat speedScale = dirVector.x * dirVector.x + dirVector.y * dirVector.y + dirVector.z * dirVector.z; \nspeedScale = sqrt(speedScale) * 0.01 / currentTime; \nlocalPosition.x *= particleStateData.lengthScale + speedScale * particleStateData.speedScale; \nmat4 temp = uniform_ViewMatrix; \nstartPos = temp * startPos; \nnewPos = temp * newPos; \nfloat scaleBefore = dirVector.x * dirVector.x + dirVector.y * dirVector.y + dirVector.z * dirVector.z; \nscaleBefore = sqrt(scaleBefore); \nif(scaleBefore < Tiny){ \nreturn 0.0; \n} \nfloat scaleAfter = dirVector.x * dirVector.x + dirVector.y * dirVector.y; \nscaleAfter = sqrt(scaleAfter); \nscaleAfter = scaleAfter / scaleBefore; \nlocalPosition.x *= scaleAfter; \nstartPos.xyz /= startPos.z; \nnewPos.xyz /= newPos.z; \ndirVector = newPos.xyz - startPos.xyz; \ndirVector = normalize(dirVector); \nvec3 dirStartVector = vec3(0.0, 1.0, 0.0); \nfloat added = -0.5 * PI; \nif(dirVector.x > 0.0){ \ndirVector.xy *= -1.0; \nadded += PI; \n} \nfloat acosValue = dot(dirStartVector, dirVector); \nfloat angle = acos(acosValue) + added; \ntemp = buildRotMat4(vec3(0.0, 0.0, angle)); \nlocalPosition = temp * localPosition; \nreturn 1.0; \n} \n",particle_rotationConst:"attribute float attribute_rotationZ ; \nfloat particle(  ParticleData curParticle ){ \nfloat rot = currentTime * attribute_rotationZ * (PI / 180.0); \nlocalPosition = buildRotMat4(vec3(0.0,0.0,rot)) * localPosition; \n} \n",particle_rotationOneBezier:"uniform float uniform_rotationBezier[22]; \nfloat particle(  ParticleData curParticle ){ \nif(discard_particle < TrueOrFalse){ \nfloat rot = calcOneBezierSize(uniform_rotationBezier, currentTime, curParticle.life); \nrot = currentTime * rot * (PI / 180.0); \nlocalPosition = buildRotMat4(vec3(0.0,0.0,rot)) * localPosition; \n} \n} \n",particle_rotationTwoBezier:"attribute float attribute_rotationRandomSeed; \nuniform float uniform_rotationBezier[22]; \nuniform float uniform_rotationBezier2[22]; \nfloat particle(  ParticleData curParticle ){ \nif(discard_particle < TrueOrFalse){ \nvec2 rotationTwoBezier = vec2(0.0); \nrotationTwoBezier.x = calcOneBezierArea(uniform_rotationBezier, currentTime, curParticle.life); \nrotationTwoBezier.y = calcOneBezierArea(uniform_rotationBezier2, currentTime, curParticle.life); \nfloat rot = mix(rotationTwoBezier.x, rotationTwoBezier.y, attribute_rotationRandomSeed); \nrot = currentTime * rot * (PI / 180.0); \nlocalPosition = buildRotMat4(vec3(0.0,0.0,rot)) * localPosition; \n} \n} \n",particle_size_vs:"uniform float uniform_bezierSize[22]; \nvoid main() { \nfloat bezierSize = calcOneBezierSize(uniform_bezierSize, currentTime, curParticle.life); \nlocalPosition.xyz *= bezierSize; \n} \n",particle_textureSheetConst:"varying vec3 varying_textureSheetData; \nuniform float uniform_textureSheet[5]; \nvec2 getSheetOffset(float frame, float tileX, float tileY) \n{ \nframe = floor(frame); \nvec2 ret = vec2(0.0); \nret.x = (1.0 / tileX) * mod(frame, tileX); \nret.y = frame / tileX; \nret.y = floor(ret.y); \nret.y = (1.0 / tileY) * ret.y; \nreturn ret; \n} \nvoid calcUVCoord() { \nvec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \nuv_0.xy *= rectUV; \nfloat frame = varying_textureSheetData.x + varying_textureSheetData.y; \nframe = clamp(frame, uniform_textureSheet[3], uniform_textureSheet[4]); \nuv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n} \n",particle_textureSheetOneBezier:"varying vec3 varying_textureSheetData; \nuniform float uniform_textureSheet[5]; \nuniform float uniform_frameBezier[22]; \nvec2 getSheetOffset(float frame, float tileX, float tileY) \n{ \nframe = floor(frame); \nvec2 ret = vec2(0.0); \nret.x = (1.0 / tileX) * mod(frame, tileX); \nret.y = frame / tileX; \nret.y = floor(ret.y); \nret.y = (1.0 / tileY) * ret.y; \nreturn ret; \n} \nvoid calcUVCoord() { \nvec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \nuv_0.xy *= rectUV; \nfloat frame = varying_textureSheetData.x + varying_textureSheetData.y; \nfloat currentTime = varying_particleData.x * uniform_textureSheet[2]; \ncurrentTime = mod(currentTime, varying_particleData.y); \nfloat bezierFrame = calcOneBezierSize(uniform_frameBezier, currentTime, varying_particleData.y); \nbezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]); \nframe += bezierFrame; \nuv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n} \n",particle_textureSheetTwoBezier:"varying vec3 varying_textureSheetData; \nuniform float uniform_textureSheet[5]; \nuniform float uniform_frameBezier1[22]; \nuniform float uniform_frameBezier2[22]; \nvec2 getSheetOffset(float frame, float tileX, float tileY) \n{ \nframe = floor(frame); \nvec2 ret = vec2(0.0); \nret.x = (1.0 / tileX) * mod(frame, tileX); \nret.y = frame / tileX; \nret.y = floor(ret.y); \nret.y = (1.0 / tileY) * ret.y; \nreturn ret; \n} \nvoid calcUVCoord() { \nvec2 rectUV = vec2(1.0 / uniform_textureSheet[0], 1.0 / uniform_textureSheet[1]); \nuv_0.xy *= rectUV; \nfloat frame = varying_textureSheetData.x + varying_textureSheetData.y; \nfloat currentTime = varying_particleData.x * uniform_textureSheet[2]; \ncurrentTime = mod(currentTime, varying_particleData.y); \nfloat b1 = calcOneBezierSize(uniform_frameBezier1, currentTime2, varying_particleData.y); \nfloat b2 = calcOneBezierSize(uniform_frameBezier2, currentTime2, varying_particleData.y); \nfloat bezierFrame = mix(b1, b2, varying_particleData.z); \nbezierFrame = clamp(bezierFrame, uniform_textureSheet[3], uniform_textureSheet[4]); \nframe += bezierFrame; \nuv_0.xy += getSheetOffset(frame, uniform_textureSheet[0], uniform_textureSheet[1]); \n} \n",particle_textureSheet_vs:"attribute vec3 attribute_textureSheetData; \nvarying vec3 varying_textureSheetData; \nfloat particle(  ParticleData curParticle ){ \nvarying_textureSheetData = attribute_textureSheetData; \n} \n	 \n",particle_time_fs:"varying vec3 varying_particleData; \nvoid main(void) { \n} \n",particle_time_vs:"attribute vec3 attribute_time ; \nfloat currentTime = 0.0; \nvarying vec3 varying_particleData; \nstruct ParticleData{ \nfloat bornTime; \nfloat life; \nfloat index; \n}; \nfloat particle( ParticleData curParticle ){ \nfloat time = particleStateData.time - particleStateData.delay; \nif(time <= curParticle.bornTime){ \nreturn currentTime = 0.0; \n} \nif(particleStateData.loop < TrueOrFalse){ \nfloat emitterDuring = particleStateData.duration - particleStateData.delay; \nif(curParticle.bornTime >= emitterDuring) \n{ \nreturn currentTime = 0.0; \n} \nif(time >= curParticle.life + curParticle.bornTime) \n{ \nreturn currentTime = 0.0; \n} \n} \ncurrentTime = time - curParticle.bornTime; \ncurrentTime = mod(currentTime, particleStateData.loopTime); \nif(currentTime >= curParticle.life){ \nreturn currentTime = 0.0; \n} \nif( currentTime <= 0.0 ) \nreturn currentTime = 0.0; \n} \nvoid main(void) { \nParticleData curParticle ; \ncurParticle.bornTime = attribute_time.x ; \ncurParticle.life = attribute_time.y ; \ncurParticle.index = attribute_time.z ; \nfloat active = particle( curParticle ) ; \nvarying_particleData.x = currentTime; \nvarying_particleData.y = curParticle.life ; \nvarying_particleData.z = curParticle.index; \nif( active < TrueOrFalse ){ \ne_discard(); \n}else{ \n} \n} \n",particle_uv_roll_fs:"uniform float uniform_particleUVRoll[2]; \nvoid calcUVCoord() { \nuv_0.xy += vec2(varying_particleData.x * uniform_particleUVRoll[0], varying_particleData.x * uniform_particleUVRoll[1]); \n} \n",particle_velocity:"attribute vec3 attribute_velocity; \nfloat particle(  ParticleData curParticle ){ \nvelocityBaseVec3 = attribute_velocity; \n} \n",particle_velocityForceConst:"attribute vec3 attribute_velocityForceConst ; \nfloat particle(   ParticleData curParticle ){ \nvelocityForceVec3 = 0.5 * attribute_velocityForceConst * currentTime * currentTime; \n} \n",particle_velocityForceOneBezier:"vec3 velocityForceOneBezier = vec3(0.0); \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \n} \nvoid main() { \nif(discard_particle < TrueOrFalse){ \nvelocityForceVec3.xyz = velocityForceOneBezier.xyz; \ncalcVelocityForceBezier(currentTime, curParticle.life); \n} \n} \n",particle_velocityForceOneBezierX:"uniform float uniform_velocityForceX[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceOneBezier.x = calcOneBezierArea(uniform_velocityForceX, curTime, totalTime); \n} \n",particle_velocityForceOneBezierY:"uniform float uniform_velocityForceY[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceOneBezier.y = calcOneBezierArea(uniform_velocityForceY, curTime, totalTime); \n} \n",particle_velocityForceOneBezierZ:"uniform float uniform_velocityForceZ[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceOneBezier.z = calcOneBezierArea(uniform_velocityForceZ, curTime, totalTime); \n} \n",particle_velocityForceTwoBezier:"attribute float attribute_velocityForceRandomSeed; \nvec3 velocityForceTwoBezier1 = vec3(0.0); \nvec3 velocityForceTwoBezier2 = vec3(0.0); \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \n} \nvoid main() { \nif(discard_particle < TrueOrFalse){ \ncalcVelocityForceBezier(currentTime, curParticle.life); \nvelocityForceVec3.x = mix(velocityForceTwoBezier1.x, velocityForceTwoBezier2.x, attribute_velocityForceRandomSeed); \nvelocityForceVec3.y = mix(velocityForceTwoBezier1.y, velocityForceTwoBezier2.y, attribute_velocityForceRandomSeed); \nvelocityForceVec3.z = mix(velocityForceTwoBezier1.z, velocityForceTwoBezier2.z, attribute_velocityForceRandomSeed); \n} \n} \n",particle_velocityForceTwoBezierX1:"uniform float uniform_velocityForceX1[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier1.x = calcOneBezierArea(uniform_velocityForceX1, curTime, totalTime); \n} \n",particle_velocityForceTwoBezierX2:"uniform float uniform_velocityForceX2[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier2.x = calcOneBezierArea(uniform_velocityForceX2, curTime, totalTime); \n} \n",particle_velocityForceTwoBezierY1:"uniform float uniform_velocityForceY1[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier1.y = calcOneBezierArea(uniform_velocityForceY1, curTime, totalTime); \n} \n",particle_velocityForceTwoBezierY2:"uniform float uniform_velocityForceY2[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier2.y = calcOneBezierArea(uniform_velocityForceY2, curTime, totalTime); \n} \n",particle_velocityForceTwoBezierZ1:"uniform float uniform_velocityForceZ1[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier1.z = calcOneBezierArea(uniform_velocityForceZ1, curTime, totalTime); \n} \n",particle_velocityForceTwoBezierZ2:"uniform float uniform_velocityForceZ2[22]; \nvoid calcVelocityForceBezier(float curTime, float totalTime) \n{ \nvelocityForceTwoBezier2.z = calcOneBezierArea(uniform_velocityForceZ2, curTime, totalTime); \n} \n",particle_velocityLimitConst:"attribute float attribute_velocityLimit; \nfloat particle(  ParticleData curParticle ){ \nvelocityLimitVec2.x = attribute_velocityLimit * currentTime; \nif(velocityLimitVec2.x < 0.0){ \nvelocityLimitVec2.x = 0.0; \n} \nvelocityLimitVec2.y = 1.0; \n} \n",particle_velocityLimitOneBezier:"uniform float uniform_velocityLimit[22]; \nvoid main() { \nif(discard_particle < TrueOrFalse){ \nvelocityLimitVec2.x = calcOneBezierArea(uniform_velocityLimit, currentTime, curParticle.life); \nvelocityLimitVec2.y = 1.0; \n} \n} \n",particle_velocityLimitTwoBezier:"uniform float uniform_velocityLimit[22]; \nuniform float uniform_velocityLimit2[22]; \nattribute float attribute_velocityLimitRandomSeed; \nvoid main() { \nif(discard_particle < TrueOrFalse){ \nfloat velocity2Limit1 = calcOneBezierArea(uniform_velocityLimit, currentTime, curParticle.life); \nfloat velocity2Limit2 = calcOneBezierArea(uniform_velocityLimit2, currentTime, curParticle.life); \nvelocityLimitVec2.x = mix(velocity2Limit1, velocity2Limit1, attribute_velocityLimitRandomSeed); \nif(velocityLimitVec2.x < 0.0){ \nvelocityLimitVec2.x = 0.0; \n} \nvelocityLimitVec2.y = 1.0; \n} \n} \n",particle_velocityOverConst:"attribute vec3 attribute_velocityOverConst; \nfloat particle(  ParticleData curParticle ){ \nvelocityOverVec3 = attribute_velocityOverConst * currentTime; \n} \n",particle_velocityOverOneBezier:"vec3 velocityTwoBezier = vec3(0.0); \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \n} \nvoid main() { \nif(discard_particle < TrueOrFalse){ \ncalcVelocityOverBezier(currentTime, curParticle.life); \nvelocityOverVec3.xyz = velocityTwoBezier.xyz; \n} \n} \n",particle_velocityOverOneBezierX:"uniform float uniform_velocityOverX[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityTwoBezier.x = calcOneBezierArea(uniform_velocityOverX, curTime, totalTime); \n} \n",particle_velocityOverOneBezierY:"uniform float uniform_velocityOverY[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityTwoBezier.y = calcOneBezierArea(uniform_velocityOverY, curTime, totalTime); \n} \n",particle_velocityOverOneBezierZ:"uniform float uniform_velocityOverZ[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityTwoBezier.z = calcOneBezierArea(uniform_velocityOverZ, curTime, totalTime); \n} \n",particle_velocityOverTwoBezier:"attribute float attribute_velocityOverRandomSeed; \nvec3 velocityOverTwoBezier1 = vec3(0.0); \nvec3 velocityOverTwoBezier2 = vec3(0.0); \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \n} \nvoid main() { \nif(discard_particle < TrueOrFalse){ \ncalcVelocityOverBezier(currentTime, curParticle.life); \nvelocityOverVec3.x = mix(velocityOverTwoBezier1.x, velocityOverTwoBezier2.x, attribute_velocityOverRandomSeed); \nvelocityOverVec3.y = mix(velocityOverTwoBezier1.y, velocityOverTwoBezier2.y, attribute_velocityOverRandomSeed); \nvelocityOverVec3.z = mix(velocityOverTwoBezier1.z, velocityOverTwoBezier2.z, attribute_velocityOverRandomSeed); \n} \n} \n",particle_velocityOverTwoBezierX1:"uniform float uniform_velocityOverX1[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier1.x = calcOneBezierArea(uniform_velocityOverX1, curTime, totalTime); \n} \n",particle_velocityOverTwoBezierX2:"uniform float uniform_velocityOverX2[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier2.x = calcOneBezierArea(uniform_velocityOverX2, curTime, totalTime); \n} \n",particle_velocityOverTwoBezierY1:"uniform float uniform_velocityOverY1[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier1.y = calcOneBezierArea(uniform_velocityOverY1, curTime, totalTime); \n} \n",particle_velocityOverTwoBezierY2:"uniform float uniform_velocityOverY2[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier2.y = calcOneBezierArea(uniform_velocityOverY2, curTime, totalTime); \n} \n",particle_velocityOverTwoBezierZ1:"uniform float uniform_velocityOverZ1[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier1.z = calcOneBezierArea(uniform_velocityOverZ1, curTime, totalTime); \n} \n",particle_velocityOverTwoBezierZ2:"uniform float uniform_velocityOverZ2[22]; \nvoid calcVelocityOverBezier(float curTime, float totalTime) \n{ \nvelocityOverTwoBezier2.z = calcOneBezierArea(uniform_velocityOverZ2, curTime, totalTime); \n} \n",particle_vs:"attribute vec4 attribute_color; \nattribute vec3 attribute_offsetPosition; \nuniform mat4 uniform_cameraMatrix; \nuniform float uniform_particleState[22]; \nuniform mat4 uniform_ViewMatrix; \nconst float PI = 3.1415926 ; \nfloat currentTime = 0.0; \nfloat totalTime = 0.0; \nconst float TrueOrFalse = 0.5; \nconst float Tiny = 0.0001; \nvec4 localPosition = vec4(0.0,0.0,0.0,1.0); \nvec3 velocityBaseVec3 = vec3(0.0,0.0,0.0); \nvec3 velocityOverVec3 = vec3(0.0,0.0,0.0); \nvec3 velocityForceVec3 = vec3(0.0,0.0,0.0); \nvec2 velocityBezierWeightVec2 = vec2(1.0, 1.0); \nvec2 velocityLimitVec2 = vec2(0.0,0.0); \nvec3 followTargetPosition = vec3(0.0,0.0,0.0); \nvec3 followTargetScale = vec3(1.0,1.0,1.0); \nvec4 followTargetRotation = vec4(0.0,0.0,0.0,0.0); \nvarying vec3 varyingViewDir ; \nfloat discard_particle = 0.0; \nParticleStateData particleStateData; \nvoid e_discard(){ \ndiscard_particle = 1.0; \n} \nstruct ParticleStateData{ \nfloat time; \nfloat loop; \nfloat worldSpace; \nfloat scaleX; \nfloat scaleY; \nfloat scaleZ; \nfloat rotationX; \nfloat rotationY; \nfloat rotationZ; \nfloat rotationW; \nfloat positionX; \nfloat positionY; \nfloat positionZ; \nfloat loopTime; \nfloat delay; \nfloat duration; \nfloat gravity; \nfloat velocityOverWorldSpace; \nfloat velocityForceWorldSpace; \nfloat cameraScale; \nfloat speedScale; \nfloat lengthScale; \n}; \nmat4 buildRotMat4(vec3 rot) \n{ \nfloat s; \nfloat c; \ns = sin(rot.x); \nc = cos(rot.x); \nmat4 ret = mat4( \nvec4(1.0, 0.0, 0.0, 0.0), \nvec4(0.0, c, s, 0.0), \nvec4(0.0, -s, c, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n); \ns = sin(rot.y); \nc = cos(rot.y); \nret = mat4( \nvec4(c, 0.0, -s, 0.0), \nvec4(0.0, 1.0, 0.0, 0.0), \nvec4(s, 0.0, c, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n) * ret; \ns = sin(rot.z); \nc = cos(rot.z); \nret = mat4( \nvec4(c, s, 0.0, 0.0), \nvec4(-s, c, 0.0, 0.0), \nvec4(0.0, 0.0, 1.0, 0.0), \nvec4(0.0, 0.0, 0.0, 1.0) \n) * ret; \nreturn ret; \n} \nmat4 buildMat4Quat(vec4 quat){ \nfloat xx = quat.x * quat.x; \nfloat xy = quat.x * quat.y; \nfloat xz = quat.x * quat.z; \nfloat xw = quat.x * quat.w; \nfloat yy = quat.y * quat.y; \nfloat yz = quat.y * quat.z; \nfloat yw = quat.y * quat.w; \nfloat zz = quat.z * quat.z; \nfloat zw = quat.z * quat.w; \nreturn mat4( \n1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0, \n2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0, \n2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0, \n0.0,							0.0,					0.0,					1 \n); \n} \nvoid main(void) { \nparticleStateData.time							= uniform_particleState[0]; \nparticleStateData.loop							= uniform_particleState[1]; \nparticleStateData.worldSpace					= uniform_particleState[2]; \nparticleStateData.scaleX						= uniform_particleState[3]; \nparticleStateData.scaleY						= uniform_particleState[4]; \nparticleStateData.scaleZ						= uniform_particleState[5]; \nparticleStateData.rotationX						= uniform_particleState[6]; \nparticleStateData.rotationY						= uniform_particleState[7]; \nparticleStateData.rotationZ						= uniform_particleState[8]; \nparticleStateData.rotationW						= uniform_particleState[9]; \nparticleStateData.positionX						= uniform_particleState[10]; \nparticleStateData.positionY						= uniform_particleState[11]; \nparticleStateData.positionZ						= uniform_particleState[12]; \nparticleStateData.loopTime						= uniform_particleState[13]; \nparticleStateData.delay							= uniform_particleState[14]; \nparticleStateData.duration						= uniform_particleState[15]; \nparticleStateData.gravity						= uniform_particleState[16]; \nparticleStateData.velocityOverWorldSpace		= uniform_particleState[17]; \nparticleStateData.velocityForceWorldSpace		= uniform_particleState[18]; \nparticleStateData.cameraScale					= uniform_particleState[19]; \nparticleStateData.speedScale					= uniform_particleState[20]; \nparticleStateData.lengthScale					= uniform_particleState[21]; \nmat4 modeViewMatrix = uniform_ModelViewMatrix ; \noutPosition = localPosition = vec4(e_position, 1.0); \n} \n",pointLight_fragment:"const int max_pointLight = 0 ; \nuniform float uniform_pointLightSource[6*max_pointLight] ; \nuniform mat4 uniform_NormalMatrix; \nstruct PointLight{ \nvec3 position ; \nvec3 diffuse ; \n}; \nvoid calculatePointLight(MaterialSource materialSource){ \nvec3 N = normal; \nfor(int i = 0 ; i < max_pointLight ; i++){ \nPointLight pointLight; \npointLight.position = vec3(uniform_pointLightSource[i*6],uniform_pointLightSource[i*6+1],uniform_pointLightSource[i*6+2]); \npointLight.diffuse = vec3(uniform_pointLightSource[i*6+3],uniform_pointLightSource[i*6+4],uniform_pointLightSource[i*6+5]); \nvec3 viewDir = normalize(varying_ViewPose.xyz/varying_ViewPose.w); \nvec4 lightVirePos = uniform_NormalMatrix * vec4(pointLight.position.xyz,1.0) ; \nvec3 lightDir = varying_ViewPose.xyz - lightVirePos.xyz ; \nfloat lightDist = length( lightDir ); \nfloat attenuation = 1.0 / (3.0 + 0.001 * lightDist +  0.00009 * lightDist * lightDist); \nlight += LightingBlinnPhong(normalize(lightDir),vec3(1.0,1.0,1.0),normal,-varying_ViewDir,attenuation); \n}; \n} \nvoid main() { \ncalculatePointLight(materialSource); \n} \n",secondaryUV_vs:"attribute vec2 attribute_uv1; \nvarying vec2 varying_uv1 ; \nvoid main(void){ \nvarying_uv1 = attribute_uv1 ; \n} \n",shadowMapping_fs:"uniform sampler2D shadowMapTexture; \nuniform vec3 uniform_ShadowColor; \nvarying vec4 varying_ShadowCoord; \nfloat unpackDepth(vec4 rgbaDepth){ \nvec4 bitShift = vec4( 1.0 , 1.0/256.0 , 1.0/(256.0*256.0) , 1.0/(256.0*256.0*256.0) ); \nfloat depth = dot(rgbaDepth,bitShift); \nreturn depth ; \n} \nvoid main() { \nvec3 shadowColor = vec3(1.0,1.0,1.0); \nfloat shadow = 0.0; \nif (varying_ShadowCoord.w > 0.0) { \nvec3 shadowDepth = varying_ShadowCoord.xyz / varying_ShadowCoord.w * 0.5 + 0.5; \nvec2 sample = clamp(shadowDepth.xy,0.0,1.0); \nfloat sampleDepth = texture2D(shadowMapTexture, sample).z; \nif(sampleDepth > shadowDepth.z) \nshadowColor = uniform_ShadowColor; \n} \ndiffuseColor.xyz = diffuseColor.xyz * shadowColor; \n} \n",shadowMapping_vs:"uniform mat4 uniform_ShadowMatrix; \nuniform mat4 uniform_ModelMatrix; \nvarying vec4 varying_ShadowCoord; \nvoid main() { \nvarying_ShadowCoord = uniform_ShadowMatrix * uniform_ModelMatrix * vec4(e_position, 1.0); \n} \n",skeletonShadowPass_vs:"attribute vec4 attribute_boneIndex; \nattribute vec4 attribute_boneWeight; \nattribute vec4 attribute_color; \nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \nconst int bonesNumber = 0; \nuniform vec4 uniform_PoseMatrix[bonesNumber]; \nmat4 buildMat4(int index){ \nvec4 quat = uniform_PoseMatrix[index * 2 + 0]; \nvec4 translation = uniform_PoseMatrix[index * 2 + 1]; \nfloat xx = quat.x * quat.x; \nfloat xy = quat.x * quat.y; \nfloat xz = quat.x * quat.z; \nfloat xw = quat.x * quat.w; \nfloat yy = quat.y * quat.y; \nfloat yz = quat.y * quat.z; \nfloat yw = quat.y * quat.w; \nfloat zz = quat.z * quat.z; \nfloat zw = quat.z * quat.w; \nreturn mat4( \n1.0 - 2.0 * (yy + zz),		2.0 * (xy + zw),		2.0 * (xz - yw),		0, \n2.0 * (xy - zw),				1.0 - 2.0 * (xx + zz),	2.0 * (yz + xw),		0, \n2.0 * (xz + yw),				2.0 * (yz - xw),		1.0 - 2.0 * (xx + yy),	0, \ntranslation.x,				translation.y,			translation.z,			1 \n); \n} \nvoid main(void){ \nvarying_color = attribute_color; \ne_boneIndex = attribute_boneIndex; \ne_boneWeight = attribute_boneWeight; \nvec4 temp_position = vec4(attribute_position, 1.0) ; \nmat4 m0 = buildMat4(int(e_boneIndex.x)); \nmat4 m1 = buildMat4(int(e_boneIndex.y)); \nmat4 m2 = buildMat4(int(e_boneIndex.z)); \nmat4 m3 = buildMat4(int(e_boneIndex.w)); \noutPosition = m0 * temp_position * e_boneWeight.x; \noutPosition += m1 * temp_position * e_boneWeight.y; \noutPosition += m2 * temp_position * e_boneWeight.z; \noutPosition += m3 * temp_position * e_boneWeight.w; \ne_position = outPosition.xyz; \noutPosition = uniform_ModelViewMatrix * outPosition; \n} \n",skeleton_vs:"attribute vec4 attribute_boneIndex; \nattribute vec4 attribute_boneWeight; \nattribute vec3 attribute_normal; \nattribute vec4 attribute_color; \nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \nconst int bonesNumber = 0; \nuniform vec4 uniform_PoseMatrix[bonesNumber]; \nuniform mat4 uniform_NormalMatrix ; \nmat4 buildMat4(int index){ \nvec4 quat = uniform_PoseMatrix[index * 2 + 0]; \nvec4 translation = uniform_PoseMatrix[index * 2 + 1]; \nfloat xy2 = 2.0 * quat.x * quat.y; \nfloat xz2 = 2.0 * quat.x * quat.z; \nfloat xw2 = 2.0 * quat.x * quat.w; \nfloat yz2 = 2.0 * quat.y * quat.z; \nfloat yw2 = 2.0 * quat.y * quat.w; \nfloat zw2 = 2.0 * quat.z * quat.w; \nfloat xx = quat.x * quat.x; \nfloat yy = quat.y * quat.y; \nfloat zz = quat.z * quat.z; \nfloat ww = quat.w * quat.w; \nmat4 matrix = mat4( \nxx - yy - zz + ww, xy2 + zw2, xz2 - yw2, 0, \nxy2 - zw2, -xx + yy - zz + ww, yz2 + xw2, 0, \nxz2 + yw2, yz2 - xw2, -xx - yy + zz + ww, 0, \ntranslation.x, translation.y, translation.z, 1 \n); \nreturn matrix; \n} \nvoid main(void){ \ne_boneIndex = attribute_boneIndex; \ne_boneWeight = attribute_boneWeight; \nvec4 temp_position = vec4(attribute_position, 1.0) ; \nvec4 temp_normal = vec4(attribute_normal, 0.0) ; \nmat4 m0 = buildMat4(int(e_boneIndex.x)); \nmat4 m1 = buildMat4(int(e_boneIndex.y)); \nmat4 m2 = buildMat4(int(e_boneIndex.z)); \nmat4 m3 = buildMat4(int(e_boneIndex.w)); \noutPosition = m0 * temp_position * e_boneWeight.x; \noutPosition += m1 * temp_position * e_boneWeight.y; \noutPosition += m2 * temp_position * e_boneWeight.z; \noutPosition += m3 * temp_position * e_boneWeight.w; \ne_position = outPosition.xyz; \nvec4 temp_n ; \ntemp_n = m0 * temp_normal * e_boneWeight.x; \ntemp_n += m1 * temp_normal * e_boneWeight.y; \ntemp_n += m2 * temp_normal * e_boneWeight.z; \ntemp_n += m3 * temp_normal * e_boneWeight.w; \nmat3 normalMatrix = mat3(uniform_NormalMatrix); \nvarying_eyeNormal = normalize(normalMatrix * -temp_n.xyz); \nvarying_ViewPose = vec4(normalMatrix*outPosition.xyz, 1.0) ; \noutPosition = uniform_ModelViewMatrix * outPosition; \n} \n",specularMap_fragment:"uniform sampler2D specularTexture; \nvoid main(void){ \nspecularColor.xyz *= texture2D( specularTexture , uv_0 ).xyz ; \n} \n",staticShadowPass_vs:"attribute vec4 attribute_color; \nvec4 e_boneIndex = vec4(0.0, 0.0, 0.0, 0.0); \nvec4 e_boneWeight = vec4(0.0, 0.0, 0.0, 0.0); \nvoid main(void){ \nvarying_color = attribute_color; \noutPosition = vec4(attribute_position, 1.0) ; \ne_position = outPosition.xyz; \noutPosition = uniform_ModelViewMatrix * outPosition; \n} \n",tangent_vs:"attribute vec3 attribute_tangent; \nvoid main(void){ \n}  \n",terrainRGBA_fragment:"uniform sampler2D blendMaskTexture ; \nuniform sampler2D splat_0Tex ; \nuniform sampler2D splat_1Tex ; \nuniform sampler2D splat_2Tex ; \nuniform sampler2D splat_3Tex ; \nuniform float uvs[8]; \nvoid main() { \nvec4 splat_control = texture2D ( blendMaskTexture , varying_uv0 ); \nvec4 cc = vec4(0.0,0.0,0.0,1.0); \nvec2 uv = varying_uv0 ; \ncc.xyz = splat_control.x * texture2D (splat_0Tex, uv * vec2(uvs[0],uvs[1])).xyz ; \ncc.xyz += splat_control.y * texture2D (splat_1Tex, uv * vec2(uvs[2],uvs[3]) ).xyz; \ncc.xyz += splat_control.z * vec4(texture2D (splat_2Tex, uv* vec2(uvs[4],uvs[5]))).xyz; \ncc.xyz += (1.0-length(splat_control.xyz)) * vec4(texture2D (splat_3Tex, uv* vec2(uvs[6],uvs[7]))).xyz; \ndiffuseColor.xyz = cc.xyz ; \n} \n",uvRoll_fs:"uniform float uvRoll[2] ; \nuniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvoid main() { \nuv_0.xy += vec2(uvRoll[0],uvRoll[1]); \ndiffuseColor = texture2D(diffuseTexture , uv_0 ); \n} \n",uvSpriteSheet_fs:"uniform float uvSpriteSheet[4] ; \nuniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvoid main() { \nuv_0.xy *= vec2(uvSpriteSheet[2],uvSpriteSheet[3]); \nuv_0.xy += vec2(uvSpriteSheet[0],uvSpriteSheet[1]); \ndiffuseColor = texture2D(diffuseTexture , uv_0 ); \n} \n",uvStreamerRoll_fs:"uniform float uvRoll[3] ; \nuniform sampler2D diffuseTexture; \nuniform sampler2D streamerTexture; \nvec4 diffuseColor ; \nvoid main() { \ndiffuseColor = texture2D(diffuseTexture , varying_uv0 ); \nvec2 rollUV = varying_uv0 + vec2(uvRoll[0],uvRoll[1]) + vec2(normal.xz) * 0.5 ; \ndiffuseColor.xyz += texture2D(streamerTexture , rollUV ).xyz * uvRoll[2] ; \n} \n",varyingViewDir_vs:"varying vec3 varying_ViewDir; \nuniform vec3 uniform_eyepos; \nuniform mat4 uniform_NormalMatrix; \nvoid main(void){ \nvarying_ViewDir = (uniform_eyepos.xyz - e_position) ; \n} \n",vertexPos_vs:"varying vec4 varying_pos; \nvoid main() { \nvarying_pos = uniform_ModelViewMatrix * vec4(e_position, 1.0) ; \n} \n                       \n",waterDiffuse_fs:"uniform sampler2D diffuseTexture; \nvec4 diffuseColor ; \nvoid main() { \ndiffuseColor.xyz *= diffuseColor.w ; \n} \n",waterNormal_fs:"uniform vec2 waterNormalData[4]; \nuniform float time ; \nuniform sampler2D normalTextureA; \nuniform sampler2D normalTextureB; \nvarying vec2 varying_uv0        ; \nmat3 TBN ; \nmat3 cotangentFrame(vec3 N, vec3 p, vec2 uv) { \nvec3 dp1 = dFdx(p); \nvec3 dp2 = dFdy(p); \nvec2 duv1 = dFdx(uv); \nvec2 duv2 = dFdy(uv); \nvec3 dp2perp = cross(dp2, N); \nvec3 dp1perp = cross(N, dp1); \nvec3 T = dp2perp * duv1.x + dp1perp * duv2.x; \nvec3 B = dp2perp * duv1.y + dp1perp * duv2.y; \nfloat invmax = 1.0 / sqrt(max(dot(T,T), dot(B,B))); \nreturn mat3(T * invmax, B * invmax, N); \n} \nvec3 tbn(vec3 map, vec3 N, vec3 V, vec2 texcoord) { \nmat3 TBN = cotangentFrame(N, -V, texcoord); \nreturn normalize(TBN * map); \n} \nvoid main(void){ \nfloat tempTime = mod(time,100000.0); \nvec2 uvA = uv_0 * waterNormalData[3].x + waterNormalData[0] * tempTime ; \nvec2 uvB = uv_0 * waterNormalData[3].y + waterNormalData[1] * tempTime  ; \nvec3 normalTex_0 = texture2D(normalTextureA,uvA * 2.0 + normal.x*waterNormalData[2].x ).xyz *2.0 - 1.0; \nvec3 normalTex_1 = texture2D(normalTextureB,uvB * 2.0 + normal.z*waterNormalData[2].y ).xyz *2.0 - 1.0; \nnormalTex_0.y *= -1.0; \nnormalTex_1.y *= -1.0; \nvec3 normalTex_A = tbn( normalTex_0 , normal , -(varying_ViewDir) , uv_0 ); \nvec3 normalTex_B = tbn( normalTex_1 , normal , -(varying_ViewDir) , uv_0 ); \nnormal.xyz = normalize( normalTex_A + normalTex_B ) ; \n}  \n",wave_fs:"uniform sampler2D diffuseTexture; \nuniform vec3 uniform_eyepos; \nuniform vec4 waveFSData[2]; \nuniform mat4 uniform_NormalMatrix; \nvec4 diffuseColor ; \nvoid main(void){ \nvec3 ViewDir = (mat3(uniform_NormalMatrix)*(uniform_eyepos.xyz - varying_ViewPose.xyz)) ; \ndiffuseColor.xyz = vec3(1.0,1.0,1.0) ; \nvec3 shallowWaterColor = waveFSData[0].xyz * waveFSData[0].w ; \nvec3 deepWaterColor = waveFSData[1].xyz * waveFSData[1].w; \nfloat facing = clamp(dot( -normalize(ViewDir),normal),0.0,1.0); \nvec3 waterColor = mix(shallowWaterColor,deepWaterColor,facing); \ndiffuseColor.xyz *= waterColor ; \n}  \n",wave_vs:"#define VERTEX_TEXTURES \nattribute vec3 attribute_normal; \nattribute vec4 attribute_color; \nvarying vec3 varying_ViewDir ; \nuniform mat4 uniform_NormalMatrix; \nuniform vec3 waveVSData[4]; \nuniform float time ; \nstruct wave{ \nvec3 wave_xyz_intensity_0 ; \nvec3 wave_xyz_intensity_1 ; \nvec3 wave_xyz_speed_0 ; \nvec3 wave_xyz_speed_1 ; \n}; \nconst float pi = 3.14 ; \nvec3 calcWave2( float t , vec3 x, float amplitude, float waveLength ,float angularVelocity ,  vec3 waveDir ){ \nangularVelocity = angularVelocity * 0.1; \nvec3 waveVector = waveDir ; \nfloat waveNumber = pi / waveLength; \nwaveVector *= waveNumber ; \nvec3 temp ; \nfloat kDotX0SubWt = dot(waveVector , x ) - angularVelocity * t  * 0.001; \nfloat A = amplitude * sin(kDotX0SubWt) ; \ntemp.xz = waveDir.xz * A ; \ntemp.y += amplitude * cos(kDotX0SubWt); \ntemp = x - temp ; \nreturn temp ; \n} \nvoid main(void){ \nwave wa ; \nwa.wave_xyz_intensity_0 = vec3(waveVSData[0]) ; \nwa.wave_xyz_intensity_1 = vec3(waveVSData[1]) ; \nwa.wave_xyz_speed_0 = vec3(waveVSData[2]) ; \nwa.wave_xyz_speed_1 = vec3(waveVSData[3]) ; \nfloat tempTime = mod( time , 1000000.0 ); \nvec3 newPose1 = calcWave2(tempTime,e_position,60.0, 500.0, 20.0,vec3(1.0,0.0,1.0)); \nnewPose1 += calcWave2(tempTime,e_position,130.0, 50.0, 20.0,vec3(1.0,0.0,-0.5)); \nnewPose1 += calcWave2(tempTime,e_position,90.0, 80.0, 20.0,vec3(1.0,0.0,-1.5)); \ne_position = newPose1 ; \nmat3 normalMatrix = mat3(uniform_NormalMatrix); \nvarying_eyeNormal = normalize(-attribute_normal); \nvarying_ViewPose = vec4(e_position, 1.0) ; \nvarying_ViewDir = ((uniform_eyepos.xyz - e_position)) ; \noutPosition = uniform_ModelViewMatrix * vec4(e_position, 1.0) ; \nvarying_color = attribute_color ; \n}  \n"},t
}();t.ShaderLib=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.register=function(t){this.context=t},e.getGPUShader=function(e,i,a){var r=this.vsShaderHashMap.getValue(i);return r||(r=this.fsShaderHashMap.getValue(i)),r||(e==t.Shader.vertex?(r=this.context.creatVertexShader(a),r.id=i,this.vsShaderHashMap.add(i,r)):e==t.Shader.fragment&&(r=this.context.creatFragmentShader(a),r.id=i,this.fsShaderHashMap.add(i,r))),r},e.getProgram=function(t,e){var i,a=this.vsShaderHashMap.getValue(t),r=this.fsShaderHashMap.getValue(e),n=a.id+"_"+r.id;return this.programlib.isHas(n)?i=this.programlib.getValue(n):(i=this.registerProgram(a,r),this.programlib.add(n,i)),this.programlib.getValue(n)},e.unRegisterShader=function(t){},e.registerProgram=function(t,e){var i=this.context.creatProgram(t,e);return i},e.unRegisterProgram=function(t,e){},e.programlib=new t.HashMap,e.vsShaderHashMap=new t.HashMap,e.fsShaderHashMap=new t.HashMap,e}();t.ShaderPool=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e;!function(t){var e=function(){function t(){this.name="",this.source="",this.funcNames=new Array,this.funcDict={},this.structDict={},this.structNames=new Array,this.attributeList=new Array,this.varyingList=new Array,this.uniformList=new Array,this.constList=new Array,this.tempList=new Array,this.sampler2DList=new Array,this.sampler3DList=new Array,this.extensionList=new Array}return t.prototype.addVar=function(t){"attribute"==t.key?this.attributeList.push(t):"varying"==t.key?this.varyingList.push(t):"uniform"==t.key?this.uniformList.push(t):"const"==t.key?this.constList.push(t):"sampler2D"==t.key?this.sampler2DList.push(t):"samplerCube"==t.key?this.sampler3DList.push(t):"#extension"==t.key?this.extensionList.push(t):this.tempList.push(t)},t.prototype.addFunc=function(t,e){if(this.funcDict[t]){var i=this.mergeMainFunc(this.funcDict[t],e);this.funcDict[t]=i}else this.funcDict[t]=e,this.funcNames.push(t);if(this.funcDict.main){var a=this.funcNames.indexOf("main");this.funcNames.splice(a,1),this.funcNames.push("main")}},t.prototype.addStruct=function(t,e){this.structDict[t]?console.log("<"+t+">struct重复"):(this.structDict[t]=e,this.structNames.push(t))},t.prototype.addContent=function(t){for(var e=0;e<t.structNames.length;++e)this.addStruct(t.structNames[e],t.structDict[t.structNames[e]]);for(var e=0;e<t.funcNames.length;++e)this.addFunc(t.funcNames[e],t.funcDict[t.funcNames[e]]);for(var e=0;e<t.attributeList.length;++e){for(var i=!0,a=0;a<this.attributeList.length;++a)if(t.attributeList[e].name==this.attributeList[a].name){t.attributeList[e].valueType!=this.attributeList[a].valueType||t.attributeList[e].key!=this.attributeList[a].key,i=!1;break}i&&this.attributeList.push(t.attributeList[e].clone())}for(var e=0;e<t.varyingList.length;++e){for(var i=!0,a=0;a<this.varyingList.length;++a)if(t.varyingList[e].name==this.varyingList[a].name){t.varyingList[e].valueType!=this.varyingList[a].valueType||t.varyingList[e].key!=this.varyingList[a].key,i=!1;break}i&&this.varyingList.push(t.varyingList[e].clone())}for(var e=0;e<t.uniformList.length;++e){for(var i=!0,a=0;a<this.uniformList.length;++a)if(t.uniformList[e].name==this.uniformList[a].name){t.uniformList[e].valueType!=this.uniformList[a].valueType||t.uniformList[e].key!=this.uniformList[a].key,i=!1;break}i&&this.uniformList.push(t.uniformList[e].clone())}for(var e=0;e<t.constList.length;++e){for(var i=!0,a=0;a<this.constList.length;++a)if(t.constList[e].name==this.constList[a].name){t.constList[e].valueType!=this.constList[a].valueType||t.constList[e].key!=this.constList[a].key,i=!1;break}i&&this.constList.push(t.constList[e].clone())}for(var e=0;e<t.tempList.length;++e){for(var i=!0,a=0;a<this.tempList.length;++a)if(t.tempList[e].name==this.tempList[a].name){t.tempList[e].valueType!=this.tempList[a].valueType||t.tempList[e].key!=this.tempList[a].key,i=!1;break}i&&this.tempList.push(t.tempList[e].clone())}for(var e=0;e<t.sampler2DList.length;++e){for(var i=!0,a=0;a<this.sampler2DList.length;++a)if(t.sampler2DList[e].name==this.sampler2DList[a].name){t.sampler2DList[e].valueType!=this.sampler2DList[a].valueType||t.sampler2DList[e].key!=this.sampler2DList[a].key,i=!1;break}i&&this.sampler2DList.push(t.sampler2DList[e].clone())}for(var e=0;e<t.sampler3DList.length;++e){for(var i=!0,a=0;a<this.sampler3DList.length;++a)if(t.sampler3DList[e].name==this.sampler3DList[a].name){t.sampler2DList[e].valueType!=this.sampler3DList[a].valueType||t.sampler3DList[e].key!=this.sampler3DList[a].key,i=!1;break}i&&this.sampler3DList.push(t.sampler3DList[e].clone())}for(var e=0;e<t.extensionList.length;++e){for(var i=!0,a=0;a<this.extensionList.length;++a)if(t.extensionList[e].name==this.extensionList[a].name){i=!1;break}i&&this.extensionList.push(t.extensionList[e].clone())}},t.prototype.mergeMainFunc=function(t,e){var i=t,a="",r=e.indexOf("{"),n=e.lastIndexOf("}");r++,a=e.slice(r,n),r=i.lastIndexOf("}");var o=i.substr(0,r),s=i.substr(r,i.length-r);i=o,i+=a;var h="";return i+=h,i+=s},t.prototype.clone=function(){var e=new t;e.name=this.name,e.source=this.source;for(var i=0;i<this.funcNames.length;++i)e.funcNames.push(this.funcNames[i]);for(var a in this.funcDict)e.funcDict[a]=this.funcDict[a];for(var i=0;i<this.structNames.length;++i)e.structNames.push(this.structNames[i]);for(var a in this.structDict)e.structDict[a]=this.structDict[a];for(var i=0;i<this.attributeList.length;++i)e.attributeList.push(this.attributeList[i].clone());for(var i=0;i<this.varyingList.length;++i)e.varyingList.push(this.varyingList[i].clone());for(var i=0;i<this.uniformList.length;++i)e.uniformList.push(this.uniformList[i].clone());for(var i=0;i<this.constList.length;++i)e.constList.push(this.constList[i].clone());for(var i=0;i<this.tempList.length;++i)e.tempList.push(this.tempList[i].clone());for(var i=0;i<this.sampler2DList.length;++i)e.sampler2DList.push(this.sampler2DList[i].clone());for(var i=0;i<this.sampler3DList.length;++i)e.sampler3DList.push(this.sampler3DList[i].clone());for(var i=0;i<this.attributeList.length;++i)e.attributeList.push(this.attributeList[i].clone());for(var i=0;i<this.extensionList.length;++i)e.extensionList.push(this.extensionList[i].clone());return e},t}();t.ShaderContent=e}(e=t.GLSL||(t.GLSL={}))}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._shaderContentDict=[],this.vs_begin="##define vs begin##",this.vs_end="##define vs end##",this.fs_begin="##define fs begin##",this.fs_end="##define fs end##"}return Object.defineProperty(e,"instance",{get:function(){return this._instance||(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e.prototype.load=function(){var e=[],i=[];for(var a in t.ShaderLib.lib){var r=t.ShaderLib.lib[a].indexOf(this.vs_begin),n=t.ShaderLib.lib[a].indexOf(this.vs_end),o=!1;-1!=r&&(o=!0,r+=this.vs_begin.length,e.push(a),i[a+"vs"]=t.ShaderLib.lib[a].substr(r,n-r)),r=t.ShaderLib.lib[a].indexOf(this.fs_begin),n=t.ShaderLib.lib[a].indexOf(this.fs_end),-1!=r&&(r+=this.fs_begin.length,o&&e.push(a),i[a+"fs"]=t.ShaderLib.lib[a].substr(r,n-r))}for(var a in e)delete t.ShaderLib.lib[e[a]];for(var a in i)t.ShaderLib.lib[a]=i[a];for(var a in t.ShaderLib.lib){var s=this.readShader(t.ShaderLib.lib[a]);this._shaderContentDict[a]=s,s.name=a}},e.prototype.readShader=function(e){for(var i=new t.GLSL.ShaderContent,a=t.StringUtil.processShaderFile(e),r=t.StringUtil.parseContent(a),n=r.concat();n.length>0;){var o=n[0];n.shift();var s=t.StringUtil.getLineType(o),h=-1;if(h=s.indexOf("struct"),-1==h)if(h=s.indexOf("function"),-1==h)if(h=s.indexOf("unknown"),-1==h);else{var l=t.StringUtil.parseLines(o),u=t.StringUtil.getVarKey(l),c=t.StringUtil.getVarType(l);if("sampler2D"==c){var d=t.StringUtil.getSampler2D(o);d&&i.addVar(d)}else if("samplerCube"==c){var p=t.StringUtil.getSampler3D(o);p&&i.addVar(p)}else if("attribute"==u){var f=t.StringUtil.getAttribute(o);f&&i.addVar(f)}else if("varying"==u){var _=t.StringUtil.getVarying(o);_&&i.addVar(_)}else if("uniform"==u){var m=t.StringUtil.getUniform(o);m&&i.addVar(m)}else if("const"==u){var v=t.StringUtil.getConst(o);v&&i.addVar(v)}else if("#extension"==u){var g=t.StringUtil.getExtension(o);g&&i.addVar(g)}else i.addVar(t.StringUtil.getTemper(o))}else{var l=s.split(" "),y=o;i.addFunc(l[1],y)}else{var l=s.split(" "),x=o;i.addStruct(l[1],x),t.StringUtil.processStruct(l[1],x,i)}}return i},e.prototype.fillShaderContent=function(i,a,r){var n,o=0,s="";for(o=0;o<a.length;++o)""!=s&&(s+="/"),s+=a[o];if(s+="/d"+r.maxDirectLight,s+="/s"+r.maxSpotLight,s+="/p"+r.maxPointLight,s+="/b"+r.maxBone,this._shaderContentDict[s])n=this._shaderContentDict[s].clone();else for(n=new t.GLSL.ShaderContent,n.name=s,o=0;o<a.length;++o){var h=this._shaderContentDict[a[o]];n.addContent(h)}for(o=0;o<n.attributeList.length;o++)s=n.attributeList[o].varName,r[s]=n.attributeList[o];for(o=0;o<n.varyingList.length;o++)s=n.varyingList[o].varName,r[s]||(r[s]=n.varyingList[o]);for(o=0;o<n.tempList.length;o++)s=n.tempList[o].varName,r[s]=n.tempList[o];for(o=0;o<n.uniformList.length;o++)s=n.uniformList[o].varName,r[s]=n.uniformList[o];var l;for(o=0;o<n.constList.length;o++)switch(s=n.constList[o].varName,l=n.constList[o],r[s]=l,s){case"max_directLight":l.value=r.maxDirectLight;break;case"max_spotLight":l.value=r.maxSpotLight;break;case"max_pointLight":l.value=r.maxPointLight;break;case"bonesNumber":i.maxBone=r.maxBone,l.value=r.maxBone}for(o=0;o<n.sampler2DList.length;o++){var u=n.sampler2DList[o];u.index=o,r.sampler2DList.push(u),u.activeTextureIndex=e.getTexture2DIndex(o)}for(o=0;o<n.sampler3DList.length;o++){var c=n.sampler3DList[o];c.activeTextureIndex=e.getTexture2DIndex(n.sampler2DList.length+o),c.index=n.sampler2DList.length+o,r.sampler3DList.push(c)}return this.synthesisShader(n,i),t.ShaderPool.getGPUShader(i.shaderType,n.name,n.source)},e.prototype.synthesisShader=function(t,i){var a,r="";for(a=0;a<t.extensionList.length;a++)r+=e.connectExtension(t.extensionList[a]);for(r+="precision highp float;            	\n",a=0;a<t.attributeList.length;a++)r+=e.connectAtt(t.attributeList[a]);for(a=0;a<t.structNames.length;a++)r+=e.connectStruct(t.structDict[t.structNames[a]]);for(a=0;a<t.varyingList.length;a++)r+=e.connectVarying(t.varyingList[a]);for(a=0;a<t.tempList.length;a++)r+=e.connectTemp(t.tempList[a]);for(a=0;a<t.constList.length;a++)r+=e.connectConst(t.constList[a]);for(a=0;a<t.uniformList.length;a++)r+=e.connectUniform(t.uniformList[a]);for(a=0;a<t.sampler2DList.length;a++){var n=t.sampler2DList[a];r+=e.connectSampler(n)}for(a=0;a<t.sampler3DList.length;a++){var o=t.sampler3DList[a];r+=e.connectSampler3D(o)}for(a=0;a<t.funcNames.length;a++)r+=t.funcDict[t.funcNames[a]];t.source=r},e.connectAtt=function(t){return"attribute "+t.valueType+" "+t.name+"; \r\n"},e.connectTemp=function(t){return""!=t.value?t.valueType+" "+t.name+" = "+t.value+"; \r\n":t.valueType+" "+t.name+"; \r\n"},e.connectStruct=function(t){return t+" \r\n"},e.connectConst=function(t){return"const "+t.valueType+" "+t.name+" = "+t.value+"; \r\n"},e.connectVarying=function(t){return"varying "+t.valueType+" "+t.name+"; \r\n"},e.connectUniform=function(t){return"uniform "+t.valueType+" "+t.name+"; \r\n"},e.connectSampler=function(t){return"uniform sampler2D "+t.name+"; \r\n"},e.connectSampler3D=function(t){return"uniform samplerCube "+t.name+"; \r\n"},e.connectExtension=function(t){return"#extension "+t.name+":"+t.value+"\r\n"},e.getTexture2DIndex=function(e){switch(e){case 0:return t.ContextSamplerType.TEXTURE_0;case 1:return t.ContextSamplerType.TEXTURE_1;case 2:return t.ContextSamplerType.TEXTURE_2;case 3:return t.ContextSamplerType.TEXTURE_3;case 4:return t.ContextSamplerType.TEXTURE_4;case 5:return t.ContextSamplerType.TEXTURE_5;case 6:return t.ContextSamplerType.TEXTURE_6;case 7:return t.ContextSamplerType.TEXTURE_7;case 8:return t.ContextSamplerType.TEXTURE_8}throw new Error("texture not big then 8")},e._shaderLibs={},e._methodLibs={},e}();t.ShaderUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.distance=2e3,this.dir=new t.Vector3D(0,-1,-1),this.init()}return Object.defineProperty(e,"instance",{get:function(){return e._instance||(e._instance=new e),e._instance},enumerable:!0,configurable:!0}),e.enableShadow=function(t){this._enable=t},e.prototype.init=function(){this.shadowRender=[]},e.prototype.castShadowLight=function(){this.shadowRender.push(new t.MultiRender(t.PassType.shadowPass)),this.shadowCamera=new t.Camera3D,this.shadowCamera.lookAt(new t.Vector3D(0,1e3,-1e3),new t.Vector3D(0,0,0)),this.shadowRender[this.shadowRender.length-1].setRenderToTexture(512,512)},e.prototype.calculateCamera=function(e,i){t.MathUtil.CALCULATION_VECTOR3D.copyFrom(this.dir),t.MathUtil.CALCULATION_VECTOR3D.normalize(),t.MathUtil.CALCULATION_VECTOR3D.negate(),t.MathUtil.CALCULATION_VECTOR3D.scaleBy(this.distance),i.lookAt(t.MathUtil.CALCULATION_VECTOR3D,e.position)},e._enable=!1,e}();t.ShadowCast=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.apply(this,arguments),this.vertex_ShaderName={},this.fragment_ShaderName={},this.attributes=new Array}return __extends(e,t),e.prototype.build=function(t,e){},e.prototype.initNode=function(t,e){},e.prototype.update=function(t,e,i){},e.prototype.activeState=function(t,e,i,a,r,n,o){},e.prototype.upload=function(){},e}(t.EventDispatcher);t.AnimationNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.AnimationCurve=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._timeEvent=new t.Event3D,this._times=new Array,this._processTimes=new Array,this._timer=0,this._start=!1}return __extends(i,e),i.prototype.start=function(){this._timer=0,this._start=!0,this._processTimes.length=0;for(var t=0;t<this._times.length;++t)this._processTimes[t]=this._times[t]},i.prototype.addTimerAxis=function(t){this._times.push(t)},i.prototype.clearTimerAxis=function(){this._times.length=0,this._processTimes.length=0},i.prototype.reset=function(){this._processTimes.length=0,this._timer=0,this._start=!1;for(var t=0;t<this._times.length;++t)this._processTimes[t]=this._times[t]},i.prototype.update=function(t,e){if(this._start){this._timer+=t,console.log(this._timer+"update");for(var a=0;a<this._processTimes.length;++a)if(this._timer>=this._processTimes[a]){this._timeEvent.eventType=i.TIME_EVENT,this._timeEvent.data=this._processTimes[a],this.dispatchEvent(this._timeEvent),this._processTimes.splice(a,1);break}}},i.TIME_EVENT="TimeEvent",i}(t.EventDispatcher);t.TimerAxis=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Line=0]="Line",t[t.BesselCurve=1]="BesselCurve"}(t.CurveType||(t.CurveType={}));var e=t.CurveType,i=function(){function i(){this.type=e.Line,this.start=new t.Point,this.end=new t.Point,this.c1=new t.Point,this.c2=new t.Point,this.cache=null,this.useCache=!1}return i.prototype.calculateValue=function(t){if(t<this.start.x||t>this.end.x)return 0;if(this.useCache)return this.cache[Math.floor(t-this.start.x)];switch(this.type){case e.Line:return this.valueFromLine(t);case e.BesselCurve:return this.valueFromBesselCurve(t)}return 0},i.prototype.valueFromLine=function(t){var e=(t-this.start.x)/(this.end.x-this.start.x);return this.start.y+e*(this.end.y-this.start.y)},i.prototype.valueFromBesselCurve=function(t){var e=(t-this.start.x)/(this.end.x-this.start.x),i=1-e,a=i*i,r=a*i;return this.start.y*r+3*this.c1.y*e*a+3*this.c2.x*e*e*i+this.end.y*e*e*e},i.prototype.cacheCurveData=function(){this.cache=[];for(var t=this.start.x;t<this.end.x;t++)this.cache.push(this.calculateValue(t));this.useCache=!0},i}();t.AnimCurve=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function a(){e.call(this),this.speed=1,this.isLoop=!0,this._propertyArray=[],this._play=!1,this._timePosition=0,this._totalTime=0,this._changeFrameTime=0,this._oldFrameIndex=0,this._event3D=new t.Event3D}return __extends(a,e),a.prototype.IsExist=function(t){for(var e=0;e<this._propertyArray.length;e++)if(this._propertyArray[e].property==t)return!0;return!1},a.prototype.addAnimCurve=function(t,e){if(this.IsExist(t))return!1;if(null==e||e.length<=0)return!1;var a=new i;a.keyFrames=e,a.property=t,a.target=this._target,a.isLoop=!0,a.timePosition=0,this._propertyArray.push(a);for(var r=0;r<e.length;r++)e[r].end.x>this._totalTime&&(this._totalTime=e[r].end.x,e[r].cacheCurveData());this.updateBindData(a)},a.prototype.removeAnimCurve=function(t){for(var e=null,i=0;i<this._propertyArray.length;i++)if(this._propertyArray[i].property==t)return e=this._propertyArray[i],this._propertyArray.splice(i,1),e.keyFrames},a.prototype.setPropertyLoop=function(t,e){for(var i=null,a=0;a<this._propertyArray.length;a++)if(this._propertyArray[a].property==t){i=this._propertyArray[a],i.isLoop=e;break}},a.prototype.bindObject3D=function(t){this._target=t;for(var e=0;e<this._propertyArray.length;e++)this.updateBindData(this._propertyArray[e])},a.prototype.updateBindData=function(t){if(this._target){t.target=this._target;for(var e=t.property.split("."),i=0;i<e.length-1;i++)t.target=t.target[e[i]];t.name=e[e.length-1]}},a.prototype.play=function(){if(!this._play){this._play=!0,this._timePosition=0;for(var t=0;t<this._propertyArray.length;t++)this._propertyArray[t].timePosition=0}},a.prototype.stop=function(){this._play=!1},Object.defineProperty(a.prototype,"timePosition",{get:function(){return this._timePosition},set:function(e){if(e!=this._timePosition){var i=e-this._timePosition;if(this._timePosition=e,this.isLoop?(this._timePosition=e%this._totalTime,this._timePosition<0&&(this._timePosition+=this._totalTime)):this._timePosition<0?(this._timePosition=0,this._event3D.eventType=t.PropertyAnimEvent3D.EVENT_PLAY_COMPLETE,this._event3D.target=this,this.dispatchEvent(this._event3D),this.stop()):this._timePosition>this._totalTime&&(this._timePosition=this._totalTime,this._event3D.eventType=t.PropertyAnimEvent3D.EVENT_PLAY_COMPLETE,this._event3D.target=this,this.dispatchEvent(this._event3D),this.stop()),this._target)for(var a,r,n=0;n<this._propertyArray.length;n++){a=this._propertyArray[n],r=a.keyFrames;var o=a.timePosition+i;if(o!=a.timePosition){var s=r[r.length-1].end.x;if(a.timePosition=o,a.isLoop)a.timePosition=e%s,a.timePosition<0&&(a.timePosition+=s);else{if(a.timePosition<0){a.timePosition=0;continue}if(a.timePosition>s){a.timePosition=s;continue}}for(var h=0;h<r.length-1;h++)if(r[h].start.x<=a.timePosition&&r[h].end.x>a.timePosition){a.target[a.name]=r[h].calculateValue(a.timePosition);break}}}}},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"totalTime",{get:function(){return this._totalTime},enumerable:!0,configurable:!0}),a.prototype.update=function(e){if(this._play){var i=this.timePosition;this.timePosition+=e*this.speed,this.timePosition<i&&(this._event3D.eventType=t.PropertyAnimEvent3D.EVENT_PLAY_COMPLETE,this._event3D.target=this,this.dispatchEvent(this._event3D))}},a.prototype.clone=function(){var t=new a;return t._propertyArray=this._propertyArray,t._totalTime=this._totalTime,t},a}(t.EventDispatcher);t.PropertyAnim=e;var i=function(){function t(){}return t}()}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.parent=null,this.name=e,this.parentIndex=-1,this.scale=new t.Vector3D(1,1,1),this.orientation=new t.Quaternion,this.translation=new t.Vector3D,this.localMatrix=new t.Matrix4_4,this.worldMatrix=new t.Matrix4_4,this.worldMatrixValid=!1}return e.prototype.clone=function(){var t=new e(this.name);return t.parent=this.parent,t.parentIndex=this.parentIndex,t.scale.copyFrom(this.scale),t.orientation.copyFrom(this.orientation),t.translation.copyFrom(this.translation),t.localMatrix.copyFrom(this.localMatrix),t.worldMatrix.copyFrom(this.worldMatrix),t.worldMatrixValid=this.worldMatrixValid,t},e.prototype.buildLocalMatrix=function(e,i,a){this.scale.copyFrom(e),this.translation.copyFrom(a),i instanceof t.Vector3D?this.orientation.fromEulerAngles(i.x,i.y,i.z):this.orientation.copyFrom(i),this.localMatrix.makeTransform(this.translation,this.scale,this.orientation)},e.prototype.buildInverseMatrix=function(e,i,a){this.inverseMatrix||(this.inverseMatrix=new t.Matrix4_4),i instanceof t.Vector3D?this.inverseMatrix.recompose([a,i,e]):this.inverseMatrix.makeTransform(a,e,i)},e}();t.Joint=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.joints=[]}return t.prototype.clone=function(){for(var e=new t,i=0;i<this.joints.length;i++)e.joints.push(this.joints[i].clone());return e},Object.defineProperty(t.prototype,"jointNum",{get:function(){return this.joints.length},enumerable:!0,configurable:!0}),t.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},t.prototype.findJointIndex=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},t}();t.Skeleton=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.joints=[]}return e.prototype.clone=function(){var t=new e;t.frameTime=this.frameTime;for(var i=0;i<this.joints.length;i++)t.joints.push(this.joints[i].clone());return t},e.prototype.lerp=function(i,a,r){this.joints=[],this.frameTime=(a.frameTime-i.frameTime)*r+i.frameTime;for(var n=0;n<i.joints.length;++n){var o=i.joints[n],s=a.joints[n],h=new t.Joint(o.name);if(h.name=o.name,h.parent=o.parent,h.parentIndex=o.parentIndex,h.scale.lerp(o.scale,s.scale,r),h.orientation.lerp(o.orientation,s.orientation,r),h.translation.lerp(o.translation,s.translation,r),h.buildLocalMatrix(h.scale,h.orientation,h.translation),h.worldMatrixValid=o.worldMatrixValid,h.worldMatrixValid){var l=o.worldMatrix.decompose(t.Orientation3D.QUATERNION,e._temp_matrixDecomposeA),u=s.worldMatrix.decompose(t.Orientation3D.QUATERNION,e._temp_matrixDecomposeB);e._temp_v0.lerp(l[0],u[0],r),e._temp_q1.x=l[1].x,e._temp_q1.y=l[1].y,e._temp_q1.z=l[1].z,e._temp_q1.w=l[1].w,e._temp_q2.x=u[1].x,e._temp_q2.y=u[1].y,e._temp_q2.z=u[1].z,e._temp_q2.w=u[1].w,e._temp_q0.lerp(e._temp_q1,e._temp_q2,r),e._temp_v1.lerp(l[2],u[2],r),h.worldMatrix.makeTransform(e._temp_v0,e._temp_v1,e._temp_q0)}this.joints.push(h)}return this},e.prototype.calculateJointWorldMatrix=function(){for(var t=0;t<this.joints.length;++t)this.calculateAbsoluteMatrix(t)},e.prototype.calculateAbsoluteMatrix=function(t){var e=this.joints[t];e.parentIndex>=0&&this.calculateAbsoluteMatrix(e.parentIndex),e.worldMatrixValid||(e.worldMatrix.copyFrom(e.localMatrix),e.parentIndex>=0&&e.worldMatrix.append(this.joints[e.parentIndex].worldMatrix),e.worldMatrixValid=!0)},e.prototype.updateGPUCacheData=function(i,a,r){for(var n=0;n<i.joints.length;++n)for(var o=0;o<this.joints.length;++o)if(i.joints[n].name==this.joints[o].name){e._temp_jointMatrix.copyFrom(i.joints[n].inverseMatrix),e._temp_jointMatrix.append(this.joints[o].worldMatrix);var s=e._temp_jointMatrix.decompose(t.Orientation3D.QUATERNION,e._temp_matrixDecomposeA);a[8*n+0]=s[1].x,a[8*n+1]=s[1].y,a[8*n+2]=s[1].z,a[8*n+3]=s[1].w,a[8*n+4]=s[0].x-r.x,a[8*n+5]=s[0].y-r.y,a[8*n+6]=s[0].z-r.z,a[8*n+7]=1;break}return a},e.prototype.findJoint=function(t){for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return this.joints[e];return null},e.prototype.findJointIndex=function(t){if(""==t)return-1;for(var e=0;e<this.joints.length;e++)if(this.joints[e].name==t)return e;return-1},e.prototype.resetWorldMatrix=function(){for(var t=0;t<this.joints.length;t++)this.joints[t].worldMatrixValid=!1},e._temp_v0=new t.Vector3D,e._temp_v1=new t.Vector3D,e._temp_v2=new t.Vector3D,e._temp_q0=new t.Quaternion,e._temp_q1=new t.Quaternion,e._temp_q2=new t.Quaternion,e._temp_jointMatrix=new t.Matrix4_4,e._temp_matrixDecomposeA=[new t.Vector3D,new t.Vector3D,new t.Vector3D],e._temp_matrixDecomposeB=[new t.Vector3D,new t.Vector3D,new t.Vector3D],e}();t.SkeletonPose=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.poseArray=[],this.animationName="",this.sampling=0,this.boneCount=0,this.frameDataOffset=0,this.sourceData=null,this._frameCount=0,this._timeLength=0,this._skeletonPose=null,this._temp_scale=new t.Vector3D,this._temp_translation=new t.Vector3D,this._temp_orientation=new t.Quaternion}return Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonPose},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameCount",{get:function(){return this.poseArray.length>0?this.poseArray.length:this._frameCount},enumerable:!0,configurable:!0}),e.prototype.findJointIndex=function(t){return this._skeletonPose?this._skeletonPose.findJointIndex(t):this.poseArray.length<=0?-1:this.poseArray[0].findJointIndex(t)},e.prototype.addSkeletonPose=function(t){this.poseArray.push(t)},e.prototype.buildInitialSkeleton=function(e,i,a){if(!this._skeletonPose){this._frameCount=a,this._skeletonPose=new t.SkeletonPose;for(var r=0;r<this.boneCount;r++){var n=new t.Joint(e[r]);n.parent=i[r],n.parentIndex=this._skeletonPose.findJointIndex(n.parent),this._skeletonPose.joints.push(n)}this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*(this.frameCount-1),this._timeLength=this.sourceData.readInt()/60/80*1e3}},e.prototype.getSkeletonPose=function(t){return this.poseArray.length>0?this.poseArray[t]:0>t||t>=2*this.frameCount?null:(t=Math.floor(t/2),this.readSkeletonPose(t,this._skeletonPose))},e.prototype.readSkeletonPose=function(t,e){this.sourceData.position=this.frameDataOffset+(40*this.boneCount+4)*t,e.frameTime=this.sourceData.readInt()/60/80*1e3;for(var i=0;i<this.boneCount;i++)this._temp_orientation.x=this.sourceData.readFloat(),this._temp_orientation.y=this.sourceData.readFloat(),this._temp_orientation.z=this.sourceData.readFloat(),this._temp_orientation.w=this.sourceData.readFloat(),this._temp_scale.x=this.sourceData.readFloat(),this._temp_scale.y=this.sourceData.readFloat(),this._temp_scale.z=this.sourceData.readFloat(),this._temp_translation.x=this.sourceData.readFloat(),this._temp_translation.y=this.sourceData.readFloat(),this._temp_translation.z=this.sourceData.readFloat(),e.joints[i].worldMatrixValid=!1,e.joints[i].buildLocalMatrix(this._temp_scale,this._temp_orientation,this._temp_translation);return e.calculateJointWorldMatrix(),e},Object.defineProperty(e.prototype,"timeLength",{get:function(){return this.poseArray.length>0?this.poseArray[this.poseArray.length-1].frameTime:this._timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"jointNum",{get:function(){return this.poseArray.length>0?this.poseArray[0].joints.length:this.boneCount},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=new e;return t.animationName=this.animationName,t.poseArray=this.poseArray,t.sampling=this.sampling,t.boneCount=this.boneCount,t.frameCount=this.frameCount,t.frameDataOffset=this.frameDataOffset,t.sourceData=this.sourceData,t._timeLength=this._timeLength,t._skeletonPose=this._skeletonPose,this._skeletonPose&&(t._skeletonPose=this._skeletonPose.clone()),t},e}();t.SkeletonAnimationClip=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(t){this.name="",this.weight=1,this._skeleton=null,this._timeLength=0,this._timePosition=0,this._skeletonAnimation=null,this._skeletonAnimationClip=null,this.name=t}return Object.defineProperty(e.prototype,"skeleton",{get:function(){return this._skeleton},set:function(t){this._skeleton=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skeletonAnimation",{get:function(){return this._skeletonAnimation},set:function(t){this._skeletonAnimation=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"skeletonAnimationClip",{get:function(){return this._skeletonAnimationClip},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"timeLength",{get:function(){return this._timeLength},enumerable:!0,configurable:!0}),e.prototype.addAnimationClip=function(e){if(e.sourceData)this._skeletonAnimationClip=e,this._timeLength=this._skeletonAnimationClip.timeLength;else{if(this._skeletonAnimationClip?this._skeletonAnimationClip.poseArray=[]:this._skeletonAnimationClip=new t.SkeletonAnimationClip,e.poseArray.length<2)this._skeletonAnimationClip.poseArray=e.poseArray;else{var i=e.poseArray[0],a=e.poseArray[1],r=Math.round((a.frameTime-i.frameTime)/t.SkeletonAnimation.fps);if(1>=r)this._skeletonAnimationClip.poseArray=e.poseArray;else{for(var n=1;n<e.poseArray.length;++n){i=e.poseArray[n-1],a=e.poseArray[n];for(var o=0;r>o;o++){var s=new t.SkeletonPose;s.lerp(i,a,o/r),this._skeletonAnimationClip.poseArray.push(s)}}this._skeletonAnimationClip.poseArray.push(e.poseArray[e.poseArray.length-1].clone())}}this._timeLength=this._skeletonAnimationClip.poseArray[this._skeletonAnimationClip.poseArray.length-1].frameTime}},Object.defineProperty(e.prototype,"timePosition",{get:function(){return this._timePosition},set:function(e){e!=this._timePosition&&(this._timePosition=e,this._skeletonAnimation.isLoop?(this._timePosition=e%this._timeLength,this._timePosition<0&&(this._timePosition+=this._timeLength)):this._timePosition<0?(this._timePosition=0,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.event3D.target=this._skeletonAnimation,this._skeletonAnimation.event3D.eventType=t.SkeletonAnimationEvent3D.EVENT_PLAY_COMPLETE,this._skeletonAnimation.dispatchEvent(this._skeletonAnimation.event3D))):this._timePosition>this._timeLength&&(this._timePosition=this._timeLength,this.name==this._skeletonAnimation.currentAnimName&&(this._skeletonAnimation.stop(),this._skeletonAnimation.event3D.target=this._skeletonAnimation,this._skeletonAnimation.event3D.eventType=t.SkeletonAnimationEvent3D.EVENT_PLAY_COMPLETE,this._skeletonAnimation.dispatchEvent(this._skeletonAnimation.event3D))))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentSkeletonPose",{get:function(){return this._skeletonAnimationClip.getSkeletonPose(this.currentFrameIndex)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"currentFrameIndex",{get:function(){return Math.floor(this._timePosition/t.SkeletonAnimation.fps)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"frameNum",{get:function(){return this._skeletonAnimationClip?this._skeletonAnimationClip.frameCount:0},enumerable:!0,configurable:!0}),e.prototype.getSkeletonPose=function(t){return this._skeletonAnimationClip.getSkeletonPose(t)},e.prototype.clone=function(){var t=new e(this.name);return t._skeleton=this._skeleton,t._timeLength=this._timeLength,t._skeletonAnimation=this._skeletonAnimation,t._skeletonAnimationClip=this._skeletonAnimationClip,t},e}();t.SkeletonAnimationState=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.speed=1,this.event3D=new t.Event3D,this.isLoop=!0,this._isPlay=!1,this._animTime=0,this._skeleton=null,this._animStateNames=[],this._animStates=[],this._skeletonMatrixData=null,this._blendSpeed=300,this._blendSkeleton=null,this._blendList=[],this._bindList={},this._temp_quat=new t.Quaternion,this._temp_vec3=new t.Vector3D,this._currentFrame=0,this._changeFrameTime=0,this._oldFrameIndex=0,this._movePosIndex=-1,this._movePosObject3D=null,this._movePosition=new t.Vector3D,this._resetMovePos=!0,this._isPlay=!1,this._skeleton=i,this._skeletonMatrixData=new Float32Array(8*this._skeleton.jointNum);for(var a=0;a<this._skeleton.jointNum;++a)this._skeletonMatrixData[8*a+3]=1,this._skeletonMatrixData[8*a+7]=1}return __extends(i,e),i.prototype.addSkeletonAnimationClip=function(e){var i=new t.SkeletonAnimationState(e.animationName);i.skeletonAnimation=this,i.skeleton=this._skeleton,i.addAnimationClip(e),this.addAnimState(i)},Object.defineProperty(i.prototype,"skeletonAnimationController",{get:function(){return this},enumerable:!0,configurable:!0}),i.prototype.addAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return;t.skeleton=this._skeleton,this._animStates.push(t),this._animStateNames.push(t.name)
},i.prototype.removeAnimState=function(t){for(var e=0;e<this._animStates.length;e++)if(this._animStates[e].name==t.name)return t.skeleton=null,this._animStates.slice(e,1),void this._animStateNames.slice(e,1)},i.prototype.play=function(t,e,a,r){if(void 0===e&&(e=1),void 0===a&&(a=!0),void 0===r&&(r=!0),!(this._animStates.length<=0)){t||(t=this._animStates[0].name);for(var n=null,o=0;o<this._animStates.length;o++)if(this._animStates[o].name==t){n=this._animStates[o];break}n&&(this._currentAnimName=t,this._blendList.push(n),n.weight=this._blendList.length>1?0:1,a&&(this._animTime=n.timePosition=0),this._changeFrameTime=n.timePosition,this._oldFrameIndex=Math.floor(this._changeFrameTime/i.fps),this.speed=e,this._isPlay=!0,this._resetMovePos=!0,-1!=this._movePosIndex&&this._movePosition.copyFrom(n.getSkeletonPose(0).joints[this._movePosIndex].worldMatrix.position))}},i.prototype.pause=function(){this._isPlay=!1},i.prototype.stop=function(){this._isPlay=!1},i.prototype.update=function(e,a,r){if(this._isPlay&&!(this._blendList.length<=0)){var n=this._blendList[this._blendList.length-1],o=a*this.speed;this._changeFrameTime+=o;for(var s=Math.floor(Math.abs(this._changeFrameTime/i.fps)),h=0;s>h;++h)this.event3D.eventType=t.SkeletonAnimationEvent3D.EVENT_FRAME_CHANGE,this.event3D.target=this,0>o?(this.event3D.data=(this._oldFrameIndex-1-h)%n.frameNum,this.event3D.data<0&&(this.event3D.data+=n.frameNum)):this.event3D.data=(this._oldFrameIndex+1+h)%n.frameNum,this.dispatchEvent(this.event3D),this._changeFrameTime+=o>0?-i.fps:i.fps;this._oldFrameIndex=this.event3D.data,this.animTime+=a*this.speed}},i.prototype.activeState=function(t,e,i,a,r,n,o){i.uniform_time&&r.uniform1f(i.uniform_time.uniformIndex,this.animTime),r.uniform4fv(i.uniform_PoseMatrix.uniformIndex,this._skeletonMatrixData)},i.prototype.clone=function(){var t=new i(this._skeleton);t._blendSpeed=this._blendSpeed,t.isLoop=this.isLoop,t._animStateNames=this._animStateNames.concat([]);for(var e=0;e<this._animStates.length;e++)t._animStates.push(this._animStates[e].clone());return t},Object.defineProperty(i.prototype,"jointNum",{get:function(){return this._skeleton.joints.length},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animStateNames",{get:function(){return this._animStateNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animStates",{get:function(){return this._animStates},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animTime",{get:function(){return this._animTime},set:function(t){if(!(this._blendList.length<=0)&&this._blendList[this._blendList.length-1].timePosition!=t){var e=t-this._animTime;if(this._blendSpeed<=0)this._blendList.length>1&&this._blendList.splice(0,this._blendList.length-1),this._blendList[0].weight=1,this._blendList[0].timePosition+=e;else{for(var i=Math.abs(e/this._blendSpeed),a=0;a<this._blendList.length;++a){var r=this._blendList[a];if(a!=this._blendList.length-1){if(r.weight=Math.max(0,r.weight-i),r.weight<=0){this._blendList.splice(a,1),--a;continue}}else r.weight=Math.min(1,r.weight+i)}this._blendList[this._blendList.length-1].timePosition+=e}this._animTime=this._blendList[this._blendList.length-1].timePosition;var n=this._blendList[0],o=n.currentSkeletonPose;if(this._blendList.length<=1)this.updateBindList(o),this.updateMovePos(o),o.updateGPUCacheData(this._skeleton,this._skeletonMatrixData,this._movePosition);else{var s=this._blendList[1],h=s.currentSkeletonPose;this._blendSkeleton||(this._blendSkeleton=o.clone()),this._blendSkeleton.lerp(o,h,s.weight),this._blendSkeleton.resetWorldMatrix(),this._blendSkeleton.calculateJointWorldMatrix(),this.updateBindList(this._blendSkeleton),this.updateMovePos(this._blendSkeleton),this._blendSkeleton.updateGPUCacheData(this._skeleton,this._skeletonMatrixData,this._movePosition)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"timeLength",{get:function(){return this._blendList.length<=0?0:this._blendList[this._blendList.length-1].timeLength},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"frameIndex",{get:function(){return this.animTime/i.fps},set:function(t){this.animTime=t*i.fps},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"blendSpeed",{get:function(){return this._blendSpeed},set:function(t){this._blendSpeed=Math.max(t,0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"currentAnimName",{get:function(){return this._currentAnimName},enumerable:!0,configurable:!0}),i.prototype.isPlay=function(){return this._isPlay},i.prototype.bindToJointPose=function(t,e){var i=this._animStates[0].skeletonAnimationClip.findJointIndex(t);if(0>i)return!1;var a=null;return this._bindList[i]?a=this._bindList[i]:(a=new Array,this._bindList[i]=a),a.push(e),!0},i.prototype.setMovePosJointName=function(t,e){var i=this._animStates[0].skeletonAnimationClip.findJointIndex(t);return 0>i?!1:(this._movePosIndex=i,this._movePosObject3D=e,this._resetMovePos=!0,!0)},i.prototype.updateBindList=function(t){var e=null,i=null,a=null;for(var r in this._bindList)if(e=this._bindList[r],!(e.length<=0)&&(i=t.joints[r]))for(var n=0;n<e.length;n++)a=e[n],this._temp_quat.fromMatrix(i.worldMatrix),this._temp_quat.toEulerAngles(this._temp_vec3),a.rotationX=this._temp_vec3.x,a.rotationY=this._temp_vec3.y,a.rotationZ=this._temp_vec3.z,a.x=i.worldMatrix.position.x,a.y=i.worldMatrix.position.y,a.z=i.worldMatrix.position.z},i.prototype.updateMovePos=function(t){var e=null;-1!=this._movePosIndex&&(e=t.joints[this._movePosIndex],this._resetMovePos?this._resetMovePos=!1:this._movePosObject3D&&(this._movePosition.x=e.worldMatrix.position.x-this._movePosition.x,this._movePosition.y=0,this._movePosition.z=e.worldMatrix.position.z-this._movePosition.z,this._movePosObject3D.orientation.transformVector(this._movePosition,this._movePosition),this._movePosObject3D.x-=this._movePosition.x,this._movePosObject3D.z-=this._movePosition.z),this._movePosition.copyFrom(e.worldMatrix.position))},i.fps=1e3/60,i}(t.EventDispatcher);t.SkeletonAnimation=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){this.volume=1,this.loop=!1,this.pitch=1,i=i||{},i.volume&&(this.volume=i.volume),i.loop&&(this.loop=i.loop),i.pitch&&(this.pitch=i.pitch),this.sound=e,this.paused=!1,t.AudioManager.instance.hasAudioContext()?(this.context=t.AudioManager.instance.context,this.startTime=0,this.startOffset=0,this.source=null,this.gain=this.context.createGain()):t.AudioManager.instance.hasAudio()&&this.sound.audio&&(this.source=this.sound.audio.cloneNode(!1),this.source.pause())}return e.prototype.play=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)throw new Error("Call stop() before calling play()");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration)}else t.AudioManager.instance.hasAudio&&(this.paused=!1,this.source.play());this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)},e.prototype.pause=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.startOffset+=this.context.currentTime-this.startTime,this.source.stop(0),this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&this.source.pause(),this.paused=!0},e.prototype.unpause=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source||!this.paused)throw new Error("Call pause() before unpausing.");if(this.createSource(),!this.source)return;this.startTime=this.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch)}else t.AudioManager.instance.hasAudio()&&this.source.play();this.paused=!1},e.prototype.stop=function(){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.stop(0),this.startOffset=0,this.source=null):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.pause(),this.source.currentTime=0)},e.prototype.setLoop=function(t){this.source&&(this.source.loop=t)},e.prototype.setVolume=function(e){this.gain?this.gain.gain.value=e*t.AudioManager.instance.volume:this.source&&(this.source.volume=e*t.AudioManager.instance.volume)},e.prototype.setPitch=function(e){t.AudioManager.instance.hasAudioContext()?this.source&&(this.source.playbackRate.value=e):t.AudioManager.instance.hasAudio()&&this.source&&(this.source.playbackRate=e)},e.prototype.isPlaying=function(){return t.AudioManager.instance.hasAudioContext()?!this.paused:t.AudioManager.instance.hasAudio()?!this.source.paused:void 0},e.prototype.getDuration=function(){if(t.AudioManager.instance.hasAudioContext()){if(this.source)return this.source.buffer.duration}else if(t.AudioManager.instance.hasAudio()&&this.source){var e=this.source.duration;if(e===e)return e}return 0},e.prototype.createSource=function(){var t=this;this.sound.buffer&&(this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(this.context.destination),this.loop&&(this.source.onended=function(){return t.play()}))},e}();t.Channel=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){e.call(this,i,a),this._position=new t.Vector3D,this._velocity=new t.Vector3D,t.AudioManager.instance.hasAudioContext()&&(this._panner=this.context.createPanner()),this._maxDistance=1e4,this._minDistance=1,this._rollOffFactor=1,this._listener=new t.Vector3D}return __extends(i,e),Object.defineProperty(i.prototype,"listener",{get:function(){return this._listener},set:function(e){if(this._listener.copyFrom(e),t.AudioManager.instance.hasAudio()&&this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"position",{get:function(){return this._position},set:function(e){if(this._position.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setPosition(e.x,e.y,e.z),t.AudioManager.instance.hasAudio()&&this.source){var i=this.fallOff(this._listener,this.position,this.minDistance,this.maxDistance,this.rollOffFactor);this.source.volume=this.volume*i}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"velocity",{get:function(){return this._velocity},set:function(e){this._velocity.copyFrom(e),t.AudioManager.instance.hasAudioContext()&&this._panner.setVelocity(e.x,e.y,e.z)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.maxDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._minDistance},set:function(e){this._minDistance=e,t.AudioManager.instance.hasAudioContext()&&(this._panner.refDistance=e)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t,this._panner&&(this._panner.rolloffFactor=t)},enumerable:!0,configurable:!0}),i.prototype.createSource=function(){this.sound.buffer&&(this.source=this.context.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this._panner),this._panner.connect(this.gain),this.gain.connect(this.context.destination))},i.prototype.fallOff=function(e,i,a,r,n){var o=t.Vector3D.distance(e,i);return a>o?1:o>r?0:1-o/(r-a)},i}(t.Channel);t.Channel3d=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(a,r,n){var o=this;if(void 0===r&&(r=null),void 0===n&&(n=null),e.call(this),this.audio=null,this._event=new t.Event3D,this._success=r,this._error=n,this.isLoaded=!1,t.AudioManager.instance.hasAudioContext())t.AudioManager.instance.isSupported(a,this.audio)?(console.warn("Audio format not supported"),this._event.eventType=i.SOUND_ERROR,this._event.target=this,this.dispatchEvent(this._event),n(this)):t.AudioManager.instance.context&&this.loadAudioFile(a);else if(t.AudioManager.instance.hasAudio()){try{this.audio=new Audio}catch(s){return console.warn("No support for Audio element"),this._event.eventType=i.SOUND_ERROR,this._event.target=this,this.dispatchEvent(this._event),void(n&&n(this))}t.AudioManager.instance.isSupported(a,this.audio)?(console.warn("Audio format not supported"),this._event.eventType=i.SOUND_ERROR,this._event.target=this,this.dispatchEvent(this._event),n&&n(this)):(this.audio.src=a,this.audio.addEventListener("canplaythrough",function(t){return o.oncanplaythrough(t)}),this.audio.addEventListener("ended",function(t){return o.onended(t)}),this.audio.load())}}return __extends(i,e),Object.defineProperty(i.prototype,"buffer",{get:function(){return this._buffer},enumerable:!0,configurable:!0}),i.prototype.loadAudioFile=function(t){var e=this;null==this.xhr&&(this.xhr=new XMLHttpRequest),this.xhr.open("GET",t,!0),this.xhr.responseType="arraybuffer",this.xhr.onload=function(t){return e.audioLoadend(t)},this.xhr.send()},i.prototype.audioLoadend=function(e){var i=this;t.AudioManager.instance.context.decodeAudioData(this.xhr.response,function(t){return i.decodeSuccessCallback(t)})},i.prototype.decodeSuccessCallback=function(t){this._buffer=t,this._event.eventType=i.SOUND_SUCCESS,this._event.target=this,this._event.data=t,this.dispatchEvent(this._event),this._success&&this._success(this)},i.prototype.onended=function(t){},i.prototype.oncanplaythrough=function(t){this.isLoaded||(this.isLoaded=!0,this._event.eventType=i.SOUND_SUCCESS,this._event.target=this,this._event.data=t,this.dispatchEvent(this._event),this._success&&this._success(this))},i.SOUND_SUCCESS="SoundSuccess",i.SOUND_ERROR="SoundError",i}(t.EventDispatcher);t.Sound=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.volume=1,this.codecs={},this.hasAudioContext()&&"undefined"!=typeof AudioContext&&(this.context=new AudioContext)}return e.prototype.hasAudio=function(){return"undefined"!=typeof Audio},e.prototype.hasAudioContext=function(){return!("undefined"==typeof AudioContext)},e.prototype.isSupported=function(t,e){null==this.codecs&&(null==e&&(e=new Audio),this.codecs={mp3:!!e.canPlayType("audio/mpeg;").replace(/^no$/,""),opus:!!e.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!e.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!e.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),aac:!!e.canPlayType("audio/aac;").replace(/^no$/,""),m4a:!!(e.canPlayType("audio/x-m4a;")||e.canPlayType("audio/m4a;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(e.canPlayType("audio/x-mp4;")||e.canPlayType("audio/mp4;")||e.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!e.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")});var i=t.match(/^data:audio\/([^;,]+);/i);return i||(i=t.split("?",1)[0].match(/\.([^.]+)$/)),i&&(i=i[1].toLowerCase()),this.codecs[i]},e.prototype.createSound=function(e,i,a){return void 0===i&&(i=null),void 0===a&&(a=null),new t.Sound(e,i,a)},e.prototype.playSound=function(e,i){i=i||{};var a=new t.Channel(e,i);return a.play(),a},e.prototype.playSound3d=function(e,i,a){a=a||{};var r=new t.Channel3d(e,a);return r.position=i,a.volume&&(r.volume=a.volume),a.loop&&(r.loop=a.loop),a.maxDistance&&(r.maxDistance=a.maxDistance),a.minDistance&&(r.minDistance=a.minDistance),a.rollOffFactor&&(r.rollOffFactor=a.rollOffFactor),r.play(),r},Object.defineProperty(e,"instance",{get:function(){return null==this._instance&&(this._instance=new e),this._instance},enumerable:!0,configurable:!0}),e}();t.AudioManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=null),void 0===i&&(i=null),this._autoUpdate=!0,this._origin=new t.Vector3D(0,0,0),this._target=e,this._lookAtObject=i}return Object.defineProperty(e.prototype,"target",{get:function(){return this._target},set:function(t){this._target!=t&&(this._target=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"autoUpdate",{get:function(){return this._autoUpdate},set:function(t){this._autoUpdate!=t&&(this._autoUpdate=t)},enumerable:!0,configurable:!0}),e.prototype.notifyUpdate=function(){},e.prototype.update=function(){},e}();t.ControllerBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n){void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=!1),void 0===n&&(n=!1),e.call(this,i),this._origin=new t.Vector3D(0,0,0),this._lookAtPosition=new t.Vector3D,this._eyesPos=new t.Vector3D,this._up=t.Vector3D.Y_AXIS,this._eyesLength=0,this._rotaEyesLine=new t.Vector3D(0,0,1),this._rotaAngle=new t.Vector3D,this._matRot=new t.Matrix4_4,this._quaRot=new t.Quaternion,this._tempVec=new t.Vector3D,this._matTemp=new t.Matrix4_4,this._mouseDown=!1,this._mouseRightDown=!1,this._screenMoveStartDetail=new t.Point,this._screenMoveDelay=new t.Point,this._isUpdate=!1,this._elapsed=0,this._speed=3,this._xAngle=0,this._ctl=!1,this._alt=!1,this._shift=!1,this._needctl=!1,this._needalt=!1,this._needshift=!1,this._keyArray=new Array,this.lookAtOffset=new t.Vector3D(0,0,0),this.firstCamera=!1,this._needctl=r,this._needalt=n,this._keyArray.push(!1),this._keyArray.push(!1),this._keyArray.push(!1),this._keyArray.push(!1),a?this.lookAtObject=a:this.lookAtPosition=new t.Vector3D,this._eyesPos.copyFrom(i.position),this._lookAtPosition.copyFrom(a.position.add(this.lookAtOffset)),this._target.lookAt(this._eyesPos,this._lookAtPosition),t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this),t.Input.addEventListener(t.KeyEvent3D.KEY_UP,this.keyUp,this),t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,this.keyDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.touchUp,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.touchDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this)}return __extends(i,e),i.prototype.scaleSpeed=function(t){this._speed*=t},i.prototype.mouseMove=function(e){this._mouseDown&&(this._needctl?this._ctl:!0)&&(this._rotaAngle.y+=t.Input.mouseOffsetX,this._rotaAngle.x+=t.Input.mouseOffsetY,this._rotaAngle.y%=360,this._rotaAngle.x%=360)},i.prototype.mouseWheel=function(e){this.distance=this._eyesLength-.1*t.Input.wheelDelta},i.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!1;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!1}},i.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!0;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!0}},i.prototype.touchMove=function(t){1==t.targetTouches.length?this.mouseMove(null):this.mouseWheel(null)},i.prototype.touchUp=function(t){this._mouseDown=!1},i.prototype.touchDown=function(t){this._mouseDown=!0},i.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0;break;case t.KeyCode.Key_Q:this._keyArray[4]=!0;break;case t.KeyCode.Key_E:this._keyArray[5]=!0;break;case t.KeyCode.Key_Control_L:this._ctl=!0;break;case t.KeyCode.Key_Alt_L:this._alt=!0}},i.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1;break;case t.KeyCode.Key_Q:this._keyArray[4]=!1;break;case t.KeyCode.Key_E:this._keyArray[5]=!1;break;case t.KeyCode.Key_Control_L:this._ctl=!1;break;case t.KeyCode.Key_Alt_L:this._alt=!1}},Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtObject&&(this._lookAtObject=null),this._lookAtPosition.copyFrom(t.add(this.lookAtOffset)),this.notifyUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lookAtObject",{get:function(){return this._lookAtObject},set:function(t){this._lookAtObject!=t&&(this._lookAtObject=t,this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset)),this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distance",{get:function(){return this._eyesLength},set:function(t){this._eyesLength=t,this._eyesLength<1&&(this._eyesLength=1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationX",{get:function(){return this._rotaAngle.x},set:function(t){this._rotaAngle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationY",{get:function(){return this._rotaAngle.y},set:function(t){this._rotaAngle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rotationZ",{get:function(){return this._rotaAngle.z},set:function(t){this._rotaAngle.z=t},enumerable:!0,configurable:!0}),i.prototype.update=function(){if(this._target){if(0==this._target.isController)return;this._keyArray[0]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[1]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[2]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[3]&&(this._tempVec.copyFrom(this._rotaEyesLine),this._matTemp.identity(),this._matTemp.appendRotation(90,t.Vector3D.Y_AXIS),this._tempVec.copyFrom(this._matTemp.transformVector(this._tempVec)),this._tempVec.y=0,this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[4]&&(this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS)),this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.add(this._tempVec)),this._lookAtObject.position=this._tempVec),this._keyArray[5]&&(this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._tempVec.copyFrom(this._quaRot.transformVector(t.Vector3D.Y_AXIS)),this._tempVec.normalize(),this._tempVec.scaleBy(this._speed),this._tempVec.copyFrom(this._lookAtObject.position.subtract(this._tempVec)),this._lookAtObject.position=this._tempVec),this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,0),this._rotaEyesLine.copyFrom(this._quaRot.transformVector(t.Vector3D.Z_AXIS)),this._rotaEyesLine.normalize(),this._tempVec.copyFrom(this._rotaEyesLine),this._tempVec.scaleBy(this._eyesLength),this._eyesPos.copyFrom(this._lookAtPosition.subtract(this._tempVec)),this._lookAtObject&&this._lookAtPosition.copyFrom(this._lookAtObject.position.add(this.lookAtOffset)),this._quaRot.fromEulerAngles(this._rotaAngle.x,this._rotaAngle.y,this._rotaAngle.z),this._tempVec.copyFrom(this._up),this._tempVec.copyFrom(this._quaRot.transformVector(this._tempVec)),this._tempVec.normalize(),this.firstCamera&&(this._lookAtObject.rotationY=this._rotaAngle.y,this._lookAtObject.rotationX=this._rotaAngle.x),this._target.lookAt(this._eyesPos,this._lookAtPosition,this._tempVec)}},i}(t.ControllerBase);t.LookAtController=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n,o,s,h,l,u,c,d,p){void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=0),void 0===n&&(n=90),void 0===o&&(o=100),void 0===s&&(s=-90),void 0===h&&(h=90),void 0===l&&(l=0/0),void 0===u&&(u=0/0),void 0===c&&(c=8),void 0===d&&(d=2),void 0===p&&(p=!1),e.call(this,i,a),this._currentPanAngle=0,this._currentTiltAngle=90,this._panAngle=0,this._tiltAngle=90,this._distance=1e3,this._minPanAngle=-(1/0),this._maxPanAngle=1/0,this._minTiltAngle=-90,this._maxTiltAngle=90,this._maxDistance=5e3,this._minDistance=-5e3,this._steps=8,this._yFactor=2,this._wrapPanAngle=!1,this._lookAtPosition=new t.Vector3D(0,0,0),this._mouseDown=!1,this._mouseRightDown=!1,this._keyArray=new Array,this.distance=o,this.panAngle=r,this.tiltAngle=n,this.minPanAngle=l||-(1/0),this.maxPanAngle=u||1/0,this.minTiltAngle=s,this.maxTiltAngle=h,this.steps=c,this.yFactor=d,this.wrapPanAngle=p,this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle,t.Input.addEventListener(t.MouseEvent3D.MOUSE_MOVE,this.mouseMove,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_WHEEL,this.mouseWheel,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_UP,this.mouseUp,this),t.Input.addEventListener(t.MouseEvent3D.MOUSE_DOWN,this.mouseDown,this),t.Input.addEventListener(t.KeyEvent3D.KEY_UP,this.keyUp,this),t.Input.addEventListener(t.KeyEvent3D.KEY_DOWN,this.keyDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_END,this.touchUp,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_START,this.touchDown,this),t.Input.addEventListener(t.TouchEvent3D.TOUCH_MOVE,this.touchMove,this)}return __extends(i,e),i.prototype.mouseMove=function(e){this._mouseDown&&(this._tiltAngle+=.1*t.Input.mouseOffsetY,this._tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)),this._panAngle+=.1*t.Input.mouseOffsetX,this._panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},i.prototype.mouseWheel=function(e){this._distance-=.1*t.Input.wheelDelta,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance))},i.prototype.mouseUp=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!1;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!1}},i.prototype.mouseDown=function(e){switch(e.mouseCode){case t.MouseCode.Mouse_Left:this._mouseDown=!0;break;case t.MouseCode.Mouse_Right:this._mouseRightDown=!0}},i.prototype.touchMove=function(t){1==t.targetTouches.length?this.mouseMove(null):this.mouseWheel(null)},i.prototype.touchUp=function(t){this._mouseDown=!1},i.prototype.touchDown=function(t){this._mouseDown=!0},i.prototype.keyDown=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!0;break;case t.KeyCode.Key_A:this._keyArray[1]=!0;break;case t.KeyCode.Key_S:this._keyArray[2]=!0;break;case t.KeyCode.Key_D:this._keyArray[3]=!0}},i.prototype.keyUp=function(e){switch(e.keyCode){case t.KeyCode.Key_W:this._keyArray[0]=!1;break;case t.KeyCode.Key_A:this._keyArray[1]=!1;break;case t.KeyCode.Key_S:this._keyArray[2]=!1;break;case t.KeyCode.Key_D:this._keyArray[3]=!1}},Object.defineProperty(i.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},set:function(t){this._lookAtPosition=t,this.notifyUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"steps",{get:function(){return this._steps},set:function(t){t=1>t?1:t,this._steps!=t&&(this._steps=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"panAngle",{get:function(){return this._panAngle},set:function(t){t=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,t)),this._panAngle!=t&&(this._panAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"tiltAngle",{get:function(){return this._tiltAngle},set:function(t){t=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,t)),this._tiltAngle!=t&&(this._tiltAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"distance",{get:function(){return this._distance},set:function(t){this._distance!=t&&(this._distance=this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,t)),this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minPanAngle",{get:function(){return this._minPanAngle},set:function(t){this._minPanAngle!=t&&(this._minPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxPanAngle",{get:function(){return this._maxPanAngle},set:function(t){this._maxPanAngle!=t&&(this._maxPanAngle=t,this.panAngle=Math.max(this._minPanAngle,Math.min(this._maxPanAngle,this._panAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minTiltAngle",{get:function(){return this._minTiltAngle},set:function(t){this._minTiltAngle!=t&&(this._minTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxTiltAngle",{get:function(){return this._maxTiltAngle},set:function(t){this._maxTiltAngle!=t&&(this._maxTiltAngle=t,this.tiltAngle=Math.max(this._minTiltAngle,Math.min(this._maxTiltAngle,this._tiltAngle)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance!=t&&(this._maxDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minDistance",{get:function(){return this._maxDistance},set:function(t){this._minDistance!=t&&(this._minDistance=t,this._distance=Math.max(this._minDistance,Math.min(this._maxDistance,this._distance)))},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"yFactor",{get:function(){return this._yFactor},set:function(t){this._yFactor!=t&&(this._yFactor=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"wrapPanAngle",{get:function(){return this._wrapPanAngle},set:function(t){this._wrapPanAngle!=t&&(this._wrapPanAngle=t,this.notifyUpdate())},enumerable:!0,configurable:!0}),i.prototype.update=function(e){void 0===e&&(e=!0),(this._tiltAngle!=this._currentTiltAngle||this._panAngle!=this._currentPanAngle)&&(this.notifyUpdate(),this._wrapPanAngle&&(this._panAngle<0?this._panAngle=this._panAngle%360+360:this._panAngle=this._panAngle%360,this._panAngle-this._currentPanAngle<-180?this._currentPanAngle-=360:this._panAngle-this._currentPanAngle>180&&(this._currentPanAngle+=360)),e?(this._currentTiltAngle+=(this._tiltAngle-this._currentTiltAngle)/(this.steps+1),this._currentPanAngle+=(this._panAngle-this._currentPanAngle)/(this.steps+1)):(this._currentPanAngle=this._panAngle,this._currentTiltAngle=this._tiltAngle),Math.abs(this._tiltAngle-this._currentTiltAngle)<.01&&Math.abs(this._panAngle-this._currentPanAngle)<.01&&(this._currentTiltAngle=this._tiltAngle,this._currentPanAngle=this._panAngle));var i=this._lookAtObject?this._lookAtObject.position:this._lookAtPosition?this._lookAtPosition:this._origin,a=new t.Vector3D;a.x=i.x+this.distance*Math.sin(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),a.z=i.z+this.distance*Math.cos(this._currentPanAngle*t.MathUtil.DEGREES_TO_RADIANS)*Math.cos(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS),a.y=i.y+this.distance*Math.sin(this._currentTiltAngle*t.MathUtil.DEGREES_TO_RADIANS)*this.yFactor,this._target&&this._lookAtPosition&&this._target.lookAt(a,this._lookAtPosition)},i}(t.ControllerBase);t.HoverController=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.PixelArray=0]="PixelArray",t[t.CompressData=1]="CompressData",t[t.ImageData=2]="ImageData"
}(t.InternalFormat||(t.InternalFormat={}));t.InternalFormat;!function(t){t[t.shadowFrameBufrfer=0]="shadowFrameBufrfer",t[t.defaultFrameBuffer=1]="defaultFrameBuffer",t[t.positionFrameBuffer=2]="positionFrameBuffer",t[t.normalFrameBuffer=3]="normalFrameBuffer",t[t.specularFrameBuffer=4]="specularFrameBuffer",t[t.leftEyeFrameBuffer=5]="leftEyeFrameBuffer",t[t.rightEyeFrameBuffer=6]="rightEyeFrameBuffer",t[t.nextFrameBuffer=7]="nextFrameBuffer"}(t.FrameBufferType||(t.FrameBufferType={}));t.FrameBufferType;!function(t){t[t.FLOAT_RGB=0]="FLOAT_RGB",t[t.FLOAT_RGBA=1]="FLOAT_RGBA",t[t.UNSIGNED_BYTE_RGB=2]="UNSIGNED_BYTE_RGB",t[t.UNSIGNED_BYTE_RGBA=3]="UNSIGNED_BYTE_RGBA"}(t.FrameBufferFormat||(t.FrameBufferFormat={}));t.FrameBufferFormat;!function(t){t[t.ALPHA=0]="ALPHA",t[t.LAYER=1]="LAYER",t[t.NORMAL=2]="NORMAL",t[t.MULTIPLY=3]="MULTIPLY",t[t.ADD=4]="ADD",t[t.SUB=5]="SUB",t[t.DIV=6]="DIV",t[t.SCREEN=7]="SCREEN",t[t.SOFT_ADD=8]="SOFT_ADD"}(t.BlendMode||(t.BlendMode={}));var e=(t.BlendMode,function(){function t(){}return t}());t.ContextSamplerType=e;var i=function(){function t(){}return t}();t.DrawMode=i;var a=function(){function t(){}return t.Direct3D_Opengl_Auto="Direct3D_Opengl_Auto",t.Direct3D_9_0="Direct3D_9_0",t.Direct3D_10_0="Direct3D_10_0",t.Direct3D_11_0="Direct3D_11_0",t.OpenGLES_2_0="OpenGLES_2_0",t.OpenGLES_3_0="OpenGLES_3_0",t.OpenGL="OpenGL",t.ColorFormat_DXT1_RGB=0,t.ColorFormat_DXT1_RGBA=0,t.ColorFormat_DXT3_RGBA=0,t.ColorFormat_DXT5_RGBA=0,t}();t.ContextConfig=a}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.isLost=!1,this.DEPTH_TEST=!1,this.CULL_FACE=!1,this.BLEND=!1,this.blend_Factors_src=-1,this.blend_Factors_dst=-1,this.cullingMode=-1,this.depthCompareMode=-1,this.vertexFormat=-1}return e.prototype.register=function(){var i;i=e.gl.getExtension("WEBGL_depth_texture")||e.gl.getExtension("MOZ_WEBGL_depth_texture")||e.gl.getExtension("WEBKIT_WEBGL_depth_texture"),i=e.gl.getExtension("EXT_texture_filter_anisotropic")||e.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),i=e.gl.getExtension("WEBGL_compressed_texture_s3tc")||e.gl.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),i=e.gl.getExtension("WEBGL_compressed_texture_pvrtc")||e.gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),i=e.gl.getExtension("WEBGL_compressed_texture_etc1"),i=e.gl.getExtension("OES_element_index_uint"),i=e.gl.getExtension("WEBGL_compressed_texture_s3tc"),i=e.gl.getExtension("OES_texture_float_linear"),i=e.gl.getExtension("OES_texture_float"),i=e.gl.getExtension("OES_texture_half_float"),i=e.gl.getExtension("OES_texture_half_float_linear"),i=e.gl.getExtension("OES_standard_derivatives"),i=e.gl.getExtension("GL_OES_standard_derivatives"),i=e.gl.getExtension("WEBGL_draw_buffers"),i=e.gl.getExtension("WEBGL_depth_texture"),i=e.gl.getExtension("WEBGL_lose_context"),t.ContextConfig.BLEND=e.gl.BLEND,t.DrawMode.TRIANGLES=e.gl.TRIANGLES,t.DrawMode.POINTS=e.gl.POINTS,t.DrawMode.LINES=e.gl.LINES,t.DrawMode.LINE_STRIP=e.gl.LINE_STRIP,t.ContextConfig.FLOAT=e.gl.FLOAT,t.ContextConfig.VERTEX_SHADER=e.gl.VERTEX_SHADER,t.ContextConfig.FRAGMENT_SHADER=e.gl.FRAGMENT_SHADER,t.ContextConfig.FRONT=e.gl.FRONT,t.ContextConfig.BACK=e.gl.BACK,t.ContextConfig.FRONT_AND_BACK=e.gl.FRONT_AND_BACK,t.ContextConfig.DEPTH_BUFFER_BIT=e.gl.DEPTH_BUFFER_BIT,t.ContextConfig.ELEMENT_ARRAY_BUFFER=e.gl.ELEMENT_ARRAY_BUFFER,t.ContextConfig.UNSIGNED_SHORT=e.gl.UNSIGNED_SHORT,t.ContextConfig.NEAREST=e.gl.NEAREST,t.ContextConfig.REPEAT=e.gl.REPEAT,t.ContextConfig.ONE=e.gl.ONE,t.ContextConfig.ZERO=e.gl.ZERO,t.ContextConfig.SRC_ALPHA=e.gl.SRC_ALPHA,t.ContextConfig.ONE_MINUS_SRC_ALPHA=e.gl.ONE_MINUS_SRC_ALPHA,t.ContextConfig.SRC_COLOR=e.gl.SRC_COLOR,t.ContextConfig.ONE_MINUS_SRC_COLOR=e.gl.ONE_MINUS_SRC_COLOR,t.ContextConfig.ColorFormat_RGB565=e.gl.RGB565,t.ContextConfig.ColorFormat_RGBA5551=e.gl.RGB5_A1,t.ContextConfig.ColorFormat_RGBA4444=e.gl.RGBA4,t.ContextConfig.ColorFormat_RGBA8888=e.gl.RGBA,t.ContextConfig.DEPTH_TEST=e.gl.DEPTH_TEST,t.ContextConfig.CULL_FACE=e.gl.CULL_FACE,t.ContextConfig.BLEND=e.gl.BLEND,t.ContextConfig.LEQUAL=e.gl.LEQUAL,i&&(t.ContextConfig.ColorFormat_DXT1_RGB=i.COMPRESSED_RGB_S3TC_DXT1_EXT,t.ContextConfig.ColorFormat_DXT1_RGBA=i.COMPRESSED_RGBA_S3TC_DXT1_EXT,t.ContextConfig.ColorFormat_DXT3_RGBA=i.COMPRESSED_RGBA_S3TC_DXT3_EXT,t.ContextConfig.ColorFormat_DXT5_RGBA=i.COMPRESSED_RGBA_S3TC_DXT5_EXT),t.ContextSamplerType.TEXTURE_0=e.gl.TEXTURE0,t.ContextSamplerType.TEXTURE_1=e.gl.TEXTURE1,t.ContextSamplerType.TEXTURE_2=e.gl.TEXTURE2,t.ContextSamplerType.TEXTURE_3=e.gl.TEXTURE3,t.ContextSamplerType.TEXTURE_4=e.gl.TEXTURE4,t.ContextSamplerType.TEXTURE_5=e.gl.TEXTURE5,t.ContextSamplerType.TEXTURE_6=e.gl.TEXTURE6,t.ContextSamplerType.TEXTURE_7=e.gl.TEXTURE7,t.ContextSamplerType.TEXTURE_8=e.gl.TEXTURE8,console.log("requst GPU Config",e.gl),t.ShaderPool.register(this)},e.prototype.viewPort=function(i,a,r,n){e.gl.viewport(i,t.ContextConfig.canvasRectangle.height-n-a,r,n)},e.prototype.creatProgram=function(i,a){var r=e.gl.createProgram();e.gl.attachShader(r,i.shader),e.gl.attachShader(r,a.shader),e.gl.linkProgram(r);var n=e.gl.getProgramParameter(r,e.gl.LINK_STATUS);n||(alert("vsShader error"+e.gl.getShaderInfoLog(i.shader)),alert("fsShader error"+e.gl.getShaderInfoLog(a.shader)));var o=new t.Program3D(r);return o},e.prototype.creatIndexBuffer=function(i){var a=new Int16Array(i),r=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,r),e.gl.bufferData(e.gl.ELEMENT_ARRAY_BUFFER,a,e.gl.STATIC_DRAW);var n=new t.IndexBuffer3D(r);return n.arrayBuffer=a,n},e.prototype.uploadIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer),e.gl.bufferData(e.gl.ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)},e.prototype.creatVertexBuffer=function(i,a){void 0===a&&(a=e.gl.STATIC_DRAW);var r=new Float32Array(i),n=e.gl.createBuffer();e.gl.bindBuffer(e.gl.ARRAY_BUFFER,n),e.gl.bufferData(e.gl.ARRAY_BUFFER,r,a);var o=new t.VertexBuffer3D(n);return o.arrayBuffer=r,o},e.prototype.uploadVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer),e.gl.bufferData(e.gl.ARRAY_BUFFER,t.arrayBuffer,e.gl.DYNAMIC_DRAW)},e.prototype.texParameteri=function(t,i,a){e.gl.texParameteri(t,i,a)},e.prototype.upLoadTextureData=function(i,a){e.gl.bindTexture(e.gl.TEXTURE_2D,a.texture2D.textureBuffer),a.texture2D.internalFormat==t.InternalFormat.ImageData?(e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,e.gl.RGBA,a.texture2D.dataFormat,a.texture2D.imageData),delete a.texture2D.imageData):a.texture2D.internalFormat==t.InternalFormat.CompressData?this.upLoadCompressedTexture2D(i,a.texture2D):a.texture2D.internalFormat==t.InternalFormat.PixelArray&&e.gl.texImage2D(e.gl.TEXTURE_2D,i,a.texture2D.colorFormat,a.texture2D.mimapData[i].width,a.texture2D.mimapData[i].height,a.texture2D.border,a.texture2D.colorFormat,a.texture2D.dataFormat,a.texture2D.mimapData[i].data),a.useMipmap&&e.gl.generateMipmap(e.gl.TEXTURE_2D)},e.prototype.upLoadCompressedTexture2D=function(t,i){e.gl.compressedTexImage2D(e.gl.TEXTURE_2D,t,i.colorFormat,i.mimapData[t].width,i.mimapData[t].height,i.border,i.mimapData[t].data)},e.prototype.creatTexture2D=function(){var i=new t.Texture2D;return i.textureBuffer=e.gl.createTexture(),i},e.prototype.creatCubeTexture=function(){var i=new t.Texture3D;return i.texture=e.gl.createTexture(),i},e.prototype.uploadCubetexture=function(t){e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,t.texture),t.image_right.mimapData&&t.image_right.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,t.image_right.mimapData[0].width,t.image_right.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_right.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_X,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_left.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,t.image_up.mimapData[0].width,t.image_up.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_up.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,t.image_down.mimapData[0].width,t.image_down.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_down.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,t.image_back.mimapData[0].width,t.image_back.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_POSITIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_back.imageData),t.image_left.mimapData&&t.image_left.mimapData.length>0?e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,t.image_front.mimapData[0].width,t.image_front.mimapData[0].height,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.mimapData[0].data):e.gl.texImage2D(e.gl.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,e.gl.RGB,e.gl.RGB,e.gl.UNSIGNED_BYTE,t.image_front.imageData),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MAG_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_MIN_FILTER,e.gl.LINEAR),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_CUBE_MAP,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE)},e.prototype.createFramebuffer=function(i,a,r){var n=e.gl.createFramebuffer(),o=this.creatTexture2D(),s=e.gl.createRenderbuffer();e.gl.bindTexture(e.gl.TEXTURE_2D,o.textureBuffer);for(var h=new Float32Array(4096),l=0;1024>l;l++)h[l]=1,h[l+1]=1,h[l+2]=1,h[l+3]=1;switch(r){case t.FrameBufferFormat.UNSIGNED_BYTE_RGB:e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGB,i,a,0,e.gl.RGB,e.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.UNSIGNED_BYTE_RGBA:e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,i,a,0,e.gl.RGBA,e.gl.UNSIGNED_BYTE,null);break;case t.FrameBufferFormat.FLOAT_RGB:e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGB,i,a,0,e.gl.RGB,e.gl.FLOAT,h);break;case t.FrameBufferFormat.FLOAT_RGBA:e.gl.texImage2D(e.gl.TEXTURE_2D,0,e.gl.RGBA,i,a,0,e.gl.RGBA,e.gl.FLOAT,h)}return e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MAG_FILTER,e.gl.NEAREST),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_MIN_FILTER,e.gl.NEAREST),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_S,e.gl.CLAMP_TO_EDGE),e.gl.texParameteri(e.gl.TEXTURE_2D,e.gl.TEXTURE_WRAP_T,e.gl.CLAMP_TO_EDGE),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,n),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,o.textureBuffer,0),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,s),e.gl.renderbufferStorage(e.gl.RENDERBUFFER,e.gl.DEPTH_COMPONENT16,i,a),o.width=i,o.height=a,o.frameBuffer=n,o.renderbuffer=s,e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.gl.bindTexture(e.gl.TEXTURE_2D,null),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,null),o},e.prototype.setRenderToTexture=function(t,i,a){void 0===i&&(i=!1),void 0===a&&(a=0),e.gl.viewport(0,0,t.width,t.height),e.gl.scissor(0,0,t.width,t.height),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,t.frameBuffer),e.gl.clearColor(0,0,0,1),e.gl.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.gl.framebufferTexture2D(e.gl.FRAMEBUFFER,e.gl.COLOR_ATTACHMENT0,e.gl.TEXTURE_2D,t.textureBuffer,0),e.gl.framebufferRenderbuffer(e.gl.FRAMEBUFFER,e.gl.DEPTH_ATTACHMENT,e.gl.RENDERBUFFER,t.renderbuffer)},e.prototype.setRenderToBackBuffer=function(){e.gl.bindTexture(e.gl.TEXTURE_2D,null),e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.gl.bindRenderbuffer(e.gl.RENDERBUFFER,null)},e.prototype.creatVertexShader=function(i){var a=e.gl.createShader(e.gl.VERTEX_SHADER);e.gl.shaderSource(a,i),e.gl.compileShader(a);var r=new t.Shader(a);return r.id=(t.Shader.ID_COUNT++).toString(),r},e.prototype.creatFragmentShader=function(i){var a=e.gl.createShader(e.gl.FRAGMENT_SHADER);e.gl.shaderSource(a,i),e.gl.compileShader(a);var r=new t.Shader(a);return r.id=(t.Shader.ID_COUNT++).toString(),r},e.prototype.clear=function(t){e.gl.clear(t)},e.prototype.clearColor=function(t,i,a,r){e.gl.clearColor(t,i,a,r)},e.prototype.clearStencil=function(t){e.gl.clearStencil(t)},e.prototype.setProgram=function(t){this.programChange=!1,this.program!=t&&(this.programChange=!0,this.program=t,e.gl.useProgram(t.program))},e.prototype.getUniformLocation=function(t,i){return e.gl.getUniformLocation(t.program,i)},e.prototype.uniform1f=function(t,i){e.gl.uniform1f(t,i)},e.prototype.uniform1fv=function(t,i){e.gl.uniform1fv(t,i)},e.prototype.uniform1i=function(t,i){e.gl.uniform1i(t,i)},e.prototype.uniform1iv=function(t,i){e.gl.uniform1iv(t,i)},e.prototype.uniform2f=function(t,i,a){e.gl.uniform2f(t,i,a)},e.prototype.uniform2fv=function(t,i){e.gl.uniform2fv(t,i)},e.prototype.uniform2i=function(t,i,a){e.gl.uniform2i(t,i,a)},e.prototype.uniform2iv=function(t,i){e.gl.uniform2iv(t,i)},e.prototype.uniform3f=function(t,i,a,r){e.gl.uniform3f(t,i,a,r)},e.prototype.uniform3fv=function(t,i){e.gl.uniform3fv(t,i)},e.prototype.uniform3i=function(t,i,a,r){e.gl.uniform3i(t,i,a,r)},e.prototype.uniform3iv=function(t,i){e.gl.uniform3iv(t,i)},e.prototype.uniform4f=function(t,i,a,r,n){e.gl.uniform4f(t,i,a,r,n)},e.prototype.uniform4fv=function(t,i){e.gl.uniform4fv(t,i)},e.prototype.uniform4i=function(t,i,a,r,n){e.gl.uniform4i(t,i,a,r,n)},e.prototype.uniform4iv=function(t,i){e.gl.uniform4iv(t,i)},e.prototype.uniformMatrix2fv=function(t,i,a){e.gl.uniformMatrix2fv(t,i,a)},e.prototype.uniformMatrix3fv=function(t,i,a){e.gl.uniformMatrix3fv(t,i,a)},e.prototype.uniformMatrix4fv=function(t,i,a){e.gl.uniformMatrix4fv(t,i,a)},e.prototype.setBlendFactors=function(t,i){(this.blend_Factors_src!=t||this.blend_Factors_dst!=i)&&(this.blend_Factors_src=t,this.blend_Factors_dst=i,e.gl.blendFunc(t,i))},e.prototype.setCulling=function(t){this.cullingMode!=t&&(this.cullingMode=t,e.gl.cullFace(t))},e.prototype.enableDepth=function(){this.DEPTH_TEST||(this.DEPTH_TEST=!0,e.gl.enable(t.ContextConfig.DEPTH_TEST))},e.prototype.disableDepth=function(){this.DEPTH_TEST&&(this.DEPTH_TEST=!1,e.gl.disable(t.ContextConfig.DEPTH_TEST))},e.prototype.enableCullFace=function(){this.CULL_FACE||(this.CULL_FACE=!0,e.gl.enable(t.ContextConfig.CULL_FACE))},e.prototype.disableCullFace=function(){this.CULL_FACE&&(this.CULL_FACE=!1,e.gl.disable(t.ContextConfig.CULL_FACE))},e.prototype.enableBlend=function(){e.gl.enable(t.ContextConfig.BLEND)},e.prototype.disableBlend=function(){e.gl.disable(t.ContextConfig.BLEND)},e.prototype.depthFunc=function(t){void 0===t&&(t=0),this.depthCompareMode!=t&&(this.depthCompareMode=t,e.gl.depthFunc(t))},e.prototype.enableDepthTest=function(t,i){void 0===i&&(i=0),t&&e.gl.enable(e.gl.DEPTH_TEST)},e.prototype.getShaderAttribLocation=function(t,i){return e.gl.getAttribLocation(t.program,i)},e.prototype.vertexAttribPointer=function(t,i,a,r,n,o){e.gl.vertexAttribPointer(t,i,a,r,n,o),e.gl.enableVertexAttribArray(t)},e.prototype.clearVaPointer=function(t){e.gl.disableVertexAttribArray(t)},e.prototype.isActiveVertexFormat=function(t){return!1},e.prototype.activeVertexFormat=function(t){this.vertexFormat=t},e.prototype.unActiveVertexFormat=function(){this.vertexFormat=-1;for(var t=0;12>t;t++)this.clearVaPointer(t)},e.prototype.setVertexShaderConstData=function(t,i,a){e.gl.vertexAttrib4fv(i,t.subarray(i,a))},e.prototype.setFragmentShaderConstData=function(t,e,i){},e.prototype.setTexture2DAt=function(t,i,a,r){e.gl.activeTexture(t),e.gl.bindTexture(e.gl.TEXTURE_2D,r.textureBuffer),e.gl.uniform1i(i,a)},e.prototype.disableTexture2DAt=function(t,e,i){},e.prototype.setCubeTextureAt=function(t,i,a,r){r&&(e.gl.activeTexture(t),e.gl.bindTexture(e.gl.TEXTURE_CUBE_MAP,r.texture),e.gl.uniform1i(i,a))},e.prototype.setScissorRectangle=function(i,a,r,n){e.gl.scissor(i,t.ContextConfig.canvasRectangle.height-n-a,r,n)},e.prototype.setStencilReferenceValue=function(){},e.prototype.setStencilActions=function(t,e,i,a,r){},e.prototype.bindVertexBuffer=function(t){e.gl.bindBuffer(e.gl.ARRAY_BUFFER,t.buffer)},e.prototype.bindIndexBuffer=function(t){e.gl.bindBuffer(e.gl.ELEMENT_ARRAY_BUFFER,t.buffer)},e.prototype.drawArrays=function(t,i,a){e.gl.drawArrays(t,i,a)},e.prototype.drawElement=function(t,i,a){e.gl.drawElements(t,a,e.gl.UNSIGNED_SHORT,i)},e.prototype.flush=function(){e.gl.flush()},e}();t.Context3DProxy=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.FrameBuffer=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this.buffer=t}return t}();t.IndexBuffer3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this.buffer=t}return t}();t.VertexBuffer3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e,i){this.data=t,this.width=e,this.height=i}return t}();t.MipmapData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this.program=t}return t}();t.Program3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.border=0,this.imageData=null,this.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,this.dataFormat=t.Context3DProxy.gl.UNSIGNED_BYTE,this.internalFormat=t.InternalFormat.PixelArray,this.mimapData=new Array}return e}();t.Texture2D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this._shader=t}return Object.defineProperty(t.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),t.vertex=0,t.fragment=1,t.ID_COUNT=0,t}();t.Shader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.border=0,this.useMipmap=!0,this.colorformat=t.ContextConfig.ColorFormat_RGBA8888,this.internalformat=t.InternalFormat.PixelArray,this.mimapData=new Array}return e}();t.Texture3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.BoundPick=0]="BoundPick",t[t.PositionPick=1]="PositionPick",t[t.UVPick=2]="UVPick"}(t.PickType||(t.PickType={}));var e=t.PickType,i=function(i){function a(){i.call(this),this._modelMatrix3D=new t.Matrix4_4,this._transformChange=!0,this._pos=new t.Vector3D,this._rot=new t.Vector3D,this._sca=new t.Vector3D(1,1,1),this._orientation=new t.Quaternion,this._axis=new t.Vector3D,this._angle=0,this._globalPos=new t.Vector3D,this._globalRot=new t.Vector3D,this._globalSca=new t.Vector3D(1,1,1),this._globalOrientation=new t.Quaternion,this._qut=new t.Quaternion,this._vec=new t.Vector3D,this._active=!1,this._isRoot=!0,this.canPick=!1,this.renderLayer=0,this.name="",this.id=0,this.layer=0,this.tag=new t.Tag,this.parent=null,this.childs=new Array,this.isController=!0,this.isDisable=!1,this.visible=!0,this.pickType=e.BoundPick,this.pickResult=new t.PickResult,this.enablePick=!1,this.mouseChilder=!1,this.enableCulling=!0,this.id=++a.s_id}return __extends(a,i),Object.defineProperty(a.prototype,"bound",{get:function(){return this._bound},set:function(t){this._bound=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"currentBound",{get:function(){return this.mouseChilder?this.bound.childBound:this.bound},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"position",{get:function(){return this._pos},set:function(t){this.updateTransformChange(!0),this._pos.copyFrom(t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotation",{get:function(){return this._rot},set:function(t){this._rot.x=t.x,this._rot.y=t.y,this._rot.z=t.z,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientation",{get:function(){return this._orientation},set:function(t){this._orientation.copyFrom(t),this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationX",{set:function(t){this._orientation.x=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationY",{set:function(t){this._orientation.y=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationZ",{set:function(t){this._orientation.z=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"orientationW",{set:function(t){this._orientation.w=t,this._orientation.toEulerAngles(this._rot),this._angle=this._orientation.toAxisAngle(this._axis),this.updateTransformChange(!0)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scale",{get:function(){return this._sca},set:function(t){this.updateTransformChange(!0),this._sca=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"x",{get:function(){return this._pos.x},set:function(t){this.updateTransformChange(!0),this._pos.x!=t&&(this._pos.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"y",{get:function(){return this._pos.y},set:function(t){this.updateTransformChange(!0),this._pos.y!=t&&(this._pos.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"z",{get:function(){return this._pos.z},set:function(t){this.updateTransformChange(!0),this._pos.z!=t&&(this._pos.z=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationX",{get:function(){return this._rot.x},set:function(t){this.updateTransformChange(!0),this._rot.x!=t&&(this._rot.x=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationY",{get:function(){return this._rot.y},set:function(t){this.updateTransformChange(!0),this._rot.y!=t&&(this._rot.y=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"rotationZ",{get:function(){return this._rot.z},set:function(t){this.updateTransformChange(!0),this._rot.z!=t&&(this._rot.z=t,this._orientation.fromEulerAngles(this._rot.x,this._rot.y,this._rot.z),this._angle=this._orientation.toAxisAngle(this._axis))},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleX",{get:function(){return this._sca.x},set:function(t){this.updateTransformChange(!0),this._sca.x!=t&&(this._sca.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleY",{get:function(){return this._sca.y},set:function(t){this.updateTransformChange(!0),this._sca.y!=t&&(this._sca.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"scaleZ",{get:function(){return this._sca.z},set:function(t){this.updateTransformChange(!0),this._sca.z!=t&&(this._sca.z=t)},enumerable:!0,configurable:!0}),a.prototype.setRotationFromAxisAngle=function(t,e){t.normalize(),this.updateTransformChange(!0),this._orientation.fromAxisAngle(t,e),this._orientation.toEulerAngles(this._rot),this._axis.copyFrom(t),this._angle=e},Object.defineProperty(a.prototype,"modelMatrix",{get:function(){return this._transformChange&&this.updateModelMatrix(),this._modelMatrix3D},set:function(e){var i=e.decompose(t.Orientation3D.QUATERNION);this.globalPosition=i[0],t.MathUtil.CALCULATION_QUATERNION.x=i[1].x,t.MathUtil.CALCULATION_QUATERNION.y=i[1].y,t.MathUtil.CALCULATION_QUATERNION.z=i[1].z,t.MathUtil.CALCULATION_QUATERNION.w=i[1].w,this.globalOrientation=t.MathUtil.CALCULATION_QUATERNION,this.globalScale=i[2]},enumerable:!0,configurable:!0}),a.prototype.updateModelMatrix=function(){if(null!=this.parent){var t=this.parent.globalOrientation;this._globalOrientation.multiply(t,this._orientation),this._globalOrientation.toEulerAngles(this._globalRot);var e=this.parent.globalScale;this._globalSca.copyFrom(e.multiply(this._sca)),t.transformVector(e.multiply(this._pos),this._globalPos),this._globalPos.copyFrom(this._globalPos.add(this.parent.globalPosition))}else this._globalOrientation.copyFrom(this._orientation),this._globalPos.copyFrom(this._pos),this._globalSca.copyFrom(this._sca),this._globalRot.copyFrom(this._rot);this.onMakeTransform(),this.onUpdateTransform(),this._transformChange=!1},a.prototype.onUpdateTransform=function(){},a.prototype.onMakeTransform=function(){this._modelMatrix3D.makeTransform(this._globalPos,this._globalSca,this._globalOrientation)},Object.defineProperty(a.prototype,"globalX",{get:function(){return this.globalPosition.x},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.x=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalY",{get:function(){return this.globalPosition.y},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.y=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalZ",{get:function(){return this.globalPosition.z},set:function(t){this._vec.copyFrom(this.globalPosition),this._vec.z=t,this.globalPosition=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalPosition",{get:function(){return this._transformChange&&this.modelMatrix,this._globalPos},set:function(t){this.parent?(this.parent.globalOrientation.inverse(this._qut),t.subtract(this.parent.globalPosition,this._vec),this._qut.transformVector(this._vec,this._vec),this._vec.divided(this.parent.globalScale,this._vec),this.position=this._vec):this.position=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationX",{get:function(){return this.globalRotation.x},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.x=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationY",{get:function(){return this.globalRotation.y},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.y=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotationZ",{get:function(){return this.globalRotation.z},set:function(t){this._vec.copyFrom(this.globalRotation),this._vec.z=t,this.globalRotation=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalRotation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalRot},set:function(t){this._qut.fromEulerAngles(t.x,t.y,t.z),this.globalOrientation=this._qut},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScale",{get:function(){return this._transformChange&&this.modelMatrix,this._globalSca},set:function(t){this.parent?(t.divided(this.parent.globalScale,this._vec),this.scale=this._vec):this.scale=t},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleX",{get:function(){return this.globalScale.x},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.x=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleY",{get:function(){return this.globalScale.y},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.y=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalScaleZ",{get:function(){return this.globalScale.z},set:function(t){this._vec.copyFrom(this.globalScale),this._vec.z=t,this.globalScale=this._vec},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"globalOrientation",{get:function(){return this._transformChange&&this.modelMatrix,this._globalOrientation},set:function(t){this.parent?(this.parent.globalOrientation.inverse(this._qut),this._qut.multiply(this._qut,t),this.orientation=this._qut):this.orientation=t},enumerable:!0,configurable:!0}),a.prototype.addChild=function(t){if(t.parent)throw Error("This object is already the other child object.");if(this.childs.indexOf(t)>=0)throw Error("The same child object has been added.");return this.childs.push(t),a.renderListChange=!0,t.parent=this,t._isRoot=!1,t.updateTransformChange(!0),t},a.prototype.addChildAt=function(t,e){return 0>e?this.childs.splice(0,0,t):e>=this.childs.length?this.childs.push(t):this.childs.splice(e,0,t),t.parent=this,t.updateTransformChange(!0),t},a.prototype.getChildAt=function(t){return 0>t||t>=this.childs.length?null:this.childs[t]},a.prototype.getChildIndex=function(t){for(var e=0;e<this.childs.length;++e)if(this.childs[e]==t)return e;return-1},a.prototype.removeChild=function(t){for(var e=0;e<this.childs.length;++e)if(this.childs[e]==t)return t.parent=null,this.childs.splice(e,1),t;return t.updateTransformChange(!0),null},a.prototype.removeChildAt=function(t){if(0>t||t>=this.childs.length)return null;var e=this.childs[t];return e.parent=null,this.childs.splice(t,1),e.updateTransformChange(!0),e},a.prototype.setChildIndex=function(t,e){for(var i=0;i<this.childs.length;++i)if(this.childs[i]==t){if(i==e)return;if(e>i)for(var a=i;a>e;--a)this.childs[a]=this.childs[a-1];else if(i>e)for(var a=i;e>a;++a)this.childs[a]=this.childs[a+1];return void(this.childs[e]=t)}},a.prototype.swapObject=function(t){for(var e=t.parent,i=new Array,a=0;a<t.childs.length;++a)i[a]=t.childs[a];if(this.parent){var r=this.parent.getChildIndex(this);this.parent.childs[r]=t}if(t.parent){var r=t.parent.getChildIndex(t);t.parent.childs[r]=this}t.parent=this.parent,this.parent=e,t.childs.length=0;for(var a=0;a<this.childs.length;++a)t.childs[a]=this.childs[a],t.childs[a].parent=t;this.childs.length=0;for(var a=0;a<i.length;++a)this.childs[a]=i[a],this.childs[a].parent=this;this.updateTransformChange(!0),t.updateTransformChange(!0)},a.prototype.swapChildren=function(t,e){for(var i=0,a=0;i<this.childs.length;++i)if(this.childs[i]==t){for(;a<this.childs.length;++a)if(this.childs[a]==e){var r=this.childs[i];this.childs[i]=this.childs[a],this.childs[a]=r;break}return}},a.prototype.swapChildrenAt=function(t,e){if(!(0>t||t>=this.childs.length||0>e||e>=this.childs.length)){var i=this.childs[t];this.childs[t]=this.childs[e],this.childs[e]=i}},a.prototype.lookAt=function(e,i,a){void 0===a&&(a=t.Vector3D.Y_AXIS)},Object.defineProperty(a.prototype,"lookAtPosition",{get:function(){return new t.Vector3D},enumerable:!0,configurable:!0}),a.prototype.findObject3D=function(t){for(var e=null,i=0;i<this.childs.length;++i){if(this.childs[i].name==t)return e=this.childs[i];if(e=this.childs[i].findObject3D(t))return e}return e},a.prototype.findObject3DToID=function(t){for(var e=null,i=0;i<this.childs.length;++i){if(this.childs[i].id==t)return e=this.childs[i];if(e=this.childs[i].findObject3DToID(t))return e}return e},a.prototype.updateTransformChange=function(t){this._transformChange=t;for(var e=0;e<this.childs.length;++e)this.childs[e].updateTransformChange(t)},a.prototype.bindAnimation=function(t){this.proAnimation=t,this.proAnimation.bindObject3D(this)},a.prototype.update=function(t,e,i){this.proAnimation&&this.proAnimation.update(e)},a.prototype.dispose=function(){this.parent&&this.parent.removeChild(this);for(var t=0;t<this.childs.length;t++)this.childs[t].dispose()},a.renderListChange=!0,a.s_id=0,a}(t.EventDispatcher);t.Object3D=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.type="",this.multiMaterial={},this._materialCount=0,this.animation=null
}return __extends(e,t),Object.defineProperty(e.prototype,"drawOrder",{get:function(){return 0},enumerable:!0,configurable:!0}),e.prototype.update=function(e,i,a){t.prototype.update.call(this,e,i,a)},e}(t.Object3D);t.IRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e}(t.Object3D);t.Entity=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===r&&(r=null),e.call(this),this.type="mesh",this.geometry=i,r?this.animation=r:i&&this.geometry.vertexFormat&t.VertexFormat.VF_SKIN&&(this.animation=new t.SkeletonAnimation(this.geometry.skeleton)),this.material=a?a:new t.TextureMaterial,this.addSubMaterial(0,this.material),this.bound=this.buildBoundBox()}return __extends(i,e),i.prototype.setMaterialByID=function(){},Object.defineProperty(i.prototype,"aabb",{get:function(){return this._aabbBox},enumerable:!0,configurable:!0}),i.prototype.initAABB=function(){this._aabbBox=new t.QuadAABB;var e=this.bound;this._aabbBox.maxPosX=e.max.x,this._aabbBox.maxPosY=e.max.z,this._aabbBox.minPosX=e.min.x,this._aabbBox.minPosY=e.min.z},Object.defineProperty(i.prototype,"isTriangle",{get:function(){return!1},enumerable:!0,configurable:!0}),i.prototype.onUpdateTransform=function(){this._aabbBox.setOffset(this._pos)},Object.defineProperty(i.prototype,"lightGroup",{set:function(t){this._lightGroup=t;for(var e in this.multiMaterial)this.multiMaterial[e].lightGroup=this._lightGroup},enumerable:!0,configurable:!0}),i.prototype.addSubMaterial=function(t,e){this.multiMaterial[t]||this._materialCount++,this.multiMaterial[t]=e,e.lightGroup=this._lightGroup},i.prototype.removeSubMaterial=function(t){this.multiMaterial[t]&&(delete this.multiMaterial[t],this._materialCount--)},i.prototype.getMaterial=function(t){return this.multiMaterial[t]},i.prototype.materialCount=function(){return this._materialCount},i.prototype.clone=function(){var t=null;this.animation&&(t=this.animation.clone());var e=new i(this.geometry,this.material,t);return e.multiMaterial=this.multiMaterial,e},i.prototype.update=function(t,i,a){e.prototype.update.call(this,t,i,a),this.isDisable||(this.animation&&this.animation.update(t,i,this.geometry),this.geometry.subGeometrys.length<=0&&this.geometry.buildDefaultSubGeometry())},i.prototype.buildBoundBox=function(){if(!this.geometry)return null;var e=new t.BoundBox(this);e.min.copyFrom(new t.Vector3D(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),e.max.copyFrom(new t.Vector3D(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE));for(var i=0;i<this.geometry.verticesData.length;i+=this.geometry.vertexAttLength)e.max.x<this.geometry.verticesData[i]&&(e.max.x=this.geometry.verticesData[i]),e.max.y<this.geometry.verticesData[i+1]&&(e.max.y=this.geometry.verticesData[i+1]),e.max.z<this.geometry.verticesData[i+2]&&(e.max.z=this.geometry.verticesData[i+2]),e.min.x>this.geometry.verticesData[i]&&(e.min.x=this.geometry.verticesData[i]),e.min.y>this.geometry.verticesData[i+1]&&(e.min.y=this.geometry.verticesData[i+1]),e.min.z>this.geometry.verticesData[i+2]&&(e.min.z=this.geometry.verticesData[i+2]);return e.fillBox(e.min,e.max),e.createChild(),this.bound=e,this.initAABB(),e},i}(t.IRender);t.Mesh=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n){void 0===a&&(a=null),void 0===r&&(r=100),void 0===n&&(n=100),null==a&&(a=new t.PlaneGeometry(r,n,1,1,1,1,t.Vector3D.Z_AXIS)),e.call(this,a,i),this.bound||(this.bound=this.buildBoundBox())}return __extends(i,e),i.prototype.update=function(t,e,i){this.globalOrientation=i.globalOrientation},i}(t.Mesh);t.Billboard=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===r&&(r=null),e.call(this,i,a),this.camera=r,a.cullMode=t.ContextConfig.FRONT,a.ambientColor=16777215,this.bound||(this.bound=this.buildBoundBox())}return __extends(i,e),i.prototype.update=function(t,i,a){e.prototype.update.call(this,t,i,a),this.camera&&(this.position=this.camera.globalPosition)},i}(t.Mesh);t.Sky=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this,new t.Geometry,new t.ColorMaterial(16711680)),this.material.drawMode=t.DrawMode.LINES,this.geometry.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0}return __extends(i,e),i}(t.Mesh);t.Wireframe=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.pointlight=0]="pointlight",t[t.directlight=1]="directlight",t[t.spotLightlight=2]="spotLightlight"}(t.LightType||(t.LightType={}));var e=(t.LightType,function(e){function i(){e.call(this),this.lightId=-1,this.lightType=-1,this._ambient=new t.Vector3D(0,0,0),this._diffuse=new t.Vector3D(1,1,1),this._specular=new t.Vector3D(1,1,1),this._halfVector=new t.Vector3D(1,1,1),this._intensity=1,this._radius=100,this._falloff=100,this._halfIntensity=0,this._spotExponent=1.1,this._spotCutoff=.7,this._spotCosCutoff=.1,this._constantAttenuation=.1,this._linearAttenuation=.1,this._quadraticAttenuation=.1,this._lightIndex=-1,this.len=25,this._change=!0,this.lightViewPos=new t.Vector3D}return __extends(i,e),Object.defineProperty(i.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!=t&&(this._intensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"halfIntensity",{get:function(){return this._halfIntensity},set:function(t){this._halfIntensity!=t&&(this._halfIntensity=t,this._change=!1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"ambient",{get:function(){return 0},set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"diffuse",{get:function(){return 0},set:function(t){this._diffuse.w=(t>>24&255)/255,this._diffuse.x=(t>>16&255)/255,this._diffuse.y=(t>>8&255)/255,this._diffuse.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"specular",{get:function(){return 0},set:function(t){this._specular.w=(t>>24&255)/255,this._specular.x=(t>>16&255)/255,this._specular.y=(t>>8&255)/255,this._specular.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),i.prototype.init=function(){},i.prototype.updateLightData=function(t,e,i){},i}(t.Object3D));t.LightBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.scenePosMat=new t.Matrix4_4,this.lightType=t.LightType.pointlight,this.diffuse=i}return __extends(i,e),Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"falloff",{get:function(){return this._falloff},set:function(t){this._falloff=t},enumerable:!0,configurable:!0}),i.prototype.updateLightData=function(t,e,a){a[e*i.stride]=this.globalPosition.x,a[e*i.stride+1]=this.globalPosition.y,a[e*i.stride+2]=this.globalPosition.z,a[e*i.stride+3]=this._diffuse.x*this._intensity,a[e*i.stride+4]=this._diffuse.y*this._intensity,a[e*i.stride+5]=this._diffuse.z*this._intensity},i.scenePos=new t.Vector3D,i.stride=6,i}(t.LightBase);t.PointLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.diffuse=i,this.lightType=t.LightType.spotLightlight}return __extends(i,e),Object.defineProperty(i.prototype,"spotCosCutoff",{get:function(){return this._spotCosCutoff},set:function(t){this._spotCosCutoff=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"spotExponent",{get:function(){return this._spotExponent},set:function(t){this._spotExponent=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"constantAttenuation",{get:function(){return this._constantAttenuation},set:function(t){this._constantAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"linearAttenuation",{get:function(){return this._linearAttenuation},set:function(t){this._linearAttenuation=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"quadraticAttenuation",{get:function(){return this._quadraticAttenuation},set:function(t){this._quadraticAttenuation=t},enumerable:!0,configurable:!0}),i.prototype.updateLightData=function(e,a,r){r[a*i.stride]=this.globalPosition.x,r[a*i.stride+1]=this.globalPosition.y,r[a*i.stride+2]=this.globalPosition.z,r[a*i.stride+3]=this.globalRotation.x*t.MathUtil.DEGREES_TO_RADIANS,r[a*i.stride+4]=this.globalRotation.y*t.MathUtil.DEGREES_TO_RADIANS,r[a*i.stride+5]=this.globalRotation.z*t.MathUtil.DEGREES_TO_RADIANS,r[a*i.stride+6]=this._diffuse.x,r[a*i.stride+7]=this._diffuse.y,r[a*i.stride+8]=this._diffuse.z,r[a*i.stride+9]=this._spotExponent,r[a*i.stride+10]=this._spotCosCutoff,r[a*i.stride+11]=this._constantAttenuation,r[a*i.stride+12]=this._linearAttenuation,r[a*i.stride+13]=this._quadraticAttenuation},i.stride=14,i}(t.LightBase);t.SpotLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),i.normalize(),this.lightType=t.LightType.directlight,this._rot.x=i.x,this._rot.y=i.y,this._rot.z=i.z}return __extends(i,e),Object.defineProperty(i.prototype,"ambient",{set:function(t){this._ambient.w=(t>>24&255)/255,this._ambient.x=(t>>16&255)/255,this._ambient.y=(t>>8&255)/255,this._ambient.z=(255&t)/255,this._change=!1},enumerable:!0,configurable:!0}),i.prototype.updateLightData=function(t,e,a){a[e*i.stride+0]=this._rot.x,a[e*i.stride+1]=this._rot.y,a[e*i.stride+2]=this._rot.z,a[e*i.stride+3]=this._diffuse.x*this._intensity,a[e*i.stride+4]=this._diffuse.y*this._intensity,a[e*i.stride+5]=this._diffuse.z*this._intensity},i.stride=6,i}(t.LightBase);t.DirectLight=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.lightNum=0,this.directLightList=new Array,this.spotLightList=new Array,this.pointLightList=new Array}return e.prototype.addLight=function(e){switch(e.lightType){case t.LightType.directlight:this.directLightList.push(e),this.lightNum++;break;case t.LightType.pointlight:this.pointLightList.push(e),this.lightNum++;break;case t.LightType.spotLightlight:this.spotLightList.push(e),this.lightNum++}},e.prototype.removeLight=function(e){switch(e.lightType){case t.LightType.directlight:var i=this.directLightList.indexOf(e);i>=0&&i<this.directLightList.length&&(this.directLightList.splice(i,1),this.lightNum--);break;case t.LightType.pointlight:var i=this.pointLightList.indexOf(e);i>=0&&i<this.pointLightList.length&&(this.pointLightList.splice(i,1),this.lightNum--);break;case t.LightType.spotLightlight:var i=this.spotLightList.indexOf(e);i>=0&&i<this.spotLightList.length&&(this.spotLightList.splice(i,1),this.lightNum--)}},e}();t.LightGroup=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._num=0,this._objDict={},this.renderList=new Array,this.mousePickList=new Array,this._nodes=new Array}return Object.defineProperty(t.prototype,"root",{get:function(){return this.rootScene},set:function(t){this.rootScene=t},enumerable:!0,configurable:!0}),t.prototype.update=function(t){this.renderList=this._nodes,this.renderList.length=0,t.frustum.update(t)},t.prototype.findRenderObject=function(t){for(var e=0;e<this.renderList.length;++e)if(this.renderList[e]===t)return e;return-1},t}();t.CollectBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.softRenderItems={},this.numberVertex=0,this.numberFace=0,this.numberDraw=0,this.numberSkin=0,this.numberAnimation=0,this.numberParticle=0}return __extends(i,e),i.prototype.applyRender=function(t,e){if(t.visible){t.material&&this.addRenderList(t,e);for(var i=0;i<t.childs.length;i++)this.applyRender(t.childs[i],e)}},i.prototype.addRenderList=function(e,i){if(!e.enableCulling||i.isVisibleToCamera(e)){if(e.material){if("normalObject"==e.tag.name&&e.material.materialData.alphaBlending)this.softRenderItems.alphaObject.push(e);else for(var a=0;a<t.Layer.layerNumber;a++)e.tag.name==t.Layer.layerType[a]&&this.softRenderItems[t.Layer.layerType[a]].push(e);t.Egret3DEngine.debug&&(this.numberFace+=e.geometry.faceCount,this.numberVertex+=e.geometry.vertexCount,this.numberDraw+=1,e.animation&&(this.numberSkin+=1),e.proAnimation&&(this.numberAnimation+=1),"particleEmit"==e.type&&(this.numberParticle+=1))}e.enablePick&&this.mousePickList.push(e)}},i.prototype.update=function(i){if(e.prototype.update.call(this,i),this.numberFace=0,this.numberVertex=0,this.numberDraw=0,this.numberSkin=0,this.numberAnimation=0,this.numberParticle=0,this.clearLayerList(),this.renderList.length=0,this.mousePickList.length=0,this.rootScene.quad){var a=i.frustum.box,r=this.rootScene.quad.getNodesByAABB(a.min.x,a.min.z,a.max.x,a.max.z);this.appendQuadList(r,i)}else this.applyRender(this.rootScene.root,i);for(var n,o=0;o<t.Layer.layerType.length;o++){n=this.softRenderItems[t.Layer.layerType[o]].length,this.softRenderItems[t.Layer.layerType[o]].sort(this.sortByOrder);for(var s=0;n>s;s++)this.renderList.push(this.softRenderItems[t.Layer.layerType[o]][s])}},i.prototype.appendQuadList=function(e,i){for(var a,r,n=0,o=e;n<o.length;n++)r=o[n],r instanceof t.Mesh&&(a=r,a&&a.visible&&a.material&&this.addRenderList(a,i))},i.prototype.clearLayerList=function(){for(var e=0;e<t.Layer.layerType.length;e++)this.softRenderItems[t.Layer.layerType[e]]?this.softRenderItems[t.Layer.layerType[e]].length=0:this.softRenderItems[t.Layer.layerType[e]]=[]},i.prototype.sort=function(e,i,a){var r=t.Vector3D.distance(e.globalPosition,a.position),n=t.Vector3D.distance(i.globalPosition,a.position);return r>n?-1:n>r?1:0},i.prototype.sortByOrder=function(t,e){return e.drawOrder-t.drawOrder},i}(t.CollectBase);t.EntityCollect=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._vtxNum=8,this._planeNum=6,this._tempVector=new t.Vector3D,this._vertex=new Array;for(var e=0;e<this._vtxNum;++e)this._vertex.push(new t.Vector3D);this._pos=new t.Vector3D,this._plane=new Array;for(var e=0;6>e;++e)this._plane.push(new t.Plane3D);this.box=new t.BoundBox(null,new t.Vector3D,new t.Vector3D),this.center=new t.Vector3D}return e.prototype.makeFrustum=function(t,e,i,a){var r=Math.tan(t/2*(Math.PI/180)),n=i*r,o=n*e,s=a*r,h=s*e;this._vertex[0].x=o,this._vertex[0].y=n,this._vertex[0].z=i,this._vertex[1].x=-o,this._vertex[1].y=n,this._vertex[1].z=i,this._vertex[2].x=-o,this._vertex[2].y=-n,this._vertex[2].z=i,this._vertex[3].x=o,this._vertex[3].y=-n,this._vertex[3].z=i,this._vertex[4].x=h,this._vertex[4].y=s,this._vertex[4].z=a,this._vertex[5].x=-h,this._vertex[5].y=s,this._vertex[5].z=a,this._vertex[6].x=-h,this._vertex[6].y=-s,this._vertex[6].z=a,this._vertex[7].x=h,this._vertex[7].y=-s,this._vertex[7].z=a},e.prototype.update=function(e){this.makeFrustum(e.fieldOfView,e.aspectRatio,e.near,e.far);var i=new Array,a=t.Matrix4_4.helpMatrix;a.copyFrom(e.modelMatrix),this._curVer=i;for(var r=0;r<this._vtxNum;++r)i.push(a.transformVector(this._vertex[r]));this.box.max.x=this.box.max.y=this.box.max.z=-Number.MAX_VALUE,this.box.min.x=this.box.min.y=this.box.min.z=Number.MAX_VALUE;for(var r=0;r<i.length;++r)this.box.max.x<i[r].x&&(this.box.max.x=i[r].x),this.box.max.y<i[r].y&&(this.box.max.y=i[r].y),this.box.max.z<i[r].z&&(this.box.max.z=i[r].z),this.box.min.x>i[r].x&&(this.box.min.x=i[r].x),this.box.min.y>i[r].y&&(this.box.min.y=i[r].y),this.box.min.z>i[r].z&&(this.box.min.z=i[r].z);this.box.calculateBox(),this._plane[0].fromPoints(i[4],i[5],i[6]),this._plane[1].fromPoints(i[1],i[6],i[5]),this._plane[2].fromPoints(i[0],i[4],i[7]),this._plane[3].fromPoints(i[1],i[0],i[3]),this._plane[4].fromPoints(i[1],i[5],i[4]),this._plane[5].fromPoints(i[3],i[7],i[6]);for(var r=0;r<this._planeNum;r++)this._plane[r].normalize();var n=new t.Vector3D;n.copyFrom(i[0].subtract(i[2])),n.scaleBy(.5),n.copyFrom(i[2].add(n));var o=new t.Vector3D;o.copyFrom(i[4].subtract(i[6])),o.scaleBy(.5),o.copyFrom(i[6].add(o)),this.center.copyFrom(o.subtract(n)),this.center.scaleBy(.5),this.center.copyFrom(n.add(this.center))},e.prototype.inPoint=function(t){for(var e=0,i=0;i<this._plane.length;++i)if(e=this._plane[i].distance(t),e>0)return!1;return!0},e.prototype.inSphere=function(t,e){for(var i=0,a=0;a<this._plane.length;++a)if(i=this._plane[a].distance(t),i>e)return!1;return!0},e.prototype.inBox=function(t){for(var e=0,i=this._plane.length,a=0;i>a;++a){for(var r=t.vexData.length/3,n=t.vexData.length,o=0;n>o;o+=3)this._tempVector.setTo(t.vexData[o],t.vexData[o+1],t.vexData[o+2]),this._tempVector.copyFrom(t.transform.transformVector(this._tempVector)),e=this._plane[a].distance(this._tempVector),e>0&&r--;if(0>=r)return!1}return!0},e}();t.Frustum=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.layerType=["normalObject","normalAlphaObject","alphaObject","effect","gui"],t.layerTypeThan=[3,2,1,0],t.layerNumber=5,t}();t.Layer=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.name="normalObject",this.clearDepth=!1}return t}();t.Tag=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.pickObject3DList=function(e,i,a,r,n){void 0===r&&(r=!1),void 0===n&&(n=null),n||(n=new Array),n.length=0;var o=this.ray;if(t.Input.mouseX<i.x||t.Input.mouseX>s+i.width||t.Input.mouseY<i.y||t.Input.mouseY>h+i.height)return n;var s=t.Input.mouseX-i.x,h=t.Input.mouseY-i.y;o.CalculateAndTransformRay(i.width,i.height,i.camera3D.modelMatrix,i.camera3D.projectMatrix,s,h);for(var l=0;l<a.length;++l){var u=a[l];new t.Vector3D;switch(u.pickType){case t.PickType.BoundPick:if(null!=u.bound){var c=u.bound;r?(c=u.currentBound,c&&o.IntersectMesh(c.vexData,c.indexData,c.vexLength,c.indexData.length/3,0,u.modelMatrix,u.pickResult)&&n.push(a[l])):o.IntersectMesh(c.vexData,c.indexData,c.vexLength,c.indexData.length/3,0,u.modelMatrix,u.pickResult)&&n.push(a[l])}break;case t.PickType.PositionPick:var d=0;u.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(d+=t.Geometry.positionSize),u.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(d+=t.Geometry.normalSize),u.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(d+=t.Geometry.tangentSize),u.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(d+=t.Geometry.colorSize),o.IntersectMeshEx(u,d,u.pickResult)&&n.push(a[l]);break;case t.PickType.UVPick:var d=0;u.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(d+=t.Geometry.positionSize),u.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(d+=t.Geometry.normalSize),u.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(d+=t.Geometry.tangentSize),u.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(d+=t.Geometry.colorSize),o.IntersectMeshEx(u,d,u.pickResult)&&n.push(a[l])}}return n},e.ray=new t.Ray,e}();t.Picker=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.normal_geometry=0]="normal_geometry",t[t.skin_geometry=1]="skin_geometry",t[t.particle_geometry=2]="particle_geometry"}(t.GeometryType||(t.GeometryType={}));t.GeometryType;!function(t){t[t.VF_POSITION=1]="VF_POSITION",t[t.VF_NORMAL=2]="VF_NORMAL",t[t.VF_TANGENT=4]="VF_TANGENT",t[t.VF_COLOR=8]="VF_COLOR",t[t.VF_UV0=16]="VF_UV0",t[t.VF_UV1=32]="VF_UV1",t[t.VF_SKIN=64]="VF_SKIN"}(t.VertexFormat||(t.VertexFormat={}));var e=t.VertexFormat,i=function(){function i(){this.geomtryType=-1,this._vertexFormat=0,this.vertexAttLength=0,this.verticesData=new Array,this.indexData=new Array,this.source_positionData=new Array,this.source_normalData=new Array,this.source_tangentData=new Array,this.source_colorData=new Array,this.source_uvData=new Array,this.source_uv2Data=new Array,this.source_SkinData=new Array,this.faceOrBack=!1,this.subGeometrys=new Array,this._bufferDiry=!0,this._vertexCount=-1}return Object.defineProperty(i.prototype,"vertexCount",{get:function(){return this._vertexCount<0&&(this._vertexCount=this.verticesData.length/this.vertexAttLength),this._vertexCount},set:function(t){this._vertexCount=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"faceCount",{get:function(){return this.indexData.length/3},enumerable:!0,configurable:!0}),i.prototype.buildDefaultSubGeometry=function(){var e=new t.SubGeometry;e.matID=0,e.geometry=this,e.start=0,e.count=this.indexData?this.indexData.length:0,this.subGeometrys.push(e)},Object.defineProperty(i.prototype,"vertexFormat",{get:function(){return this._vertexFormat},set:function(t){this._vertexFormat=t,this.vertexFormat&e.VF_POSITION&&(this.vertexAttLength+=i.positionSize),this.vertexFormat&e.VF_NORMAL&&(this.vertexAttLength+=i.normalSize),this.vertexFormat&e.VF_TANGENT&&(this.vertexAttLength+=i.tangentSize),this.vertexFormat&e.VF_COLOR&&(this.vertexAttLength+=i.colorSize),this.vertexFormat&e.VF_UV0&&(this.vertexAttLength+=i.uvSize),this.vertexFormat&e.VF_UV1&&(this.vertexAttLength+=i.uv2Size),this.vertexFormat&e.VF_SKIN&&(this.vertexAttLength+=i.skinSize),this.vertexSizeInBytes=4*this.vertexAttLength},enumerable:!0,configurable:!0}),i.prototype.calculateVertexFormat=function(){this.vertexCount=this.source_positionData.length/i.positionSize;for(var t=0;t<this.vertexCount;++t)if(this.vertexFormat&e.VF_POSITION&&(this.verticesData.push(this.source_positionData[t*i.positionSize]),this.verticesData.push(this.source_positionData[t*i.positionSize+1]),this.verticesData.push(this.source_positionData[t*i.positionSize+2])),this.vertexFormat&e.VF_NORMAL&&(this.verticesData.push(this.source_normalData[t*i.normalSize]),this.verticesData.push(this.source_normalData[t*i.normalSize+1]),this.verticesData.push(this.source_normalData[t*i.normalSize+2])),this.vertexFormat&e.VF_TANGENT&&(this.verticesData.push(this.source_tangentData[t*i.tangentSize]),this.verticesData.push(this.source_tangentData[t*i.tangentSize+1]),this.verticesData.push(this.source_tangentData[t*i.tangentSize+2])),this.vertexFormat&e.VF_COLOR&&(this.verticesData.push(this.source_colorData[t*i.colorSize]),this.verticesData.push(this.source_colorData[t*i.colorSize+1]),this.verticesData.push(this.source_colorData[t*i.colorSize+2]),this.verticesData.push(this.source_colorData[t*i.colorSize+3])),this.vertexFormat&e.VF_UV0&&(this.verticesData.push(this.source_uvData[t*i.uvSize]),this.verticesData.push(this.source_uvData[t*i.uvSize+1])),this.vertexFormat&e.VF_UV1&&(this.verticesData.push(this.source_uv2Data[t*i.uv2Size]),this.verticesData.push(this.source_uv2Data[t*i.uv2Size+1])),this.vertexFormat&e.VF_SKIN)for(var a=0;a<i.skinSize;++a)this.verticesData.push(this.source_SkinData[t*i.skinSize+a])},i.prototype.activeState=function(t,e,i,a){this._bufferDiry&&(this._bufferDiry=!1,this.upload(i)),i.bindVertexBuffer(this.sharedVertexBuffer),i.bindIndexBuffer(this.sharedIndexBuffer)},i.prototype.upload=function(e,i){void 0===i&&(i=t.Context3DProxy.gl.STATIC_DRAW),this.sharedIndexBuffer||this.sharedVertexBuffer?(this.sharedVertexBuffer.arrayBuffer.set(this.verticesData),e.uploadVertexBuffer(this.sharedVertexBuffer)):(this.sharedIndexBuffer=e.creatIndexBuffer(this.indexData),this.sharedVertexBuffer=e.creatVertexBuffer(this.verticesData,i))},i.prototype.getVertexForIndex=function(t,a,r){if(void 0===r&&(r=null),r||(r=new Array),0>t||t>=this.verticesData.length)return r;var n=0;if(this.vertexFormat&e.VF_POSITION&&(a&e.VF_POSITION&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1]),r.push(this.verticesData[t*this.vertexAttLength+n+2])),n+=i.positionSize),this.vertexFormat&e.VF_NORMAL&&(a&e.VF_NORMAL&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1]),r.push(this.verticesData[t*this.vertexAttLength+n+2])),n+=i.normalSize),this.vertexFormat&e.VF_TANGENT&&(a&e.VF_TANGENT&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1]),r.push(this.verticesData[t*this.vertexAttLength+n+2])),n+=i.tangentSize),this.vertexFormat&e.VF_COLOR&&(a&e.VF_COLOR&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1]),r.push(this.verticesData[t*this.vertexAttLength+n+2]),r.push(this.verticesData[t*this.vertexAttLength+n+3])),n+=i.colorSize),this.vertexFormat&e.VF_UV0&&(a&e.VF_UV0&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1])),n+=i.uvSize),this.vertexFormat&e.VF_UV1&&(a&e.VF_UV1&&(r.push(this.verticesData[t*this.vertexAttLength+n+0]),r.push(this.verticesData[t*this.vertexAttLength+n+1])),n+=i.uv2Size),this.vertexFormat&e.VF_SKIN){if(a&e.VF_SKIN)for(var o=0;o<i.skinSize;++o)r.push(this.verticesData[t*this.vertexAttLength+n+o]);n+=i.skinSize}return r},i.prototype.setVerticesForIndex=function(t,a,r,n){void 0===n&&(n=1);for(var o=0,s=0,h=0;n>h;++h){if(o=0,this.vertexFormat&e.VF_POSITION&&(a&e.VF_POSITION?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],this.verticesData[t*this.vertexAttLength+o+2]=r[s+2],s+=i.positionSize):(this.verticesData[t*this.vertexAttLength+o+0]=0,this.verticesData[t*this.vertexAttLength+o+1]=0,this.verticesData[t*this.vertexAttLength+o+2]=0),o+=i.positionSize),this.vertexFormat&e.VF_NORMAL&&(a&e.VF_NORMAL?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],this.verticesData[t*this.vertexAttLength+o+2]=r[s+2],s+=i.normalSize):(this.verticesData[t*this.vertexAttLength+o+0]=0,this.verticesData[t*this.vertexAttLength+o+1]=0,this.verticesData[t*this.vertexAttLength+o+2]=0),o+=i.normalSize),this.vertexFormat&e.VF_TANGENT&&(a&e.VF_TANGENT?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],this.verticesData[t*this.vertexAttLength+o+2]=r[s+2],s+=i.tangentSize):(this.verticesData[t*this.vertexAttLength+o+0]=0,this.verticesData[t*this.vertexAttLength+o+1]=0,this.verticesData[t*this.vertexAttLength+o+2]=0),o+=i.tangentSize),this.vertexFormat&e.VF_COLOR&&(a&e.VF_COLOR?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],this.verticesData[t*this.vertexAttLength+o+2]=r[s+2],this.verticesData[t*this.vertexAttLength+o+3]=r[s+3],s+=i.colorSize):(this.verticesData[t*this.vertexAttLength+o+0]=1,this.verticesData[t*this.vertexAttLength+o+1]=1,this.verticesData[t*this.vertexAttLength+o+2]=1,this.verticesData[t*this.vertexAttLength+o+3]=1),o+=i.colorSize),this.vertexFormat&e.VF_UV0&&(a&e.VF_UV0?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],s+=i.uvSize):(this.verticesData[t*this.vertexAttLength+o+0]=0,this.verticesData[t*this.vertexAttLength+o+1]=0),o+=i.uvSize),this.vertexFormat&e.VF_UV1&&(a&e.VF_UV1?(this.verticesData[t*this.vertexAttLength+o+0]=r[s+0],this.verticesData[t*this.vertexAttLength+o+1]=r[s+1],s+=i.uv2Size):(this.verticesData[t*this.vertexAttLength+o+0]=0,this.verticesData[t*this.vertexAttLength+o+1]=0),o+=i.uv2Size),this.vertexFormat&e.VF_SKIN){if(a&e.VF_SKIN){for(var l=0;l<i.skinSize;++l)this.verticesData[t*this.vertexAttLength+o+l]=r[s+l];s+=i.skinSize}else for(var l=0;l<i.skinSize;++l)this.verticesData[t*this.vertexAttLength+o+l]=0;o+=i.skinSize}t++}},i.prototype.getVertexIndices=function(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=null),i||(i=new Array),-1==e?e=this.indexData.length:e;for(var a=0;e-t>a;++a)i[a]=this.indexData[a+t];return i},i.prototype.setVertexIndices=function(t,e){for(var i=0;i<e.length;++i)this.indexData[t+i]=e[i]},i.positionSize=3,i.normalSize=3,i.tangentSize=3,i.colorSize=4,i.uvSize=2,i.uv2Size=2,i.skinSize=8,i}();t.Geometry=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.vertexAttLength=17,this.vertLen=0,this.faces=0,this.source_indexData=new Array,this.source_vertexData=new Array,this.source_vertexColorData=new Array,this.source_normalData=new Array,this.source_tangtData=new Array,this.source_uvData=new Array,this.source_uv2Data=new Array,this.source_skinData=new Array,this.vertexIndex=0,this.indices=new Array,this.vertices=new Array,this.normals=new Array,this.tangts=new Array,this.verticesColor=new Array,this.uvs=new Array,this.uv2s=new Array,this.skinMesh=new Array,this.faceNormals=new Array,this.faceWeights=new Array,this.vertexIndices=new Array,this.uvIndices=new Array,this.uv2Indices=new Array,this.normalIndices=new Array,this.colorIndices=new Array,this.indexIds=new Array,this.matCount=0,this.material={}}return e.buildGeomtry=function(e,i){var a=new t.Geometry;a.vertexFormat=i,a.skeleton=e.skeleton;for(var r=new t.Vector3D,n=new t.Vector3D(1,1,1),o=new t.Vector3D(1,1,1,1),s=new t.UV(1,0),h=new t.UV(1,0),l=0,u=0;u<e.faces;u++){a.indexData.push(3*u+0,3*u+2,3*u+1);for(var c=0;3>c;c++)l=e.vertexIndices[3*u+c]*t.Geometry.positionSize,r.x=e.source_vertexData[l+0],r.y=e.source_vertexData[l+1],r.z=e.source_vertexData[l+2],e.normalIndices&&e.source_normalData&&e.source_normalData.length>0&&(l=e.normalIndices[3*u+c]*t.Geometry.normalSize,n.x=e.source_normalData[l+0],n.y=e.source_normalData[l+1],n.z=e.source_normalData[l+2]),e.colorIndices&&e.source_vertexColorData&&e.source_vertexColorData.length>0&&(l=e.colorIndices[3*u+c]*t.Geometry.colorSize,o.x=e.source_vertexColorData[l+0],o.y=e.source_vertexColorData[l+1],o.z=e.source_vertexColorData[l+2],o.w=e.source_vertexColorData[l+3]),e.uvIndices&&e.source_uvData&&e.source_uvData.length>0&&(l=e.uvIndices[3*u+c]*t.Geometry.uvSize,s.u=e.source_uvData[l+0],s.v=e.source_uvData[l+1]),e.uv2Indices&&e.source_uv2Data&&e.source_uv2Data.length>0&&(l=e.uv2Indices[3*u+c]*t.Geometry.uvSize,h.u=e.source_uv2Data[l+0],h.v=e.source_uv2Data[l+1]),i&t.VertexFormat.VF_POSITION&&(a.source_positionData.push(r.x),a.source_positionData.push(r.y),a.source_positionData.push(r.z)),i&t.VertexFormat.VF_NORMAL&&(a.source_normalData.push(n.x),a.source_normalData.push(n.y),a.source_normalData.push(n.z)),i&t.VertexFormat.VF_TANGENT&&(a.source_tangentData.push(0),a.source_tangentData.push(0),a.source_tangentData.push(0)),i&t.VertexFormat.VF_COLOR&&(a.source_colorData.push(o.x),a.source_colorData.push(o.y),a.source_colorData.push(o.z),a.source_colorData.push(o.w)),i&t.VertexFormat.VF_UV0&&(a.source_uvData.push(s.u),a.source_uvData.push(s.v)),i&t.VertexFormat.VF_UV1&&(a.source_uv2Data.push(h.u),a.source_uv2Data.push(h.v)),i&t.VertexFormat.VF_SKIN&&(null!=e.source_skinData&&e.source_skinData.length>0?(l=e.vertexIndices[3*u+c]*t.Geometry.skinSize,a.source_SkinData.push(e.source_skinData[l+0],e.source_skinData[l+2],e.source_skinData[l+4],e.source_skinData[l+6],e.source_skinData[l+1],e.source_skinData[l+3],e.source_skinData[l+5],e.source_skinData[l+7])):a.source_SkinData.push(0,0,0,0,0,0,0,0))}a.calculateVertexFormat();for(var c=0;c<e.matCount;++c){var d=new t.SubGeometry;d.matID=c,d.geometry=a,d.start=3*e.material[c].start*Uint16Array.BYTES_PER_ELEMENT,d.count=3*e.material[c].count,d.textureDiffuse=e.material[c].textureDiffuse,d.textureNormal=e.material[c].textureNormal,d.textureSpecular=e.material[c].textureSpecular,a.subGeometrys.push(d)}return a},e.combinGeomtryData=function(t,e){void 0===e&&(e=!0);for(var i=0,a=0,r=0,n=0,o=0,s=0,h=0,l=t.vertexDatas;i<t.vertLen;)l[i++]=t.vertices[a++],l[i++]=t.vertices[a++],l[i++]=t.vertices[a++],t.normals&&t.normals.length?(l[i++]=t.normals[r++],l[i++]=t.normals[r++],l[i++]=t.normals[r++]):(l[i++]=0,l[i++]=0,l[i++]=0),t.tangts?(i++,i++,i++):(l[i++]=0,l[i++]=0,l[i++]=0),t.source_vertexColorData&&t.source_vertexColorData.length?(l[i++]=t.verticesColor[s++],l[i++]=t.verticesColor[s++],l[i++]=t.verticesColor[s++],l[i++]=t.verticesColor[s++]):(l[i++]=1,l[i++]=1,l[i++]=1,l[i++]=1),t.uvs&&t.uvs.length?(l[i++]=t.uvs[n++],l[i++]=t.uvs[n++],t.uv2s&&t.uv2s.length?(l[i++]=t.uv2s[o++],l[i++]=t.uv2s[o++]):(l[i++]=t.uvs[o++],l[i++]=t.uvs[o++])):(l[i++]=0,l[i++]=0,l[i++]=0,l[i++]=0),t.skinMesh&&t.skinMesh.length&&(l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++],l[i++]=t.skinMesh[h++])
},e.updateFaceNormals=function(t){for(var e,i,a,r,n,o,s,h,l,u,c,d,p,f,_,m,v,g,y,x,D=0,b=0,w=0,T=t.indices.length,P=t.vertexDatas,S=17,C=3;T>D;){e=C+t.indices[D++]*S,i=P[e],n=P[e+1],h=P[e+2],e=C+t.indices[D++]*S,a=P[e],o=P[e+1],l=P[e+2],e=C+t.indices[D++]*S,r=P[e],s=P[e+1],u=P[e+2],c=r-i,d=s-n,p=u-h,f=a-i,_=o-n,m=l-h,v=p*_-d*m,g=c*m-p*f,y=d*f-c*_,x=Math.sqrt(v*v+g*g+y*y);var A=1e4*x;1>A&&(A=1),t.faceWeights[w++]=A,x=1/x,t.faceNormals[b++]=v*x,t.faceNormals[b++]=g*x,t.faceNormals[b++]=y*x}},e.updateVertexNormals=function(t){this.updateFaceNormals(t);for(var e,i,a=0,r=1,n=2,o=(t.vertexDatas.length,17),s=3,h=0,l=0,u=t.indices.length;u>h;)i=t.faceWeights[l++],e=s+t.indices[h++]*o,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[n]*i,e=s+t.indices[h++]*o,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[n]*i,e=s+t.indices[h++]*o,t.vertexDatas[e]+=t.faceNormals[a]*i,t.vertexDatas[e++]+=t.faceNormals[r]*i,t.vertexDatas[e++]+=t.faceNormals[n]*i,a+=3,r+=3,n+=3},e.updateFaceTangents=function(e){var i,a,r,n,o,s,h,l,u,c,d,p,f,_,m,v,g,y,x,D,b,w=0,T=e.indexData.length,P=e.verticesData,S=e.vertexAttLength,C=0,A=e.vertexAttLength,E=0;for(e.vertexFormat&t.VertexFormat.VF_TANGENT&&(E+=t.Geometry.positionSize+t.Geometry.normalSize+t.Geometry.tangentSize),e.vertexFormat&t.VertexFormat.VF_COLOR&&(E+=t.Geometry.colorSize);T>w;)i=e.indexData[w],a=e.indexData[w+1],r=e.indexData[w+2],n=E+i*A,s=P[n],n=E+a*A,h=P[n]-s,n=E+r*A,l=P[n]-s,o=C+i*S,c=P[o],d=P[o+1],p=P[o+2],o=C+a*S,f=P[o]-c,_=P[o+1]-d,m=P[o+2]-p,o=C+r*S,v=P[o]-c,g=P[o+1]-d,y=P[o+2]-p,x=l*f-h*v,D=l*_-h*g,b=l*m-h*y,u=1/Math.sqrt(x*x+D*D+b*b),e.source_tangentData[w++]=u*x,e.source_tangentData[w++]=u*D,e.source_tangentData[w++]=u*b;var L,M,F=e.indexData.length,z=0,O=1,N=2,V=t.Geometry.positionSize+t.Geometry.normalSize,R=e.vertexAttLength;for(w=0;F>w;)M=1,L=V+e.indexData[w++]*R,e.verticesData[L++]+=e.source_tangentData[z]*M,e.verticesData[L++]+=e.source_tangentData[O]*M,e.verticesData[L]+=e.source_tangentData[N]*M,L=V+e.indexData[w++]*R,e.verticesData[L++]+=e.source_tangentData[z]*M,e.verticesData[L++]+=e.source_tangentData[O]*M,e.verticesData[L]+=e.source_tangentData[N]*M,L=V+e.indexData[w++]*R,e.verticesData[L++]+=e.source_tangentData[z]*M,e.verticesData[L++]+=e.source_tangentData[O]*M,e.verticesData[L]+=e.source_tangentData[N]*M,z+=3,O+=3,N+=3;var B=e.verticesData.length;for(w=V;B>w;){var I=e.verticesData[w],U=e.verticesData[w+1],k=e.verticesData[w+2],G=1/Math.sqrt(I*I+U*U+k*k);e.verticesData[w]=I*G,e.verticesData[w+1]=U*G,e.verticesData[w+2]=k*G,w+=e.vertexAttLength}},e}();t.GeometryData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.start=0,this.count=0,this.matID=0,this.preAttList=new Array}return e.prototype.upload=function(e,i){e.attributeDiry=!1;var a=0;e.attributeList=[],this.geometry.vertexFormat&t.VertexFormat.VF_POSITION&&(e.attribute_position&&(e.attribute_position.uniformIndex||(e.attribute_position.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_position.varName)),e.attribute_position.size=t.Geometry.positionSize,e.attribute_position.dataType=t.ContextConfig.FLOAT,e.attribute_position.normalized=!1,e.attribute_position.stride=this.geometry.vertexSizeInBytes,e.attribute_position.offsetBytes=a,e.attributeList.push(e.attribute_position)),a+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_NORMAL&&(e.attribute_normal&&(e.attribute_normal.uniformIndex||(e.attribute_normal.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_normal.varName)),e.attribute_normal.size=t.Geometry.normalSize,e.attribute_normal.dataType=t.ContextConfig.FLOAT,e.attribute_normal.normalized=!1,e.attribute_normal.stride=this.geometry.vertexSizeInBytes,e.attribute_normal.offsetBytes=a,e.attributeList.push(e.attribute_normal)),a+=t.Geometry.normalSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_TANGENT&&(e.attribute_tangent&&(e.attribute_tangent.uniformIndex||(e.attribute_tangent.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_tangent.varName)),e.attribute_tangent.size=t.Geometry.tangentSize,e.attribute_tangent.dataType=t.ContextConfig.FLOAT,e.attribute_tangent.normalized=!1,e.attribute_tangent.stride=this.geometry.vertexSizeInBytes,e.attribute_tangent.offsetBytes=a,e.attributeList.push(e.attribute_tangent)),a+=t.Geometry.tangentSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_COLOR&&(e.attribute_color&&(e.attribute_color.uniformIndex||(e.attribute_color.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_color.varName)),e.attribute_color.size=t.Geometry.colorSize,e.attribute_color.dataType=t.ContextConfig.FLOAT,e.attribute_color.normalized=!1,e.attribute_color.stride=this.geometry.vertexSizeInBytes,e.attribute_color.offsetBytes=a,e.attributeList.push(e.attribute_color)),a+=t.Geometry.colorSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_UV0&&(e.attribute_uv0&&(e.attribute_uv0.uniformIndex||(e.attribute_uv0.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_uv0.varName)),e.attribute_uv0.size=t.Geometry.uvSize,e.attribute_uv0.dataType=t.ContextConfig.FLOAT,e.attribute_uv0.normalized=!1,e.attribute_uv0.stride=this.geometry.vertexSizeInBytes,e.attribute_uv0.offsetBytes=a,e.attributeList.push(e.attribute_uv0)),a+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_UV1&&(e.attribute_uv1&&(e.attribute_uv1.uniformIndex||(e.attribute_uv1.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_uv1.varName)),e.attribute_uv1.size=t.Geometry.uv2Size,e.attribute_uv1.dataType=t.ContextConfig.FLOAT,e.attribute_uv1.normalized=!1,e.attribute_uv1.stride=this.geometry.vertexSizeInBytes,e.attribute_uv1.offsetBytes=a,e.attributeList.push(e.attribute_uv1)),a+=t.Geometry.uv2Size*Float32Array.BYTES_PER_ELEMENT),this.geometry.vertexFormat&t.VertexFormat.VF_SKIN&&(e.attribute_boneIndex&&(e.attribute_boneIndex.uniformIndex||(e.attribute_boneIndex.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_boneIndex.varName)),e.attribute_boneIndex.size=t.Geometry.skinSize/2,e.attribute_boneIndex.dataType=t.ContextConfig.FLOAT,e.attribute_boneIndex.normalized=!1,e.attribute_boneIndex.stride=this.geometry.vertexSizeInBytes,e.attribute_boneIndex.offsetBytes=a,e.attributeList.push(e.attribute_boneIndex)),a+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT,e.attribute_boneWeight&&(e.attribute_boneWeight.uniformIndex||(e.attribute_boneWeight.uniformIndex=i.getShaderAttribLocation(e.program3D,e.attribute_boneWeight.varName)),e.attribute_boneWeight.size=t.Geometry.skinSize/2,e.attribute_boneWeight.dataType=t.ContextConfig.FLOAT,e.attribute_boneWeight.normalized=!1,e.attribute_boneWeight.stride=this.geometry.vertexSizeInBytes,e.attribute_boneWeight.offsetBytes=a,e.attributeList.push(e.attribute_boneWeight)),a+=t.Geometry.skinSize/2*Float32Array.BYTES_PER_ELEMENT);for(var r=0;r<this.preAttList.length;++r){var n=this.preAttList[r],o=e[n.name];o&&(o.uniformIndex||(o.uniformIndex=i.getShaderAttribLocation(e.program3D,o.varName),o.size=n.size,o.dataType=t.ContextConfig.FLOAT,o.normalized=!1,o.stride=this.geometry.vertexSizeInBytes,o.offsetBytes=a,e.attributeList.push(o))),a+=n.size*Float32Array.BYTES_PER_ELEMENT}},e.prototype.activeState=function(t,e,i,a){i.attributeDiry&&this.upload(i,a),a.unActiveVertexFormat();for(var r=0;r<i.attributeList.length;r++){var n=i.attributeList[r];n.uniformIndex>=0&&a.vertexAttribPointer(n.uniformIndex,n.size,n.dataType,n.normalized,n.stride,n.offsetBytes)}},e.prototype.deactiveState=function(t,e){},e.use=!1,e}();t.SubGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a){void 0===t&&(t=80),void 0===i&&(i=80),void 0===a&&(a=80),e.call(this),this._width=80,this._height=80,this._depth=80,this._width=t,this._height=i,this._depth=a,this.buildGeomtry(!0)}return __extends(i,e),Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"depth",{get:function(){return this._depth},enumerable:!0,configurable:!0}),i.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1,this.verticesData=new Array,this.indexData=new Array,this.verticesData.push(.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,0,-10,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,0,10,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,0,-10,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,0,-10,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*-this._height,.5*this._depth,10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*-this._height,.5*-this._depth,10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,1,1,0,0,.5*this._width,.5*this._height,.5*this._depth,0,10,0,1,0,0,1,1,1,1,0,1,0,0,.5*this._width,.5*this._height,.5*-this._depth,0,10,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0,.5*-this._width,.5*-this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,1,0,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*-this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,1,1,0,0,.5*-this._width,.5*this._height,.5*this._depth,-10,0,0,1,0,0,1,1,1,1,0,1,0,0,.5*-this._width,.5*this._height,.5*-this._depth,-10,0,0,1,0,0,1,1,1,1,0,0,0,0),e?this.indexData.push(0,2,1,3,5,4,6,8,7,9,11,10,12,14,13,15,17,16,18,20,19,21,23,22,24,26,25,27,29,28,30,32,31,33,35,34):this.indexData.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35),this.buildDefaultSubGeometry()},i}(t.Geometry);t.CubeGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i){void 0===t&&(t=100),void 0===i&&(i=200),e.call(this),this._height=t,this._radius=i,this.buildGeomtry()}return __extends(i,e),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),i.prototype.buildGeomtry=function(){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1,this.verticesData=new Array,this.indexData=new Array;var e=20,i=20,a=2*Math.PI/e;for(i=0;e>=i;i++){var r=this._radius*Math.sin(i*a),n=this._radius*Math.cos(i*a);this.verticesData.push(r,0+this._height/2,n,r,0,n,1,0,0,1,1,1,1,1,0,0,0,r,0-this._height/2,n,r,0,n,1,0,0,1,1,1,1,1,0,0,0)}var o=this.verticesData.length/17,s=this.verticesData.length;this.verticesData.push(0,0+this._height/2,0,0,1,0,1,0,0,1,1,1,1,1,0,0,0);var h=this.verticesData.length;this.verticesData.push(0,0-this._height/2,0,0,-1,0,1,0,0,1,1,1,1,1,0,0,0);for(var l=0;o>l;l++)0!=(1&l)?this.indexData.push(l,l+1>=o?l+1-o:l+1,l+2>=o?l+2-o:l+2,s,l,l+2>=o?l+2-o:l+2):this.indexData.push(l+1>=o?l+1-o:l+1,l,l+2>=o?l+2-o:l+2,l,h,l+2>=o?l+2-o:l+2);var u=new t.SubGeometry;u.geometry=this,u.start=0,u.count=this.indexData.length,this.subGeometrys.push(u)},i}(t.Geometry);t.CylinderGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n,o,s,h,l,u){void 0===i&&(i=500),void 0===a&&(a=500),void 0===r&&(r=1),void 0===n&&(n=1),void 0===o&&(o=1),void 0===s&&(s=1),void 0===h&&(h=t.Vector3D.Y_AXIS),void 0===l&&(l=!0),void 0===u&&(u=!0),e.call(this),this._segmentsW=1,this._segmentsH=1,this._width=500,this._height=500,this._scaleU=1,this._scaleV=1,this._width=i,this._height=a,this._segmentsW=r,this._segmentsH=n,this._scaleU=o,this._scaleV=s,this._wCenter=l,this._hCenter=u,this.buildGeometry(h)}return __extends(i,e),Object.defineProperty(i.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleU",{get:function(){return this._scaleU},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"scaleV",{get:function(){return this._scaleV},enumerable:!0,configurable:!0}),i.prototype.buildGeometry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0;var i,a,r,n,o=this._segmentsW+1,s=(this._segmentsH+1)*o,h=this.vertexAttLength,l=h-15;r=this._segmentsH*this._segmentsW*6,this.verticesData=new Array(s*h),this.indexData=new Array(r),r=0;for(var u=(new t.Vector3D,0),c=0;c<=this._segmentsH;++c)for(var d=0;d<=this._segmentsW;++d){switch(i=(d/this._segmentsW-.5)*this._width,a=(c/this._segmentsH-.5)*this._height,0==this._wCenter&&(i+=this._width/2),0==this._hCenter&&(a+=this._height/2),e){case t.Vector3D.Y_AXIS:this.verticesData[u++]=i,this.verticesData[u++]=0,this.verticesData[u++]=a,this.verticesData[u++]=0,this.verticesData[u++]=1,this.verticesData[u++]=0;break;case t.Vector3D.Z_AXIS:this.verticesData[u++]=i,this.verticesData[u++]=a,this.verticesData[u++]=0,this.verticesData[u++]=0,this.verticesData[u++]=0,this.verticesData[u++]=-1;break;case t.Vector3D.X_AXIS:this.verticesData[u++]=0,this.verticesData[u++]=i,this.verticesData[u++]=a,this.verticesData[u++]=1,this.verticesData[u++]=0,this.verticesData[u++]=0;break;default:this.verticesData[u++]=i,this.verticesData[u++]=0,this.verticesData[u++]=a,this.verticesData[u++]=0,this.verticesData[u++]=1,this.verticesData[u++]=0}if(this.verticesData[u++]=1,this.verticesData[u++]=0,this.verticesData[u++]=0,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=d/this._segmentsW*this._scaleU,this.verticesData[u++]=(1-c/this._segmentsH)*this._scaleV,u+=l,d!=this._segmentsW&&c!=this._segmentsH){n=d+c*o;var p=1;this.indexData[r++]=n*p,this.indexData[r++]=(n+o+1)*p,this.indexData[r++]=(n+o)*p,this.indexData[r++]=n*p,this.indexData[r++]=(n+1)*p,this.indexData[r++]=(n+o+1)*p}}var f=new t.SubGeometry;f.geometry=this,f.start=0,f.count=this.indexData.length,this.subGeometrys.push(f)},i}(t.Geometry);t.PlaneGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a){void 0===t&&(t=100),void 0===i&&(i=15),void 0===a&&(a=15),e.call(this),this._segmentsW=50,this._segmentsH=50,this._radius=100,this._radius=t,this._segmentsW=i,this._segmentsH=a,this.buildSphere(!0)}return __extends(i,e),Object.defineProperty(i.prototype,"segmentsW",{get:function(){return this._segmentsW},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"segmentsH",{get:function(){return this._segmentsH},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"radius",{get:function(){return this._radius},enumerable:!0,configurable:!0}),i.prototype.buildSphere=function(e){void 0===e&&(e=!0),this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var i=0,a=0,r=0,n=(this._segmentsH+1)*(this._segmentsW+1),o=this.vertexAttLength,s=o-9;this.verticesData=new Array(n*o),this.indexData=new Array((this._segmentsH-1)*this._segmentsW*6);var h=0,l=0,u=0,c=0,d=0,p=0;for(a=0;a<=this._segmentsH;++a){h=l;var f=Math.PI*a/this._segmentsH,_=-this._radius*Math.cos(f),m=this._radius*Math.sin(f);for(i=0;i<=this._segmentsW;++i){var v=2*Math.PI*i/this._segmentsW,g=m*Math.cos(v),y=m*Math.sin(v),x=1/Math.sqrt(g*g+y*y+_*_),D=Math.sqrt(y*y+g*g);if(d=0,p=D>.007?g/D:0,u=-_,c=y,i==this._segmentsW?(this.verticesData[l++]=this.verticesData[h],this.verticesData[l++]=this.verticesData[h+1],this.verticesData[l++]=this.verticesData[h+2],this.verticesData[l++]=g*x,this.verticesData[l++]=u*x,this.verticesData[l++]=c*x,this.verticesData[l++]=D>.007?-y/D:1,this.verticesData[l++]=d,this.verticesData[l++]=p,this.verticesData[l+0]=1,this.verticesData[l+1]=1,this.verticesData[l+2]=1,this.verticesData[l+3]=1):(this.verticesData[l++]=g,this.verticesData[l++]=u,this.verticesData[l++]=c,this.verticesData[l++]=g*x,this.verticesData[l++]=u*x,this.verticesData[l++]=c*x,this.verticesData[l++]=D>.007?-y/D:1,this.verticesData[l++]=d,this.verticesData[l++]=p,this.verticesData[l]=1,this.verticesData[l+1]=1,this.verticesData[l+2]=1,this.verticesData[l+3]=1),i>0&&a>0){var b=(this._segmentsW+1)*a+i,w=(this._segmentsW+1)*a+i-1,T=(this._segmentsW+1)*(a-1)+i-1,P=(this._segmentsW+1)*(a-1)+i;a==this._segmentsH?(this.verticesData[l-9]=this.verticesData[h],this.verticesData[l-8]=this.verticesData[h+1],this.verticesData[l-7]=this.verticesData[h+2],e?(this.indexData[r++]=b,this.indexData[r++]=P,this.indexData[r++]=T):(this.indexData[r++]=b,this.indexData[r++]=T,this.indexData[r++]=P)):1==a?e?(this.indexData[r++]=b,this.indexData[r++]=T,this.indexData[r++]=w):(this.indexData[r++]=b,this.indexData[r++]=w,this.indexData[r++]=T):e?(this.indexData[r++]=b,this.indexData[r++]=P,this.indexData[r++]=T,this.indexData[r++]=b,this.indexData[r++]=T,this.indexData[r++]=w):(this.indexData[r++]=b,this.indexData[r++]=T,this.indexData[r++]=P,this.indexData[r++]=b,this.indexData[r++]=w,this.indexData[r++]=T)}l+=s}}var o=17,s=((this._segmentsH+1)*(this._segmentsW+1)*o,o-2),l=13;for(a=0;a<=this._segmentsH;++a)for(i=0;i<=this._segmentsW;++i)this.verticesData[l++]=i/this._segmentsW,this.verticesData[l++]=a/this._segmentsH,l+=s;var S=new t.SubGeometry;S.geometry=this,S.start=0,S.count=this.indexData.length,this.subGeometrys.push(S)},i}(t.Geometry);t.SphereGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.createGeometry=function(e){void 0===e&&(e=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1);var i=new t.Geometry;return i.vertexFormat=e,i},e.createGemetryForType=function(e,i){switch(e){case"CubeGeometry":return new t.CubeGeometry(i.width,i.height,i.depth);case"CylinderGeometry":return new t.CylinderGeometry(i.height,i.radius);case"ElevationGeometry":return new t.ElevationGeometry(i.heightmap,i.width,i.height,i.depth,i.segmentsW,i.segmentsH);case"PlaneGeometry":return new t.PlaneGeometry(i.width,i.height,i.segmentsW,i.segmentsH,i.uScale,i.vScale);case"SphereGeometry":return new t.SphereGeometry(i.r,i.segmentsW,i.segmentsH)}return null},e}();t.GeometryUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a,r,n,o,s,h){void 0===i&&(i=1e3),void 0===a&&(a=100),void 0===r&&(r=1e3),void 0===n&&(n=30),void 0===o&&(o=30),void 0===s&&(s=255),void 0===h&&(h=0),e.call(this),this._width=100,this._height=100,this._segmentsW=100,this._segmentsH=100,this._depth=100,this._minElevation=100,this._maxElevation=100,this._scaleU=1,this._scaleV=1,this._segmentsW=n,this._segmentsH=o,this._width=i,this._height=a,this._depth=r,this._minElevation=h,this._maxElevation=s,this._heightmap=t,this._canvas=document.createElement("canvas");var l=this._canvas.getContext("2d");this._canvas.width=t.imageData.width,this._canvas.height=t.imageData.height,l.drawImage(t.imageData,0,0,t.width,t.height),document.body.appendChild(this._canvas),this._canvas.hidden=!0,this.imageData=l.getImageData(0,0,this._heightmap.imageData.width,this._heightmap.imageData.height),document.body.removeChild(this._canvas),this.buildGeomtry(!0)}return __extends(i,e),i.prototype.buildGeomtry=function(e){this.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1;var i,a,r,n,o,s,h,l=this._segmentsW+1,u=(this._segmentsH+1)*l,c=(this._heightmap.width-1)/this._segmentsW,d=(this._heightmap.height-1)/this._segmentsH;this.verticesData=new Array(3*u),this.indexData=new Array(this._segmentsH*this._segmentsW*6),u=0,r=0;for(var p,f=0;f<=this._segmentsH;++f)for(var _=0;_<=this._segmentsW;++_)i=(_/this._segmentsW-.5)*this._width,a=(f/this._segmentsH-.5)*this._depth,o=Math.floor(_*c),s=Math.floor((this._segmentsH-f)*d),p=255&this.getPixel(o,s),h=p>this._maxElevation?this._maxElevation/255*this._height:p<this._minElevation?this._minElevation/255*this._height:p/255*this._height,this.verticesData[u++]=i,this.verticesData[u++]=h,this.verticesData[u++]=a,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=-1,this.verticesData[u++]=0,this.verticesData[u++]=0,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=1,this.verticesData[u++]=_/this._segmentsW*this._scaleU,this.verticesData[u++]=1-f/this._segmentsH*this._scaleV,this.verticesData[u++]=_/this._segmentsW,this.verticesData[u++]=1-f/this._segmentsH,_!=this._segmentsW&&f!=this._segmentsH&&(n=_+f*l,this.indexData[r++]=n,this.indexData[r++]=n+l+1,this.indexData[r++]=n+l,this.indexData[r++]=n,this.indexData[r++]=n+1,this.indexData[r++]=n+l+1);this.updateFaceNormals(),this.buildDefaultSubGeometry()},i.prototype.getPixel=function(t,e){var i=e*(4*this._heightmap.imageData.width)+4*t,a=this.imageData.data[i+3]<<24|this.imageData.data[i+0]<<16|this.imageData.data[i+1]<<8|this.imageData.data[i+2];return a},i.prototype.getHeightBypos=function(t,e){var i=this.getPixel(t,e);return i>this._maxElevation?this._maxElevation/255*this._height:i<this._minElevation?this._minElevation/255*this._height:i/255*this._height},i.prototype.updateFaceNormals=function(){for(var t,e,i,a,r,n,o,s,h,l,u,c,d,p,f,_,m,v,g,y,x=0,D=0,b=this.indexData.length,w=this.verticesData,T=17,P=0,S=[];b>x;)t=P+this.indexData[x+0]*T,e=w[t],r=w[t+1],s=w[t+2],t=P+this.indexData[x+1]*T,i=w[t],n=w[t+1],h=w[t+2],t=P+this.indexData[x+2]*T,a=w[t],o=w[t+1],l=w[t+2],u=i-e,c=n-r,d=h-s,p=a-e,f=o-r,_=l-s,m=d*f-c*_,v=u*_-d*p,g=c*p-u*f,y=Math.sqrt(m*m+v*v+g*g),S[D++]=g*y,S[D++]=v*y,S[D++]=m*y,x+=3;x=0;for(var C=0,A=1,E=2,L=this.vertexAttLength,M=3;b>x;)t=M+this.indexData[x++]*L,this.verticesData[t++]=S[C],this.verticesData[t++]=S[A],this.verticesData[t++]=S[E],t=M+this.indexData[x++]*L,this.verticesData[t++]=S[C],this.verticesData[t++]=S[A],this.verticesData[t++]=S[E],t=M+this.indexData[x++]*L,this.verticesData[t++]=S[C],this.verticesData[t++]=S[A],this.verticesData[t++]=S[E],C+=3,A+=3,E+=3},i}(t.Geometry);t.ElevationGeometry=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){var i=this;e.call(this),this._time=0,this._keyStatus={},this._mouseStatus={},this._isTouchStart=!1,this._mouseEvent3d=new t.MouseEvent3D,this._keyEvent3d=new t.KeyEvent3D,this._touchEvent3d=new t.TouchEvent3D,this._windowsEvent3d=new t.Event3D,this._orientationEvent3d=new t.OrientationEvent3D,this.onGamepadStick1=null,this.onGamepadStick2=null,this._gp=!1,this._oldPosition1=null,this._oldPosition2=null,window.addEventListener("click",function(t){return i.mouseClick(t)},!0),window.addEventListener("mousedown",function(t){return i.mouseStart(t)},!0),window.addEventListener("mouseup",function(t){return i.mouseEnd(t)},!0),window.addEventListener("mousewheel",function(t){return i.mouseWheel(t)},!0),window.addEventListener("mousemove",function(t){return i.mouseMove(t)},!0),window.addEventListener("mouseover",function(t){return i.mouseOver(t)},!0),window.addEventListener("keydown",function(t){return i.keyDown(t)},!0),window.addEventListener("keyup",function(t){return i.keyUp(t)},!0),this.canGame()&&(window.addEventListener("gamepadconnected",function(t){return i.ongamepadconnected(t)},!0),window.addEventListener("gamepaddisconnected",function(t){return i.ongamepaddisconnected(t)},!0)),window.addEventListener("touchstart",function(t){return i.touchStart(t)},!0),window.addEventListener("touchend",function(t){return i.touchEnd(t)},!0),window.addEventListener("touchmove",function(t){return i.touchMove(t)},!0),window.addEventListener("touchcancel",function(t){return i.touchEnd(t)},!0),window.addEventListener("resize",function(t){return i.onWindowsResize(t)},!0),window.addEventListener("orientationchange",function(t){return i.onOrientationChange(t)},!0),window.addEventListener("devicemotion",function(t){return i.onDeviceMotion(t)},!0),window.addEventListener("deviceorientation",function(t){return i.onDeviceOrientation(t)},!0)}return __extends(i,e),Object.defineProperty(i,"instance",{get:function(){return null==this._instance&&(this._instance=new i),this._instance},enumerable:!0,configurable:!0}),i.addEventListener=function(t,e,a){return i.instance.addEventListener(t,e,a)},i.removeEventListener=function(t,e,a){i.instance.removeEventListener(t,e,a)},i.removeEventListenerAt=function(t){i.instance.removeEventListenerAt(t)},i.prototype.ongamepaddisconnected=function(t){this._gp=!1},i.prototype.ongamepadconnected=function(t){this._gp=!0},i.prototype.getGamepadButtonState=function(t){return navigator.getGamepads()[0].buttons[t].pressed},i.prototype.getGamepadStick1=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[0],navigator.getGamepads()[0].axes[1],0)},i.prototype.getGamepadStick2=function(){return new t.Vector3D(navigator.getGamepads()[0].axes[2],navigator.getGamepads()[0].axes[3],0)},i.prototype.canGame=function(){return"getGamepads"in navigator},i.reportOnGamepad=function(){i.instance.canGame()&&i.instance._gp&&(null!=i.instance.onGamepadStick1&&i.instance.onGamepadStick1(i.instance.getGamepadStick1()),null!=i.instance.onGamepadStick2&&i.instance.onGamepadStick2(i.instance.getGamepadStick2()))},i.prototype.printout=function(){var t="";t+="id: "+navigator.getGamepads()[0].id+"<br/>";for(var e=navigator.getGamepads()[0].buttons.length,i=0;e>i;i++)t+="Button "+(i+1)+": ",this.getGamepadButtonState(i)&&(t+=" pressed"),t+="<br/>";var a=this.getGamepadStick1();t+="Stick 1: "+a.x+","+a.y+"<br/>",a=this.getGamepadStick2(),t+="Stick 2: "+a.x+","+a.y+"<br/>"},i.prototype.onPinch=function(e,i,a,r){this._oldPosition1=new t.Point(e,i),this._oldPosition2=new t.Point(a,r)},i.prototype.onSwipe=function(t,e){i.mouseX=t,i.mouseY=e,this._oldPosition1=null,this._oldPosition2=null,this._time=(new Date).getTime()},i.prototype.touchStart=function(e){if(this.deliverMessage()){e.preventDefault();var a=e.targetTouches[0].clientX-i.canvas.x+i.canvas.offsetX,r=e.targetTouches[0].clientY-i.canvas.y+i.canvas.offsetY;if(2==e.targetTouches.length){var n=e.targetTouches[1].clientX-i.canvas.x+i.canvas.offsetX,o=e.targetTouches[1].clientY-i.canvas.y+i.canvas.offsetY;this.onPinch(a,r,n,o)}else 1==e.targetTouches.length&&this.onSwipe(a,r);this._touchEvent3d.targetTouches=e.targetTouches,this._touchEvent3d.target=this,this._isTouchStart||(this._isTouchStart=!0,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_START,this.dispatchEvent(this._touchEvent3d))}},i.prototype.touchEnd=function(e){if(e.targetTouches.length>1){var a=e.targetTouches[0].clientX-i.canvas.x+i.canvas.offsetX,r=e.targetTouches[0].clientY-i.canvas.y+i.canvas.offsetY,n=e.targetTouches[1].clientX-i.canvas.x+i.canvas.offsetX,o=e.targetTouches[1].clientY-i.canvas.y+i.canvas.offsetY;this.onPinch(a,r,n,o)}else 1==e.targetTouches.length?this.onSwipe(e.targetTouches[0].clientX-i.canvas.x+i.canvas.offsetX,e.targetTouches[0].clientY-i.canvas.y+i.canvas.offsetY):(this._oldPosition1=null,this._oldPosition2=null,this._time=0);this._isTouchStart=!1,this._touchEvent3d.targetTouches=e.targetTouches,this._touchEvent3d.target=this,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_END,this.dispatchEvent(this._touchEvent3d)},i.prototype.touchMove=function(e){if(i.mouseLastX=i.mouseX,i.mouseLastY=i.mouseY,i.mouseX=e.targetTouches[0].clientX-i.canvas.x+i.canvas.offsetX,i.mouseY=e.targetTouches[0].clientY-i.canvas.y+i.canvas.offsetY,i.mouseOffsetX=i.mouseX-i.mouseLastX,i.mouseOffsetY=i.mouseY-i.mouseLastY,e.preventDefault(),e.targetTouches.length>1){var a=new t.Point(i.mouseX,i.mouseY),r=new t.Point(e.targetTouches[1].clientX-i.canvas.x+i.canvas.offsetX,e.targetTouches[1].clientY-i.canvas.y+i.canvas.offsetY);null==this._oldPosition1&&(this._oldPosition1=a),null==this._oldPosition2&&(this._oldPosition2=r),this.isEnlarge(this._oldPosition1,this._oldPosition2,a,r)?i.wheelDelta=120:i.wheelDelta=-120,this._oldPosition1=a,this._oldPosition2=r}this._touchEvent3d.targetTouches=e.targetTouches,this._touchEvent3d.target=this,this._touchEvent3d.eventType=t.TouchEvent3D.TOUCH_MOVE,this.dispatchEvent(this._touchEvent3d)},i.prototype.mouseClick=function(e){this.deliverMessage()&&(this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_CLICK,this.dispatchEvent(this._mouseEvent3d))},i.prototype.mouseEnd=function(e){this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseStatus[this._mouseEvent3d.mouseCode]=!1,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_UP,this.dispatchEvent(this._mouseEvent3d)},i.prototype.deliverMessage=function(){for(var t=i.canvas.view3Ds,e=0;e<t.length;++e)if(t[e].inView3D(i.mouseX,i.mouseY))return!0;return!1},i.prototype.mouseStart=function(e){this.deliverMessage()&&(this._mouseEvent3d.mouseCode=e.button,this._mouseEvent3d.target=this,this._mouseStatus[this._mouseEvent3d.mouseCode]||(this._mouseStatus[this._mouseEvent3d.mouseCode]=!0,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_DOWN,this.dispatchEvent(this._mouseEvent3d)))},i.prototype.mouseMove=function(e){i.mouseLastX=i.mouseX,i.mouseLastY=i.mouseY,i.mouseX=e.clientX-i.canvas.x+i.canvas.offsetX,i.mouseY=e.clientY-i.canvas.y+i.canvas.offsetY,i.mouseOffsetX=i.mouseX-i.mouseLastX,i.mouseOffsetY=i.mouseY-i.mouseLastY,this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_MOVE,this.dispatchEvent(this._mouseEvent3d)},i.prototype.mouseOver=function(e){this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_OVER,this.dispatchEvent(this._mouseEvent3d)
},i.prototype.mouseWheel=function(e){i.wheelDelta=e.wheelDelta,this._mouseEvent3d.target=this,this._mouseEvent3d.eventType=t.MouseEvent3D.MOUSE_WHEEL,this.dispatchEvent(this._mouseEvent3d)},i.prototype.keyDown=function(e){this._keyEvent3d.keyCode=e.keyCode,this._keyEvent3d.target=this,this._keyStatus[e.keyCode]||(this._keyStatus[e.keyCode]=!0,this._keyEvent3d.eventType=t.KeyEvent3D.KEY_CLICK,this.dispatchEvent(this._keyEvent3d),this._keyEvent3d.eventType=t.KeyEvent3D.KEY_DOWN,this.dispatchEvent(this._keyEvent3d))},i.prototype.keyUp=function(e){this._keyEvent3d.keyCode=e.keyCode,this._keyEvent3d.target=this,this._keyStatus[e.keyCode]&&(this._keyEvent3d.eventType=t.KeyEvent3D.KEY_CLICK,this.dispatchEvent(this._keyEvent3d)),this._keyStatus[e.keyCode]=!1,this._keyEvent3d.eventType=t.KeyEvent3D.KEY_UP,this.dispatchEvent(this._keyEvent3d)},i.prototype.onWindowsResize=function(e){this._windowsEvent3d.target=this,this._windowsEvent3d.eventType=t.Event3D.RESIZE,this.dispatchEvent(this._windowsEvent3d)},i.prototype.onOrientationChange=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.ORIENTATION_CHANGE,this.dispatchEvent(this._orientationEvent3d)},i.prototype.onDeviceMotion=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_MOTION,this._orientationEvent3d.acceleration=e.acceleration,this._orientationEvent3d.accelerationIncludingGravity=e.accelerationIncludingGravity,this._orientationEvent3d.rotationRate=e.rotationRate,this.dispatchEvent(this._orientationEvent3d)},i.prototype.onDeviceOrientation=function(e){this._orientationEvent3d.target=this,this._orientationEvent3d.eventType=t.OrientationEvent3D.DEVICE_ORIENTATION,this._orientationEvent3d.absolute=e.absolute,this._orientationEvent3d.alpha=e.alpha,this._orientationEvent3d.beta=e.beta,this._orientationEvent3d.gamma=e.gamma,this.dispatchEvent(this._orientationEvent3d)},i.prototype.GetSlideAngle=function(t,e){return 180*Math.atan2(e,t)/Math.PI},i.prototype.GetSlideDirection=function(t,e,i,a){var r=e-a,n=i-t,o=0;if(Math.abs(n)<2&&Math.abs(r)<2)return o;var s=this.GetSlideAngle(n,r);return s>=-45&&45>s?o=4:s>=45&&135>s?o=1:s>=-135&&-45>s?o=2:(s>=135&&180>=s||s>=-180&&-135>s)&&(o=3),o},i.prototype.isEnlarge=function(t,e,i,a){var r=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)),n=Math.sqrt((i.x-a.x)*(i.x-a.x)+(i.y-a.y)*(i.y-a.y));return n>r?!0:!1},i.mouseX=0,i.mouseY=0,i.wheelDelta=0,i.mouseOffsetX=0,i.mouseOffsetY=0,i.mouseLastX=0,i.mouseLastY=0,i._instance=null,i}(t.EventDispatcher);t.Input=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.orientation=new t.Vector3D,this.screenOrientation=0,this.openDebug=!1,this.offsetRotation=new t.Vector3D,this.fixOritation=new t.Vector3D,this.state=-1,this.degtorad=Math.PI/180,this.q=new t.Quaternion,this.q1=new t.Quaternion,this.outQ=new t.Quaternion,this.fix=new t.Vector3D,this.fixinterpolate=new t.Vector3D,this.fixAxis=new t.Vector3D,this.caheFixAxis=new t.Vector3D,this.steps=1,this.interpolate=!0,this.openDebug&&(this.accDiv=document.createElement("div"),this.accGravityDiv=document.createElement("div"),this.rotationRateDiv=document.createElement("div"),this.orientationRateDiv=document.createElement("div"),this.stateDiv=document.createElement("div"),this.accDiv.style.color="red",this.accGravityDiv.style.color="red",this.rotationRateDiv.style.color="red",this.orientationRateDiv.style.color="red",this.stateDiv.style.color="red",this.stateDiv.style.fontSize="52",document.body.appendChild(this.accDiv),document.body.appendChild(this.accGravityDiv),document.body.appendChild(this.rotationRateDiv),document.body.appendChild(this.orientationRateDiv),document.body.appendChild(this.stateDiv))}return e.prototype.start=function(){var t=this;this.orientationchangeHandler(),window.addEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.addEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.addEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.stop=function(){var t=this;window.removeEventListener("orientationchange",function(){return t.orientationchangeHandler()}),window.removeEventListener("devicemotion",function(e){return t.motionHandler(e)}),window.removeEventListener("deviceorientation",function(e){return t.orientationHandler(e)})},e.prototype.orientationchangeHandler=function(){void 0!=window.orientation&&(this.screenOrientation=window.orientation)},e.prototype.motionHandler=function(t){this.acc=t.acceleration,this.accGravity=t.accelerationIncludingGravity,this.rotationRate=t.rotationRate},e.prototype.orientationHandler=function(t){this.orientation.x=t.alpha,this.orientation.y=t.beta,this.orientation.z=t.gamma,this.openDebug&&this.debug()},e.prototype.debug=function(){this.accGravityDiv.innerHTML="<br><br> Gravity-x:"+this.orientation.x*t.MathUtil.RADIANS_TO_DEGREES+"<br>Gravity-y:"+this.orientation.y+"<br>Gravity-z:"+this.orientation.z,this.orientationRateDiv.innerHTML="<br> orientation-x:"+this.fixOritation.x+"<br>orientation-y:"+this.fixOritation.y+"<br>orientation-z:"+this.fixOritation.z,this.stateDiv.innerHTML="<br> state: "+this.state},e.prototype.getOrientation=function(){switch(window.screen.msOrientation){case"landscape-primary":return-90;case"landscape-secondary":return 90;case"portrait-secondary":return 180;case"portrait-primary":return 0}return window.orientation||0},e.prototype.getQuaternion=function(e,i,a){var r=i?i*this.degtorad:0,n=a?a*this.degtorad:0,o=e?e*this.degtorad:0;r=Math.floor(100*r)/100,n=Math.floor(100*n)/100;var s=-this.getOrientation()*this.degtorad;this.state=this.getOrientation();var h=Math.cos(r/2),l=Math.cos(n/2),u=Math.cos(o/2),c=Math.sin(r/2),d=Math.sin(n/2),p=Math.sin(o/2);this.q.w=h*l*u-c*d*p,this.q.x=c*l*u-h*d*p,this.q.y=h*d*u+c*l*p,this.q.z=h*l*p+c*d*u;var f=new t.Vector3D(0,0,1),_=new t.Quaternion;return _.fromAxisAngle(f,s),this.q.multiply(this.q,_),f.setTo(-1,0,0),_.fromAxisAngle(f,90*this.degtorad),this.q.multiply(this.q,_),this.q},e.prototype.update=function(t){this.getBaseQuaternion(this.orientation.x,this.orientation.y,this.orientation.z),this.q.toEulerAngles(this.fixOritation),this.interpolate?(this.fixinterpolate.x=this.fixOritation.x-this.fix.x,this.fixinterpolate.y=this.fixOritation.y-this.fix.y,this.fixinterpolate.z=this.fixOritation.z-this.fix.z,this.caheFixAxis.x=this.fixOritation.x/Math.abs(this.fixOritation.x),this.caheFixAxis.y=this.fixOritation.y/Math.abs(this.fixOritation.y),this.caheFixAxis.z=this.fixOritation.z/Math.abs(this.fixOritation.z),this.fixAxis.x==this.caheFixAxis.x&&this.fixAxis.y==this.caheFixAxis.y&&this.fixAxis.z==this.caheFixAxis.z?(this.fix.x+=this.fixinterpolate.x/(this.steps+.01),this.fix.y+=this.fixinterpolate.y/(this.steps+.01),this.fix.z+=this.fixinterpolate.z/(this.steps+.01)):(this.fix.x=this.fixOritation.x,this.fix.y=this.fixOritation.y,this.fix.z=this.fixOritation.z,this.fixAxis.x=this.caheFixAxis.x,this.fixAxis.y=this.caheFixAxis.y,this.fixAxis.z=this.caheFixAxis.z),t.camera3D.rotationX=-this.fix.x,t.camera3D.rotationY=-this.fix.y,t.camera3D.rotationZ=this.fix.z):(t.camera3D.rotationX=-this.fixOritation.x,t.camera3D.rotationY=-this.fixOritation.y,t.camera3D.rotationZ=this.fixOritation.z)},e.prototype.getBaseQuaternion=function(t,e,i){var a=e?e*this.degtorad:0,r=i?i*this.degtorad:0,n=t?t*this.degtorad:0,o=Math.cos(a/2),s=Math.cos(r/2),h=Math.cos(n/2),l=Math.sin(a/2),u=Math.sin(r/2),c=Math.sin(n/2),d=o*s*h-l*u*c,p=l*s*h-o*u*c,f=o*u*h+l*s*c,_=o*s*c+l*u*h;return this.q.w=d,this.q.x=p,this.q.y=f,this.q.z=_,this.q},e}();t.OrientationController=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){void 0===i&&(i=null),void 0===a&&(a=null),e.call(this),this._event=new t.LoaderEvent3D,this._dataformat=null,this.url="",this.parentUrl="",this.resourceName="",this.data=null,i&&(a&&(this.dataformat=a),this.load(i))}return __extends(i,e),i.prototype.load=function(t){var e=this;if(this.data=null,this.url=t,null==this._dataformat){this._dataformat=i.DATAFORMAT_TEXT;this.url.lastIndexOf("."),this.url.lastIndexOf("/");if(this.url.length>=4)switch(this.url.substr(this.url.length-4,4).toLowerCase()){case".dds":this._dataformat=i.DATAFORMAT_DDS;break;case".tga":this._dataformat=i.DATAFORMAT_TGA;break;case".bmp":this._dataformat=i.DATAFORMAT_BITMAP;break;case".png":this._dataformat=i.DATAFORMAT_BITMAP;break;case".jpg":this._dataformat=i.DATAFORMAT_BITMAP;break;case".hdr":this._dataformat=i.DATAFORMAT_HDR;break;case"glsl":this._dataformat=i.DATAFORMAT_TEXT;break;case".pvr":this._dataformat=i.DATAFORMAT_PVR;break;case".esm":this._dataformat=i.DATAFORMAT_ESM;break;case".eam":this._dataformat=i.DATAFORMAT_EAM;break;case".eca":this._dataformat=i.DATAFORMAT_ECA;break;case".epa":this._dataformat=i.DATAFORMAT_EPA}}return null==this._xhr&&(this._xhr=this.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&this._xhr.abort(),this._xhr.open("GET",this.url,!0),this._xhr.addEventListener("progress",function(t){return e.onProgress(t)},!1),this._xhr.addEventListener("readystatechange",function(t){return e.onReadyStateChange(t)},!1),this._xhr.addEventListener("error",function(t){return e.onError(t)},!1),this.dataformat==i.DATAFORMAT_BITMAP?this._xhr.responseType="blob":this.dataformat!=i.DATAFORMAT_TEXT&&(this._xhr.responseType="arraybuffer"),void this._xhr.send())},Object.defineProperty(i.prototype,"dataformat",{get:function(){return this._dataformat},set:function(t){this._dataformat=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bytesLoaded",{get:function(){return this._progressEvent?this._progressEvent.loaded:0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"bytesTotal",{get:function(){return this._progressEvent?this._progressEvent.total:0},enumerable:!0,configurable:!0}),i.prototype.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400?console.log(this.url,"load fail"):this.loadComplete())},i.prototype.loadComplete=function(){var e=this;switch(this.dataformat){case i.DATAFORMAT_BINARY:this.data=new t.ByteArray(this._xhr.response);break;case i.DATAFORMAT_SOUND:this.data=this._xhr.responseBody;break;case i.DATAFORMAT_TEXT:this.data=this._xhr.responseText;break;case i.DATAFORMAT_BITMAP:var a=document.createElement("img");return void 0!=window.createObjectURL?a.src=window.createObjectURL(this._xhr.response):void 0!=window.URL?a.src=window.URL.createObjectURL(this._xhr.response):void 0!=window.webkitURL&&(a.src=window.webkitURL.createObjectURL(this._xhr.response)),void(a.onload=function(){return e.onLoad(a)});case i.DATAFORMAT_DDS:this.data=t.DDSParser.parse(this._xhr.response);break;case i.DATAFORMAT_TGA:this.data=t.TGAParser.parse(this._xhr.response);break;case i.DATAFORMAT_HDR:this.data=t.HDRParser.parse(this._xhr.response);break;case i.DATAFORMAT_ESM:this.data=t.ESMParser.parse(this._xhr.response);break;case i.DATAFORMAT_EAM:this.data=t.EAMParser.parse(this._xhr.response);break;case i.DATAFORMAT_ECA:this.data=t.ECAParser.parse(this._xhr.response);break;case i.DATAFORMAT_EPA:this.data=t.EPAParser.parse(this._xhr.response);break;case i.DATAFORMAT_PVR:break;default:this.data=this._xhr.responseText}this.doLoadComplete()},i.prototype.onProgress=function(e){this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.target=this,this._event.loader=this,this._progressEvent=e,this.dispatchEvent(this._event)},i.prototype.onError=function(e){this._event.eventType=t.LoaderEvent3D.LOADER_ERROR,this._event.target=this,this._event.loader=this,this.dispatchEvent(this._event),console.log("load error",e)},i.prototype.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},i.prototype.onLoad=function(e){this.data=new t.ImageTexture(e),this.doLoadComplete()},i.prototype.doLoadComplete=function(){this.resourceName=t.StringUtil.getURLName(this.url),this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE,this._event.target=this,this._event.loader=this,this._event.data=this.data,this.dispatchEvent(this._event)},i.DATAFORMAT_BINARY="binary",i.DATAFORMAT_TEXT="text",i.DATAFORMAT_SOUND="sound",i.DATAFORMAT_BITMAP="bitmap",i.DATAFORMAT_DDS="dds",i.DATAFORMAT_TGA="tga",i.DATAFORMAT_ESM="esm",i.DATAFORMAT_EAM="eam",i.DATAFORMAT_ECA="eca",i.DATAFORMAT_EPA="epa",i.DATAFORMAT_PVR="pvr",i.DATAFORMAT_HDR="hdr",i}(t.EventDispatcher);t.URLLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.AssetEvent=e;var i=function(){function i(){this._loaderDict={}}return i.prototype.findAsset=function(t){return this._loaderDict[t]},i.prototype.dispatchTask=function(e,i){if(void 0===i&&(i=null),!this._loaderDict[e]){var a=new t.URLLoader(e,i);a.addEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this),this._loaderDict[e]=a}return this._loaderDict[e]},i.prototype.dispatchEvent=function(t,i,a,r){var n=new e;n.callback=i,n.thisObject=a,n.param=r;var o=t.assetEventList;o||(o=new Array,t.assetEventList=o),o.push(n)},i.prototype.onComplete=function(e){e.loader.removeEventListener(t.LoaderEvent3D.LOADER_COMPLETE,this.onComplete,this);var i=e.loader.assetEventList;if(i){for(var a=0;a<i.length;++a){var r=i[a];r.callback.call(r.thisObject,e.loader,r.param)}i.length=0}},i}();t.AssetManager=i}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.RGB_S3TC_DXT1_FORMAT=2001]="RGB_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT1_FORMAT=2002]="RGBA_S3TC_DXT1_FORMAT",t[t.RGBA_S3TC_DXT3_FORMAT=2003]="RGBA_S3TC_DXT3_FORMAT",t[t.RGBA_S3TC_DXT5_FORMAT=2003]="RGBA_S3TC_DXT5_FORMAT"}(t.DDSFormat||(t.DDSFormat={}));var e=t.DDSFormat,i=function(){function i(){}return i.parse=function(a,r){void 0===r&&(r=!0);var n=31,o=0,s=542327876,h=131072,l=512,u=4,c=i.fourCCToInt32("DXT1"),d=i.fourCCToInt32("DXT3"),p=i.fourCCToInt32("DXT5"),f=1021,o=0,_=1,m=2,v=3,g=4,y=7,x=20,D=21,b=22,w=23,T=24,P=25,S=26,C=28,A=new Int32Array(a,0,n);if(A[o]!==s)return console.error("DDSParser.parse: Invalid magic number in DDS header."),null;if(!(A[x]&u))return console.error("DDSParser.parse: Unsupported format, must contain a FourCC code."),null;var E,L,M,F,z,O=A[D],N=!1,V=1;switch(O){case c:E=8,L=e.RGB_S3TC_DXT1_FORMAT;break;case d:E=16,L=e.RGBA_S3TC_DXT3_FORMAT;break;case p:E=16,L=e.RGBA_S3TC_DXT5_FORMAT;break;default:if(!(32==A[b]&&16711680&A[w]&&65280&A[T]&&255&A[P]&&4278190080&A[S]))return console.error("DDSParser.parse: Unsupported FourCC code ",i.int32ToFourCC(O)),null;N=!0,E=64,L=f}A[m]&h&&r!==!1&&(V=Math.max(1,A[y])),M=A[C]&l?!0:!1,F=A[g],z=A[v];var R=A[_]+4,B=M?6:1,I=new Array,U=!1;L==e.RGB_S3TC_DXT1_FORMAT&&0==t.ContextConfig.ColorFormat_DXT1_RGB?U=!0:L==e.RGBA_S3TC_DXT3_FORMAT&&0==t.ContextConfig.ColorFormat_DXT3_RGBA?U=!0:L==e.RGBA_S3TC_DXT5_FORMAT&&0==t.ContextConfig.ColorFormat_DXT5_RGBA&&(U=!0);var k=new t.MimapTexture;k.width=F,k.height=z;for(var G=0;B>G;G++){for(var j=0;V>j;j++){var X;if(N){X=i.loadARGBMip(a,R,F,z);var Y=X.length}else{var Y=Math.max(4,F)/4*Math.max(4,z)/4*E;X=new Uint8Array(a,R,Y),U&&(X=i.softSolutionDXT(F,z,L,X))}var K=new t.MipmapData(X,F,z);I.push(K),R+=Y,F=Math.max(.5*F,1),z=Math.max(.5*z,1)}F=F,z=z}return U?(k.internalFormat=t.InternalFormat.PixelArray,k.colorFormat=t.ContextConfig.ColorFormat_RGBA8888):(k.internalFormat=t.InternalFormat.CompressData,c==O?k.colorFormat=t.ContextConfig.ColorFormat_DXT1_RGB:d==O?k.colorFormat=t.ContextConfig.ColorFormat_DXT3_RGBA:p==O&&(k.colorFormat=t.ContextConfig.ColorFormat_DXT5_RGBA)),k.mimapData=I,k},i.loadARGBMip=function(t,e,i,a){for(var r=i*a*4,n=new Uint8Array(t,e,r),o=new Uint8Array(r),s=0,h=0,l=0;a>l;l++)for(var u=0;i>u;u++){var c=n[h];h++;var d=n[h];h++;var p=n[h];h++;var f=n[h];h++,o[s]=p,s++,o[s]=d,s++,o[s]=c,s++,o[s]=f,s++}return o},i.fourCCToInt32=function(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)},i.int32ToFourCC=function(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&65385)},i.softSolutionDXT=function(i,a,r,n){var o,s=new Uint8Array(i*a*4),h=[new t.Color,new t.Color,new t.Color,new t.Color],l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];switch(r){case e.RGB_S3TC_DXT1_FORMAT:case e.RGBA_S3TC_DXT1_FORMAT:o=n.length/8;for(var u=0;o>u;u++){var c=n[8*u+0]|n[8*u+1]<<8,d=n[8*u+2]|n[8*u+3]<<8;h[0].r=c>>11&31,h[0].g=c>>5&63,h[0].b=31&c,h[0].a=255,h[1].r=d>>11&31,h[1].g=d>>5&63,h[1].b=31&d,h[1].a=255,c>d?(h[2].lerp(h[0],h[1],.33),h[3].lerp(h[0],h[1],.66)):h[2].lerp(h[0],h[1],.5);for(var p=0;4>p;p++)l[4*p+0]=3&n[8*u+4+p],l[4*p+1]=n[8*u+4+p]>>2&3,l[4*p+2]=n[8*u+4+p]>>4&3,l[4*p+3]=n[8*u+4+p]>>6&3;for(var f=0;f<h.length;f++)h[f].r=8*h[f].r,h[f].g=4*h[f].g,h[f].b=8*h[f].b;var _=u%(i/4)*4,m=4*Math.floor(u/(i/4));a>m+0&&(i>_+0&&(s[(m+0)*(4*i)+4*(_+0)+0]=h[l[0]].r,s[(m+0)*(4*i)+4*(_+0)+1]=h[l[0]].g,s[(m+0)*(4*i)+4*(_+0)+2]=h[l[0]].b,s[(m+0)*(4*i)+4*(_+0)+3]=h[l[0]].a),i>_+1&&(s[(m+0)*(4*i)+4*(_+1)+0]=h[l[1]].r,s[(m+0)*(4*i)+4*(_+1)+1]=h[l[1]].g,s[(m+0)*(4*i)+4*(_+1)+2]=h[l[1]].b,s[(m+0)*(4*i)+4*(_+1)+3]=h[l[1]].a),i>_+2&&(s[(m+0)*(4*i)+4*(_+2)+0]=h[l[2]].r,s[(m+0)*(4*i)+4*(_+2)+1]=h[l[2]].g,s[(m+0)*(4*i)+4*(_+2)+2]=h[l[2]].b,s[(m+0)*(4*i)+4*(_+2)+3]=h[l[2]].a),i>_+3&&(s[(m+0)*(4*i)+4*(_+3)+0]=h[l[3]].r,s[(m+0)*(4*i)+4*(_+3)+1]=h[l[3]].g,s[(m+0)*(4*i)+4*(_+3)+2]=h[l[3]].b,s[(m+0)*(4*i)+4*(_+3)+3]=h[l[3]].a)),a>m+1&&(i>_+0&&(s[(m+1)*(4*i)+4*(_+0)+0]=h[l[4]].r,s[(m+1)*(4*i)+4*(_+0)+1]=h[l[4]].g,s[(m+1)*(4*i)+4*(_+0)+2]=h[l[4]].b,s[(m+1)*(4*i)+4*(_+0)+3]=h[l[4]].a),i>_+1&&(s[(m+1)*(4*i)+4*(_+1)+0]=h[l[5]].r,s[(m+1)*(4*i)+4*(_+1)+1]=h[l[5]].g,s[(m+1)*(4*i)+4*(_+1)+2]=h[l[5]].b,s[(m+1)*(4*i)+4*(_+1)+3]=h[l[5]].a),i>_+2&&(s[(m+1)*(4*i)+4*(_+2)+0]=h[l[6]].r,s[(m+1)*(4*i)+4*(_+2)+1]=h[l[6]].g,s[(m+1)*(4*i)+4*(_+2)+2]=h[l[6]].b,s[(m+1)*(4*i)+4*(_+2)+3]=h[l[6]].a),i>_+3&&(s[(m+1)*(4*i)+4*(_+3)+0]=h[l[7]].r,s[(m+1)*(4*i)+4*(_+3)+1]=h[l[7]].g,s[(m+1)*(4*i)+4*(_+3)+2]=h[l[7]].b,s[(m+1)*(4*i)+4*(_+3)+3]=h[l[7]].a)),a>m+2&&(i>_+0&&(s[(m+2)*(4*i)+4*(_+0)+0]=h[l[8]].r,s[(m+2)*(4*i)+4*(_+0)+1]=h[l[8]].g,s[(m+2)*(4*i)+4*(_+0)+2]=h[l[8]].b,s[(m+2)*(4*i)+4*(_+0)+3]=h[l[8]].a),i>_+1&&(s[(m+2)*(4*i)+4*(_+1)+0]=h[l[9]].r,s[(m+2)*(4*i)+4*(_+1)+1]=h[l[9]].g,s[(m+2)*(4*i)+4*(_+1)+2]=h[l[9]].b,s[(m+2)*(4*i)+4*(_+1)+3]=h[l[9]].a),i>_+2&&(s[(m+2)*(4*i)+4*(_+2)+0]=h[l[10]].r,s[(m+2)*(4*i)+4*(_+2)+1]=h[l[10]].g,s[(m+2)*(4*i)+4*(_+2)+2]=h[l[10]].b,s[(m+2)*(4*i)+4*(_+2)+3]=h[l[10]].a),i>_+3&&(s[(m+2)*(4*i)+4*(_+3)+0]=h[l[11]].r,s[(m+2)*(4*i)+4*(_+3)+1]=h[l[11]].g,s[(m+2)*(4*i)+4*(_+3)+2]=h[l[11]].b,s[(m+2)*(4*i)+4*(_+3)+3]=h[l[11]].a)),a>m+3&&(i>_+0&&(s[(m+3)*(4*i)+4*(_+0)+0]=h[l[12]].r,s[(m+3)*(4*i)+4*(_+0)+1]=h[l[12]].g,s[(m+3)*(4*i)+4*(_+0)+2]=h[l[12]].b,s[(m+3)*(4*i)+4*(_+0)+3]=h[l[12]].a),i>_+1&&(s[(m+3)*(4*i)+4*(_+1)+0]=h[l[13]].r,s[(m+3)*(4*i)+4*(_+1)+1]=h[l[13]].g,s[(m+3)*(4*i)+4*(_+1)+2]=h[l[13]].b,s[(m+3)*(4*i)+4*(_+1)+3]=h[l[13]].a),i>_+2&&(s[(m+3)*(4*i)+4*(_+2)+0]=h[l[14]].r,s[(m+3)*(4*i)+4*(_+2)+1]=h[l[14]].g,s[(m+3)*(4*i)+4*(_+2)+2]=h[l[14]].b,s[(m+3)*(4*i)+4*(_+2)+3]=h[l[14]].a),i>_+3&&(s[(m+3)*(4*i)+4*(_+3)+0]=h[l[15]].r,s[(m+3)*(4*i)+4*(_+3)+1]=h[l[15]].g,s[(m+3)*(4*i)+4*(_+3)+2]=h[l[15]].b,s[(m+3)*(4*i)+4*(_+3)+3]=h[l[15]].a))}break;case e.RGBA_S3TC_DXT3_FORMAT:o=n.length/16;for(var u=0;o>u;u++){var c=n[16*u+8]|n[16*u+9]<<8,d=n[16*u+10]|n[16*u+11]<<8;h[0].r=c>>11&31,h[0].g=c>>5&63,h[0].b=31&c,h[0].a=255,h[1].r=d>>11&31,h[1].g=d>>5&63,h[1].b=31&d,h[1].a=255,c>d?(h[2].lerp(h[0],h[1],.33),h[3].lerp(h[0],h[1],.66)):(h[2].lerp(h[0],h[1],.5),h[3].a=0);for(var p=0;4>p;p++)l[4*p+0]=3&n[16*u+12+p],l[4*p+1]=n[16*u+12+p]>>2&3,l[4*p+2]=n[16*u+12+p]>>4&3,l[4*p+3]=n[16*u+12+p]>>6&3;for(var f=0;f<h.length;f++)h[f].r=8*h[f].r,h[f].g=4*h[f].g,h[f].b=8*h[f].b;var _=u%(i/4)*4,m=4*Math.floor(u/(i/4));a>m+0&&(i>_+0&&(s[(m+0)*(4*i)+4*(_+0)+0]=h[l[0]].r,s[(m+0)*(4*i)+4*(_+0)+1]=h[l[0]].g,s[(m+0)*(4*i)+4*(_+0)+2]=h[l[0]].b,s[(m+0)*(4*i)+4*(_+0)+3]=17*(15&n[16*u+0])),i>_+1&&(s[(m+0)*(4*i)+4*(_+1)+0]=h[l[1]].r,s[(m+0)*(4*i)+4*(_+1)+1]=h[l[1]].g,s[(m+0)*(4*i)+4*(_+1)+2]=h[l[1]].b,s[(m+0)*(4*i)+4*(_+1)+3]=17*(n[16*u+0]>>4&15)),i>_+2&&(s[(m+0)*(4*i)+4*(_+2)+0]=h[l[2]].r,s[(m+0)*(4*i)+4*(_+2)+1]=h[l[2]].g,s[(m+0)*(4*i)+4*(_+2)+2]=h[l[2]].b,s[(m+0)*(4*i)+4*(_+2)+3]=17*(15&n[16*u+1])),i>_+3&&(s[(m+0)*(4*i)+4*(_+3)+0]=h[l[3]].r,s[(m+0)*(4*i)+4*(_+3)+1]=h[l[3]].g,s[(m+0)*(4*i)+4*(_+3)+2]=h[l[3]].b,s[(m+0)*(4*i)+4*(_+3)+3]=17*(n[16*u+1]>>4&15))),a>m+1&&(i>_+0&&(s[(m+1)*(4*i)+4*(_+0)+0]=h[l[4]].r,s[(m+1)*(4*i)+4*(_+0)+1]=h[l[4]].g,s[(m+1)*(4*i)+4*(_+0)+2]=h[l[4]].b,s[(m+1)*(4*i)+4*(_+0)+3]=17*(15&n[16*u+2])),i>_+1&&(s[(m+1)*(4*i)+4*(_+1)+0]=h[l[5]].r,s[(m+1)*(4*i)+4*(_+1)+1]=h[l[5]].g,s[(m+1)*(4*i)+4*(_+1)+2]=h[l[5]].b,s[(m+1)*(4*i)+4*(_+1)+3]=17*(n[16*u+2]>>4&15)),i>_+2&&(s[(m+1)*(4*i)+4*(_+2)+0]=h[l[6]].r,s[(m+1)*(4*i)+4*(_+2)+1]=h[l[6]].g,s[(m+1)*(4*i)+4*(_+2)+2]=h[l[6]].b,s[(m+1)*(4*i)+4*(_+2)+3]=17*(15&n[16*u+3])),i>_+3&&(s[(m+1)*(4*i)+4*(_+3)+0]=h[l[7]].r,s[(m+1)*(4*i)+4*(_+3)+1]=h[l[7]].g,s[(m+1)*(4*i)+4*(_+3)+2]=h[l[7]].b,s[(m+1)*(4*i)+4*(_+3)+3]=17*(n[16*u+3]>>4&15))),a>m+2&&(i>_+0&&(s[(m+2)*(4*i)+4*(_+0)+0]=h[l[8]].r,s[(m+2)*(4*i)+4*(_+0)+1]=h[l[8]].g,s[(m+2)*(4*i)+4*(_+0)+2]=h[l[8]].b,s[(m+2)*(4*i)+4*(_+0)+3]=17*(15&n[16*u+4])),i>_+1&&(s[(m+2)*(4*i)+4*(_+1)+0]=h[l[9]].r,s[(m+2)*(4*i)+4*(_+1)+1]=h[l[9]].g,s[(m+2)*(4*i)+4*(_+1)+2]=h[l[9]].b,s[(m+2)*(4*i)+4*(_+1)+3]=17*(n[16*u+4]>>4&15)),i>_+2&&(s[(m+2)*(4*i)+4*(_+2)+0]=h[l[10]].r,s[(m+2)*(4*i)+4*(_+2)+1]=h[l[10]].g,s[(m+2)*(4*i)+4*(_+2)+2]=h[l[10]].b,s[(m+2)*(4*i)+4*(_+2)+3]=17*(15&n[16*u+5])),i>_+3&&(s[(m+2)*(4*i)+4*(_+3)+0]=h[l[11]].r,s[(m+2)*(4*i)+4*(_+3)+1]=h[l[11]].g,s[(m+2)*(4*i)+4*(_+3)+2]=h[l[11]].b,s[(m+2)*(4*i)+4*(_+3)+3]=17*(n[16*u+5]>>4&15))),a>m+3&&(i>_+0&&(s[(m+3)*(4*i)+4*(_+0)+0]=h[l[12]].r,s[(m+3)*(4*i)+4*(_+0)+1]=h[l[12]].g,s[(m+3)*(4*i)+4*(_+0)+2]=h[l[12]].b,s[(m+3)*(4*i)+4*(_+0)+3]=17*(15&n[16*u+6])),i>_+1&&(s[(m+3)*(4*i)+4*(_+1)+0]=h[l[13]].r,s[(m+3)*(4*i)+4*(_+1)+1]=h[l[13]].g,s[(m+3)*(4*i)+4*(_+1)+2]=h[l[13]].b,s[(m+3)*(4*i)+4*(_+1)+3]=17*(n[16*u+6]>>4&15)),i>_+2&&(s[(m+3)*(4*i)+4*(_+2)+0]=h[l[14]].r,s[(m+3)*(4*i)+4*(_+2)+1]=h[l[14]].g,s[(m+3)*(4*i)+4*(_+2)+2]=h[l[14]].b,s[(m+3)*(4*i)+4*(_+2)+3]=17*(15&n[16*u+7])),i>_+3&&(s[(m+3)*(4*i)+4*(_+3)+0]=h[l[15]].r,s[(m+3)*(4*i)+4*(_+3)+1]=h[l[15]].g,s[(m+3)*(4*i)+4*(_+3)+2]=h[l[15]].b,s[(m+3)*(4*i)+4*(_+3)+3]=17*(n[16*u+7]>>4&15)))}break;case e.RGBA_S3TC_DXT5_FORMAT:}return s},i}();t.DDSParser=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t}();t.PVR=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.RGB_PVRTC_4BPPV1_Format=2100]="RGB_PVRTC_4BPPV1_Format",t[t.RGB_PVRTC_2BPPV1_Format=2101]="RGB_PVRTC_2BPPV1_Format",t[t.RGBA_PVRTC_4BPPV1_Format=2102]="RGBA_PVRTC_4BPPV1_Format",t[t.RGBA_PVRTC_2BPPV1_Format=2103]="RGBA_PVRTC_2BPPV1_Format"}(t.PVRFormat||(t.PVRFormat={}));var e=t.PVRFormat,i=function(){function i(){}return i.parse=function(e){var a=new t.PVR,r=13,n=new Uint32Array(e,0,r),o={buffer:e,header:n};return 55727696===n[0]?a=i._parseV3(o):559044176===n[11]?a=i._parseV2(o):console.log("PVRParser unknow pvr format. PVRParser::parse"),a},i._parseV2=function(t){var a,r,n=t.header,o=n[0],s=n[1],h=n[2],l=n[3],u=n[4],a=(n[5],n[6]),c=(n[7],n[8],n[9],n[10]),d=(n[11],n[12]),p=255,f=24,_=25,m=u&p,v=c>0;if(m===_)r=v?e.RGBA_PVRTC_4BPPV1_Format:e.RGB_PVRTC_4BPPV1_Format,a=4;else{if(m!==f)throw new Error("pvrtc - unknown format "+m);r=v?e.RGBA_PVRTC_2BPPV1_Format:e.RGB_PVRTC_2BPPV1_Format,a=2}return t.dataPtr=o,t.bpp=a,t.format=r,t.width=h,t.height=s,t.numSurfaces=d,t.numMipmaps=l+1,t.isCubemap=6===d,i._extract(t)},i._parseV3=function(t){var a,r,n=t.header,o=n[12],s=n[2],h=n[6],l=n[7],u=(n[9],n[10]),c=n[11];switch(s){case 0:a=2,r=e.RGB_PVRTC_2BPPV1_Format;break;case 1:a=2,r=e.RGBA_PVRTC_2BPPV1_Format;break;case 2:a=4,r=e.RGB_PVRTC_4BPPV1_Format;break;case 3:a=4,r=e.RGBA_PVRTC_4BPPV1_Format;break;default:throw new Error("pvrtc - unsupported PVR format "+s)}return t.dataPtr=52+o,t.bpp=a,t.format=r,t.width=l,t.height=h,t.numSurfaces=u,t.numMipmaps=c,t.isCubemap=6===u,i._extract(t)},i._extract=function(e){var i=new t.PVR,a=e.buffer,r=e.dataPtr,n=e.bpp,o=e.numSurfaces,s=0,h=0,l=0,u=0,c=0,d=0;2===n?(l=8,u=4):(l=4,u=4),h=l*u*n/8,i.mipmaps.length=e.numMipmaps*o;for(var p=0;p<e.numMipmaps;){var f=e.width>>p,_=e.height>>p;c=f/l,d=_/u,2>c&&(c=2),2>d&&(d=2),s=c*d*h;for(var m=0;o>m;m++){var v=new Uint8Array(a,r,s),g={data:v,width:f,height:_};i.mipmaps[m*e.numMipmaps+p]=g,r+=s}p++}return i},i}();t.PVRParser=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){function i(t){switch(t.image_type){case d:case _:(t.colormap_length>256||24!==t.colormap_size||1!==t.colormap_type)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for indexed type");break;case p:case f:case m:case v:t.colormap_type&&console.error("TGAParser.parse.tgaCheckHeader: Invalid type colormap data for colormap type");break;case c:console.error("TGAParser.parse.tgaCheckHeader: No data");break;default:console.error('TGAParser.parse.tgaCheckHeader: Invalid type " '+t.image_type+'"')}(t.width<=0||t.height<=0)&&console.error("TGAParser.parse.tgaCheckHeader: Invalid image size"),8!==t.pixel_size&&16!==t.pixel_size&&24!==t.pixel_size&&32!==t.pixel_size&&console.error('TGAParser.parse.tgaCheckHeader: Invalid pixel size "'+t.pixel_size+'"')}function a(t,e,i,a,r){var n,o,s,h;if(o=i.pixel_size>>3,s=i.width*i.height*o,e&&(h=r.subarray(a,a+=i.colormap_length*(i.colormap_size>>3))),t){n=new Uint8Array(s);for(var l,u,c,d=0,p=new Uint8Array(o);s>d;)if(l=r[a++],u=(127&l)+1,128&l){for(c=0;o>c;++c)p[c]=r[a++];for(c=0;u>c;++c)n.set(p,d+c*o);d+=o*u}else{for(u*=o,c=0;u>c;++c)n[d+c]=r[a++];d+=u}}else n=r.subarray(a,a+=e?i.width*i.height:s);return{pixel_data:n,palettes:h}}function r(t,e,i,a,r,n,o,s,h){var l,u,c,d=h,p=0,f=S.width;for(c=e;c!==a;c+=i)for(u=r;u!==o;u+=n,p++)l=s[p],t[4*(u+f*c)+3]=255,t[4*(u+f*c)+2]=d[3*l+0],t[4*(u+f*c)+1]=d[3*l+1],t[4*(u+f*c)+0]=d[3*l+2];return t}function n(t,e,i,a,r,n,o,s){var h,l,u,c=0,d=S.width;for(u=e;u!==a;u+=i)for(l=r;l!==o;l+=n,c+=2)h=s[c+0]+(s[c+1]<<8),t[4*(l+d*u)+0]=(31744&h)>>7,t[4*(l+d*u)+1]=(992&h)>>2,t[4*(l+d*u)+2]=(31&h)>>3,t[4*(l+d*u)+3]=32768&h?0:255;return t}function o(t,e,i,a,r,n,o,s){var h,l,u=0,c=S.width;for(l=e;l!==a;l+=i)for(h=r;h!==o;h+=n,u+=3)t[4*(h+c*l)+3]=255,t[4*(h+c*l)+2]=s[u+0],t[4*(h+c*l)+1]=s[u+1],t[4*(h+c*l)+0]=s[u+2];return t}function s(t,e,i,a,r,n,o,s){var h,l,u=0,c=S.width;for(l=e;l!==a;l+=i)for(h=r;h!==o;h+=n,u+=4)t[4*(h+c*l)+2]=s[u+0],t[4*(h+c*l)+1]=s[u+1],t[4*(h+c*l)+0]=s[u+2],t[4*(h+c*l)+3]=s[u+3];return t}function h(t,e,i,a,r,n,o,s){var h,l,u,c=0,d=S.width;for(u=e;u!==a;u+=i)for(l=r;l!==o;l+=n,c++)h=s[c],t[4*(l+d*u)+0]=h,t[4*(l+d*u)+1]=h,t[4*(l+d*u)+2]=h,t[4*(l+d*u)+3]=255;return t}function l(t,e,i,a,r,n,o,s){var h,l,u=0,c=S.width;for(l=e;l!==a;l+=i)for(h=r;h!==o;h+=n,u+=2)t[4*(h+c*l)+0]=s[u+0],t[4*(h+c*l)+1]=s[u+0],t[4*(h+c*l)+2]=s[u+0],t[4*(h+c*l)+3]=s[u+1];return t}function u(t,e,i,a){var u,c,d,p,f,_,m=new Uint8Array(t*e*4);switch((S.flags&g)>>y){default:case b:u=0,d=1,f=t,c=0,p=1,_=e;break;case x:u=0,d=1,f=t,c=e-1,p=-1,_=-1;break;case w:u=t-1,d=-1,f=-1,c=0,p=1,_=e;break;case D:u=t-1,d=-1,f=-1,c=e-1,p=-1,_=-1}if(E)switch(S.pixel_size){case 8:h(m,c,p,_,u,d,f,i);break;case 16:l(m,c,p,_,u,d,f,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}else switch(S.pixel_size){case 8:r(m,c,p,_,u,d,f,i,a);break;case 16:n(m,c,p,_,u,d,f,i);break;case 24:o(m,c,p,_,u,d,f,i);break;case 32:s(m,c,p,_,u,d,f,i);break;default:console.error("TGAParser.parse.getTgaRGBA: not support this format")}return m}var c=0,d=1,p=2,f=3,_=9,m=10,v=11,g=48,y=4,x=0,D=1,b=2,w=3;e.byteLength<19&&console.error("TGAParser.parse: Not enough data to contain header.");var T=new Uint8Array(e),P=0,S={id_length:T[P++],colormap_type:T[P++],image_type:T[P++],colormap_index:T[P++]|T[P++]<<8,colormap_length:T[P++]|T[P++]<<8,colormap_size:T[P++],origin:[T[P++]|T[P++]<<8,T[P++]|T[P++]<<8],width:T[P++]|T[P++]<<8,height:T[P++]|T[P++]<<8,pixel_size:T[P++],flags:T[P++]};i(S),S.id_length+P>e.byteLength&&console.error("TGAParser.parse: No data"),P+=S.id_length;var C=!1,A=!1,E=!1;switch(S.image_type){case _:C=!0,A=!0;break;case d:A=!0;break;case m:C=!0;break;case p:break;case v:C=!0,E=!0;break;case f:E=!0}var L=a(C,A,S,P,T),M=u(S.width,S.height,L.pixel_data,L.palettes),F=new t.MimapTexture;return F.width=S.width,F.height=S.height,F.internalFormat=t.InternalFormat.PixelArray,F.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,F.mimapData=[new t.MipmapData(M,S.width,S.height)],F},e}();t.TGAParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.ldexp=function(t,e){return e>1023?t*Math.pow(2,1023)*Math.pow(2,e-1023):-1074>e?t*Math.pow(2,-1074)*Math.pow(2,e+1074):t*Math.pow(2,e)},e.readPixelsRawRLE=function(t,e,i,a,r,n){function o(e){var i=0;do e[i++]=t[a];while(++a<_&&i<e.length);return i}function s(e,i,r){var n=0;do e[i+n++]=t[a];while(++a<_&&r>n);return n}function h(t,e,i,a){var r=4*a,n=s(e,i,r);if(r>n)throw new Error("Error reading raw pixels: got "+n+" bytes, expected "+r)}for(var l,u,c,d=new Array(4),p=null,f=new Array(2),_=t.length;n>0;){if(o(d)<d.length)throw new Error("Error reading bytes: expected "+d.length);if(2!=d[0]||2!=d[1]||0!=(128&d[2]))return e[i++]=d[0],e[i++]=d[1],e[i++]=d[2],e[i++]=d[3],void h(t,e,i,r*n-1);if(((255&d[2])<<8|255&d[3])!=r)throw new Error("Wrong scanline width "+((255&d[2])<<8|255&d[3])+", expected "+r);null==p&&(p=new Array(4*r)),l=0;for(var m=0;4>m;m++)for(u=(m+1)*r;u>l;){if(o(f)<f.length)throw new Error("Error reading 2-byte buffer");if((255&f[0])>128){if(c=(255&f[0])-128,0==c||c>u-l)throw new Error("Bad scanline data");for(;c-->0;)p[l++]=f[1]}else{if(c=255&f[0],0==c||c>u-l)throw new Error("Bad scanline data");if(p[l++]=f[1],--c>0){if(s(p,l,c)<c)throw new Error("Error reading non-run data");l+=c}}}for(var m=0;r>m;m++)e[i+0]=p[m],e[i+1]=p[m+r],e[i+2]=p[m+2*r],e[i+3]=p[m+3*r],i+=4;n--}},e.parse=function(i){function a(){var t="";do{var e=i[r];if(e==o){++r;break}t+=String.fromCharCode(e)}while(++r<n);return t}i instanceof ArrayBuffer&&(i=new Uint8Array(i));for(var r=0,n=i.length,o=10,s=0,h=0,l=1,u=!1,c=0;20>c;c++){var d,p=a();if(d=p.match(e.radiancePattern));else if(d=p.match(e.formatPattern))u=!0;else if(d=p.match(e.exposurePattern))l=Number(d[1]);else if(d=p.match(e.commentPattern));else if(d=p.match(e.widthHeightPattern)){h=Number(d[1]),s=Number(d[2]);break}}if(!u)throw new Error("File is not run length encoded!");var f=new Uint8Array(s*h*4),_=s,m=h;this.readPixelsRawRLE(i,f,0,r,_,m);var v=new t.MipmapData(f,s,h),g=new t.MimapTexture;return g.internalFormat=t.InternalFormat.PixelArray,g.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,g.mimapData=[v],g.useMipmap=!1,g.width=s,g.height=h,g},e.radiancePattern="#\\?RADIANCE",e.commentPattern="#.*",e.gammaPattern="GAMMA=",e.exposurePattern="EXPOSURE=\\s*([0-9]*[.][0-9]*)",e.formatPattern="FORMAT=32-bit_rle_rgbe",e.widthHeightPattern="-Y ([0-9]+) \\+X ([0-9]+)",e}();t.HDRParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var i=new t.ByteArray(e),a=new t.ByteArray;i.readBytes(a,0,3);var r=i.readUnsignedInt();return t.EAMVersion.versionDictionary[r]?t.EAMVersion.versionDictionary[r](i):(console.log("egret3d engine not found "+r+" version"),null)},e}();t.EAMParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e){var i=e.readUnsignedByte();e.readUnsignedByte();if(0>=i)return null;for(var a=new t.SkeletonAnimationClip,r=new Array,n=new Array,o=0;i>o;o++)r.push(e.readUTF()),n.push(e.readUTF());for(var s=(e.readInt(),e.readInt()),h=new t.Quaternion,l=new t.Vector3D,u=new t.Vector3D,o=0;s>o;o++){var c=new t.SkeletonPose;c.frameTime=e.readInt()/60/80*1e3;for(var d=0;i>d;d++){var p=new t.Joint(r[d]);p.parent=n[d],p.parentIndex=c.findJointIndex(p.parent),h.fromEulerAngles(e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES),l.x=e.readFloat(),l.y=e.readFloat(),l.z=e.readFloat(),u.x=e.readFloat(),u.y=e.readFloat(),u.z=e.readFloat(),p.buildLocalMatrix(l,h,u),c.joints.push(p)
}c.calculateJointWorldMatrix(),a.addSkeletonPose(c)}return a},e.parserVersion_2=function(e){var i=e.readUnsignedByte();e.readUnsignedByte();if(0>=i)return null;for(var a=new t.SkeletonAnimationClip,r=new Array,n=new Array,o=0;i>o;o++)r.push(e.readUTF()),n.push(e.readUTF());for(var s=(e.readInt(),e.readInt()),h=new t.Quaternion,l=new t.Vector3D,u=new t.Vector3D,o=0;s>o;o++){var c=new t.SkeletonPose;c.frameTime=e.readInt()/60/80*1e3;for(var d=0;i>d;d++){var p=new t.Joint(r[d]);p.parent=n[d],p.parentIndex=c.findJointIndex(p.parent),h.x=e.readFloat(),h.y=e.readFloat(),h.z=e.readFloat(),h.w=e.readFloat(),l.x=e.readFloat(),l.y=e.readFloat(),l.z=e.readFloat(),u.x=e.readFloat(),u.y=e.readFloat(),u.z=e.readFloat(),p.buildLocalMatrix(l,h,u),c.joints.push(p)}c.calculateJointWorldMatrix(),a.addSkeletonPose(c)}return a},e.parserVersion_3=function(t){return null},e.versionDictionary={1:function(t){return e.parserVersion_1(t)},2:function(t){return e.parserVersion_2(t)},3:function(t){return e.parserVersion_3(t)}},e}();t.EAMVersion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var i=new t.ByteArray(e),a=new t.ByteArray;i.readBytes(a,0,3);var r=i.readUnsignedInt();return t.ECAVersion.versionDictionary[r]?t.ECAVersion.versionDictionary[r](i):(console.log("egret3d engine not found "+r+" version"),null)},e}();t.ECAParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e){for(var i=new t.CameraAnimationController,a=e.readUnsignedInt(),r=null,n=new t.Vector3D(1,1,1,1);a--;)r=new t.CameraAnimationFrame,r.time=e.readInt(),r.fov=e.readFloat(),r.rotation=new t.Vector3D(e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES+90,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES),r.translation=new t.Vector3D(e.readFloat(),e.readFloat(),e.readFloat()),r.matrix=new t.Matrix4_4,r.matrix.recompose([r.translation,r.rotation,n]),i.cameraAnimationFrames.push(r);return i},e.versionDictionary={1:function(t){return e.parserVersion_1(t)}},e}();t.ECAVersion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var i=new t.ByteArray(e),a=new t.ByteArray;i.readBytes(a,0,3);var r=i.readUnsignedInt();if(!t.ESMVersion.versionDictionary[r])return console.log("egret3d engine not found "+r+" version"),null;var n=new t.GeometryData;t.ESMVersion.versionDictionary[r](i,n);var o,s=0;return n.source_skinData.length>0?(s=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_SKIN,o=t.GeometryData.buildGeomtry(n,s)):(s=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_NORMAL|t.VertexFormat.VF_TANGENT|t.VertexFormat.VF_COLOR|t.VertexFormat.VF_UV0|t.VertexFormat.VF_UV1,o=t.GeometryData.buildGeomtry(n,s)),o},e}();t.ESMParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e,i){var a=e.readInt();i.matCount=e.readInt();for(var r=0;r<i.matCount;++r)i.material[r]={},i.material[r].matID=e.readInt(),i.material[r].start=e.readInt(),i.material[r].count=e.readInt(),i.material[r].textureDiffuse=e.readUTF(),i.material[r].textureNormal=e.readUTF(),i.material[r].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var n=e.readInt(),r=0;n>r;r++)i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL)for(var o=e.readInt(),r=0;o>r;r++)i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat());if(a&t.VertexFormat.VF_COLOR)for(var s=e.readInt(),r=0;s>r;r++)i.source_vertexColorData.push(e.readFloat()),i.source_vertexColorData.push(e.readFloat()),i.source_vertexColorData.push(e.readFloat()),i.source_vertexColorData.push(e.readFloat());if(a&t.VertexFormat.VF_UV0)for(var h=e.readInt(),r=0;h>r;r++)i.source_uvData.push(e.readFloat()),i.source_uvData.push(e.readFloat());if(a&t.VertexFormat.VF_UV1)for(var h=e.readInt(),r=0;h>r;r++)i.source_uv2Data.push(e.readFloat()),i.source_uv2Data.push(e.readFloat());i.faces=e.readInt();for(var r=0;r<i.faces;r++)i.vertexIndices.push(e.readUnsignedInt()),i.vertexIndices.push(e.readUnsignedInt()),i.vertexIndices.push(e.readUnsignedInt()),a&t.VertexFormat.VF_NORMAL&&(i.normalIndices.push(e.readUnsignedInt()),i.normalIndices.push(e.readUnsignedInt()),i.normalIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_COLOR&&(i.colorIndices.push(e.readUnsignedInt()),i.colorIndices.push(e.readUnsignedInt()),i.colorIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_UV0&&(i.uvIndices.push(e.readUnsignedInt()),i.uvIndices.push(e.readUnsignedInt()),i.uvIndices.push(e.readUnsignedInt())),a&t.VertexFormat.VF_UV1&&(i.uv2Indices.push(e.readUnsignedInt()),i.uv2Indices.push(e.readUnsignedInt()),i.uv2Indices.push(e.readUnsignedInt()));var l=e.readUnsignedByte();l>0&&(i.skeleton=new t.Skeleton);for(var u=(new t.Quaternion,new t.Vector3D),c=new t.Vector3D,d=new t.Vector3D,r=0;l>r;++r){var p=new t.Joint(null);e.readInt(),p.parentIndex=e.readInt(),p.name=e.readUTF(),u.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,u.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,u.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.x=e.readFloat(),c.y=e.readFloat(),c.z=e.readFloat(),d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),p.buildInverseMatrix(c,u,d),i.skeleton.joints.push(p)}for(var f=e.readInt(),r=0;f>r;r++){for(var _=e.readUnsignedByte(),m=0;_>m;m++)i.source_skinData.push(e.readUnsignedByte()),i.source_skinData.push(e.readFloat());for(var m=_;4>m;m++)i.source_skinData.push(0),i.source_skinData.push(0)}},e.parserVersion_2=function(e,i){var a=e.readInt();i.matCount=e.readInt();for(var r=0;r<i.matCount;++r)i.material[r]={},i.material[r].matID=e.readInt(),i.material[r].start=e.readInt(),i.material[r].count=e.readInt(),i.material[r].textureDiffuse=e.readUTF(),i.material[r].textureNormal=e.readUTF(),i.material[r].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var n=e.readInt(),r=0;n>r;r++)i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL)for(var o=e.readInt(),r=0;o>r;r++)i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat());if(a&t.VertexFormat.VF_COLOR)for(var s=e.readInt(),r=0;s>r;r++)i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255);if(a&t.VertexFormat.VF_UV0)for(var h=e.readInt(),r=0;h>r;r++)i.source_uvData.push(e.readFloat()),i.source_uvData.push(e.readFloat());if(a&t.VertexFormat.VF_UV1)for(var h=e.readInt(),r=0;h>r;r++)i.source_uv2Data.push(e.readFloat()),i.source_uv2Data.push(e.readFloat());i.faces=e.readInt();for(var r=0;r<i.faces;r++)i.vertexIndices.push(e.readUnsignedShort()),i.vertexIndices.push(e.readUnsignedShort()),i.vertexIndices.push(e.readUnsignedShort()),a&t.VertexFormat.VF_NORMAL&&(i.normalIndices.push(e.readUnsignedShort()),i.normalIndices.push(e.readUnsignedShort()),i.normalIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_COLOR&&(i.colorIndices.push(e.readUnsignedShort()),i.colorIndices.push(e.readUnsignedShort()),i.colorIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV0&&(i.uvIndices.push(e.readUnsignedShort()),i.uvIndices.push(e.readUnsignedShort()),i.uvIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV1&&(i.uv2Indices.push(e.readUnsignedShort()),i.uv2Indices.push(e.readUnsignedShort()),i.uv2Indices.push(e.readUnsignedShort()));var l=e.readUnsignedByte();l>0&&(i.skeleton=new t.Skeleton);for(var u=(new t.Quaternion,new t.Vector3D),c=new t.Vector3D,d=new t.Vector3D,r=0;l>r;++r){var p=new t.Joint(null);e.readInt(),p.parentIndex=e.readInt(),p.name=e.readUTF(),u.x=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,u.y=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,u.z=e.readFloat()*t.MathUtil.RADIANS_TO_DEGREES,c.x=e.readFloat(),c.y=e.readFloat(),c.z=e.readFloat(),d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),p.buildInverseMatrix(c,u,d),i.skeleton.joints.push(p)}for(var f=e.readInt(),r=0;f>r;r++){for(var _=e.readUnsignedByte(),m=0;_>m;m++)i.source_skinData.push(e.readUnsignedByte()),i.source_skinData.push(e.readFloat());for(var m=_;4>m;m++)i.source_skinData.push(0),i.source_skinData.push(0)}},e.parserVersion_3=function(e,i){var a=e.readInt();i.matCount=e.readInt();for(var r=0;r<i.matCount;++r)i.material[r]={},i.material[r].matID=e.readInt(),i.material[r].start=e.readInt(),i.material[r].count=e.readInt(),i.material[r].textureDiffuse=e.readUTF(),i.material[r].textureNormal=e.readUTF(),i.material[r].textureSpecular=e.readUTF();if(a&t.VertexFormat.VF_POSITION)for(var n=e.readInt(),r=0;n>r;r++)i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat()),i.source_vertexData.push(e.readFloat());if(a&t.VertexFormat.VF_NORMAL)for(var o=e.readInt(),r=0;o>r;r++)i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat()),i.source_normalData.push(e.readFloat());if(a&t.VertexFormat.VF_COLOR)for(var s=e.readInt(),r=0;s>r;r++)i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255),i.source_vertexColorData.push(e.readUnsignedByte()/255);if(a&t.VertexFormat.VF_UV0)for(var h=e.readInt(),r=0;h>r;r++)i.source_uvData.push(e.readFloat()),i.source_uvData.push(e.readFloat());if(a&t.VertexFormat.VF_UV1)for(var h=e.readInt(),r=0;h>r;r++)i.source_uv2Data.push(e.readFloat()),i.source_uv2Data.push(e.readFloat());i.faces=e.readInt();for(var r=0;r<i.faces;r++)i.vertexIndices.push(e.readUnsignedShort()),i.vertexIndices.push(e.readUnsignedShort()),i.vertexIndices.push(e.readUnsignedShort()),a&t.VertexFormat.VF_NORMAL&&(i.normalIndices.push(e.readUnsignedShort()),i.normalIndices.push(e.readUnsignedShort()),i.normalIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_COLOR&&(i.colorIndices.push(e.readUnsignedShort()),i.colorIndices.push(e.readUnsignedShort()),i.colorIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV0&&(i.uvIndices.push(e.readUnsignedShort()),i.uvIndices.push(e.readUnsignedShort()),i.uvIndices.push(e.readUnsignedShort())),a&t.VertexFormat.VF_UV1&&(i.uv2Indices.push(e.readUnsignedShort()),i.uv2Indices.push(e.readUnsignedShort()),i.uv2Indices.push(e.readUnsignedShort()));var l=e.readUnsignedByte();l>0&&(i.skeleton=new t.Skeleton);for(var u=new t.Quaternion,c=(new t.Vector3D,new t.Vector3D),d=new t.Vector3D,r=0;l>r;++r){var p=new t.Joint(null);e.readInt(),p.parentIndex=e.readInt(),p.name=e.readUTF(),u.x=e.readFloat(),u.y=e.readFloat(),u.z=e.readFloat(),u.w=e.readFloat(),c.x=e.readFloat(),c.y=e.readFloat(),c.z=e.readFloat(),d.x=e.readFloat(),d.y=e.readFloat(),d.z=e.readFloat(),p.buildInverseMatrix(c,u,d),i.skeleton.joints.push(p)}for(var f=e.readInt(),r=0;f>r;r++){for(var _=e.readUnsignedByte(),m=0;_>m;m++)i.source_skinData.push(e.readUnsignedByte()),i.source_skinData.push(e.readFloat());for(var m=_;4>m;m++)i.source_skinData.push(0),i.source_skinData.push(0)}},e.versionDictionary={1:function(t,i){return e.parserVersion_1(t,i)},2:function(t,i){return e.parserVersion_2(t,i)},3:function(t,i){return e.parserVersion_3(t,i)}},e}();t.ESMVersion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parse=function(e){var i=new t.ByteArray(e);if(1701863680!=i.readUnsignedInt())return null;var a=i.readUnsignedInt();return t.EPAVersion.versionDictionary[a]?t.EPAVersion.versionDictionary[a](i):(console.log("egret3d engine not found "+a+" version"),null)},e}();t.EPAParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parserVersion_1=function(e){for(var i=new t.PropertyAnim,a=e.readUnsignedShort(),r=0;a>r;r++){for(var n=e.readUTF(),o=[],s=e.readUnsignedShort(),h=0;s>h;h++){var l=new t.AnimCurve;l.type=e.readUnsignedInt(),l.start.x=e.readFloat(),l.start.y=e.readFloat(),l.end.x=e.readFloat(),l.end.y=e.readFloat(),l.c1.x=e.readFloat(),l.c1.y=e.readFloat(),l.c2.x=e.readFloat(),l.c2.y=e.readFloat(),o.push(l)}i.addAnimCurve(n,o)}return i},e.versionDictionary={1:function(t){return e.parserVersion_1(t)}},e}();t.EPAVersion=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.parse=function(t){var e=null;if(!window.DOMParser&&window.ActiveXObject)for(var i=["MSXML.2.DOMDocument.6.0","MSXML.2.DOMDocument.3.0","Microsoft.XMLDOM"],a=0;a<i.length;a++)try{e=new ActiveXObject(i[a]),e.async=!1,e.loadXML(t);break}catch(r){}else{if(!(window.DOMParser&&document.implementation&&document.implementation.createDocument))return null;try{var n=new DOMParser;e=n.parseFromString(t,"text/xml")}catch(r){}}return e},t.eachXmlAttr=function(t,e){if(null!=t&&null!=e)for(var i,a=0,r=t.attributes.length;r>a;a++)i=t.attributes[a],e(i.nodeName,i.textContent)},t}();t.XMLParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===i&&(i=null),void 0===a&&(a="MapConfig.xml"),void 0===r&&(r="resource/scene/"),e.call(this),this.container=null,this.autoPlayAnimation=!1,this._pathRoot="",this._path="",this._mapXmlParser=null,this._textures={},this._taskCount=0,this._event=new t.LoaderEvent3D,this.huds=new Array,this.taskTotal=0,this.taskCurrent=0,this.lightDict={},this.container=new t.Object3D,i&&this.load(i,a,r)}return __extends(i,e),i.prototype.findTexture=function(t){return this._textures[t]},i.prototype.load=function(t,e,a){void 0===e&&(e="MapConfig.xml"),void 0===a&&(a="resource/scene/"),this._pathRoot=a+t+"/",this._path=this._pathRoot+e,this.taskTotal++;var r=i._assetMgr.dispatchTask(this._path);r.data?this.parseXML(r.data):(this.addTask(r),i._assetMgr.dispatchEvent(r,this.onXmlLoad,this,null))},i.prototype.parseXML=function(e){var a=t.XMLParser.parse(e);this._mapXmlParser=new t.MapXmlParser(a);for(var r in this._mapXmlParser.taskDict)this.taskTotal++;this.createLight();for(var n=0;n<this._mapXmlParser.nodeList.length;n++){var o=this._mapXmlParser.nodeList[n];switch(o.object3d.parent||this.container.addChild(o.object3d),("Object3D"==o.type||"Camera3D"==o.type)&&this.doLoadEpa(o),o.type){case"Mesh":if(o.path){var s=this._pathRoot+o.path,h=i._assetMgr.dispatchTask(s);h.data?this.processMesh(o,new t.Mesh(h.data,new t.TextureMaterial)):(this.addTask(h),i._assetMgr.dispatchEvent(h,this.onEsmLoad,this,o))}else o.geometry&&this.processMesh(o,new t.Mesh(t.GeometryUtil.createGemetryForType(o.geometry.type,o.geometry),new t.TextureMaterial));break;case"Terrain":if(o.path){var s=this._pathRoot+o.path,l=i._assetMgr.dispatchTask(s);if(l.data){var u=o.geometry,c=new t.ElevationGeometry(l.data,u.width,u.height,u.depth,u.segmentsW,u.segmentsH),d=new t.Mesh(c,new t.TextureMaterial(l.data));this.processHeightMesh(o,d)}else this.addTask(l),i._assetMgr.dispatchEvent(l,this.onHeightImg,this,o)}break;case"ParticleEmitter":if(o.path){var s=this._pathRoot+o.path,p=i._assetMgr.dispatchTask(s);if(p.data){var f=p.ParticleData;f&&this.processParticle(f,o)}else this.addTask(l),i._assetMgr.dispatchEvent(p,this.onParticleXML,this,o)}}}for(var n=0;n<this._mapXmlParser.textures.length;++n){var _=this._mapXmlParser.textures[n],s=this._pathRoot+_.path,m=i._assetMgr.dispatchTask(s);m.data?this._textures[_.name]=m.data:(this.addTask(m),i._assetMgr.dispatchEvent(m,this.onTexture,this,_.name))}for(var n=0;n<this._mapXmlParser.hudList.length;++n){var v=this._mapXmlParser.hudList[n],g=new t.HUD;if(g.name=v.name,g.bothside=v.bothside,g.x=v.x,g.y=v.y,g.rotationX=v.rx,g.rotationY=v.ry,g.rotationZ=v.rz,g.width=v.width,g.height=v.height,v.vs&&(g.vsShader=v.vs),v.fs&&(g.fsShader=v.fs),this.huds.push(g),v.hud=g,v.texture){var s=this._pathRoot+v.texture,y=i._assetMgr.dispatchTask(s);y.data?g.diffuseTexture=y.data:(this.addTask(y),i._assetMgr.dispatchEvent(y,this.onHudTexture,this,v))}}},i.prototype.onParticleXML=function(e,i){var a=e.ParticleData;a||(a=(new t.ParticleXmlParser).parse(e.data),e.ParticleData=a,a.fileUrl=e.url,a.fileName=e.fileName),this.processParticle(a,i),this.processTask(e)},i.prototype.processParticle=function(e,a){if(e.shape.meshFile){var r=this._pathRoot+e.shape.meshFile,n=i._assetMgr.dispatchTask(r);if(n.data)e.shape.geometry=n.data,this.processParticleGeometry(e,a);else{var o={};o.particle=e,o.nodeData=a,this.addTask(n),i._assetMgr.dispatchEvent(n,this.onParticleEsmLoad,this,o)}}else a.geometry&&(e.shape.geometry=t.GeometryUtil.createGemetryForType(a.geometry.type,a.geometry)),this.processParticleGeometry(e,a);return null},i.prototype.processParticleGeometry=function(e,i){e.materialData=this._mapXmlParser.matDict[i.materialIDs[0]];var a=new t.ParticleEmitter(e,new t.TextureMaterial);i.x*=t.ParticleData.SCALE_VALUE,i.y*=t.ParticleData.SCALE_VALUE,i.z*=t.ParticleData.SCALE_VALUE,i.object3d.position.scaleBy(t.ParticleData.SCALE_VALUE),this.processObject3d(i,a),a.play(),this.processMat(i)},i.prototype.processObject3d=function(t,e){e.name=t.object3d.name,e.visible=t.object3d.visible,e.position=t.object3d.position,e.orientation=t.object3d.orientation,e.scale=t.object3d.scale,t.object3d.swapObject(e),t.object3d=e},i.prototype.onXmlLoad=function(t){this.parseXML(t.data),this.processTask(t)},i.prototype.onHeightImg=function(e,i){var a=i.geometry,r=new t.ElevationGeometry(e.data,a.width,a.height,a.depth,a.segmentsW,a.segmentsH),n=new t.Mesh(r,new t.TextureMaterial(e.data));this.processHeightMesh(i,n),this.doLoadEpa(i),this.processTask(e)},i.prototype.onTexture=function(t,e){this._textures[e]=t.data,this.processTask(t)},i.prototype.onHudTexture=function(t,e){e.hud.diffuseTexture=t.data,this.processTask(t)},i.prototype.onMaterialTexture=function(t,e){var i=null,a=null,r=e.mapNodeData;i=r.object3d,a=i.getMaterial(e.matID),a[e.type]=t.data,this.processTask(t)},i.prototype.onMethodTexture=function(t,e){e.method[e.textureName]=t.data,this.processTask(t)},i.prototype.doLoadEpa=function(t){if(t.propertyAnims)for(var e=0;e<t.propertyAnims.length;++e){var a=t.propertyAnims[e],r=this._pathRoot+a.path,n=i._assetMgr.dispatchTask(r);n.data?this.processEpa(t,n.data):(this.addTask(n),i._assetMgr.dispatchEvent(n,this.onEpaLoad,this,t))}},i.prototype.processEpa=function(t,e){t.object3d.bindAnimation(e),this.autoPlayAnimation&&t.object3d.proAnimation&&t.object3d.proAnimation.play()},i.prototype.processHeightMesh=function(t,e){this.processObject3d(t,e),this.processMat(t)},i.prototype.processMesh=function(t,e){this.processObject3d(t,e),this.processMat(t);for(var a=0;a<t.skinClips.length;a++){var r=t.skinClips[a],n=this._pathRoot+r.path,o=i._assetMgr.dispatchTask(n);if(o.data){var s=o.data;e.animation.skeletonAnimationController.addSkeletonAnimationClip(s.clone())}else{var h={};h.eamData=r,h.mapNodeData=t,this.addTask(o),i._assetMgr.dispatchEvent(o,this.onEamLoad,this,h)}}},i.prototype.onEsmLoad=function(e,i){if(i){var a=new t.Mesh(e.data,new t.TextureMaterial);this.processMesh(i,a),this.doLoadEpa(i)}this.processTask(e)},i.prototype.onParticleEsmLoad=function(t,e){var i=e.particle,a=e.nodeData;i.shape.geometry=t.data,this.processParticleGeometry(i,a),this.processTask(t)},i.prototype.onEamLoad=function(t,e){var i=t.data;i.animationName=e.eamData.name;var a=e.mapNodeData.object3d;a.animation.skeletonAnimationController.addSkeletonAnimationClip(i.clone()),this.autoPlayAnimation&&a.animation.play(i.animationName,1,!1,!1),this.processTask(t)},i.prototype.onEpaLoad=function(t,e){var i=t.data,a=i.clone();this.processEpa(e,a),this.processTask(t)},i.prototype.addTask=function(t){this._taskCount++},i.prototype.processTask=function(e){if(this._taskCount--,this.taskCurrent++,this._event.eventType=t.LoaderEvent3D.LOADER_PROGRESS,this._event.target=this,this._event.loader=e,this._event.data=e,this.dispatchEvent(this._event),this._taskCount<=0){for(var i=[],a=0;a<this._mapXmlParser.nodeList.length;a++){var r=this._mapXmlParser.nodeList[a];if(r.object3d instanceof t.ParticleEmitter)for(var n=r.object3d,o=0;o<r.childs.length;++o){var s=r.childs[o],h=this.container.findObject3D(s.name);i.push(h),h instanceof t.ParticleEmitter&&n.addSubEmitter(Number(t.ParticleDataSubEmitterPhase[s.phase]),h)}}for(var l,a=0;a<i.length;a++)l=i[a],l&&l.parent&&l.parent.removeChild(l);if(this._event.eventType=t.LoaderEvent3D.LOADER_COMPLETE,this._event.target=this,this.view3d)for(var a=0;a<this.huds.length;++a)this.view3d.addHUD(this.huds[a]);this.dispatchEvent(this._event)}},i.prototype.addImaTask=function(t,e,a,r,n){var o=null,s=this._pathRoot+t,o=i._assetMgr.dispatchTask(s);if(o.data)n[e]=o.data;else{var h={};h.type=e,h.matID=a,h.mapNodeData=r,this.addTask(o),i._assetMgr.dispatchEvent(o,this.onMaterialTexture,this,h)}return o},i.prototype.addMethodImgTask=function(t,e,a){var r=this._pathRoot+t,n=i._assetMgr.dispatchTask(r);if(n.data)e[a]=n.data;else{var o={};o.method=e,o.textureName=a,this.addTask(n),i._assetMgr.dispatchEvent(n,this.onMethodTexture,this,o)}return n},i.prototype.processMat=function(e){for(var i=e.object3d,a=0;a<e.materialIDs.length;++a){var r=this._mapXmlParser.matDict[e.materialIDs[a]];if(r){var n=i.getMaterial(a);n||(n=new t.TextureMaterial,i.addSubMaterial(a,n));var o=null;""!=r.diffuseTextureName&&(o=this.addImaTask(r.diffuseTextureName,"diffuseTexture",a,e,n)),""!=r.normalTextureName&&(o=this.addImaTask(r.normalTextureName,"normalTexture",a,e,n)),""!=r.specularTextureName&&(o=this.addImaTask(r.specularTextureName,"specularTexture",a,e,n)),n.diffuseColor=r.diffuseColor,n.ambientColor=r.ambientColor,n.specularColor=r.specularColor,n.alpha=r.alpha,n.specularLevel=r.specularLevel,n.gloss=r.gloss,n.castShadow=r.castShadow,n.acceptShadow=r.acceptShadow,n.smooth=r.smooth,n.repeat=r.repeat,n.bothside=r.bothside,n.drawMode=r.drawMode,n.cullMode=r.cullMode,n.blendMode=r.blendMode,n.cutAlpha=r.cutAlpha,n.uvRectangle.copy(r.uvRectangle);for(var s=new t.LightGroup,h=0;h<r.lightIds.length;++h){var l=this.lightDict[r.lightIds[h]];l&&s.addLight(l)}s.lightNum>0&&(n.lightGroup=s),this.processMethod(n,r)}}},i.prototype.processMethod=function(e,i){for(var a=null,r=null,n=0,o=i.methods;n<o.length;n++){r=o[n];var s=t.CheckerboardTexture.texture;if(r.type==t.MatMethodData.methodType.lightmapMethod){var h=new t.LightmapMethod(r.usePower);e.diffusePass.addMethod(h),h.lightTexture=s;var l=r.texturesData[0];a=this.addMethodImgTask(l.path,h,l.attributeName)}else if(r.type==t.MatMethodData.methodType.uvRollMethod){var u=new t.UVRollMethod;e.diffusePass.addMethod(u),u.speedU=r.uSpeed,u.speedV=r.vSpeed,e.repeat=!0,u.start(!0)}else if(r.type==t.MatMethodData.methodType.mulUvRollMethod){var c=new t.MulUVRollMethod;e.diffusePass.addMethod(c),c.diffuseTexture1=s,c.setSpeedU(0,r.uSpeed),c.setSpeedV(0,r.vSpeed);var l=r.texturesData[0];c.setSpeedU(1,l.uSpeed),c.setSpeedV(1,l.vSpeed),a=this.addMethodImgTask(l.path,c,l.attributeName),e.repeat=!0,c.start(!0)}else if(r.type==t.MatMethodData.methodType.alphaMaskMethod){var d=new t.AlphaMaskMethod;e.diffusePass.addMethod(d),d.maskTexture=s;var l=r.texturesData[0];a=this.addMethodImgTask(l.path,d,l.attributeName)}else if(r.type==t.MatMethodData.methodType.streamerMethod){var p=new t.StreamerMethod;e.diffusePass.addMethod(p),p.steamerTexture=s;var l=r.texturesData[0];a=this.addMethodImgTask(l.path,p,l.attributeName),p.speedU=r.uSpeed,p.speedV=r.vSpeed,p.start(!0)}else if(r.type==t.MatMethodData.methodType.terrainARGBMethod){var f=new t.TerrainARGBMethod(s,s,s,s,s);e.diffusePass.addMethod(f);for(var l=null,_=0;_<r.texturesData.length;++_)l=r.texturesData[_],a=this.addMethodImgTask(l.path,f,l.attributeName),0!=_&&f.setUVTitling(_-1,Number(l.uvTitlingX),Number(l.uvTitlingY))}else if(r.type==t.MatMethodData.methodType.waterWaveMethod){var m=new t.WaterWaveMethod;e.diffusePass.addMethod(m),r.deepWaterColor&&(m.deepWaterColor=Number(r.deepWaterColor)),r.shallowWaterColor&&(m.shallowWaterColor=Number(r.shallowWaterColor)),e.repeat=!0}else if(r.type==t.MatMethodData.methodType.waterNormalMethod){var v=new t.WaterNormalMethod;e.diffusePass.addMethod(v),v.normalTextureA=s,v.normalTextureB=s,r.uScale&&r.vScale&&v.setUvScale(Number(r.uScale),Number(r.vScale));for(var l=null,_=0;_<r.texturesData.length;++_)l=r.texturesData[_],v.setUvSpeed(_,Number(l.uSpeed),Number(l.vSpeed)),a=this.addMethodImgTask(l.path,v,l.attributeName)}}},i.prototype.createLight=function(){var e=null;for(var i in this._mapXmlParser.lightDict)if(e=this._mapXmlParser.lightDict[i],e.type==t.LightType.directlight&&this._mapXmlParser.directLight){var a=new t.DirectLight(e.direction);a.lightId=e.id,a.diffuse=e.diffuseColor,a.ambient=e.ambientColor,a.halfIntensity=e.halfIntensity,a.intensity=e.intensity,this.lightDict[e.id]=a}else if(e.type==t.LightType.pointlight&&this._mapXmlParser.pointLight){var r=new t.PointLight(0);r.lightId=e.id,r.position=e.position,r.ambient=e.ambientColor,r.diffuse=e.diffuseColor,r.radius=e.radius,r.falloff=e.falloff,r.intensity=e.intensity,this.lightDict[e.id]=r}},i._assetMgr=new t.AssetManager,i}(t.EventDispatcher);t.MapLoader=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.type="",this.insID="",this.parent="",this.name="",this.path="",this.fov=0,this.clipNear=0,this.clipFar=0,this.materialIDs=[],this.skinClips=[],this.propertyAnims=[],this.billboard=!1,this.visible=!0,this.x=0,this.y=0,this.z=0,this.rx=0,this.ry=0,this.rz=0,this.rw=0,this.sx=1,this.sy=1,this.sz=1,this.geometry={},this.childs=[]}return t}();t.MapNodeData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this.version=1,this.nodeList=new Array,this.hudList=new Array,this.matDict={},this.lightDict={},this.directLight=!1,this.pointLight=!1,this.textures=[],this.taskDict={};var i=e.getElementsByTagName("version");this.version=Number(i[0].textContent);var a=e.getElementsByTagName("mat"),r=e.getElementsByTagName("node"),n=e.getElementsByTagName("env"),o=(e.getElementsByTagName("cameraAnims"),e.getElementsByTagName("hud")),s=e.getElementsByTagName("texture");this.parseEnvironment(n);for(var h=0;h<a.length;h++){var l=this.parseMat(a[h]);l&&(this.matDict[l.id]=l,this.calculateMatTask(l))}for(var h=0;h<r.length;h++){var u=this.parseNode(r[h]);u&&(this.nodeList.push(u),this.calculateNodeTask(u))}for(var h=0;h<s.length;h++)this.parseTexture(s[h]);for(var h=0;h<o.length;h++){var c=this.parseHud(o[h]);c&&(this.hudList.push(c),this.calculateHudTask(c))}for(var h=0;h<this.nodeList.length;h++){var u=this.nodeList[h];if("Camera3D"==u.type){var d=new t.Camera3D;d.fieldOfView=u.fov,d.near=u.clipNear,d.far=u.clipFar,u.object3d=d}else"Billboard"==u.type?u.object3d=new t.Billboard(new t.TextureMaterial(t.CheckerboardTexture.texture)):"Terrain"==u.type?u.object3d=new t.Object3D:u.object3d=new t.Object3D;u.object3d.name=u.name,u.object3d.visible=u.visible,u.object3d.position=new t.Vector3D(u.x,u.y,u.z),u.object3d.orientation=new t.Quaternion(u.rx,u.ry,u.rz,u.rw),u.object3d.scale=new t.Vector3D(u.sx,u.sy,u.sz)}this.processNode()}return e.prototype.parseTexture=function(t){if(1==t.childNodes.length)return null;var e,i=null,a=0,r=0;for(a=0,r=t.childNodes.length;r>a;a++)if(e=t.childNodes[a],!this.nodeFilter(e)){for(var n={},o=0;o<e.attributes.length;++o)i=e.attributes[o],n[i.name]=i.value;this.textures.push(n),this.calculateTextureTask(n)}},e.prototype.parseMethod=function(e){if(e.childNodes.length<=1)return null;for(var i,a,r,n=[],o=0,s=null,h=0,o=e.childNodes.length;o>h;h++)if(i=e.childNodes[h],a=i.nodeName,!this.nodeFilter(i)){r=new t.MatMethodData,r.type=a;for(var l=0;l<i.attributes.length;++l){s=i.attributes[l];var u=typeof r[s.name];"string"==u?r[s.name]=s.value:"number"==u?r[s.name]=Number(s.value):"boolean"==u?r[s.name]="true"==s.value?!0:!1:r[s.name]=s.value}for(var l=0;l<i.childNodes.length;++l){var c=i.childNodes[l];if(!this.nodeFilter(c)){for(var d={},p=0;p<c.attributes.length;++p)s=c.attributes[p],d[s.name]=s.value;r.texturesData.push(d)}}n.push(r)}return n},e.prototype.parseMat=function(e){if(0==e.childNodes.length)return null;for(var i=new t.MatSphereData,a=null,r=0;r<e.attributes.length;++r)a=e.attributes[r],i[a.name]=a.value;for(var n,o,s=0,r=0,s=e.childNodes.length;s>r;r++)if(n=e.childNodes[r],o=n.nodeName,!this.nodeFilter(n))if("methods"==o)i.methods=this.parseMethod(n);else if("uvRectangle"==o)for(var h=0;h<n.attributes.length;++h)i.uvRectangle[n.attributes[h].name]=Number(n.attributes[h].value);else if("blendMode"==o)i[n.nodeName]=t.BlendMode[n.textContent];else if("lightIds"==o){if(n.textContent)for(var l=n.textContent.split(","),h=0;h<l.length;++h)i.lightIds.push(Number(l[h]))}else{var u=typeof i[n.nodeName];"string"==u?i[n.nodeName]=n.textContent:"number"==u?i[n.nodeName]=Number(n.textContent):"boolean"==u&&(i[n.nodeName]="true"==n.textContent?!0:!1)}return i},e.prototype.processNode=function(){for(var t=0;t<this.nodeList.length;t++)for(var e=this.nodeList[t],i=0;i<this.nodeList.length;i++){var a=this.nodeList[i];if(e.parent==a.insID){a.object3d.addChild(e.object3d);break}}},e.prototype.parseNode=function(e){if(1==e.childNodes.length)return null;for(var i=null,a=new t.MapNodeData,r=0;r<e.attributes.length;++r){i=e.attributes[r];var n=typeof a[i.name];"number"==n?a[i.name]=Number(i.value):"boolean"==n?a[i.name]="true"==i.value?!0:!1:a[i.name]=i.value}var o,s,r=0,h=0;for(r=0,h=e.childNodes.length;h>r;r++)if(o=e.childNodes[r],s=o.nodeName,!this.nodeFilter(o))if("pos"==s)for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],a[i.nodeName]=Number(i.value);else if("rot"==s)for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],a[i.nodeName]=Number(i.value);else if("scale"==s)for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],a[i.nodeName]=Number(i.value);else if("mat"==s)for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],"id"==i.nodeName&&(a.materialIDs=(i.value+"").split(","));else if("skinClip"==s){var u={};a.skinClips.push(u);for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],u[i.nodeName]=i.value}else if("propertyAnim"==s){var c={};a.propertyAnims.push(c);for(var l=0;l<o.attributes.length;++l)i=o.attributes[l],c[i.nodeName]=i.value}else if("geometry"==s){for(var d={},l=0;l<o.attributes.length;++l)i=o.attributes[l],"type"==i.name?d[i.name]=i.value:d[i.name]=Number(i.value);a.geometry=d}else if("sub"==s){for(var p={},l=0;l<o.attributes.length;++l)i=o.attributes[l],p[i.name]=i.value;a.childs.push(p)}return a},e.prototype.parseEnvironment=function(e){if(!(e.length<=0)){for(var i,a,r,n=null,o=0;o<e[0].attributes.length;++o)n=e[0].attributes[o],this[n.name]="open"==n.value;for(var s=0,h=e.length;h>s;s++){i=e[s];for(var l=0;l<i.childNodes.length;++l)if(a=i.childNodes[l],!this.nodeFilter(a))if("light"==a.nodeName){for(var u=new t.MapLightData,o=0;o<a.attributes.length;++o)n=a.attributes[o],"id"==n.name?u[n.name]=Number(n.value):u[n.name]=n.value;this.lightDict[u.id]=u;for(var o=0;o<a.childNodes.length;++o)if(r=a.childNodes[o],!this.nodeFilter(r))if("direction"==r.nodeName)for(var c=0;c<r.attributes.length;++c)n=r.attributes[c],u.direction[n.name]=Number(n.value);else if("position"==r.nodeName)for(var c=0;c<r.attributes.length;++c)n=r.attributes[c],u.position[n.name]=Number(n.value);else"type"==r.nodeName&&(u.type=t.LightType[r.textContent])}else"fog"==a.nodeName}}},e.prototype.parseHud=function(e){if(1==e.childNodes.length)return null;for(var i=null,a=new t.HUDData,r=0;r<e.attributes.length;++r)i=e.attributes[r],"bothside"==i.nodeName?a[i.nodeName]="true"==i.value:a[i.nodeName]=i.value;var n,o,r=0,s=0;for(r=0,s=e.childNodes.length;s>r;r++)if(n=e.childNodes[r],o=n.nodeName,!this.nodeFilter(n))for(var h=0;h<n.attributes.length;++h)i=n.attributes[h],"shader"==o?a[i.nodeName]=i.value:a[i.nodeName]=Number(i.value);return a},e.prototype.calculateMatTask=function(t){""!=t.diffuseTextureName&&(this.taskDict[t.diffuseTextureName]=0),""!=t.normalTextureName&&(this.taskDict[t.normalTextureName]=0),""!=t.specularTextureName&&(this.taskDict[t.specularTextureName]=0);
for(var e=0;e<t.methods.length;++e)for(var i=t.methods[e],a=0;a<i.texturesData.length;++a){var r=i.texturesData[a];r.path&&(this.taskDict[r.path]=0)}},e.prototype.calculateNodeTask=function(t){t.path&&(this.taskDict[t.path]=0);for(var e=0;e<t.skinClips.length;e++){var i=t.skinClips[e];i.path&&(this.taskDict[i.path]=0)}for(var e=0;e<t.propertyAnims.length;++e){var a=t.propertyAnims[e];a.path&&(this.taskDict[a.path]=0)}},e.prototype.calculateHudTask=function(t){t.texture&&(this.taskDict[t.texture]=0)},e.prototype.calculateTextureTask=function(t){t.path&&(this.taskDict[t.path]=0)},e.prototype.nodeFilter=function(t){return"#text"==t.nodeName||"#comment"==t.nodeName},e}();t.MapXmlParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.id="",this.type="",this.usePower=!1,this.texturesData=[],this.uSpeed=0,this.vSpeed=0}return t.methodType={lightmapMethod:"lightmapMethod",uvRollMethod:"uvRollMethod",mulUvRollMethod:"mulUvRollMethod",alphaMaskMethod:"alphaMaskMethod",streamerMethod:"streamerMethod",terrainARGBMethod:"terrainARGBMethod",waterWaveMethod:"waterWaveMethod",waterNormalMethod:"waterNormalMethod",particleUVRoll:"particleUVRoll"},t}();t.MatMethodData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.id="",this.diffuseTextureName="",this.normalTextureName="",this.specularTextureName="",this.diffuseColor=0,this.ambientColor=0,this.specularColor=0,this.alpha=0,this.specularLevel=0,this.gloss=0,this.ambientPower=0,this.diffusePower=0,this.normalPower=0,this.castShadow=!1,this.acceptShadow=!1,this.smooth=!1,this.repeat=!1,this.bothside=!1,this.drawMode=0,this.cullMode=0,this.blendMode=0,this.cutAlpha=.7,this.methods=[],this.lightIds=[],this.uvRectangle=new t.Rectangle(0,0,1,1)}return e}();t.MatSphereData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.id=0,this.type=0,this.diffuseColor=16777215,this.ambientColor=16777215,this.intensity=1,this.halfIntensity=0,this.direction=new t.Vector3D(-.5,-.6,.2),this.position=new t.Vector3D,this.falloff=0,this.radius=100}return e}();t.MapLightData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.bothside=!1}return t}();t.HUDData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.apply(this,arguments),this._event=new t.ParserEvent3D}return __extends(i,e),i.prototype.parser=function(e){var i=this,a=new t.ByteArray(e),r=new t.ByteArray;a.readBytes(r,0,3),a.position=0;var n=0;switch(n|=r.readUnsignedByte()<<16,n|=r.readUnsignedByte()<<8,n|=r.readUnsignedByte()){case 4473939:this.datas=t.DDSParser.parse(e),this.dataFormat=".dds",this.doLoadComplete();break;case 2:case 16:this.datas=t.TGAParser.parse(e),this.dataFormat=".tga",this.doLoadComplete();break;case 16767231:var o=new Blob([e]);this.dataFormat=".jpg";var s=document.createElement("img");void 0!=window.createObjectURL?s.src=window.createObjectURL(o):void 0!=window.URL?s.src=window.URL.createObjectURL(o):void 0!=window.webkitURL&&(s.src=window.webkitURL.createObjectURL(o)),s.onload=function(){return i.onLoad(s)};break;case 8998990:var o=new Blob([e]);this.dataFormat=".png";var s=document.createElement("img");void 0!=window.createObjectURL?s.src=window.createObjectURL(o):void 0!=window.URL?s.src=window.URL.createObjectURL(o):void 0!=window.webkitURL&&(s.src=window.webkitURL.createObjectURL(o)),s.onload=function(){return i.onLoad(s)};break;case 6648685:this.dataFormat=".esm",this.datas=t.ESMParser.parse(e),this.doLoadComplete();break;case 6644077:this.dataFormat=".eam",this.datas=t.EAMParser.parse(e),this.doLoadComplete();break;case 6644577:this.dataFormat=".eca",this.datas=t.ECAParser.parse(e),this.doLoadComplete();break;default:return!1}return!0},i.prototype.onLoad=function(e){this.datas=new t.ImageTexture(e),this.doLoadComplete()},i.prototype.doLoadComplete=function(){this._event.eventType=t.ParserEvent3D.PARSER_COMPLETE,this._event.data=this,this._event.parser=this,this.dispatchEvent(this._event)},i}(t.EventDispatcher);t.ParserUtils=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.vsShaderList=[],this.fsShaderList=[]}return t.prototype.upload=function(t,e,i,a,r,n,o){},t.prototype.activeState=function(t,e,i,a,r,n,o){},t.prototype.dispose=function(){},t}();t.MethodBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n,o){e.call(this),this.uvs=new Float32Array(8),this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("terrainRGBA_fragment"),this.controlTex=i,this.splat_0=a,this.splat_1=r,this.splat_2=n,this.splat_3=o,this.uvs[0]=1,this.uvs[1]=1,this.uvs[2]=1,this.uvs[3]=1,this.uvs[4]=1,this.uvs[5]=1,this.uvs[6]=1,this.uvs[7]=1}return __extends(i,e),i.prototype.setUVTitling=function(t,e,i){this.uvs[2*t]=e,this.uvs[2*t+1]=i},Object.defineProperty(i.prototype,"splat_0_Texture",{set:function(t){this.splat_0=t,this.materialData.splat_0Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"splat_1_Texture",{set:function(t){this.splat_1=t,this.materialData.splat_1Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"splat_2_Texture",{set:function(t){this.splat_2=t,this.materialData.splat_2Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"splat_3_Texture",{set:function(t){this.splat_3=t,this.materialData.splat_3Tex=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"controlTexture",{set:function(t){this.controlTex=t,this.materialData.blendMaskTexture=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.uvs=r.getUniformLocation(i.program3D,"uvs")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform1fv(i.uvs,this.uvs)},i.prototype.dispose=function(){},i}(t.MethodBase);t.TerrainARGBMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i="expHeightFog_fs"),e.call(this),this.uniform_globalFog=new Float32Array(7),this._fogColor=204,this._globalDensity=1,this._fogStartDistance=1e3,this._fogDistanceScale=.5,this._height=500,this._fogAlpha=1,this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs"),"line"==i?this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("lineFog"):"exp"==i?this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expFog_fs"):"expHeightFog_fs"==i&&(this.fsShaderList[t.ShaderPhaseType.lighting_fragment]=this.fsShaderList[t.ShaderPhaseType.lighting_fragment]||[],this.fsShaderList[t.ShaderPhaseType.lighting_fragment].push("expHeightFog_fs")),this.uniform_globalFog[0]=.5,this.uniform_globalFog[1]=.6,this.uniform_globalFog[2]=.7,this.uniform_globalFog[3]=this._globalDensity,this.uniform_globalFog[4]=this._fogStartDistance,this.uniform_globalFog[5]=this._height,this.uniform_globalFog[6]=this._fogAlpha}return __extends(i,e),Object.defineProperty(i.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t,this.uniform_globalFog[0]=(this._fogColor>>16&255)/255,this.uniform_globalFog[1]=(this._fogColor>>8&255)/255,this.uniform_globalFog[2]=(255&this._fogColor)/255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"globalDensity",{get:function(){return this._globalDensity},set:function(t){this._globalDensity=t,this.uniform_globalFog[3]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t,this.uniform_globalFog[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogHeight",{get:function(){return this._height},set:function(t){this._height=t,this.uniform_globalFog[5]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogAlpha",{get:function(){return this._height},set:function(t){this._height=t,this.uniform_globalFog[6]=t},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.uniform_globalFog=r.getUniformLocation(i.program3D,"uniform_globalFog")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform1fv(i.uniform_globalFog,this.uniform_globalFog)},i.prototype.dispose=function(){},i}(t.MethodBase);t.FogMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.uniform_globalFog=new Float32Array(7),this._fogColor=204,this._fogStartDistance=1e3,this._fogFarDistance=4e4,this._fogAlpha=.6,this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs"),this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("lineFog"),this.uniform_globalFog[0]=.5,this.uniform_globalFog[1]=.6,this.uniform_globalFog[2]=.7,this.uniform_globalFog[3]=1,this.uniform_globalFog[4]=this._fogStartDistance,this.uniform_globalFog[5]=this._fogFarDistance,this.uniform_globalFog[6]=this._fogAlpha}return __extends(i,e),Object.defineProperty(i.prototype,"fogColor",{get:function(){return this.fogColor},set:function(t){this._fogColor=t,this.uniform_globalFog[0]=(this._fogColor>>16&255)/255,this.uniform_globalFog[1]=(this._fogColor>>8&255)/255,this.uniform_globalFog[2]=(255&this._fogColor)/255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogStartDistance",{get:function(){return this._fogStartDistance},set:function(t){this._fogStartDistance=t,this.uniform_globalFog[4]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogFarDistance",{get:function(){return this._fogFarDistance},set:function(t){this._fogFarDistance=t,this.uniform_globalFog[5]=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"fogAlpha",{get:function(){return this._fogAlpha},set:function(t){this._fogAlpha=t,this.uniform_globalFog[6]=t},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.uniform_globalFog=r.getUniformLocation(i.program3D,"uniform_globalFog")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform1fv(i.uniform_globalFog,this.uniform_globalFog)},i.prototype.dispose=function(){},i}(t.MethodBase);t.LineFogMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._uvRoll=new Float32Array(2),this._speedU=5e-5,this._speedV=0,this._time=0,this._start=!1,this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvRoll_fs")}return __extends(i,e),Object.defineProperty(i.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:!0,configurable:!0}),i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},i.prototype.stop=function(){this._start=!1},i.prototype.upload=function(t,e,i,a,r,n,o){i.uvRoll=r.getUniformLocation(i.program3D,"uvRoll")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._start&&(this._time+=e,this._uvRoll[0]=this._time*this._speedU,this._uvRoll[1]=this._time*this._speedV,r.uniform1fv(i.uvRoll,this._uvRoll))},i}(t.MethodBase);t.UVRollMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._uvRoll=new Float32Array(4),this._uvSpeed=new Float32Array(4),this._time=0,this._start=!1,this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("mulUvRoll_fs"),this._uvSpeed[0]=5e-5,this._uvSpeed[1]=0,this._uvSpeed[2]=5e-5,this._uvSpeed[3]=0}return __extends(i,e),i.prototype.setSpeedU=function(t,e){this._uvSpeed[2*t+0]=e},i.prototype.getSpeedU=function(t){return this._uvSpeed[2*t+0]},i.prototype.setSpeedV=function(t,e){this._uvSpeed[2*t+1]=e},i.prototype.getSpeedV=function(t){return this._uvSpeed[2*t+1]},i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},i.prototype.stop=function(){this._start=!1},Object.defineProperty(i.prototype,"diffuseTexture1",{get:function(){return this._diffuseTexture1},set:function(t){this._diffuseTexture1=t,this.materialData.diffuseTexture1=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.mulUvRoll=r.getUniformLocation(i.program3D,"mulUvRoll")},i.prototype.activeState=function(t,e,i,a,r,n,o){if(this._start){this._time+=e;for(var s=0;4>s;++s)this._uvRoll[s]=this._time*this._uvSpeed[s];r.uniform1fv(i.mulUvRoll,this._uvRoll)}},i}(t.MethodBase);t.MulUVRollMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n){e.call(this),this._uvSpriteSheet=new Float32Array(4),this._uvRectangle=new t.Rectangle,this._speed=0,this._time=0,this._numTime=.4,this._start=!1,this._frameNum=12,this._row=4,this._column=4,this._currentFrame=0,this.frameList=[],this._change=!1,this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvSpriteSheet_fs"),this.frameNum=i,this.row=a,this.column=r,this.numTime=n}return __extends(i,e),i.prototype.caculate=function(){this._speed=1e3*this._numTime/this._frameNum,this._uvRectangle.x=0,this._uvRectangle.y=0,this._uvRectangle.width=1/this._row,this._uvRectangle.height=1/this._column,this.frameList.length=this._frameNum;for(var e=0,i=0,a=0;a<this._frameNum;a++){e=a%this._row,i=Math.floor(a/this._column);var r=new t.Rectangle;r.x=e*this._uvRectangle.width+this._uvRectangle.x,r.y=i*this._uvRectangle.height+this._uvRectangle.y,r.width=this._uvRectangle.width,r.height=this._uvRectangle.height,this.frameList[a]=r}},Object.defineProperty(i.prototype,"numTime",{get:function(){return this._numTime},set:function(t){this._numTime!=t&&(this._change=!0,this._numTime=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"frameNum",{get:function(){return this._frameNum},set:function(t){this._frameNum!=t&&(this._change=!0,this._frameNum=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"row",{get:function(){return this._row},set:function(t){this._row!=t&&(this._change=!0,this._row=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"column",{get:function(){return this._column},set:function(t){this._column!=t&&(this._change=!0,this._column=t)},enumerable:!0,configurable:!0}),i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0,this._change&&this.caculate()},i.prototype.stop=function(){this._start=!1},i.prototype.upload=function(t,e,i,a,r,n,o){i.uvSpriteSheet=r.getUniformLocation(i.program3D,"uvSpriteSheet")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._start&&(this._time+=e,this._time/this._speed>1&&(this._currentFrame++,this._currentFrame=this._currentFrame%this._frameNum,this._time=0,this._uvSpriteSheet[0]=this.frameList[this._currentFrame].x,this._uvSpriteSheet[1]=this.frameList[this._currentFrame].y,this._uvSpriteSheet[2]=this.frameList[this._currentFrame].width,this._uvSpriteSheet[3]=this.frameList[this._currentFrame].height,r.uniform1fv(i.uvSpriteSheet,this._uvSpriteSheet)))},i}(t.MethodBase);t.UVSpriteSheetMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=!0),e.call(this),this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("secondaryUV_vs"),i?(this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("lightMapSpecularPower_fs")):(this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("lightMap_fs"))}return __extends(i,e),Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,this.materialData.lightTexture!=this.texture&&(this.materialData.lightTexture=this.texture,this.materialData.lightTexture.useMipmap=!1,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){},i.prototype.activeState=function(t,e,i,a,r,n,o){},i}(t.MethodBase);t.LightmapMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._speed=new t.Vector3D,this._time=0,this._windData=new Float32Array(4),this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("detail_Bending_vs")}return __extends(i,e),Object.defineProperty(i.prototype,"windDirAndSpeed",{get:function(){return this._speed},set:function(t){this._speed=t,this._windData[1]=t.x,this._windData[2]=t.y,this._windData[3]=t.z},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.uniformTime=r.getUniformLocation(i.program3D,"uniformTime")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._time+=e,this._windData[0]=this._time,r.uniform1fv(i.uniformTime,this._windData)},i}(t.MethodBase);t.PlantDistortedMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("alphaMask_fs")}return __extends(i,e),Object.defineProperty(i.prototype,"maskTexture",{set:function(t){this.texture=t,this.materialData.maskTexture=this.texture,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){},i.prototype.activeState=function(t,e,i,a,r,n,o){},i}(t.MethodBase);t.AlphaMaskMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.aoPower=1,this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("AOMap_fs"),this.lightTexture=i}return __extends(i,e),Object.defineProperty(i.prototype,"lightTexture",{set:function(t){this.texture=t,this.materialData.aoTexture=this.texture,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.aoPower=r.getUniformLocation(i.program3D,"aoPower")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform1f(i.aoPower,this.aoPower)},i.prototype.dispose=function(){},i}(t.MethodBase);t.AOMapMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorTransform_fs")}return __extends(i,e),Object.defineProperty(i.prototype,"colorTransform",{get:function(){return this.materialData.colorTransform},set:function(t){this.materialData.colorTransform=t},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.uniform_colorTransformVec4=r.getUniformLocation(i.program3D,"uniform_colorTransformVec4"),i.uniform_colorTransformM44=r.getUniformLocation(i.program3D,"uniform_colorTransformM44")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform4fv(i.uniform_colorTransformVec4,this.colorTransform.vec4),r.uniformMatrix4fv(i.uniform_colorTransformM44,!1,this.colorTransform.m44.rawData)},i}(t.MethodBase);t.ColorTransformMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._posStart=new t.Vector3D,this._posEnd=new t.Vector3D,this._color=new t.Color,this._zeroVector=new t.Vector3D,this._helpVector=new t.Vector3D,this._helpMatrix=new t.Matrix4_4,this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("colorGradients_fs"),this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("vertexPos_vs")}return __extends(i,e),i.prototype.setStartData=function(t,e,i){this._color.copyFrom(i),this._posStart.copyFrom(t),this._posEnd.copyFrom(e),this._posStart.w=0,this._posEnd.w=0},i.prototype.upload=function(t,e,i,a,r,n,o){i.uniform_colorGradientsSource=r.getUniformLocation(i.program3D,"uniform_colorGradientsSource")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._helpMatrix.identity(),this._helpMatrix.copyFrom(o.viewMatrix),this._helpMatrix.transformVector(this._posStart,this._helpVector),this.materialData.colorGradientsSource[0]=this._helpVector.x,this.materialData.colorGradientsSource[1]=this._helpVector.y,this.materialData.colorGradientsSource[2]=this._helpVector.z,this._helpMatrix.transformVector(this._posEnd,this._helpVector),this.materialData.colorGradientsSource[3]=this._helpVector.x,this.materialData.colorGradientsSource[4]=this._helpVector.y,this.materialData.colorGradientsSource[5]=this._helpVector.z,this.materialData.colorGradientsSource[6]=this._color.r,this.materialData.colorGradientsSource[7]=this._color.g,this.materialData.colorGradientsSource[8]=this._color.b,this.materialData.colorGradientsSource[9]=this._color.a,r.uniform1fv(i.uniform_colorGradientsSource,this.materialData.colorGradientsSource)},i}(t.MethodBase);t.ColorGradientsMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._uvRoll=new Float32Array(3),this._speedU=1e-4,this._speedV=1e-4,this._intensity=.9,this._time=0,this._start=!1,this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("uvStreamerRoll_fs"),this.start()}return __extends(i,e),Object.defineProperty(i.prototype,"speedU",{get:function(){return this._speedU},set:function(t){this._speedU=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"speedV",{get:function(){return this._speedV},set:function(t){this._speedV=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"steamerTexture",{get:function(){return this._steamerTexture},set:function(t){this._steamerTexture=t,this.materialData.streamerTexture=t,this.materialData.textureChange=!0},enumerable:!0,configurable:!0}),i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},i.prototype.stop=function(){this._start=!1},i.prototype.upload=function(t,e,i,a,r,n,o){i.uvRoll=r.getUniformLocation(i.program3D,"uvRoll")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._start&&(this._time+=e,this._uvRoll[0]=this._time*this._speedU,this._uvRoll[1]=this._time*this._speedV,this._uvRoll[2]=this._intensity,r.uniform1fv(i.uvRoll,this._uvRoll))},i}(t.MethodBase);t.StreamerMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.materialData=i.materialData,this.vsShaderList[t.ShaderPhaseType.local_vertex]=this.vsShaderList[t.ShaderPhaseType.local_vertex]||[],this.vsShaderList[t.ShaderPhaseType.local_vertex].push("shadowMapping_vs"),this.fsShaderList[t.ShaderPhaseType.shadow_fragment]=this.fsShaderList[t.ShaderPhaseType.shadow_fragment]||[],this.fsShaderList[t.ShaderPhaseType.shadow_fragment].push("shadowMapping_fs")}return __extends(i,e),Object.defineProperty(i.prototype,"shadowMapTexture",{get:function(){return this.materialData.shadowMapTexture},set:function(t){this.materialData.shadowMapTexture!=t&&(this.materialData.shadowMapTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){},i.prototype.activeState=function(e,i,a,r,n,o,s){t.ShadowCast.instance.shadowCamera&&n.uniformMatrix4fv(a.uniform_ShadowMatrix.uniformIndex,!1,t.ShadowCast.instance.shadowCamera.viewProjectionMatrix.rawData),n.uniform3fv(a.uniform_ShadowColor.uniformIndex,this.materialData.shadowColor)},i}(t.MethodBase);t.ShadowMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.vsShaderList[t.ShaderPhaseType.global_vertex]=this.fsShaderList[t.ShaderPhaseType.global_vertex]||[],this.vsShaderList[t.ShaderPhaseType.global_vertex].push("cube_vertex"),this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("cube_fragment")}return __extends(i,e),i.prototype.upload=function(t,e,i,a,r,n,o){},i.prototype.activeState=function(t,e,i,a,r,n,o){},i}(t.MethodBase);t.CubeMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]=this.fsShaderList[t.ShaderPhaseType.diffuse_fragment]||[],this.fsShaderList[t.ShaderPhaseType.diffuse_fragment].push("color_fragment")}return __extends(i,e),i.prototype.upload=function(t,e,i,a,r,n,o){},i.prototype.activeState=function(t,e,i,a,r,n,o){},i}(t.MethodBase);t.ColorMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._waveVSData=new Float32Array(12),this._waveFSData=new Float32Array(8),this._time=0,this._start=!1,this._wave_xyz_intensity_0=new t.Vector3D(120,50,70),this._wave_xyz_intensity_1=new t.Vector3D(80,40,80),this._wave_xyz_speed_0=new t.Vector3D(.001,.001,-.001),this._wave_xyz_speed_1=new t.Vector3D(.001,.001,.001),this.vsShaderList[t.ShaderPhaseType.start_vertex]=this.vsShaderList[t.ShaderPhaseType.start_vertex]||[],this.vsShaderList[t.ShaderPhaseType.start_vertex].push("wave_vs"),this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("wave_fs"),this.start(),this._waveVSData[0]=this._wave_xyz_intensity_0.x,this._waveVSData[1]=this._wave_xyz_intensity_0.y,this._waveVSData[2]=this._wave_xyz_intensity_0.z,this._waveVSData[3]=this._wave_xyz_intensity_1.x,this._waveVSData[4]=this._wave_xyz_intensity_1.y,this._waveVSData[5]=this._wave_xyz_intensity_1.z,this._waveVSData[6]=this._wave_xyz_speed_0.x,this._waveVSData[7]=this._wave_xyz_speed_0.y,this._waveVSData[8]=this._wave_xyz_speed_0.z,this._waveVSData[9]=this._wave_xyz_speed_1.x,this._waveVSData[10]=this._wave_xyz_speed_1.y,this._waveVSData[11]=this._wave_xyz_speed_1.z,this._waveFSData[0]=0,this._waveFSData[1]=63/255,this._waveFSData[2]=77/255,this._waveFSData[3]=1,this._waveFSData[4]=71/255,this._waveFSData[5]=118/255,this._waveFSData[6]=138/255,this._waveFSData[7]=1}return __extends(i,e),Object.defineProperty(i.prototype,"deepWaterColor",{get:function(){var t=255*this._waveFSData[0],e=255*this._waveFSData[1],i=255*this._waveFSData[2],a=255*this._waveFSData[3];return a<<24|t<<16|e<<8|i},set:function(t){var e=t>>24&255,i=t>>16&255,a=t>>8&255,r=255&t;this._waveFSData[0]=i/255,this._waveFSData[1]=a/255,this._waveFSData[2]=r/255,this._waveFSData[3]=e/255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"shallowWaterColor",{get:function(){var t=255*this._waveFSData[4],e=255*this._waveFSData[5],i=255*this._waveFSData[6],a=255*this._waveFSData[7];return a<<24|t<<16|e<<8|i},set:function(t){var e=t>>24&255,i=t>>16&255,a=t>>8&255,r=255&t;this._waveFSData[4]=i/255,this._waveFSData[5]=a/255,this._waveFSData[6]=r/255,this._waveFSData[7]=e/255},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"waveTexture",{set:function(t){this._waveTexture=t,t&&this.materialData.waveTexture!=this._waveTexture&&(this.materialData.waveTexture=t,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},i.prototype.stop=function(){this._start=!1},i.prototype.upload=function(t,e,i,a,r,n,o){i.waveVSData=r.getUniformLocation(i.program3D,"waveVSData"),i.waveFSData=r.getUniformLocation(i.program3D,"waveFSData"),i.time=r.getUniformLocation(i.program3D,"time")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._start&&(this._time+=e,r.uniform3fv(i.waveVSData,this._waveVSData),r.uniform4fv(i.waveFSData,this._waveFSData),r.uniform1f(i.time,this._time))},i}(t.MethodBase);t.WaterWaveMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._uvData=new Float32Array(8),this._time=0,this._start=!1,this._speedU_0=new t.Point(-9e-6,0),this._speedU_1=new t.Point(3e-5,0),this._distion_intensity=new t.Point(.05,.05),this._normal_0_UVScale=4,this._normal_1_UVScale=4,this.fsShaderList[t.ShaderPhaseType.normal_fragment]=this.fsShaderList[t.ShaderPhaseType.normal_fragment]||[],this.fsShaderList[t.ShaderPhaseType.normal_fragment].push("waterNormal_fs"),this.start(),this._uvData[0]=2.5*this._speedU_0.x,this._uvData[1]=2.5*this._speedU_0.y,this._uvData[2]=2.5*this._speedU_1.x,this._uvData[3]=2.5*this._speedU_1.y,this._uvData[4]=this._distion_intensity.x,this._uvData[5]=this._distion_intensity.y,this._uvData[6]=this._normal_0_UVScale,this._uvData[7]=this._normal_1_UVScale}return __extends(i,e),i.prototype.start=function(t){void 0===t&&(t=!1),t&&(this._time=0),this._start=!0},i.prototype.stop=function(){this._start=!1},i.prototype.setUvSpeed=function(t,e,i){switch(t){case 0:this._speedU_0.x=e,this._speedU_0.y=i,this._uvData[0]=2.5*this._speedU_0.x,this._uvData[1]=2.5*this._speedU_0.y;break;case 1:this._speedU_1.x=e,this._speedU_1.y=i,this._uvData[2]=2.5*this._speedU_1.x,this._uvData[3]=2.5*this._speedU_1.y}},i.prototype.setUvScale=function(t,e){this._normal_0_UVScale=t,this._normal_1_UVScale=e,this._uvData[6]=this._normal_0_UVScale,this._uvData[7]=this._normal_1_UVScale},Object.defineProperty(i.prototype,"normalTextureA",{set:function(t){this._normalTexture_0=t,this.materialData.normalTextureA!=this._normalTexture_0&&(this.materialData.normalTextureA=this._normalTexture_0,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"normalTextureB",{set:function(t){this._normalTexture_1=t,this.materialData.normalTextureB!=this._normalTexture_1&&(this.materialData.normalTextureB=this._normalTexture_1,this.materialData.textureChange=!0)},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.waterNormalData=r.getUniformLocation(i.program3D,"waterNormalData"),i.time=r.getUniformLocation(i.program3D,"time")},i.prototype.activeState=function(t,e,i,a,r,n,o){this._start&&(this._time+=e,r.uniform2fv(i.waterNormalData,this._uvData),r.uniform1f(i.time,this._time))},i}(t.MethodBase);t.WaterNormalMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.reflectValue=.3,this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]=this.fsShaderList[t.ShaderPhaseType.multi_end_fragment]||[],this.fsShaderList[t.ShaderPhaseType.multi_end_fragment].push("environmentMapping_fragment")}return __extends(i,e),Object.defineProperty(i.prototype,"reflect",{get:function(){return this.reflectValue},set:function(t){this.reflectValue=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"environmentTexture",{set:function(t){this.texture=t,t&&this.materialData.environmentMapTex!=this.texture&&(this.materialData.environmentMapTex=t,this.materialData.textureChange=!0)
},enumerable:!0,configurable:!0}),i.prototype.upload=function(t,e,i,a,r,n,o){i.reflectValue=r.getUniformLocation(i.program3D,"reflectValue")},i.prototype.activeState=function(t,e,i,a,r,n,o){r.uniform1f(i.reflectValue,this.reflectValue)},i}(t.MethodBase);t.EnvironmentMethod=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.sampler2DList=new Array,this.sampler3DList=new Array,this.vertexShader=new t.ShaderBase(t.Shader.vertex),this.fragmentShader=new t.ShaderBase(t.Shader.fragment),this.maxDirectLight=0,this.maxSpotLight=0,this.maxPointLight=0,this.maxBone=0,this.attributeDiry=!0}return e.prototype.dispose=function(){},e}();t.PassUsage=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.apply(this,arguments),this.shaderPhaseTypes={},this.matID=0,this.drawMode=t.DrawMode.TRIANGLES,this.useMipmap=!0,this.normalTexture=t.CheckerboardTexture.texture,this.matcapTexture=t.CheckerboardTexture.texture,this.specularTexture=t.CheckerboardTexture.texture,this.lightTexture=t.CheckerboardTexture.texture,this.maskTexture=t.CheckerboardTexture.texture,this.aoTexture=t.CheckerboardTexture.texture,this.environmentTexture=t.CheckerboardTexture.texture,this.blendMaskTexture=t.CheckerboardTexture.texture,this.splat_0Tex=t.CheckerboardTexture.texture,this.splat_1Tex=t.CheckerboardTexture.texture,this.splat_2Tex=t.CheckerboardTexture.texture,this.splat_3Tex=t.CheckerboardTexture.texture,this.layer=0,this.castShadow=!1,this.acceptShadow=!0,this.shadowColor=new Float32Array([.5,.5,.6]),this.depthTest=!0,this.depthMode=0,this.smooth=!0,this.blendMode=t.BlendMode.NORMAL,this.alphaBlending=!1,this.ambientColor=3355443,this.diffuseColor=16777215,this.specularColor=16777215,this.specularLevel=4,this.gloss=20,this.cutAlpha=.7,this.repeat=!1,this.bothside=!1,this.alpha=1,this.albedo=.95,this.specularScale=1,this.normalScale=1,this.uvRectangle=new t.Rectangle(0,0,1,1),this.materialDataNeedChange=!0,this.textureChange=!1,this.textureStateChage=!0,this.cullFrontOrBack=t.ContextConfig.BACK,this.materialSourceData=new Float32Array(20),this.materialSourceData2=new Float32Array(20),this.colorGradientsSource=new Float32Array(10),this.colorTransform=new t.ColorTransform}return __extends(i,e),i.prototype.clone=function(){var t=new i;t.drawMode=this.drawMode,t.diffuseTexture=this.diffuseTexture,t.shadowMapTexture=this.shadowMapTexture;for(var e=0;3>e;++e)t.shadowColor[e]=this.shadowColor[e];return t.layer=this.layer,t.castShadow=this.castShadow,t.acceptShadow=this.acceptShadow,t.depthTest=this.depthTest,t.smooth=this.smooth,t.blendMode=this.blendMode,t.blend_src=this.blend_src,t.blend_dest=this.blend_dest,t.ambientColor=this.ambientColor,t.diffuseColor=this.diffuseColor,t.specularColor=this.specularColor,t.cutAlpha=this.cutAlpha,t.alpha=this.alpha,t.specularLevel=this.specularLevel,t.gloss=this.gloss,t.albedo=this.albedo,t.specularScale=this.specularScale,t.materialDataNeedChange=this.materialDataNeedChange,t.textureChange=!0,t.cullFrontOrBack=this.cullFrontOrBack,t.colorTransform=this.colorTransform,t},i.prototype.dispose=function(){},i}(Object);t.MaterialData=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){this._passChange=!0,this._vs_shader_methods={},this._fs_shader_methods={},this.methodList=new Array,this.methodDatas=new Array,this.vsShaderNames=new Array,this.fsShaderNames=new Array,this._helpMatrix=new t.Matrix4_4,this._materialData=e}return e.prototype.addMethod=function(t){var e=this.methodList.indexOf(t);-1==e&&(this.methodList.push(t),t.materialData=this._materialData,this._passChange=!0)},e.prototype.removeMethod=function(t){var e=this.methodList.indexOf(t);-1!=e&&(this.methodList.slice(e),this._passChange=!0)},e.prototype.materialDataChange=function(){this._materialData.materialDataNeedChange=!0},e.prototype.passInvalid=function(){this._passChange=!0},e.prototype.resetTexture=function(t){var e;for(var i in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[i],this._materialData[e.varName]&&(e.texture=this._materialData[e.varName]);var a;for(var i in this._passUsage.sampler3DList)a=this._passUsage.sampler3DList[i],this._materialData[a.varName]&&(a.texture=this._materialData[a.varName]);this._materialData.textureChange=!1},e.prototype.addMethodShaders=function(t,e){for(var i=0;i<e.length;i++)t.addUseShaderName(e[i])},e.prototype.addShaderPhase=function(e,i,a){var r,n,o;for(n in i){r=i[n];for(var s=0;s<r.length;s++){a[n]=a[n]||[],a[n].push(r[s]),o=t.ShaderPhaseType[n];var h=this._materialData.shaderPhaseTypes[e].indexOf(t.ShaderPhaseType[o]);-1!=h&&this._materialData.shaderPhaseTypes[e].splice(h,1)}}},e.prototype.initOthreMethods=function(){for(var t,e,i=0;i<this.methodList.length;i++){var a=this.methodList[i];for(t in a.vsShaderList){e=a.vsShaderList[t];for(var r=0;r<e.length;r++)this._vs_shader_methods[t]=this._vs_shader_methods[t]||[],this._vs_shader_methods[t].push(e[r])}for(t in a.fsShaderList){e=a.fsShaderList[t];for(var r=0;r<e.length;r++)this._fs_shader_methods[t]=this._fs_shader_methods[t]||[],this._fs_shader_methods[t].push(e[r])}}},e.prototype.initUseMethod=function(e,i){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e&&(e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")):e.particleAnimationController&&(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("particle_vs"),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.vertex_shaders,this._vs_shader_methods),this.addShaderPhase(this._passID,e.particleAnimationController.particleAnimationState.fragment_shaders,this._fs_shader_methods))),this._materialData.acceptShadow&&(this._vs_shader_methods[t.ShaderPhaseType.global_vertex]=this._vs_shader_methods[t.ShaderPhaseType.global_vertex]||[],this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment]||[]),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.specular_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.specular_fragment].push("specularMap_fragment")),-1!=this._materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment].push("matCap_TextureMult_fs")),this.lightGroup&&(this._passUsage.maxDirectLight=this.lightGroup.directLightList.length,this._passUsage.maxSpotLight=this.lightGroup.spotLightList.length,this._passUsage.maxPointLight=this.lightGroup.pointLightList.length,this._vs_shader_methods[t.ShaderPhaseType.local_vertex]=this._vs_shader_methods[t.ShaderPhaseType.local_vertex]||[],this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("lightingBase_fs"),this.lightGroup.directLightList.length&&(this._passUsage.directLightData=new Float32Array(t.DirectLight.stride*this.lightGroup.directLightList.length),this._vs_shader_methods[t.ShaderPhaseType.local_vertex].push("varyingViewDir_vs"),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("directLight_fragment")),this.lightGroup.spotLightList.length&&(this._passUsage.spotLightData=new Float32Array(t.SpotLight.stride*this.lightGroup.spotLightList.length),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("spotLight_fragment")),this.lightGroup.pointLightList.length&&(this._passUsage.pointLightData=new Float32Array(t.PointLight.stride*this.lightGroup.pointLightList.length),this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment].push("pointLight_fragment"))),this.initOthreMethods();var a;this.addMethodShaders(this._passUsage.vertexShader,["base_vs"]),a=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],a&&a.length>0?this.addMethodShaders(this._passUsage.vertexShader,a):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vertex"]),a=this._vs_shader_methods[t.ShaderPhaseType.local_vertex],a&&a.length>0&&this.addMethodShaders(this._passUsage.vertexShader,a),a=this._vs_shader_methods[t.ShaderPhaseType.global_vertex],a&&a.length>0&&this.addMethodShaders(this._passUsage.vertexShader,a),a=this._vs_shader_methods[t.ShaderPhaseType.end_vertex],a&&a.length>0?this.addMethodShaders(this._passUsage.vertexShader,a):this.addMethodShaders(this._passUsage.vertexShader,["end_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),a=this._fs_shader_methods[t.ShaderPhaseType.start_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.materialsource_fragment],a&&a.length>0?this.addMethodShaders(this._passUsage.fragmentShader,a):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),a=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment],a&&a.length>0?this.addMethodShaders(this._passUsage.fragmentShader,a):this.addMethodShaders(this._passUsage.fragmentShader,["diffuse_fragment"]),a=this._fs_shader_methods[t.ShaderPhaseType.normal_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.shadow_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.lighting_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.specular_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.multi_end_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.end_fragment],a&&a.length>0?this.addMethodShaders(this._passUsage.fragmentShader,a):e&&e.particleAnimationController?this.addMethodShaders(this._passUsage.fragmentShader,["particle_end_fs"]):this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"])},e.prototype.upload=function(e,i,a,r,n,o,s){this._passChange&&this._passUsage&&t.Context3DProxy.gl.deleteProgram(this._passUsage.program3D.program),this._passChange=!1,this.initUseMethod(o,s),this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage),this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage),this._passUsage.program3D=t.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id);for(var h in this._passUsage)-1!=h.indexOf("uniform")&&this._passUsage[h]&&(this._passUsage[h].uniformIndex=a.getUniformLocation(this._passUsage.program3D,h));var l;for(var u in this._passUsage.sampler2DList)l=this._passUsage.sampler2DList[u],l.uniformIndex=a.getUniformLocation(this._passUsage.program3D,l.varName),l.texture=this._materialData[l.varName];var c;for(var u in this._passUsage.sampler3DList)c=this._passUsage.sampler3DList[u],c.uniformIndex=a.getUniformLocation(this._passUsage.program3D,c.varName);if(this.methodList)for(var d=0;d<this.methodList.length;d++)this.methodList[d].upload(e,i,this._passUsage,null,a,r,n)},e.prototype.draw=function(e,i,a,r,n,o,s){this._materialData.materialDataNeedChange&&(this._materialData.materialSourceData[0]=(this._materialData.diffuseColor>>16&255)/255,this._materialData.materialSourceData[1]=(this._materialData.diffuseColor>>8&255)/255,this._materialData.materialSourceData[2]=(255&this._materialData.diffuseColor)/255,this._materialData.materialSourceData[3]=(this._materialData.ambientColor>>16&255)/255,this._materialData.materialSourceData[4]=(this._materialData.ambientColor>>8&255)/255,this._materialData.materialSourceData[5]=(255&this._materialData.ambientColor)/255,this._materialData.materialSourceData[6]=(this._materialData.specularColor>>16&255)/255,this._materialData.materialSourceData[7]=(this._materialData.specularColor>>8&255)/255,this._materialData.materialSourceData[8]=(255&this._materialData.specularColor)/255,this._materialData.materialSourceData[9]=this._materialData.alpha,this._materialData.materialSourceData[10]=this._materialData.cutAlpha,this._materialData.materialSourceData[11]=this._materialData.gloss,this._materialData.materialSourceData[12]=this._materialData.specularLevel,this._materialData.materialSourceData[13]=this._materialData.albedo,this._materialData.materialSourceData[14]=this._materialData.uvRectangle.x,this._materialData.materialSourceData[15]=this._materialData.uvRectangle.y,this._materialData.materialSourceData[16]=this._materialData.uvRectangle.width,this._materialData.materialSourceData[17]=this._materialData.uvRectangle.height,this._materialData.materialSourceData[18]=this._materialData.specularLevel,this._materialData.materialSourceData[19]=this._materialData.normalScale),this._passChange&&this.upload(e,i,a,r,n,s,o.geometry),a.setProgram(this._passUsage.program3D),o.activeState(e,i,this._passUsage,a),this._materialData.depthTest?(a.enableDepth(),a.depthFunc(t.ContextConfig.LEQUAL)):(a.disableDepth(),a.depthFunc(t.ContextConfig.LEQUAL)),a.setCulling(this._materialData.cullFrontOrBack),this._materialData.bothside?a.disableCullFace():a.enableCullFace(),this._materialData.alphaBlending&&t.Context3DProxy.gl.depthMask(!1),a.enableBlend(),a.setBlendFactors(this._materialData.blend_src,this._materialData.blend_dest),this._passUsage.uniform_materialSource&&a.uniform1fv(this._passUsage.uniform_materialSource.uniformIndex,this._materialData.materialSourceData),this._materialData.textureChange&&this.resetTexture(a);var h;for(var l in this._passUsage.sampler2DList)h=this._passUsage.sampler2DList[l],h.texture=this._materialData[h.varName],h.texture&&(h.texture.upload(a),a.setTexture2DAt(h.activeTextureIndex,h.uniformIndex,h.index,h.texture.texture2D),h.texture.useMipmap&&(h.texture.useMipmap=this._materialData.useMipmap),h.texture.repeat=this._materialData.repeat,h.texture.smooth=this._materialData.smooth,h.texture.activeState(a),this._materialData.textureStateChage=!1);var u;for(var l in this._passUsage.sampler3DList)u=this._passUsage.sampler3DList[l],u.texture=this._materialData[u.varName],u.texture&&(u.texture.upload(a),a.setCubeTextureAt(u.activeTextureIndex,u.uniformIndex,u.index,u.texture.texture3D));var c=0;if(this.lightGroup){for(c=0;c<this._passUsage.maxDirectLight;c++)this.lightGroup.directLightList[c].updateLightData(n,c,this._passUsage.directLightData);for(c=0;c<this._passUsage.maxSpotLight;c++)this.lightGroup.spotLightList[c].updateLightData(n,c,this._passUsage.spotLightData);for(c=0;c<this._passUsage.maxPointLight;c++)this.lightGroup.pointLightList[c].updateLightData(n,c,this._passUsage.pointLightData);this._passUsage.uniform_directLightSource&&a.uniform1fv(this._passUsage.uniform_directLightSource.uniformIndex,this._passUsage.directLightData),this._passUsage.uniform_sportLightSource&&a.uniform1fv(this._passUsage.uniform_sportLightSource.uniformIndex,this._passUsage.spotLightData),this._passUsage.uniform_pointLightSource&&a.uniform1fv(this._passUsage.uniform_pointLightSource.uniformIndex,this._passUsage.pointLightData)}if(this._passUsage.uniform_ModelMatrix&&a.uniformMatrix4fv(this._passUsage.uniform_ModelMatrix.uniformIndex,!1,r.rawData),this._passUsage.uniform_ViewMatrix&&a.uniformMatrix4fv(this._passUsage.uniform_ViewMatrix.uniformIndex,!1,n.viewMatrix.rawData),this._passUsage.uniform_ProjectionMatrix&&a.uniformMatrix4fv(this._passUsage.uniform_ProjectionMatrix.uniformIndex,!1,n.projectMatrix.rawData),this._passUsage.uniform_ModelViewMatrix&&(this._helpMatrix.identity(),this._helpMatrix.copyFrom(r),this._helpMatrix.multiply(n.viewMatrix),a.uniformMatrix4fv(this._passUsage.uniform_ModelViewMatrix.uniformIndex,!1,this._helpMatrix.rawData)),this._passUsage.uniform_ViewProjectionMatrix&&a.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,n.viewProjectionMatrix.rawData),s&&s.activeState(e,i,this._passUsage,o,a,r,n),this.methodList)for(var c=0;c<this.methodList.length;c++)this.methodList[c].activeState(e,i,this._passUsage,null,a,r,n);this._passUsage.uniform_NormalMatrix&&(this._helpMatrix.identity(),this._helpMatrix.copyFrom(r),this._helpMatrix.multiply(n.viewMatrix),this._helpMatrix.invert(),this._helpMatrix.transpose(),a.uniformMatrix4fv(this._passUsage.uniform_NormalMatrix.uniformIndex,!1,this._helpMatrix.rawData)),this._passUsage.uniform_ShadowMatrix,this._passUsage.uniform_eyepos&&a.uniform3f(this._passUsage.uniform_eyepos.uniformIndex,n.x,n.y,n.z),this._passUsage.uniform_cameraMatrix&&a.uniformMatrix4fv(this._passUsage.uniform_cameraMatrix.uniformIndex,!1,n.modelMatrix.rawData),a.drawElement(this._materialData.drawMode,o.start,o.count),this._materialData.alphaBlending&&t.Context3DProxy.gl.depthMask(!0),o.deactiveState(this._passUsage,a)},e.prototype.deactiveState=function(t,e){var i;for(var a in t.sampler2DList)i=this._passUsage.sampler2DList[a],i.texture&&e.disableTexture2DAt(i.activeTextureIndex,i.uniformIndex,i.index)},e.prototype.dispose=function(){},e}();t.MaterialPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this._passID=t.PassType.colorPass}return __extends(i,e),i.prototype.initUseMethod=function(t,i){e.prototype.initUseMethod.call(this,t,i)},i}(t.MaterialPass);t.ColorPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this._passID=t.PassType.diffusePass}return __extends(i,e),i.prototype.initUseMethod=function(t,i){e.prototype.initUseMethod.call(this,t,i)},i}(t.MaterialPass);t.DiffusePass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this._passID=t.PassType.shadowPass}return __extends(i,e),i.prototype.initUseMethod=function(e,i){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e?e.skeletonAnimationController?(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeletonShadowPass_vs")):e.particleAnimationController:(this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("staticShadowPass_vs")),-1!=this._materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuseShadowPass_fs"));var a;this.addMethodShaders(this._passUsage.vertexShader,["baseShadowPass_vs"]),a=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],a&&a.length>0&&this.addMethodShaders(this._passUsage.vertexShader,a),this.addMethodShaders(this._passUsage.vertexShader,["endShadowPass_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["baseShadowPass_fs"]),a=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),this.addMethodShaders(this._passUsage.fragmentShader,["endShadowPass_fs"])},i}(t.MaterialPass);t.ShadowPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this._passID=t.PassType.CubePass}return __extends(i,e),i.prototype.initUseMethod=function(e,i){this._passChange=!1;this._passUsage=new t.PassUsage,this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,this._passUsage.vertexShader.addUseShaderName("cube_vertex"),this._passUsage.fragmentShader.addUseShaderName("cube_fragment")},i}(t.MaterialPass);t.CubePass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this,i),this._passID=t.PassType.matCapPass}return __extends(i,e),i.prototype.initUseMethod=function(e,i){this._passChange=!1;this._passUsage=new t.PassUsage,this._vs_shader_methods={},this._fs_shader_methods={},e&&e.skeletonAnimationController&&(this._passUsage.maxBone=2*e.skeletonAnimationController.jointNum,this._vs_shader_methods[t.ShaderPhaseType.start_vertex]=[],this._vs_shader_methods[t.ShaderPhaseType.start_vertex].push("skeleton_vs")),this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment].push("diffuse_fragment"),this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment].push("matCap_TextureAdd_fs"),this._materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1!=this._materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this._fs_shader_methods[t.ShaderPhaseType.normal_fragment]=[],this._fs_shader_methods[t.ShaderPhaseType.normal_fragment].push("normalMap_fragment"));var a;this.addMethodShaders(this._passUsage.vertexShader,["base_vs","tangent_vs"]),a=this._vs_shader_methods[t.ShaderPhaseType.start_vertex],a&&a.length>0?this.addMethodShaders(this._passUsage.vertexShader,a):this.addMethodShaders(this._passUsage.vertexShader,["diffuse_vertex"]),a=this._vs_shader_methods[t.ShaderPhaseType.local_vertex],a&&a.length>0&&this.addMethodShaders(this._passUsage.vertexShader,a),this.addMethodShaders(this._passUsage.vertexShader,["end_vs"]),this.addMethodShaders(this._passUsage.fragmentShader,["base_fs"]),a=this._fs_shader_methods[t.ShaderPhaseType.materialsource_fragment],a&&a.length>0?this.addMethodShaders(this._passUsage.fragmentShader,a):this.addMethodShaders(this._passUsage.fragmentShader,["materialSource_fs"]),a=this._fs_shader_methods[t.ShaderPhaseType.diffuse_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.normal_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),a=this._fs_shader_methods[t.ShaderPhaseType.matCap_fragment],a&&a.length>0&&this.addMethodShaders(this._passUsage.fragmentShader,a),this.addMethodShaders(this._passUsage.fragmentShader,["end_fs"])},i}(t.MaterialPass);t.MatCapPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.diffusePass=0]="diffusePass",t[t.colorPass=1]="colorPass",t[t.normalPass=2]="normalPass",t[t.shadowPass=3]="shadowPass",t[t.lightPass=4]="lightPass",t[t.matCapPass=5]="matCapPass",t[t.depthPass_8=6]="depthPass_8",t[t.depthPass_32=7]="depthPass_32",t[t.CubePass=8]="CubePass"}(t.PassType||(t.PassType={}));var e=t.PassType,i=function(){function i(){}return i.CreatPass=function(i,a){switch(i){case e.colorPass:return a.shaderPhaseTypes[e.colorPass]=[],[new t.ColorPass(a)];case e.diffusePass:return a.shaderPhaseTypes[e.diffusePass]=[],[new t.DiffusePass(a)];case e.shadowPass:return a.shaderPhaseTypes[e.shadowPass]=[],[new t.ShadowPass(a)];case e.matCapPass:return a.shaderPhaseTypes[e.matCapPass]=[],[new t.MatCapPass(a)];case e.CubePass:return a.shaderPhaseTypes[e.diffusePass]=[],[new t.CubePass(a)]}return null},i.PassAuto=[!0,!0,!0,!1,!1,!0,!0,!0],i}();t.PassUtil=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.passes=[],null==e?this.setData(new t.MaterialData):this.setData(e)}return e.prototype.setData=function(e){this.materialData=e,this.initPass(),this.blendMode=t.BlendMode.NORMAL},e.prototype.getData=function(){return this.materialData},e.prototype.initPass=function(){this.addPass(t.PassType.colorPass)},Object.defineProperty(e.prototype,"lightGroup",{get:function(){return this._lightGroup},set:function(e){if(this._lightGroup=e,this.passes[t.PassType.diffusePass]&&this.passes[t.PassType.diffusePass].length>0)for(var i=0;i<this.passes[t.PassType.diffusePass].length;i++)this.passes[t.PassType.diffusePass][i].lightGroup=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depth",{get:function(){return this.materialData.depthTest},set:function(t){this.materialData.depthTest=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthMode",{get:function(){return this.materialData.depthMode},set:function(t){this.materialData.depthMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this.materialData.diffuseTexture},set:function(e){e&&(this.materialData.diffuseTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.diffuse_fragment),this.materialData.shaderPhaseTypes[t.PassType.shadowPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.shadowPass].indexOf(t.ShaderPhaseType.diffuse_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.shadowPass].push(t.ShaderPhaseType.diffuse_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normalTexture",{get:function(){return this.materialData.normalTexture},set:function(e){e&&(this.materialData.normalTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.normal_fragment)&&(this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.normal_fragment),this.passInvalid(t.PassType.diffusePass)),this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.normal_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.normal_fragment))},enumerable:!0,configurable:!0}),e.prototype.passInvalid=function(t){if(this.passes[t]&&this.passes[t].length>0)for(var e=0;e<this.passes[t].length;e++)this.passes[t][e].passInvalid()},Object.defineProperty(e.prototype,"matcapTexture",{get:function(){return this.materialData.normalTexture},set:function(e){e&&(this.materialData.matcapTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.matCap_fragment)&&(this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.matCap_fragment),this.passInvalid(t.PassType.diffusePass)),this.materialData.shaderPhaseTypes[t.PassType.matCapPass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.matCapPass].indexOf(t.ShaderPhaseType.matCap_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.matCapPass].push(t.ShaderPhaseType.matCap_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularTexture",{get:function(){return this.materialData.specularTexture},set:function(e){e&&(this.materialData.specularTexture=e,this.materialData.textureChange=!0,this.materialData.shaderPhaseTypes[t.PassType.diffusePass]&&-1==this.materialData.shaderPhaseTypes[t.PassType.diffusePass].indexOf(t.ShaderPhaseType.specular_fragment)&&this.materialData.shaderPhaseTypes[t.PassType.diffusePass].push(t.ShaderPhaseType.specular_fragment))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"drawMode",{get:function(){return this.materialData.drawMode},set:function(t){this.materialData.drawMode=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cutAlpha",{get:function(){return this.materialData.cutAlpha},set:function(t){this.materialData.cutAlpha=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffuseColor",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ambientColor",{get:function(){return this.materialData.ambientColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.ambientColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularColor",{get:function(){return this.materialData.specularColor},set:function(t){this.materialData.materialDataNeedChange=!0,this.materialData.specularColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha!=t&&(this.materialData.alpha=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"alphaBlending",{get:function(){return this.materialData.alphaBlending},set:function(t){this.materialData.alphaBlending!=t&&(this.materialData.alphaBlending=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"specularLevel",{get:function(){return this.materialData.specularLevel},set:function(t){this.materialData.specularLevel!=t&&(this.materialData.specularLevel=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gloss",{get:function(){return this.materialData.gloss},set:function(t){this.materialData.gloss!=t&&(this.materialData.gloss=t,this.materialData.materialDataNeedChange=!0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uvRectangle",{get:function(){return this.materialData.uvRectangle},set:function(t){this.materialData.uvRectangle.x=t.x,this.materialData.uvRectangle.y=t.y,this.materialData.uvRectangle.width=t.width,this.materialData.uvRectangle.height=t.height,this.materialData.materialDataNeedChange=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"diffusePass",{get:function(){return this.passes[t.PassType.diffusePass][0]},enumerable:!0,configurable:!0}),e.prototype.addPass=function(e){this.passes[e]=this.passes[t.PassType.shadowPass]||t.PassUtil.CreatPass(e,this.materialData)},Object.defineProperty(e.prototype,"castShadow",{get:function(){return this.materialData.castShadow},set:function(e){this.materialData.castShadow=e,e?this.addPass(t.PassType.shadowPass):this.passes[t.PassType.shadowPass]&&(this.disposePass(t.PassType.shadowPass),this.passes[t.PassType.shadowPass]=null)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"acceptShadow",{get:function(){return this.materialData.acceptShadow},set:function(t){this.materialData.acceptShadow=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"shadowColor",{get:function(){var t=0;return t|=255*this.materialData.shadowColor[0]<<16,t|=255*this.materialData.shadowColor[1]<<8,t|=255*this.materialData.shadowColor[2]},set:function(t){this.materialData.shadowColor[0]=t>>16&1,this.materialData.shadowColor[1]=t>>8&1,this.materialData.shadowColor[2]=1&t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"smooth",{get:function(){return this.materialData.smooth},set:function(t){this.materialData.smooth=t,this.materialData.textureStateChage=!0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"repeat",{get:function(){return this.materialData.repeat},set:function(t){this.materialData.repeat=t,this.materialData.textureStateChage=!0
},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bothside",{get:function(){return this.materialData.bothside},set:function(t){this.materialData.textureStateChage=!0,this.materialData.bothside=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cullMode",{get:function(){return this.materialData.cullFrontOrBack},set:function(t){this.materialData.textureStateChage=!0,this.materialData.cullFrontOrBack=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"blendMode",{set:function(e){switch(this.materialData.textureStateChage=!0,this.materialData.blendMode=e,e){case t.BlendMode.NORMAL:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA,this.materialData.alphaBlending=!1;break;case t.BlendMode.LAYER:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA,this.materialData.blend_dest=t.ContextConfig.ZERO,this.materialData.alphaBlending=!0;break;case t.BlendMode.MULTIPLY:this.materialData.blend_src=t.ContextConfig.ZERO,this.materialData.blend_dest=t.ContextConfig.SRC_COLOR,this.materialData.alphaBlending=!0;break;case t.BlendMode.ADD:this.materialData.blend_src=t.ContextConfig.SRC_ALPHA,this.materialData.blend_dest=t.ContextConfig.ONE,this.materialData.alphaBlending=!0;break;case t.BlendMode.SOFT_ADD:this.materialData.blend_src=t.ContextConfig.SRC_COLOR,this.materialData.blend_dest=t.ContextConfig.ONE,this.materialData.alphaBlending=!0;break;case t.BlendMode.ALPHA:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_ALPHA,this.materialData.alphaBlending=!0;break;case t.BlendMode.SCREEN:this.materialData.blend_src=t.ContextConfig.ONE,this.materialData.blend_dest=t.ContextConfig.ONE_MINUS_SRC_COLOR}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointSize",{get:function(){return this.materialData.specularLevel},set:function(t){t!=this.materialData.specularLevel&&(this.materialData.specularLevel=t,this.materialData.textureStateChage=!0)},enumerable:!0,configurable:!0}),e.prototype.disposePass=function(t){for(var e=0;e<this.passes[t].length;e++)this.passes[t][e].dispose()},e.prototype.renderXRayPass=function(){},e.prototype.renderOutlinePass=function(){},e.prototype.renderNormalPass=function(){},e.prototype.renderDepthPass=function(){},e.prototype.renderPositionPass=function(){},e.prototype.renderUVPass=function(){},e.prototype.renderScendUVPass=function(){},e.prototype.renderVertexColorPass=function(){},e.prototype.renderLightingPass=function(){},e}();t.MaterialBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=13421772),e.call(this),this.color=i,this.diffuseTexture=t.CheckerboardTexture.texture,this.initMatPass()}return __extends(i,e),i.prototype.initMatPass=function(){this.addPass(t.PassType.diffusePass),this.diffusePass.addMethod(new t.ColorMethod)},Object.defineProperty(i.prototype,"color",{get:function(){return this.materialData.diffuseColor},set:function(t){this.materialData.diffuseColor=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"alpha",{get:function(){return this.materialData.alpha},set:function(t){this.materialData.alpha=t},enumerable:!0,configurable:!0}),i}(t.MaterialBase);t.ColorMaterial=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){void 0===i&&(i=null),void 0===a&&(a=null),e.call(this,a),i?this.diffuseTexture=i:this.diffuseTexture=t.CheckerboardTexture.texture,this.initMatPass()}return __extends(i,e),i.prototype.initMatPass=function(){this.addPass(t.PassType.diffusePass)},i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t},i}(t.MaterialBase);t.TextureMaterial=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i){void 0===t&&(t=null),void 0===i&&(i=null),e.call(this,i),this.diffuseTexture=t,this.initMatPass()}return __extends(i,e),i.prototype.initMatPass=function(){this.addPass(t.PassType.diffusePass),this.diffusePass.addMethod(new t.CubeMethod)},i.prototype.clone=function(){var t=new i(this.diffuseTexture,this.materialData.clone());return t},i}(t.MaterialBase);t.CubeTextureMaterial=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._renderIndex=0,this.numEntity=0}return e.prototype.setRenderToTexture=function(e,i,a){void 0===a&&(a=t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.renderTexture=new t.RenderTexture(e,i,a)},e.prototype.draw=function(t,e,i,a,r,n,o){void 0===n&&(n=null),void 0===o&&(o=!1)},e}();t.RenderBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=t.PassType.diffusePass),e.call(this),this._i=0,this._j=0,this._pass=i}return __extends(i,e),i.prototype.draw=function(e,i,a,r,n,o,s){void 0===o&&(o=null),void 0===s&&(s=!1),this.numEntity=r.renderList.length,this.renderTexture&&(this.renderTexture.upload(a),a.setRenderToTexture(this.renderTexture.texture2D,!0,0));var h;for(this._renderIndex=0;this._renderIndex<this.numEntity;this._renderIndex++)if(this._renderItem=r.renderList[this._renderIndex],!s||this._renderItem.material.castShadow)for(this._renderItem.geometry.activeState(e,i,t.Egret3DCanvas.context3DProxy,n),this._i=0;this._i<this._renderItem.geometry.subGeometrys.length;this._i++){var l=this._renderItem.geometry.subGeometrys[this._i],u=l.matID;if(h=this._renderItem.multiMaterial[u],null!=h)if(h.passes[this._pass])for(this._j=h.passes[this._pass].length-1;this._j>=0;this._j--)h.passes[this._pass][this._j].draw(e,i,a,this._renderItem.modelMatrix,n,l,this._renderItem.animation);else if(t.PassUtil.PassAuto[this._pass])for(this._j=h.passes[this._pass].length-1;this._j>=0;this._j--)h.passes[this._pass]=t.PassUtil.CreatPass(this._pass,h.materialData),h.passes[this._pass][this._j].draw(e,i,a,this._renderItem.modelMatrix,n,l,this._renderItem.animation)}this.renderTexture&&(a.setRenderToBackBuffer(),o&&(a.viewPort(o.x,o.y,o.width,o.height),a.setScissorRectangle(o.x,o.y,o.width,o.height)))},i}(t.RenderBase);t.MultiRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){e.call(this),this._hud=new t.HUD,this._hud.vsShader=i,this._hud.fsShader=a}return __extends(i,e),i.prototype.setRenderToTexture=function(e,i,a){void 0===a&&(a=t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.renderTexture=new t.RenderTexture(e,i,t.FrameBufferFormat.UNSIGNED_BYTE_RGB)},i.prototype.draw=function(t,e,i,a,r,n,o){void 0===n&&(n=null),this.numEntity=a.renderList.length,this.renderTexture&&(this.renderTexture.upload(i),i.setRenderToTexture(this.renderTexture.texture2D,!0,0)),this._hud.viewPort=r.viewPort,this._hud.x=r.viewPort.x,this._hud.y=r.viewPort.y,this._hud.width=r.viewPort.width,this._hud.height=r.viewPort.height,this._hud.diffuseTexture=o.end,this._hud.colorTexture=o.colorTexture,this._hud.draw(i),i.setRenderToBackBuffer(),n&&(i.viewPort(n.x,n.y,n.width,n.height),i.setScissorRectangle(n.x,n.y,n.width,n.height))},i}(t.RenderBase);t.PostRender=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t["float"]=0]="float",t[t.vec2=1]="vec2",t[t.vec3=2]="vec3",t[t.vec4=3]="vec4"}(t.ValueType||(t.ValueType={}));var e=t.ValueType,i=function(){function t(){}return t.prototype.calculate=function(t,e){return void 0===e&&(e=null),new Error("asd"),null},t}();t.ValueShape=i;var a=function(t){function i(){t.apply(this,arguments),this.valueType=e["float"],this.value=5}return __extends(i,t),i.prototype.calculate=function(t){for(var e=[],i=0;t>i;i++)e.push(this.value);return e},i}(i);t.ConstValueShape=a;var r=function(t){function i(){t.apply(this,arguments),this.valueType=e["float"],this.min=0,this.max=100}return __extends(i,t),i.prototype.calculate=function(t){for(var e=[],i=0;t>i;i++)e.push(this.min+Math.random()*(this.max-this.min));return e},i}(i);t.ConstRandomValueShape=r;var n=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec2,this.minX=0,this.minY=0}return __extends(a,i),a.prototype.calculate=function(e){for(var i=[],a=0;e>a;a++){var r=new t.Point;r.x=this.minX,r.y=this.minY,i.push(r)}return i},a}(i);t.Vec2ConstValueShape=n;var o=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec2,this.minX=0,this.minY=0,this.maxX=100,this.maxY=100}return __extends(a,i),a.prototype.calculate=function(e){for(var i=[],a=0;e>a;a++){var r=new t.Point;r.x=this.minX+Math.random()*(this.maxX-this.minX),r.y=this.minY+Math.random()*(this.maxY-this.minY),i.push(r)}return i},a}(i);t.Vec2ConstRandomValueShape=o;var s=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.minX=0,this.minY=0,this.minZ=0}return __extends(a,i),a.prototype.calculate=function(e){for(var i=[],a=0;e>a;a++){var r=new t.Vector3D;r.x=this.minX,r.y=this.minY,r.z=this.minZ,i.push(r)}return i},a}(i);t.Vec3ConstValueShape=s;var h=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.minX=-50,this.minY=-50,this.minZ=-50,this.maxX=50,this.maxY=50,this.maxZ=50}return __extends(a,i),a.prototype.calculate=function(e){for(var i=[],a=0;e>a;a++){var r=new t.Vector3D;r.x=this.minX+Math.random()*(this.maxX-this.minX),r.y=this.minY+Math.random()*(this.maxY-this.minY),r.z=this.minZ+Math.random()*(this.maxZ-this.minZ),i.push(r)}return i},a}(i);t.Vec3ConstRandomValueShape=h;var l=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.width=100,this.height=100,this.depth=100}return __extends(a,i),a.prototype.calculate=function(e){for(var i,a=[],r=0;e>r;r++)i=new t.Vector3D,i.x=Math.random()*this.width-.5*this.width,i.y=Math.random()*this.height-.5*this.height,i.z=Math.random()*this.depth-.5*this.depth,a.push(i);return a},a}(i);t.CubeVector3DValueShape=l;var u=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.width=100,this.height=100}return __extends(a,i),a.prototype.calculate=function(e){for(var i,a=[],r=0;e>r;r++)i=new t.Vector3D,i.x=Math.random()*this.width-.5*this.width,i.y=0,i.z=Math.random()*this.height-.5*this.height,a.push(i);return a},a}(i);t.PlaneValueShape=u;var c=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.radiusTop=20,this.radiusBottom=20,this.height=20,this.coneType=t.ParticleConeShapeType.Volume}return __extends(a,i),a.prototype.calculate=function(e){var i,a=[];if(this.radiusBottom==this.radiusTop){this.origPoint=null;for(var r,n=0;e>n;n++){if(i=new t.Vector3D,r=2*Math.random()*Math.PI,i.x=Math.sin(r)*this.radiusBottom,i.z=Math.cos(r)*this.radiusBottom,this.coneType==t.ParticleConeShapeType.Volume){var o=Math.random();i.x*=o,i.z*=o,i.y=Math.random()*this.height-.5*this.height}else this.coneType==t.ParticleConeShapeType.VolumeShell?i.y=Math.random()*this.height-.5*this.height:this.coneType==t.ParticleConeShapeType.Base?(i.y=.5*-this.height,i.x*=o,i.z*=o):this.coneType==t.ParticleConeShapeType.BaseShell&&(i.y=.5*-this.height);a.push(i)}}else{this.origPoint=new t.Vector3D(0,0,0);var s=this.radiusTop*this.height/Math.abs(this.radiusTop-this.radiusBottom);this.origPoint.y=-(this.height/2+s),this.radiusTop<this.radiusBottom&&(this.origPoint.y*=-1);for(var r,h,l=Math.abs(this.radiusBottom-this.radiusTop),n=0;e>n;n++){if(i=new t.Vector3D,r=2*Math.random()*Math.PI,this.coneType==t.ParticleConeShapeType.Base?i.y=.5*-this.height:this.coneType==t.ParticleConeShapeType.BaseShell?i.y=.5*-this.height:this.coneType==t.ParticleConeShapeType.Volume?i.y=Math.random()*this.height-.5*this.height:this.coneType==t.ParticleConeShapeType.VolumeShell&&(i.y=Math.random()*this.height-.5*this.height),h=Math.abs(i.y-this.origPoint.y),this.radiusBottom<this.radiusTop?(h=l*(this.height/2+i.y)/this.height,h+=this.radiusBottom):(h=l*(this.height/2-i.y)/this.height,h+=this.radiusBottom),i.x=Math.sin(r)*h,i.z=Math.cos(r)*h,this.coneType==t.ParticleConeShapeType.Volume||this.coneType==t.ParticleConeShapeType.Base){var o=Math.random();i.x*=o,i.z*=o}a.push(i)}}this.origPoint&&this.yz_zy(this.origPoint);for(var n=0,u=a.length;u>n;n++)this.yz_zy(a[n]);return a},a.prototype.yz_zy=function(t){t.y+=this.height/2,t.setTo(t.x,t.z,t.y,t.w)},a.prototype.getDirection=function(e,i){return null==i&&(i=new t.Vector3D),i.setTo(0,1,0),null==e?i:(this.origPoint&&(i.copyFrom(e),i.decrementBy(this.origPoint),i.normalize(),this.radiusTop<this.radiusBottom&&(i.x*=-1,i.y*=-1,i.z*=-1)),i)},a}(i);t.CylinderValueShape=c;var d=(function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.points=[new t.Vector3D,new t.Vector3D(100,0,0),new t.Vector3D(100,200,0)]}return __extends(a,i),a.prototype.calculate=function(e){if(1==this.points.length)return this.points;for(var i=[],a=0,r=0,n=1;n<this.points.length;n++)a+=t.Vector3D.distance(this.points[n-1],this.points[n]);r=a/e;for(var o=new t.Vector3D,s=0,h=0,l=0,n=1;n<this.points.length;n++)o.x=this.points[n].x-this.points[n-1].x,o.y=this.points[n].y-this.points[n-1].y,o.z=this.points[n].z-this.points[n-1].z,o.normalize(),o.scaleBy(r+l),s=t.Vector3D.distance(this.points[n-1],this.points[n]),h=t.Vector3D.distance(o,this.points[n]),h>s&&(l+=h);return i},a}(i),function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3}return __extends(a,i),a.prototype.calculate=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var a=[],r=e[0][0];return a=this.getPoints1(t,r)},a.prototype.getPoints1=function(e,i){for(var a,r,n,o,s,h=[],l=0;e>l;l++)a=2*Math.random()-1,r=2*Math.random()-1,n=2*Math.random()-1,o=a*a+r*r+n*n,o>1?l--:(s=Math.sqrt(o),h.push(new t.Vector3D(a/s*i,r/s*i,n/s*i)));return h},a.prototype.getPoints2=function(t,e){for(var i=[],a=0;t>a;a++);return i},a}(i),function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.r=10}return __extends(a,i),a.prototype.calculate=function(t){var e=[];return e=this.getPoints1(t,this.r)},a.prototype.getPoints1=function(e,i){for(var a,r,n,o,s=[],h=new t.Vector3D(0,0,0),l=0;e>l;l++)a=2*Math.random()*i-i,r=2*Math.random()*i-i,n=2*Math.random()*i-i,o=new t.Vector3D(a,r,n),t.Vector3D.distance(h,o)>i?l--:s.push(o);return s},a}(i));t.BallValueShape=d;var p=function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.r=10}return __extends(a,i),a.prototype.calculate=function(t){var e=[];return e=this.getPoints1(t,this.r)},a.prototype.getPoints1=function(e,i){for(var a,r,n,o,s=[],h=new t.Vector3D(0,0,0),l=0;e>l;l++)a=2*Math.random()*i-i,r=2*Math.random()*i-i,n=Math.abs(2*Math.random()*i-i),o=new t.Vector3D(a,r,n),t.Vector3D.distance(h,o)>i?l--:s.push(o);return s},a}(i);t.HemiBallValueShape=p;var f=(function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3}return __extends(a,i),a.prototype.calculate=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var a,r=e[0],n=r[0];return a=this.createRandomPoint1(t,n)},a.prototype.createRandomPoint1=function(e,i){for(var a=[],r=2*i,n=0;e>n;n++){var o=Math.random()*r-i,s=Math.random()*r-i;o*o+s*s>i*i?n--:a.push(new t.Vector3D(o,0,s))}return a},a.prototype.createRandomPoint2=function(e,i){for(var a,r,n,o=[],s=0;e>s;s++)a=new t.Vector3D,r=Math.sqrt(Math.random())*i,n=360*Math.random(),a.x=r*Math.sin(n),a.z=r*Math.cos(n),a.y=0,o.push(a);return o},a}(i),function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3,this.normalList=[],this.type=t.ParticleMeshShapeType.Edge}return __extends(a,i),a.prototype.calculate=function(e){var i=[];return this.type==t.ParticleMeshShapeType.Edge?this.edgePosition(i,e):this.type==t.ParticleMeshShapeType.Triangle?this.trianglePosition(i,e):this.type==t.ParticleMeshShapeType.Vertex&&this.vertexPosition(i,e),i},a.prototype.edgePosition=function(e,i){for(var r,n,o,s,h,l=this.geometry.indexData.length/3,u=[],c=0;i>c;c++){r=new t.Vector3D,e.push(r);var d=3*Math.floor(l*Math.random());u.length=0,this.geometry.getVertexForIndex(d+0,t.VertexFormat.VF_POSITION,u),a.vct1.setTo(u[0],u[1],u[2]),u.length=0,this.geometry.getVertexForIndex(d+1,t.VertexFormat.VF_POSITION,u),a.vct2.setTo(u[0],u[1],u[2]),u.length=0,this.geometry.getVertexForIndex(d+2,t.VertexFormat.VF_POSITION,u),a.vct3.setTo(u[0],u[1],u[2]),n=this.calcNormal(a.vct1,a.vct2,a.vct3),this.normalList.push(n),h=Math.random(),.333>h?(o=a.vct1,s=a.vct2):.666>h?(o=a.vct2,s=a.vct3):(o=a.vct3,s=a.vct1),o.lerp(o,s,Math.random()),r.copyFrom(o)}},a.prototype.trianglePosition=function(e,i){for(var r,n,o=this.geometry.indexData.length/3,s=new t.Vector3D,h=new t.Vector3D,l=[],u=0;i>u;u++){r=new t.Vector3D,e.push(r);var c=3*Math.floor(o*Math.random());l.length=0,this.geometry.getVertexForIndex(c+0,t.VertexFormat.VF_POSITION,l),a.vct1.setTo(l[0],l[1],l[2]),l.length=0,this.geometry.getVertexForIndex(c+1,t.VertexFormat.VF_POSITION,l),a.vct2.setTo(l[0],l[1],l[2]),l.length=0,this.geometry.getVertexForIndex(c+2,t.VertexFormat.VF_POSITION,l),a.vct3.setTo(l[0],l[1],l[2]),n=this.calcNormal(a.vct1,a.vct2,a.vct3),this.normalList.push(n),s.lerp(a.vct1,a.vct2,Math.random()),h.lerp(a.vct2,a.vct3,Math.random()),r.lerp(s,h,Math.random())}},a.prototype.vertexPosition=function(e,i){for(var r,n,o,s=this.geometry.indexData.length/3,h=[],l=0;i>l;l++){r=new t.Vector3D,e.push(r);var u=3*Math.floor(s*Math.random());h.length=0,this.geometry.getVertexForIndex(u+0,t.VertexFormat.VF_POSITION,h),a.vct1.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(u+1,t.VertexFormat.VF_POSITION,h),a.vct2.setTo(h[0],h[1],h[2]),h.length=0,this.geometry.getVertexForIndex(u+2,t.VertexFormat.VF_POSITION,h),a.vct3.setTo(h[0],h[1],h[2]),n=this.calcNormal(a.vct1,a.vct2,a.vct3),this.normalList.push(n),o=Math.random(),.333>o?r.copyFrom(a.vct1):.666>o?r.copyFrom(a.vct2):r.copyFrom(a.vct3)}},a.prototype.calcNormal=function(t,e,i){return a.crsVector1.setTo(e.x-t.x,e.y-t.y,e.z-t.z),a.crsVector2.setTo(i.x-t.x,i.y-t.y,i.z-t.z),this.normal=a.crsVector1.crossProduct(a.crsVector2),this.normal.normalize(),this.normal},a.vct1=new t.Vector3D,a.vct2=new t.Vector3D,a.vct3=new t.Vector3D,a.crsVector1=new t.Vector3D,a.crsVector2=new t.Vector3D,a}(i));t.Mesh3DValueShape=f;var _=(function(i){function a(){i.apply(this,arguments),this.valueType=e.vec3}return __extends(a,i),a.prototype.calculate=function(e){for(var i=[],a=1;a<arguments.length;a++)i[a-1]=arguments[a];var r=[],n=[];n.push(new t.Vector3D(0,0,0)),n.push(new t.Vector3D(-200,1e3,700)),n.push(new t.Vector3D(200,-50,300)),n.push(new t.Vector3D(-300,-220,500));for(var o,s,h,l,u,c=n[0],d=n[1],p=n[2],f=n[3],_=0;e>_;_++)o=Math.random(),s=1-o,h=c.x*s*s*s+3*d.x*s*s*o+3*p.x*s*o*o+f.x*o*o*o,l=c.y*s*s*s+3*d.y*s*s*o+3*p.y*s*o*o+f.y*o*o*o,u=c.z*s*s*s+3*d.z*s*s*o+3*p.z*s*o*o+f.z*o*o*o,r.push(new t.Vector3D(h,l,u));return r},a}(i),function(){function t(){this.emitter={}}return t.calculate=function(t,e){return e.calculate(t,e)},t.getValues=function(t,e,i){},t._instance=new t,t}());t.Value=_}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleEndNode",this.vertex_ShaderName[t.ShaderPhaseType.end_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.end_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.end_vertex].push("particle_end_vs")}return __extends(i,e),i.prototype.build=function(t,e){},i}(t.AnimationNode);t.ParticleEndNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleSpeedNode",this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push("particle_bezier"),this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push("particle_time_vs"),this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_time_fs"),this.fragment_ShaderName[t.ShaderPhaseType.diffuse_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.diffuse_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.diffuse_fragment].push("particle_diffuse_fragment"),this.attribute_time=new t.GLSL.VarRegister,this.attribute_time.name="attribute_time",this.attribute_time.size=3,this.attributes.push(this.attribute_time)}return __extends(i,e),i.prototype.initNode=function(e){var i=this._node=e,a=new t.ConstRandomValueShape;a.max=i.max,a.min=i.min,this._life=a},i.prototype.build=function(e,i){this._animationState=this.state;var a,r=this._animationState.emitter.data.emission,n=this._life.calculate(i);a=r.type==t.ParticleValueType.Const?this.createBornTimeConst(i,r):this.createBornTimeBezier(i,r),a.sort(function(t,e){return t-e}),a.length=i;for(var o,s=e.vertexCount/i,h=0,l=0,u=0,c=0,d=this._animationState.emitter.data.life.duration,p=0;i>p;++p){if(u=a[p],this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(c=u/d,c-=Math.floor(c),o=this._node.bezier1.calc(c),this._node.type==t.ParticleValueType.TwoBezier){var f=Math.random();o*=f,o+=this._node.bezier2.calc(c)*(1-f)}}else o=n[p];l=Math.max(l,o);for(var _=0;s>_;++_)h=p*s+_,h=h*e.vertexAttLength+this.attribute_time.offsetIndex,e.verticesData[h+0]=u,e.verticesData[h+1]=o,e.verticesData[h+2]=p}var m=l;u>l&&(m=u),this._animationState.loopTime=m,this._animationState.circleTime=this._animationState.emitter.data.life.delay+o+u},i.prototype.createBornTimeConst=function(t,e){var i,a=[];i=e.rate<=0?60:1/e.rate;for(var r=0;t>r;r++)a.push(r*i+i);return e.bursts&&(a=this.burstParticle(e.bursts,a,t)),a},i.prototype.createBornTimeBezier=function(t,e){for(var i=[],a=e.bezier,r=10,n=1e3/r,o=1e3*this._node.duration,s=(Math.ceil(1e3*this._node.duration/n),0),h=0,l=0,u=0;t>u;)if(s+=n,h+=a.calc(s%o/o)/r,h>=1){l=Math.floor(h),u+=l;for(var c=0;l>c;c++)i.push((s+c*n/l)/1e3);h-=l}return e.bursts&&(i=this.burstParticle(e.bursts,i,t)),i},i.prototype.burstParticle=function(t,e,i){t.sort(function(t,e){return t.x-e.x});for(var a,r=this._node.duration,n=[],o=0;o<t.length;o++){a=t[o];for(var s=0;s<a.y;s++)n.push(a.x)}var h=e[e.length-1],l=1;this._node.loop&&(l=Math.ceil(h/this._node.duration));for(var o=0,i=n.length;i>o;o++)for(var u=n[o],c=0;l>c;c++)e.push(c*r+u);return e},Object.defineProperty(i.prototype,"offsetIndex",{get:function(){return this.attribute_time.offsetIndex},enumerable:!0,configurable:!0}),i}(t.AnimationNode);t.ParticleTime=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.rotationMat=new t.Matrix4_4,this.name="ParticlePosition",this.attribute_offsetPosition=new t.GLSL.VarRegister,this.attribute_offsetPosition.name="attribute_offsetPosition",this.attribute_offsetPosition.size=3,this.attributes.push(this.attribute_offsetPosition)}return __extends(i,e),i.prototype.initNode=function(e,i){var a,r=i.renderMode;a=r==t.ParticleRenderModeType.Billboard?"particle_rm_billboard":r==t.ParticleRenderModeType.StretchedBillboard?"particle_rm_stretched":"particle_rm_mesh",this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push(a);var n=this._node=e;if(n.type==t.ParticleDataShapeType.Point){var o=new t.Vec3ConstValueShape;o.minX=0,o.minY=0,o.minZ=0,this._positions=o}else if(n.type==t.ParticleDataShapeType.Cube){var s=new t.CubeVector3DValueShape;s.width=n.cubeW,s.height=n.cubeH,s.depth=n.cubeD,this._positions=s}else if(n.type==t.ParticleDataShapeType.Sphere){var h=new t.BallValueShape;h.r=n.sphereRadius,this._positions=h}else if(n.type==t.ParticleDataShapeType.HemiSphere){var l=new t.HemiBallValueShape;l.r=n.hemiSphereRadius,this._positions=l}else if(n.type==t.ParticleDataShapeType.Cone){var u=new t.CylinderValueShape;u.radiusTop=n.coneRadiusTop,u.radiusBottom=n.coneRadiusBottom,u.coneType==t.ParticleConeShapeType.BaseShell?u.height=0:u.height=n.coneHeight,u.coneType=n.coneType,this._positions=u}else if(n.type==t.ParticleDataShapeType.Mesh){var c=new t.Mesh3DValueShape;c.geometry=n.geometry,c.type=n.meshType,this._positions=c}},Object.defineProperty(i.prototype,"offsetIndex",{get:function(){return this.attribute_offsetPosition.offsetIndex},enumerable:!0,configurable:!0}),i.prototype.build=function(e,i){this._animationState=this.state;var a,r=this._positions.calculate(i),n=this._animationState.directionArray=[];this._node.type==t.ParticleDataShapeType.Mesh&&(a=this._positions.normalList);for(var o=e.vertexCount/i,s=0,h=this._animationState.emitter.data,l=new t.Vector3D,u=this._positions,c=0;i>c;++c){var d=r[c];l.copyFrom(d),d.multiply(h.property.scale,d);var p=new t.Vector3D;h.shape.randomDirection?p.setTo(Math.random()-.5,Math.random()-.5,Math.random()-.5):this._node.type==t.ParticleDataShapeType.Point?p.setTo(Math.random()-.5,Math.random()-.5,Math.random()-.5):this._node.type==t.ParticleDataShapeType.Cube?p.setTo(0,0,1,1):this._node.type==t.ParticleDataShapeType.Sphere?p.copyFrom(l):this._node.type==t.ParticleDataShapeType.HemiSphere?p.copyFrom(l):this._node.type==t.ParticleDataShapeType.Cone?p=u.getDirection(l,p):this._node.type==t.ParticleDataShapeType.Mesh&&p.copyFrom(a[c]),p.normalize(),n.push(p);for(var f=0;o>f;++f)s=c*o+f,s=s*e.vertexAttLength+this.attribute_offsetPosition.offsetIndex,e.verticesData[s+0]=d.x,e.verticesData[s+1]=d.y,e.verticesData[s+2]=d.z}},i}(t.AnimationNode);t.ParticlePosition=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.rotationMat=new t.Matrix4_4,this.name="ParticleRotation"}return __extends(i,e),i.prototype.initNode=function(e){var i=this._node=e;this._rotations=new t.ConstRandomValueShape,this._rotations.max=i.max,this._rotations.min=i.min},i.prototype.build=function(e,i){this._animationState=this.state;for(var a,r,n,o=this._rotations.calculate(i),s=e.vertexCount/i,h=0,l=new t.Vector3D,u=0,c=this._animationState.emitter.data.life.duration,d=this._animationState.emitter.timeNode.offsetIndex,p=0,f=this._animationState.emitter.data.property.renderMode,_=0;i>_;++_){if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(r=p*e.vertexAttLength+d,n=e.verticesData[r+0],u=n/c,u-=Math.floor(u),a=this._node.bezier1.calc(u),this._node.type==t.ParticleValueType.TwoBezier){var m=Math.random();a*=m,a+=this._node.bezier2.calc(u)*(1-m)}}else a=o[_];this.rotationMat.identity(),f==t.ParticleRenderModeType.VerticalBillboard||f==t.ParticleRenderModeType.HorizontalBillboard?this.rotationMat.rotation(0,a,0):this.rotationMat.rotation(0,0,a);for(var v=0;s>v;++v)h=_*s+v,h*=e.vertexAttLength,l.x=e.verticesData[h+0],l.y=e.verticesData[h+1],l.z=e.verticesData[h+2],this.rotationMat.transformVector4(l,l),e.verticesData[h+0]=l.x,e.verticesData[h+1]=l.y,e.verticesData[h+2]=l.z}},i}(t.AnimationNode);t.ParticleRotation=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleScale"}return __extends(i,e),i.prototype.initNode=function(e){var i=this._node=e;this._scale=new t.ConstRandomValueShape,this._scale.max=i.max,this._scale.min=i.min},i.prototype.build=function(e,i){this._animationState=this.state;for(var a,r,n=this._scale.calculate(i),o=e.vertexCount/i,s=0,h=0,l=this._animationState.emitter.data.life.duration,u=this._animationState.emitter.timeNode.offsetIndex,c=0,d=0,p=0;i>p;++p){if(this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(a=c*e.vertexAttLength+u,r=e.verticesData[a+0],h=r/l,h-=Math.floor(h),d=this._node.bezier1.calc(h),this._node.type==t.ParticleValueType.TwoBezier){var f=Math.random();d*=f,d+=this._node.bezier2.calc(h)*(1-f)}}else d=n[p];for(var _=0;o>_;++_)s=p*o+_,s*=e.vertexAttLength,e.verticesData[s+0]*=d,e.verticesData[s+1]*=d,e.verticesData[s+2]*=d}},i}(t.AnimationNode);t.ParticleScale=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.bornTime=0,this.life=0,this.id=0,this.timeIndex=0,this.name="ParticleStartColor"}return __extends(i,e),i.prototype.initNode=function(t){this._node=t},i.prototype.build=function(e,i){this.particleAnimationState=this.state;for(var a=3,r=e.vertexCount/i,n=0,o=this.particleAnimationState.emitter.timeNode.offsetIndex,s=0,h=new t.Color,l=new t.Color,u=0,c=this.particleAnimationState.emitter.data.life.duration,d=0;i>d;++d){s=d*r,this.timeIndex=s*e.vertexAttLength+o,this.bornTime=e.verticesData[this.timeIndex+0],u=this.bornTime/c,u-=Math.floor(u),this.lerpBirthColor(h,l,u),h.a/=256,h.r/=256,h.g/=256,h.b/=256,this.processTintColor(h,this._node.tintColor);for(var p=0;r>p;++p)n=d*r+p,n=n*e.vertexAttLength+a,e.verticesData[n+0]=h.r,e.verticesData[n+1]=h.g,e.verticesData[n+2]=h.b,e.verticesData[n+3]=h.a}},i.prototype.processTintColor=function(t,e){t.a*=e.a/128,t.r*=e.r/128,t.g*=e.g/128,t.b*=e.b/128},i.prototype.lerpBirthColor=function(e,i,a){this._node.colorType==t.ParticleBirthColorType.Const?e.copyFrom(this._node.colorConst1):this._node.colorType==t.ParticleBirthColorType.RandomConst?e.randomColor(this._node.colorConst1,this._node.colorConst2,!0):this._node.colorType==t.ParticleBirthColorType.OneGradients?this._node.colorGradients1.lerpColor(a,e):this._node.colorType==t.ParticleBirthColorType.TwoGradients&&(this._node.colorGradients1.lerpColor(a,e),this._node.colorGradients2.lerpColor(a,i),e.lerp(e,i,.5))},i}(t.AnimationNode);t.ParticleStartColor=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.count=0,this._followRotation=!1,this._followScale=!1,this.bornTime=0,this.life=0,this.id=0,this.timeIndex=0,this.geometryDirty=!1,this.name="ParticleFollowNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_follow_vs"),this.attribute_followPosition=new t.GLSL.VarRegister,this.attribute_followPosition.name="attribute_followPosition",this.attribute_followPosition.size=3,this.attributes.push(this.attribute_followPosition),this.attribute_followRotation=new t.GLSL.VarRegister,this.attribute_followRotation.name="attribute_followRotation",this.attribute_followRotation.size=4,this.attributes.push(this.attribute_followRotation),this.attribute_followScale=new t.GLSL.VarRegister,this.attribute_followScale.name="attribute_followScale",this.attribute_followScale.size=3,this.attributes.push(this.attribute_followScale)}return __extends(i,e),i.prototype.initNode=function(t){var e=t;this._followScale=e.followScale,this._followRotation=e.followRotation},i.prototype.build=function(t,e){this.count=e,this.particleAnimationState=this.state,this.lifeCircles=[];for(var i=0;i<this.count;i++)this.lifeCircles[i]=-1},i.prototype.update=function(t,e,i){this.geometryDirty=this.geometryDirty;var a=this.particleAnimationState.emitter.data.life.loop,r=this.particleAnimationState.loopTime+this.particleAnimationState.emitter.data.life.duration;if(a||!(.001*t>=r)){for(var n=0,o=i.vertexCount/this.count,s=0,h=!1,l=this.particleAnimationState.emitter.timeNode.offsetIndex,u=.001*t-this.particleAnimationState.emitter.data.life.delay,c=i.sharedVertexBuffer?i.sharedVertexBuffer.arrayBuffer:i.verticesData,d=this.particleAnimationState.followTarget||this.particleAnimationState.emitter,p=0;p<this.count;++p){s=p*o,this.timeIndex=s*i.vertexAttLength+l,this.bornTime=c[this.timeIndex+0],this.life=c[this.timeIndex+1];var f=-1;if(u>=this.bornTime){if(u>this.bornTime+this.life&&!a)continue;if(f=Math.floor((u-this.bornTime)/this.particleAnimationState.loopTime),f!=this.lifeCircles[p]){this.lifeCircles[p]=f,h=!0;for(var _=0;o>_;++_)n=s+_,n=n*i.vertexAttLength+this.attribute_followPosition.offsetIndex,c[n+0]=d.globalPosition.x,c[n+1]=d.globalPosition.y,c[n+2]=d.globalPosition.z,n=s+_,n=n*i.vertexAttLength+this.attribute_followRotation.offsetIndex,this._followRotation?(c[n+0]=d.globalOrientation.x,c[n+1]=d.globalOrientation.y,c[n+2]=d.globalOrientation.z,c[n+3]=d.globalOrientation.w):(c[n+0]=0,c[n+1]=0,c[n+2]=0,c[n+3]=0),n=s+_,n=n*i.vertexAttLength+this.attribute_followScale.offsetIndex,this._followScale?(c[n+0]=d.globalScaleX,c[n+1]=d.globalScaleY,c[n+2]=d.globalScaleZ):(c[n+0]=0,c[n+1]=0,c[n+2]=0)
}}}this.geometryDirty=h}},i.prototype.activeState=function(t,e,i,a,r,n,o){this.geometryDirty&&(n.geometry.upload(o),this.geometryDirty=!1)},i}(t.AnimationNode);t.ParticleFollowNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocity"),this.attribute_velocity=new t.GLSL.VarRegister,this.attribute_velocity.name="attribute_velocity",this.attribute_velocity.size=3,this.attributes.push(this.attribute_velocity)}return __extends(i,e),i.prototype.initNode=function(e){var i=this._node=e;(i.type==t.ParticleValueType.Const||i.type==t.ParticleValueType.RandomConst)&&(this._velocityConstShape=new t.ConstRandomValueShape,this._velocityConstShape.max=i.max,this._velocityConstShape.min=i.min)},i.prototype.build=function(e,i){this._animationState=this.state;for(var a,r,n,o=e.vertexCount/i,s=0,h=this._velocityConstShape.calculate(i),l=this._animationState.directionArray,u=new t.Vector3D,c=0,d=this._animationState.emitter.data.life.duration,p=this._animationState.emitter.timeNode.offsetIndex,f=0,_=0;i>_;++_){if(f=_*o,this._node.type==t.ParticleValueType.OneBezier||this._node.type==t.ParticleValueType.TwoBezier){if(a=f*e.vertexAttLength+p,r=e.verticesData[a+0],c=r/d,c-=Math.floor(c),n=this._node.bezier1.calc(c),this._node.type==t.ParticleValueType.TwoBezier){var m=Math.random();n*=m,n+=this._node.bezier2.calc(c)*(1-m)}}else n=h[_];u.copyFrom(l[_]),u.scaleBy(n);for(var v=0;o>v;++v)s=_*o+v,s=s*e.vertexAttLength+this.attribute_velocity.offsetIndex,e.verticesData[s+0]=u.x,e.verticesData[s+1]=u.y,e.verticesData[s+2]=u.z}},i}(t.AnimationNode);t.ParticleVelocityNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._colorSegment=new Float32Array(2*i.MaxColor),this.name="ParticleColorGlobalNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_color_vs"),this.fragment_ShaderName[t.ShaderPhaseType.multi_end_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.multi_end_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.multi_end_fragment].push("particle_color_fs")}return __extends(i,e),i.prototype.initNode=function(t){var e=t,a=i.MaxColor,r=e.data;r.colors.length=r.times.length=a;for(var n,o=0;a>o;o++)n=r.colors[o],n?(this._colorSegment[o]=this.getGpuColor(n.r,n.g,n.b),this._colorSegment[o+a]=this.getTimeAndAlpha(r.times[o],n.a)):(this._colorSegment[o]=0,this._colorSegment[o+a]=0)},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_colorTransform.uniformIndex,this._colorSegment)},i.prototype.getGpuColor=function(t,e,i){t=this.normalizeChannel(t),e=this.normalizeChannel(e),i=this.normalizeChannel(i);var a=256*t+e+i/256;return a},i.prototype.normalizeChannel=function(t){return t>255?t=255:0>t&&(t=0),t=Math.floor(t)},i.prototype.normalizeTime=function(t){return t>=1?t=.9999:0>t&&(t=0),t},i.prototype.getTimeAndAlpha=function(t,e){return e=this.normalizeChannel(e),t=this.normalizeTime(t),e+t},i.MaxColor=20,i}(t.AnimationNode);t.ParticleColorGlobalNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleSizeGlobalNode",this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push("particle_size_vs")}return __extends(i,e),i.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.data.sampler()},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_bezierSize.uniformIndex,this._floatCompressData)},i}(t.AnimationNode);t.ParticleSizeGlobalNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityOverConstNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverConst"),this.attribute_velocityOver=new t.GLSL.VarRegister,this.attribute_velocityOver.name="attribute_velocityOverConst",this.attribute_velocityOver.size=3,this.attributes.push(this.attribute_velocityOver)}return __extends(i,e),i.prototype.initNode=function(e){var i=e;this._velocityOverShape=new t.Vec3ConstRandomValueShape,this._velocityOverShape.maxX=i.velocityOver.max.x,this._velocityOverShape.maxY=i.velocityOver.max.y,this._velocityOverShape.maxZ=i.velocityOver.max.z,this._velocityOverShape.minX=i.velocityOver.min.x,this._velocityOverShape.minY=i.velocityOver.min.y,this._velocityOverShape.minZ=i.velocityOver.min.z},i.prototype.build=function(t,e){this.particleAnimationState=this.state;for(var i=t.vertexCount/e,a=0,r=this._velocityOverShape.calculate(e),n=0;e>n;++n)for(var o=r[n],s=0;i>s;++s)a=n*i+s,a=a*t.vertexAttLength+this.attribute_velocityOver.offsetIndex,t.verticesData[a+0]=o.x,t.verticesData[a+1]=o.y,t.verticesData[a+2]=o.z},i}(t.AnimationNode);t.ParticleVelocityOverConstNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityOverOneBezierNode"}return __extends(i,e),i.prototype.initNode=function(e){this._node=e,this._floatCompressDataX=this._node.velocityOver.xBezier1.trySampler(),this._floatCompressDataY=this._node.velocityOver.yBezier1.trySampler(),this._floatCompressDataZ=this._node.velocityOver.zBezier1.trySampler(),this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverOneBezier"),this._floatCompressDataX&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverOneBezierX"),this._floatCompressDataY&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverOneBezierY"),this._floatCompressDataZ&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverOneBezierZ")},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){this._floatCompressDataX&&o.uniform1fv(r.uniform_velocityOverX.uniformIndex,this._floatCompressDataX),this._floatCompressDataY&&o.uniform1fv(r.uniform_velocityOverY.uniformIndex,this._floatCompressDataY),this._floatCompressDataZ&&o.uniform1fv(r.uniform_velocityOverZ.uniformIndex,this._floatCompressDataZ)},i}(t.AnimationNode);t.ParticleVelocityOverOneBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityOverTwoBezierNode",this.attribute_randomSeed=new t.GLSL.VarRegister,this.attribute_randomSeed.name="attribute_velocityOverRandomSeed",this.attribute_randomSeed.size=1,this.attributes.push(this.attribute_randomSeed)}return __extends(i,e),i.prototype.initNode=function(e){this._node=e,this._floatCompressDataX1=this._node.velocityOver.xBezier1.trySampler(),this._floatCompressDataY1=this._node.velocityOver.yBezier1.trySampler(),this._floatCompressDataZ1=this._node.velocityOver.zBezier1.trySampler(),this._floatCompressDataX2=this._node.velocityOver.xBezier2.trySampler(),this._floatCompressDataY2=this._node.velocityOver.yBezier2.trySampler(),this._floatCompressDataZ2=this._node.velocityOver.zBezier2.trySampler(),this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezier"),this._floatCompressDataX1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierX1"),this._floatCompressDataX2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierX2"),this._floatCompressDataY1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierY1"),this._floatCompressDataY2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierY2"),this._floatCompressDataZ1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierZ1"),this._floatCompressDataZ2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityOverTwoBezierZ2")},i.prototype.build=function(t,e){this._animationState=this.state;for(var i=t.vertexCount/e,a=0,r=0;e>r;++r)for(var n=Math.random(),o=0;i>o;++o)a=r*i+o,a=a*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.verticesData[a+0]=n},i.prototype.activeState=function(t,e,i,a,r,n,o){this._floatCompressDataX1&&o.uniform1fv(r.uniform_velocityOverX1.uniformIndex,this._floatCompressDataX1),this._floatCompressDataX2&&o.uniform1fv(r.uniform_velocityOverX2.uniformIndex,this._floatCompressDataX2),this._floatCompressDataY1&&o.uniform1fv(r.uniform_velocityOverY1.uniformIndex,this._floatCompressDataY1),this._floatCompressDataY2&&o.uniform1fv(r.uniform_velocityOverY2.uniformIndex,this._floatCompressDataY2),this._floatCompressDataZ1&&o.uniform1fv(r.uniform_velocityOverZ1.uniformIndex,this._floatCompressDataZ1),this._floatCompressDataZ2&&o.uniform1fv(r.uniform_velocityOverZ2.uniformIndex,this._floatCompressDataZ2)},i}(t.AnimationNode);t.ParticleVelocityOverTwoBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityForceConstNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceConst"),this.attribute_accelerationSpeed=new t.GLSL.VarRegister,this.attribute_accelerationSpeed.name="attribute_velocityForceConst",this.attribute_accelerationSpeed.size=3,this.attributes.push(this.attribute_accelerationSpeed)}return __extends(i,e),i.prototype.initNode=function(e){this._node=e;var i=this._node.velocityForce;this._forceData=new t.Vec3ConstRandomValueShape,this._forceData.maxX=i.max.x,this._forceData.maxY=i.max.y,this._forceData.maxZ=i.max.z,this._forceData.minX=i.min.x,this._forceData.minY=i.min.y,this._forceData.minZ=i.min.z},i.prototype.build=function(t,e){for(var i=t.vertexCount/e,a=0,r=this._forceData.calculate(e),n=0;e>n;++n)for(var o=r[n],s=0;i>s;++s)a=n*i+s,a=a*t.vertexAttLength+this.attribute_accelerationSpeed.offsetIndex,t.verticesData[a+0]=o.x,t.verticesData[a+1]=o.y,t.verticesData[a+2]=o.z},i}(t.AnimationNode);t.ParticleVelocityForceConstNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityForceOneBezierNode"}return __extends(i,e),i.prototype.initNode=function(e){this._node=e,this._floatCompressDataX=this._node.velocityForce.xBezier1.trySampler(),this._floatCompressDataY=this._node.velocityForce.yBezier1.trySampler(),this._floatCompressDataZ=this._node.velocityForce.zBezier1.trySampler(),this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceOneBezier"),this._floatCompressDataX&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceOneBezierX"),this._floatCompressDataY&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceOneBezierY"),this._floatCompressDataZ&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceOneBezierZ")},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){this._floatCompressDataX&&o.uniform1fv(r.uniform_velocityForceX.uniformIndex,this._floatCompressDataX),this._floatCompressDataY&&o.uniform1fv(r.uniform_velocityForceY.uniformIndex,this._floatCompressDataY),this._floatCompressDataZ&&o.uniform1fv(r.uniform_velocityForceZ.uniformIndex,this._floatCompressDataZ)},i}(t.AnimationNode);t.ParticleVelocityForceOneBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityForceTwoBezierNode",this.attribute_randomSeed=new t.GLSL.VarRegister,this.attribute_randomSeed.name="attribute_velocityForceRandomSeed",this.attribute_randomSeed.size=1,this.attributes.push(this.attribute_randomSeed)}return __extends(i,e),i.prototype.initNode=function(e){this._node=e,this._floatCompressDataX1=this._node.velocityForce.xBezier1.trySampler(),this._floatCompressDataY1=this._node.velocityForce.yBezier1.trySampler(),this._floatCompressDataZ1=this._node.velocityForce.zBezier1.trySampler(),this._floatCompressDataX2=this._node.velocityForce.xBezier2.trySampler(),this._floatCompressDataY2=this._node.velocityForce.yBezier2.trySampler(),this._floatCompressDataZ2=this._node.velocityForce.zBezier2.trySampler(),this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezier"),this._floatCompressDataX1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierX1"),this._floatCompressDataX2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierX2"),this._floatCompressDataY1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierY1"),this._floatCompressDataY2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierY2"),this._floatCompressDataZ1&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierZ1"),this._floatCompressDataZ2&&this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityForceTwoBezierZ2")},i.prototype.build=function(t,e){this._animationState=this.state;for(var i=t.vertexCount/e,a=0,r=0;e>r;++r)for(var n=Math.random(),o=0;i>o;++o)a=r*i+o,a=a*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.verticesData[a+0]=n},i.prototype.activeState=function(t,e,i,a,r,n,o){this._floatCompressDataX1&&o.uniform1fv(r.uniform_velocityForceX1.uniformIndex,this._floatCompressDataX1),this._floatCompressDataX2&&o.uniform1fv(r.uniform_velocityForceX2.uniformIndex,this._floatCompressDataX2),this._floatCompressDataY1&&o.uniform1fv(r.uniform_velocityForceY1.uniformIndex,this._floatCompressDataY1),this._floatCompressDataY2&&o.uniform1fv(r.uniform_velocityForceY2.uniformIndex,this._floatCompressDataY2),this._floatCompressDataZ1&&o.uniform1fv(r.uniform_velocityForceZ1.uniformIndex,this._floatCompressDataZ1),this._floatCompressDataZ2&&o.uniform1fv(r.uniform_velocityForceZ2.uniformIndex,this._floatCompressDataZ2)},i}(t.AnimationNode);t.ParticleVelocityForceTwoBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityLimitConstNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityLimitConst"),this.attribute_velocityLimit=new t.GLSL.VarRegister,this.attribute_velocityLimit.name="attribute_velocityLimit",this.attribute_velocityLimit.size=1,this.attributes.push(this.attribute_velocityLimit)}return __extends(i,e),i.prototype.initNode=function(e){var i=e;this._velocityLimitShape=new t.ConstRandomValueShape,this._velocityLimitShape.max=i.velocityLimit.max,this._velocityLimitShape.min=i.velocityLimit.min},i.prototype.build=function(t,e){this._animationState=this.state;for(var i=t.vertexCount/e,a=0,r=this._velocityLimitShape.calculate(e),n=0;e>n;++n)for(var o=r[n],s=0;i>s;++s)a=n*i+s,a=a*t.vertexAttLength+this.attribute_velocityLimit.offsetIndex,t.verticesData[a+0]=o},i}(t.AnimationNode);t.ParticleVelocityLimitConstNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityLimitOneBezierNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityLimitOneBezier")}return __extends(i,e),i.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.velocityLimit.bezier1.sampler()},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_velocityLimit.uniformIndex,this._floatCompressData)},i}(t.AnimationNode);t.ParticleVelocityLimitOneBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleVelocityLimitTwoBezierNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_velocityLimitTwoBezier"),this.attribute_randomSeed=new t.GLSL.VarRegister,this.attribute_randomSeed.name="attribute_velocityLimitRandomSeed",this.attribute_randomSeed.size=1,this.attributes.push(this.attribute_randomSeed)}return __extends(i,e),i.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.velocityLimit.bezier1.sampler(),this._floatCompressData2=this._node.velocityLimit.bezier2.sampler()},i.prototype.build=function(t,e){this._animationState=this.state;for(var i=t.vertexCount/e,a=0,r=0;e>r;++r)for(var n=Math.random(),o=0;i>o;++o)a=r*i+o,a=a*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.verticesData[a+0]=n},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_velocityLimit.uniformIndex,this._floatCompressData),o.uniform1fv(r.uniform_velocityLimit2.uniformIndex,this._floatCompressData2)},i}(t.AnimationNode);t.ParticleVelocityLimitTwoBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleRotationConstNode",this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push("particle_rotationConst"),this.attribute_Rotation=new t.GLSL.VarRegister,this.attribute_Rotation.name="attribute_rotationZ",this.attribute_Rotation.size=1,this.attributes.push(this.attribute_Rotation)}return __extends(i,e),i.prototype.initNode=function(e){var i=e;this._rotation=new t.ConstRandomValueShape,this._rotation.max=i.max.z,this._rotation.min=i.min.z},i.prototype.build=function(t,e){for(var i=0,a=t.vertexCount/e,r=this._rotation.calculate(e),n=0;e>n;++n)for(var o=r[n],s=0;a>s;++s)i=n*a+s,i=i*t.vertexAttLength+this.attribute_Rotation.offsetIndex,t.verticesData[i+0]=o},i}(t.AnimationNode);t.ParticleRotationConstNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleRotationOneBezierNode",this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_rotationOneBezier")}return __extends(i,e),i.prototype.initNode=function(t){this._node=t,this._floatCompressData=this._node.bezier1.sampler()},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_rotationBezier.uniformIndex,this._floatCompressData)},i}(t.AnimationNode);t.ParticleRotationOneBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.name="ParticleRotationTwoBezierNode",this.attribute_randomSeed=new t.GLSL.VarRegister,this.attribute_randomSeed.name="attribute_rotationRandomSeed",this.attribute_randomSeed.size=1,this.attributes.push(this.attribute_randomSeed)}return __extends(i,e),i.prototype.initNode=function(e){this._node=e,this._floatCompressData=this._node.bezier1.sampler(),this._floatCompressData2=this._node.bezier2.sampler(),this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.global_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.global_vertex].push("particle_rotationTwoBezier")},i.prototype.build=function(t,e){this._animationState=this.state;for(var i=t.vertexCount/e,a=0,r=0;e>r;++r)for(var n=Math.random(),o=0;i>o;++o)a=r*i+o,a=a*t.vertexAttLength+this.attribute_randomSeed.offsetIndex,t.verticesData[a+0]=n},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_rotationBezier.uniformIndex,this._floatCompressData),o.uniform1fv(r.uniform_rotationBezier2.uniformIndex,this._floatCompressData2)},i}(t.AnimationNode);t.ParticleRotationTwoBezierNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._sheetFloatData=new Float32Array(5),this.name="ParticleTextureSheetNode",this.attribute_textureSheetData=new t.GLSL.VarRegister,this.attribute_textureSheetData.name="attribute_textureSheetData",this.attribute_textureSheetData.size=3,this.attributes.push(this.attribute_textureSheetData),this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]=this.vertex_ShaderName[t.ShaderPhaseType.local_vertex]||[],this.vertex_ShaderName[t.ShaderPhaseType.local_vertex].push("particle_textureSheet_vs")}return __extends(i,e),i.prototype.initNode=function(e,i){this._sheetData=i,this._sheetFloatData[0]=this._sheetData.tileX,this._sheetFloatData[1]=this._sheetData.tileY,this._sheetFloatData[2]=this._sheetData.circles,this._sheetData.whole?(this._sheetFloatData[3]=0,this._sheetFloatData[4]=this._sheetData.tileX*this._sheetData.tileY-1):(this._sheetFloatData[3]=0,this._sheetFloatData[4]=this._sheetData.tileY-1),this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst?(this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_textureSheetConst")):this._sheetData.frameType==t.ParticleValueType.OneBezier?(this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_bezier"),this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_textureSheetOneBezier"),this._floatCompressData1=this._sheetData.bezier1.sampler()):this._sheetData.frameType==t.ParticleValueType.TwoBezier&&(this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_bezier"),this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_textureSheetTwoBezier"),this._floatCompressData1=this._sheetData.bezier1.sampler(),this._floatCompressData2=this._sheetData.bezier2.sampler())},i.prototype.build=function(e,i){for(var a=0,r=0,n=0,o=0,s=e.vertexCount/i,h=0;i>h;++h){a=this._sheetData.whole?0:this._sheetData.randomRow?Math.floor(this._sheetData.tileY*Math.random())*this._sheetData.tileX:this._sheetData.row*this._sheetData.tileX,this._sheetData.frameType==t.ParticleValueType.Const||this._sheetData.frameType==t.ParticleValueType.RandomConst?(r=(this._sheetData.max-this._sheetData.min)*Math.random()+this._sheetData.min,r=Math.floor(r)):r=0,n=this._sheetData.frameType==t.ParticleValueType.TwoBezier?Math.random():1;for(var l=0;s>l;++l)o=h*s+l,o=o*e.vertexAttLength+this.attribute_textureSheetData.offsetIndex,e.verticesData[o+0]=a+.001,e.verticesData[o+1]=r,e.verticesData[o+2]=n}},i.prototype.activeState=function(e,i,a,r,n,o,s){s.uniform1fv(n.uniform_textureSheet.uniformIndex,this._sheetFloatData),this._sheetData.frameType==t.ParticleValueType.OneBezier?s.uniform1fv(n.uniform_frameBezier.uniformIndex,this._floatCompressData1):this._sheetData.frameType==t.ParticleValueType.TwoBezier&&(s.uniform1fv(n.uniform_frameBezier1.uniformIndex,this._floatCompressData1),s.uniform1fv(n.uniform_frameBezier2.uniformIndex,this._floatCompressData2))},i}(t.AnimationNode);t.ParticleTextureSheetNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this._uvRollData=new Float32Array(2),this.name="ParticleUVRollNode",this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]=this.fragment_ShaderName[t.ShaderPhaseType.start_fragment]||[],this.fragment_ShaderName[t.ShaderPhaseType.start_fragment].push("particle_uv_roll_fs")}return __extends(i,e),i.prototype.initNode=function(t,e){this._methodData=e,this._uvRollData[0]=this._methodData.uSpeed,this._uvRollData[1]=this._methodData.vSpeed},i.prototype.build=function(t,e){},i.prototype.activeState=function(t,e,i,a,r,n,o){o.uniform1fv(r.uniform_particleUVRoll.uniformIndex,this._uvRollData)},i}(t.AnimationNode);t.ParticleUVRollNode=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function a(){e.call(this),this._empty=!0,this.bornTime=0,this.life=0,this.id=0,this.timeIndex=0,this.count=0,this.position=new t.Vector3D,this._added=!1,this._orientation=new t.Quaternion,this._birthPhase=new i(t.ParticleDataSubEmitterPhase.BIRTH),this._collisionPhase=new i(t.ParticleDataSubEmitterPhase.COLLISION),this._deathPhase=new i(t.ParticleDataSubEmitterPhase.DEATH),this.name="ParticleSubEmitterNode"}return __extends(a,e),a.prototype.initNode=function(t,e){void 0===e&&(e=null),this._parent=e},a.prototype.importSubEmitter=function(e,i){var a;e==t.ParticleDataSubEmitterPhase.BIRTH?a=this._birthPhase:e==t.ParticleDataSubEmitterPhase.COLLISION?a=this._collisionPhase:e==t.ParticleDataSubEmitterPhase.DEATH&&(a=this._deathPhase),a&&(this._empty=!1,a.importSubEmitter(i))},a.prototype.build=function(t,e){this.count=e,this._animationState=this.state,this._lifeCircles=[];for(var i=0;i<this.count;i++)this._lifeCircles[i]=-1},a.prototype.update=function(t,e,i){if(!this._empty){this.recycleParticle();var a=this._animationState.emitter.data.life.loop,r=this._animationState.loopTime+this._animationState.emitter.data.life.duration;if(a||!(.001*t>=r))for(var n=0,o=i.vertexCount/this.count,s=0,h=this._animationState.emitter.positionNode.offsetIndex,l=this._animationState.emitter.timeNode.offsetIndex,u=.001*t-this._animationState.emitter.data.life.delay,c=i.sharedVertexBuffer?i.sharedVertexBuffer.arrayBuffer:i.verticesData,d=(this._animationState.followTarget||this._animationState.emitter,0);d<this.count;++d){s=d*o,this.timeIndex=s*i.vertexAttLength+l,this.bornTime=c[this.timeIndex+0],this.life=c[this.timeIndex+1];var p=-1;if(u>=this.bornTime){if(u>this.bornTime+this.life&&!a)continue;p=Math.floor((u-this.bornTime)/this._animationState.loopTime),p!=this._lifeCircles[d]&&(n=s*i.vertexAttLength+h,this._lifeCircles[d]=p,this.position.x=c[n+0],this.position.y=c[n+1],this.position.z=c[n+2],this.emitParticleAtPhase(this._birthPhase,this.position))}}}},a.prototype.emitParticleAtPhase=function(e,i){var a,r,n,o,s=e.playing.getKeys();this._orientation.copyFrom(this._parent.orientation),this._orientation.w*=-1;for(var h=0,l=s.length;l>h;h++)a=s[h],n=e.recycle.getValueByKey(a),r=e.playing.getValueByKey(a),o=n.shift(),null==o&&(o=new t.ParticleEmitter(a.data,a.material)),r.push(o),o.play(),o.position=i,o.orientation=this._orientation,this._parent.addChild(o)},a.prototype.recycleParticle=function(){this.recycleParticleAtPhase(this._birthPhase),this.recycleParticleAtPhase(this._collisionPhase),this.recycleParticleAtPhase(this._deathPhase)},a.prototype.recycleParticleAtPhase=function(t){for(var e,i,a,r,n,o=t.playing.getKeys(),s=0,h=o.length;h>s;s++)for(e=o[s],i=t.playing.getValueByKey(e),a=t.recycle.getValueByKey(e),n=i.length-1;n>=0;n--)r=i[n],r.loopProgress>1&&(i.splice(n,1),r.stop(),this._parent.removeChild(r),a.push(r))},a.prototype.activeState=function(t,e,i,a,r,n,o){},a}(t.AnimationNode);t.ParticleSubEmitterNode=e;var i=function(){function e(e){this.playing=new t.DoubleArray,this.recycle=new t.DoubleArray}return e.prototype.importSubEmitter=function(t){this.playing.getKeys().indexOf(t)>=0||(this.playing.put(t,[]),this.recycle.put(t,[]))},e}();t.ParticleSubEmitterNodePhase=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){this.numberOfVertices=0,this.vertexSizeInBytes=0,this.vertex_shaders={},this.fragment_shaders={},this.loopTime=0,this.circleTime=0,this.reverse=1,this.followTarget=null,this._particleProperty=new Float32Array(22),this._particleFsData=new Float32Array(3),this._emitter=e,this.name=t,this.animNodes=[],this.keyFrames=[]}return Object.defineProperty(t.prototype,"emitter",{get:function(){return this._emitter},enumerable:!0,configurable:!0}),t.prototype.addNode=function(t){t.state=this,this.animNodes.push(t)},t.prototype.removeNode=function(t){var e=this.animNodes.indexOf(t);-1!=e&&this.animNodes.splice(e,1)},t.prototype.clean=function(){this.animNodes.length=0},t.prototype.addShaderPhase=function(t,e){var i,a;for(a in t){i=t[a];for(var r=0;r<i.length;r++)e[a]=e[a]||[],e[a].push(i[r])}},t.prototype.calculate=function(t){for(var e=0;e<this.animNodes.length;e++){this.addShaderPhase(this.animNodes[e].vertex_ShaderName,this.vertex_shaders),this.addShaderPhase(this.animNodes[e].fragment_ShaderName,this.fragment_shaders);for(var i=t.vertexAttLength,a=0;a<this.animNodes[e].attributes.length;++a)this.animNodes[e].attributes[a].size>0&&(this.animNodes[e].attributes[a].offsetIndex=i,t.vertexAttLength+=this.animNodes[e].attributes[a].size,t.vertexSizeInBytes+=4*this.animNodes[e].attributes[a].size,t.subGeometrys[0].preAttList.push(this.animNodes[e].attributes[a])),i=t.vertexAttLength}},t.prototype.fill=function(t,e){for(var i=0;i<this.animNodes.length;i++)this.animNodes[i].build(t,e)},t.prototype.update=function(t,e,i){for(var a=0;a<this.animNodes.length;a++)this.animNodes[a].update(t,e,i)},t.prototype.activeState=function(t,e,i,a,r,n,o,s){var h,l,u=this._emitter.data;u.followTarget&&this._emitter.followTarget?(h=this._emitter.followTarget.globalOrientation,l=this._emitter.followTarget.globalPosition):(h=this._emitter.globalOrientation,l=this._emitter.globalPosition),this._particleProperty[0]=.001*e,this._particleProperty[1]=u.life.loop?1:0,this._particleProperty[2]=u.followTarget?1:0,this._particleProperty[3]=1,this._particleProperty[4]=1,this._particleProperty[5]=1,this._particleProperty[6]=h.x,this._particleProperty[7]=h.y,this._particleProperty[8]=h.z,this._particleProperty[9]=h.w,this._particleProperty[10]=l.x,this._particleProperty[11]=l.y,this._particleProperty[12]=l.z,this._particleProperty[13]=this.loopTime,this._particleProperty[14]=u.life.delay,this._particleProperty[15]=u.life.duration,this._particleProperty[16]=u.property.gravity,this._particleProperty[17]=u.moveSpeed.velocityOver&&u.moveSpeed.velocityOver.worldSpace?1:0,this._particleProperty[18]=u.moveSpeed.velocityForce&&u.moveSpeed.velocityForce.worldSpace?1:0,this._particleProperty[19]=u.property.cameraScale,this._particleProperty[20]=u.property.speedScale,this._particleProperty[21]=u.property.lengthScale,o.uniform1fv(r.uniform_particleState.uniformIndex,this._particleProperty),this._particleFsData[0]=s.far,this._particleFsData[1]=s.near,this._particleFsData[2]=this._emitter.material.materialData.blendMode,o.uniform1fv(r.uniform_particleFsData.uniformIndex,this._particleFsData);for(var c=0;c<this.animNodes.length;c++)this.animNodes[c].activeState(t,e,i,a,r,n,o)},t}();t.ParticleAnimationState=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){e.call(this),this.animTime=0,this.delay=0,this.speed=1,this._play=!1,this.animStates=[],this.particleAnimationState=new t.ParticleAnimationState("particle",i),this.addAnimState(this.particleAnimationState)}return __extends(i,e),i.prototype.update=function(t,e,i){this._play&&(this.delay=e,this.animTime+=this.delay,this.particleAnimationState&&this.particleAnimationState.update(this.animTime,this.delay,i))
},i.prototype.activeState=function(t,e,i,a,r,n,o){this.particleAnimationState&&this.particleAnimationState.activeState(t,this.animTime,e,this.delay,i,a,r,o)},i.prototype.play=function(t,e,i,a){void 0===e&&(e=1),void 0===i&&(i=!0),void 0===a&&(a=!0),this._play=!0,i&&(this.animTime=0),a&&(this.animTime=this.particleAnimationState.loopTime),this.delay=0},i.prototype.stop=function(){this._play=!1},i.prototype.isPlay=function(){return this._play},i.prototype.addAnimState=function(t){var e=this.animStates.indexOf(t);-1==e&&this.animStates.push(t)},i.prototype.removeAnimState=function(t){var e=this.animStates.indexOf(t);-1!=e&&this.animStates.splice(e,1)},i.prototype.getAnimList=function(){return[]},i.prototype.getAnimNode=function(){return[]},i.prototype.clone=function(){return null},i}(t.EventDispatcher);t.ParticleAnimation=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.Property=0]="Property",t[t.Emission=1]="Emission",t[t.Life=2]="Life",t[t.Shape=3]="Shape",t[t.RotationBirth=4]="RotationBirth",t[t.ScaleBirth=5]="ScaleBirth",t[t.Geometry=6]="Geometry",t[t.MoveSpeed=7]="MoveSpeed",t[t.FollowTarget=8]="FollowTarget",t[t.ScaleBezier=9]="ScaleBezier",t[t.RotationSpeed=10]="RotationSpeed",t[t.ColorOffset=11]="ColorOffset",t[t.TextureSheet=12]="TextureSheet"}(t.ParticleDataNodeType||(t.ParticleDataNodeType={}));var e=t.ParticleDataNodeType;!function(t){t[t.BIRTH=0]="BIRTH",t[t.COLLISION=1]="COLLISION",t[t.DEATH=2]="DEATH"}(t.ParticleDataSubEmitterPhase||(t.ParticleDataSubEmitterPhase={}));t.ParticleDataSubEmitterPhase;!function(t){t[t.Const=0]="Const",t[t.RandomConst=1]="RandomConst",t[t.OneBezier=2]="OneBezier",t[t.TwoBezier=3]="TwoBezier"}(t.ParticleValueType||(t.ParticleValueType={}));var i=t.ParticleValueType;!function(t){t[t.Billboard=0]="Billboard",t[t.StretchedBillboard=1]="StretchedBillboard",t[t.HorizontalBillboard=2]="HorizontalBillboard",t[t.VerticalBillboard=3]="VerticalBillboard",t[t.Mesh=4]="Mesh"}(t.ParticleRenderModeType||(t.ParticleRenderModeType={}));var a=t.ParticleRenderModeType;!function(t){t[t.Const=0]="Const",t[t.RandomConst=1]="RandomConst",t[t.OneGradients=2]="OneGradients",t[t.TwoGradients=3]="TwoGradients"}(t.ParticleBirthColorType||(t.ParticleBirthColorType={}));var r=t.ParticleBirthColorType;!function(t){t[t.Point=0]="Point",t[t.Cube=1]="Cube",t[t.Sphere=2]="Sphere",t[t.HemiSphere=3]="HemiSphere",t[t.Cone=4]="Cone",t[t.Mesh=5]="Mesh"}(t.ParticleDataShapeType||(t.ParticleDataShapeType={}));var n=t.ParticleDataShapeType;!function(t){t[t.Vertex=0]="Vertex",t[t.Triangle=1]="Triangle",t[t.Edge=2]="Edge"}(t.ParticleMeshShapeType||(t.ParticleMeshShapeType={}));var o=t.ParticleMeshShapeType;!function(t){t[t.Base=0]="Base",t[t.BaseShell=1]="BaseShell",t[t.Volume=2]="Volume",t[t.VolumeShell=3]="VolumeShell"}(t.ParticleConeShapeType||(t.ParticleConeShapeType={}));var s=t.ParticleConeShapeType,h=function(){function t(){this.property=new u,this.emission=new c,this.life=new d,this.shape=new p,this.rotationBirth=new f,this.scaleBirth=new _,this.geometry=new m,this.moveSpeed=new v}return t.prototype.validate=function(){this.property.validate(),this.emission.validate(),this.life.validate(),this.shape.validate(),this.rotationBirth.validate(),this.scaleBirth.validate(),this.geometry.validate(),this.moveSpeed.validate(),this.scaleBezier&&this.scaleBezier.validate(),this.rotationSpeed&&this.rotationSpeed.validate(),this.colorOffset&&this.colorOffset.validate(),this.followTarget&&this.followTarget.validate(),this.textureSheet&&this.textureSheet.validate()},t.prototype.scaleBy=function(t){this.property.bounds.scaleBy(t),this.property.gravity*=t,this.property.position.scaleBy(t),this.shape.cubeW*=t,this.shape.cubeH*=t,this.shape.cubeD*=t,this.shape.sphereRadius*=t,this.shape.hemiSphereRadius*=t,this.shape.coneHeight*=t,this.shape.coneRadiusBottom*=t,this.shape.coneRadiusTop*=t,this.geometry.planeW*=t,this.geometry.planeH*=t,this.moveSpeed.max*=t,this.moveSpeed.min*=t,this.moveSpeed.bezier1&&this.moveSpeed.bezier1.scaleBy(t),this.moveSpeed.bezier2&&this.moveSpeed.bezier2.scaleBy(t),this.moveSpeed.velocityOver&&this.moveSpeed.velocityOver.scaleBy(t),this.moveSpeed.velocityLimit&&this.moveSpeed.velocityLimit.scaleBy(t),this.moveSpeed.velocityForce&&this.moveSpeed.velocityForce.scaleBy(t)},t.SCALE_VALUE=1,t}();t.ParticleData=h;var l=function(){function t(t){this._nodeType=t}return Object.defineProperty(t.prototype,"nodeType",{get:function(){return this._nodeType},enumerable:!0,configurable:!0}),t}();t.ParticleDataNode=l;var u=function(i){function n(){i.call(this,e.Property),this.particleCount=10,this.bounds=new t.Vector3D(10,10,10),this.colorType=r.Const,this.colorConst1=new t.Color(255,255,255,255),this.colorConst2=new t.Color(255,255,255,255),this.tintColor=new t.Color(128,128,128,128),this.gravity=0,this.prewarm=!1,this.rotation=new t.Vector3D(0,0,0,1),this.scale=new t.Vector3D(1,1,1,1),this.position=new t.Vector3D(0,0,0,1),this.sortingFudge=0,this.renderMode=a.Billboard,this.cameraScale=0,this.speedScale=0,this.lengthScale=1}return __extends(n,i),n.prototype.validate=function(){null==this.bounds&&(this.bounds=new t.Vector3D(10,10,10)),this.bounds.x<0&&(this.bounds.x=1),this.bounds.y<0&&(this.bounds.y=1),this.bounds.z<0&&(this.bounds.z=1),this.particleCount<0&&(this.particleCount=10),null==this.colorConst1&&(this.colorConst1=new t.Color(255,255,255,255)),null==this.colorConst2&&(this.colorConst2=new t.Color(255,255,255,255)),(this.colorType==r.OneGradients||this.colorType==r.TwoGradients)&&null==this.colorGradients1&&(this.colorGradients1=new t.ColorGradients),this.colorType==r.TwoGradients&&null==this.colorGradients2&&(this.colorGradients2=new t.ColorGradients),null==this.rotation&&(this.rotation=new t.Vector3D(0,0,0,1)),null==this.scale&&(this.scale=new t.Vector3D(1,1,1,1)),null==this.position&&(this.rotation=new t.Vector3D(0,0,0,1))},n}(l);t.ParticleDataProperty=u;var c=function(a){function r(){a.call(this,e.Emission),this.rate=10,this.type=i.Const,this.bezier=new t.BezierData}return __extends(r,a),r.prototype.validate=function(){this.rate<0&&(this.rate=1e-5),this.type==i.OneBezier&&(null==this.bezier&&(this.bezier=new t.BezierData),this.bezier.validate())},r}(l);t.ParticleDataEmission=c;var d=function(a){function r(){a.call(this,e.Life),this.type=i.Const,this.max=0,this.min=0,this.duration=5,this.delay=0,this.loop=!0}return __extends(r,a),r.prototype.validate=function(){this.max<=0&&(this.max=1),this.min>this.max&&(this.min=this.max),this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst&&this.min>this.max&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate()),this.delay<0&&(this.delay=0),this.duration<0&&(this.duration=5)},r}(l);t.ParticleDataLife=d;var p=function(t){function i(){t.call(this,e.Shape),this.type=n.Cube,this.randomDirection=!1,this.cubeW=0,this.cubeH=0,this.cubeD=0,this.sphereRadius=10,this.hemiSphereRadius=10,this.coneHeight=10,this.coneRadiusBottom=2,this.coneRadiusTop=4,this.coneType=s.Volume,this.meshType=o.Vertex}return __extends(i,t),i.prototype.validate=function(){this.type==n.Cube?(this.cubeW<0&&(this.cubeW=0),this.cubeH<0&&(this.cubeH=0),this.cubeD<0&&(this.cubeD=0)):this.type==n.Sphere&&this.sphereRadius<0&&(this.sphereRadius=10)},i}(l);t.ParticleDataShape=p;var f=function(a){function r(){a.call(this,e.RotationBirth),this.type=i.Const,this.max=0,this.min=0}return __extends(r,a),r.prototype.validate=function(){this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst&&this.min>this.max&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},r}(l);t.ParticleDataRotationBirth=f;var _=function(a){function r(){a.call(this,e.ScaleBirth),this.type=i.Const,this.max=1,this.min=1}return __extends(r,a),r.prototype.validate=function(){this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst&&this.min>this.max&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},r}(l);t.ParticleDataScaleBirth=_;var m=function(t){function i(){t.call(this,e.Geometry),this.planeW=10,this.planeH=10}return __extends(i,t),i.prototype.validate=function(){this.planeW<0&&(this.planeW=10),this.planeH<0&&(this.planeH=10)},i}(l);t.ParticleDataGeometry=m;var v=function(a){function r(){a.call(this,e.MoveSpeed),this.type=i.Const,this.max=0,this.min=0}return __extends(r,a),r.prototype.validate=function(){this.velocityOver&&this.velocityOver.validate(),this.velocityLimit&&this.velocityLimit.validate(),this.velocityForce&&this.velocityForce.validate(),this.type==i.Const&&(this.min=this.max),this.type==i.RandomConst&&this.min>this.max&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},r}(l);t.ParticleDataMoveSpeed=v;var g=function(){function e(){this.type=i.Const,this.max=0,this.min=0,this.bezier1=new t.BezierData,this.bezier2=new t.BezierData}return e.prototype.validate=function(){this.max<0&&(this.max=0),this.min>this.max&&(this.min=this.max),this.type==i.Const&&(this.min=this.max),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},e.prototype.scaleBy=function(t){this.min*=t,this.max*=t,this.bezier1&&this.bezier1.scaleBy(t),this.bezier2&&this.bezier2.scaleBy(t)},e}();t.VelocityLimitLifeTimeData=g;var y=function(){function e(){this.type=i.Const,this.max=new t.Vector3D,this.min=new t.Vector3D,this.worldSpace=!1,this.xBezier1=new t.BezierData,this.yBezier1=new t.BezierData,this.zBezier1=new t.BezierData,this.xBezier2=new t.BezierData,this.yBezier2=new t.BezierData,this.zBezier2=new t.BezierData}return e.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.xBezier1&&(this.xBezier1=new t.BezierData),null==this.yBezier1&&(this.yBezier1=new t.BezierData),null==this.zBezier1&&(this.zBezier1=new t.BezierData),this.xBezier1.validate(),this.yBezier1.validate(),this.zBezier1.validate()),this.type==i.TwoBezier&&(null==this.xBezier2&&(this.xBezier2=new t.BezierData),null==this.yBezier2&&(this.yBezier2=new t.BezierData),null==this.zBezier2&&(this.zBezier2=new t.BezierData),this.xBezier2.validate(),this.yBezier2.validate(),this.zBezier2.validate())},e.prototype.scaleBy=function(t){this.min.scaleBy(t),this.max.scaleBy(t),this.xBezier1&&this.xBezier1.scaleBy(t),this.yBezier1&&this.yBezier1.scaleBy(t),this.zBezier1&&this.zBezier1.scaleBy(t),this.xBezier2&&this.xBezier2.scaleBy(t),this.yBezier2&&this.yBezier2.scaleBy(t),this.zBezier2&&this.zBezier2.scaleBy(t)},e}();t.VelocityOverLifeTimeData=y;var x=function(){function e(){this.type=i.Const,this.max=new t.Vector3D,this.min=new t.Vector3D,this.worldSpace=!1,this.xBezier1=new t.BezierData,this.yBezier1=new t.BezierData,this.zBezier1=new t.BezierData,this.xBezier2=new t.BezierData,this.yBezier2=new t.BezierData,this.zBezier2=new t.BezierData}return e.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.xBezier1&&(this.xBezier1=new t.BezierData),null==this.yBezier1&&(this.yBezier1=new t.BezierData),null==this.zBezier1&&(this.zBezier1=new t.BezierData),this.xBezier1.validate(),this.yBezier1.validate(),this.zBezier1.validate()),this.type==i.TwoBezier&&(null==this.xBezier2&&(this.xBezier2=new t.BezierData),null==this.yBezier2&&(this.yBezier2=new t.BezierData),null==this.zBezier2&&(this.zBezier2=new t.BezierData),this.xBezier2.validate(),this.yBezier2.validate(),this.zBezier2.validate())},e.prototype.scaleBy=function(t){this.min.scaleBy(t),this.max.scaleBy(t),this.xBezier1&&this.xBezier1.scaleBy(t),this.yBezier1&&this.yBezier1.scaleBy(t),this.zBezier1&&this.zBezier1.scaleBy(t),this.xBezier2&&this.xBezier2.scaleBy(t),this.yBezier2&&this.yBezier2.scaleBy(t),this.zBezier2&&this.zBezier2.scaleBy(t)},e}();t.VelocityForceLifeTimeData=x;var D=function(i){function a(){i.call(this,e.ScaleBezier),this.data=new t.BezierData}return __extends(a,i),a.prototype.validate=function(){null==this.data&&(this.data=new t.BezierData),this.data.validate()},a}(l);t.ParticleDataScaleBezier=D;var b=function(a){function r(){a.call(this,e.RotationSpeed),this.max=new t.Vector3D,this.min=new t.Vector3D,this.type=i.Const,this.bezier1=new t.BezierData,this.bezier2=new t.BezierData}return __extends(r,a),r.prototype.validate=function(){null==this.max&&(this.max=new t.Vector3D),null==this.min&&(this.min=this.max.clone()),(this.type==i.OneBezier||this.type==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.type==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate())},r}(l);t.ParticleDataRotationSpeed=b;var w=function(i){function a(){i.call(this,e.ColorOffset),this.data=new t.ColorGradients}return __extends(a,i),a.prototype.validate=function(){null==this.data.colors&&(this.data.colors=[]),null==this.data.times&&(this.data.times=[])},a}(l);t.ParticleDataColorOffset=w;var T=function(t){function i(){t.call(this,e.FollowTarget),this.followRotation=!0,this.followScale=!0}return __extends(i,t),i.prototype.validate=function(){},i}(l);t.ParticleDataFollowTarget=T;var P=function(a){function r(){a.call(this,e.TextureSheet),this.tileX=1,this.tileY=1,this.whole=!0,this.frameType=i.Const,this.randomRow=!1,this.row=0,this.min=0,this.max=0,this.circles=1,this.bezier1=new t.BezierData,this.bezier2=new t.BezierData}return __extends(r,a),r.prototype.validate=function(){this.tileX<0&&(this.tileX=1),this.tileX=Math.floor(this.tileX),this.tileY<0&&(this.tileY=1),this.tileY=Math.floor(this.tileY),this.max<0&&(this.max=0),this.min>this.max&&(this.min=this.max),(this.frameType==i.OneBezier||this.frameType==i.TwoBezier)&&(null==this.bezier1&&(this.bezier1=new t.BezierData),this.bezier1.validate()),this.frameType==i.TwoBezier&&(null==this.bezier2&&(this.bezier2=new t.BezierData),this.bezier2.validate()),this.circles<1&&(this.circles=1)},r}(l);t.ParticleDataTextureSheet=P}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.version=1}return e.prototype.parse=function(e){this._particleData=new t.ParticleData,this._xml=t.XMLParser.parse(e),this.version=Number(this.getNode(this._xml,"version").textContent);var i=this.getNode(this._xml,"property");this.parseProperty(i);var a=this.getNode(this._xml,"emission");this.parseEmission(a);var r=this.getNode(this._xml,"life");this.parseLife(r);var n=this.getNode(this._xml,"shape");this.parseShape(n);var o=this.getNode(this._xml,"rotationBirth");this.parseRotationBirth(o);var s=this.getNode(this._xml,"scaleBirth");this.parseScaleBirth(s);var h=this.getNode(this._xml,"geometry");this.parseGeometry(h);var l=this.getNode(this._xml,"moveSpeed");this.parseMoveSpeed(l);var u=this.getNode(this._xml,"followTarget");this.parseFollowTarget(u);var c=this.getNode(this._xml,"scaleBezier");this.parseScaleBeizer(c);var d=this.getNode(this._xml,"rotationSpeed");this.parseRotationSpeed(d);var p=this.getNode(this._xml,"colorOffset");this.parseColorOffset(p);var f=(this.getNode(this._xml,"mat"),this.getNode(this._xml,"textureSheet"));return this.parseTextureSheet(f),this._particleData.validate(),this._particleData.scaleBy(t.ParticleData.SCALE_VALUE),this._particleData},e.prototype.parseProperty=function(e){var i=this._particleData.property;i.particleCount=Number(this.getNode(e,"particleCount").textContent),i.prewarm="true"==this.getNode(e,"prewarm").textContent;var a=this.getNode(e,"bounds");i.bounds=this.parseVector3D(a,i.bounds),i.colorType=t.ParticleBirthColorType[this.getNode(e,"colorType").textContent];var r=this.getNode(e,"colorConst1"),n=this.getNode(e,"colorConst2"),o=this.getNode(e,"colorGradients1"),s=this.getNode(e,"colorGradients2"),h=this.getNode(e,"tintColor");this.parseColorProperty(i,r,n,o,s,h),i.gravity=Number(this.getNode(e,"gravity").textContent);var l=this.getNode(e,"transform"),u=this.getNode(l,"rotation"),c=this.getNode(l,"scale"),d=this.getNode(l,"position");i.rotation=this.parseVector3D(u,i.rotation),i.scale=this.parseVector3D(c,i.scale),i.position=this.parseVector3D(d,i.position);var p=this.getNode(e,"render"),f=this.getNode(p,"renderMode");f&&(i.renderMode=t.ParticleRenderModeType[f.textContent]);var _=this.getNode(p,"lengthScale");_&&(i.lengthScale=Number(_.textContent));var m=this.getNode(p,"cameraScale");m&&(i.cameraScale=Number(m.textContent));var v=this.getNode(p,"speedScale");v&&(i.speedScale=Number(v.textContent));var g=this.getNode(p,"meshFile");g&&(i.meshFile=g.textContent);var y=this.getNode(e,"sortingFudge");y&&(i.sortingFudge=Number(y.textContent))},e.prototype.parseColorProperty=function(e,i,a,r,n,o){if(i&&(e.colorConst1=t.Color.createColor(Number(i.textContent))),a&&(e.colorConst2=t.Color.createColor(Number(a.textContent))),r){var s=this.getNodeList(r,"item");e.colorGradients1=this.parseGradientsColor(s,e.colorGradients1)}if(n){var s=this.getNodeList(n,"item");e.colorGradients2=this.parseGradientsColor(s,e.colorGradients2)}o&&(e.tintColor=t.Color.createColor(Number(o.textContent)))},e.prototype.parseEmission=function(e){var i=this._particleData.emission;i.type=t.ParticleValueType[this.getNode(e,"type").textContent],i.rate=Number(this.getNode(e,"rate").textContent);var a,r,n=this.getNode(e,"bursts"),o=0,s=0;if(n){i.bursts=[];var h=this.getNodeList(n,"item");for(o=0,s=h?h.length:0;s>o;o++)a=h[o],r=new t.Point,i.bursts.push(r),this.eachAttr(a,function(t,e){"time"==t?r.x=Number(e):"count"==t&&(r.y=Number(e))})}var l=this.getNode(e,"bezier");i.type==t.ParticleValueType.OneBezier&&(i.bezier=this.parseBezierData(l))},e.prototype.parseLife=function(e){var i=this._particleData.life;i.type=t.ParticleValueType[this.getNode(e,"type").textContent],i.min=Number(this.getNode(e,"min").textContent),i.max=Number(this.getNode(e,"max").textContent),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2")),i.duration=Number(this.getNode(e,"duration").textContent),i.delay=Number(this.getNode(e,"delay").textContent),i.loop="true"==this.getNode(e,"loop").textContent},e.prototype.parseShape=function(e){var i=this._particleData.shape;i.type=t.ParticleDataShapeType[this.getNode(e,"type").textContent],i.randomDirection="true"==this.getNode(e,"randomDirection").textContent;var a=this.getNode(e,"cube");this.eachAttr(a,function(t,e){"width"==t?i.cubeW=Number(e):"height"==t?i.cubeH=Number(e):"depth"==t&&(i.cubeD=Number(e))});var r=this.getNode(e,"sphereRadius");r&&(i.sphereRadius=Number(r.textContent));var n=this.getNode(e,"hemiSphereRadius");n&&(i.hemiSphereRadius=Number(n.textContent));var o=this.getNode(e,"cone");this.eachAttr(o,function(e,a){"coneHeight"==e?i.coneHeight=Number(a):"coneRadiusBottom"==e?i.coneRadiusBottom=Number(a):"coneRadiusTop"==e?i.coneRadiusTop=Number(a):"type"==e&&(i.coneType=t.ParticleConeShapeType[a])});var s=this.getNode(e,"meshType");s&&(i.meshType=t.ParticleMeshShapeType[s.textContent]);var h=this.getNode(e,"meshFile");h&&(i.meshFile=h.textContent)},e.prototype.parseRotationBirth=function(e){var i=this._particleData.rotationBirth;i.type=t.ParticleValueType[this.getNode(e,"type").textContent],i.min=Number(this.getNode(e,"min").textContent),i.max=Number(this.getNode(e,"max").textContent),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))},e.prototype.parseScaleBirth=function(e){var i=this._particleData.scaleBirth;i.type=t.ParticleValueType[this.getNode(e,"type").textContent],i.min=Number(this.getNode(e,"min").textContent),i.max=Number(this.getNode(e,"max").textContent),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))},e.prototype.parseGeometry=function(t){var e=this._particleData.geometry,i=this.getNode(t,"plane");this.eachAttr(i,function(t,i){"width"==t?e.planeW=Number(i):"height"==t&&(e.planeH=Number(i))})},e.prototype.parseMoveSpeed=function(e){var i=this._particleData.moveSpeed;i.type=t.ParticleValueType[this.getNode(e,"type").textContent],i.min=Number(this.getNode(e,"min").textContent),i.max=Number(this.getNode(e,"max").textContent),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"));var a=this.getNode(e,"velocityOver");if(a){var r=new t.VelocityOverLifeTimeData;r.type=t.ParticleValueType[this.getNode(a,"type").textContent];var n=this.getNode(a,"min"),o=this.getNode(a,"max");r.min=this.parseVector3D(n,r.min),r.max=this.parseVector3D(o,r.max),r.worldSpace="true"==this.getNode(a,"worldSpace").textContent,r.xBezier1=this.parseBezierData(this.getNode(a,"xBezier1")),r.yBezier1=this.parseBezierData(this.getNode(a,"yBezier1")),r.zBezier1=this.parseBezierData(this.getNode(a,"zBezier1")),r.xBezier2=this.parseBezierData(this.getNode(a,"xBezier2")),r.yBezier2=this.parseBezierData(this.getNode(a,"yBezier2")),r.zBezier2=this.parseBezierData(this.getNode(a,"zBezier2")),i.velocityOver=r}var s=this.getNode(e,"velocityForce");if(s){var h=new t.VelocityForceLifeTimeData;h.type=t.ParticleValueType[this.getNode(s,"type").textContent];var n=this.getNode(s,"min"),o=this.getNode(s,"max");h.min=this.parseVector3D(n,h.min),h.max=this.parseVector3D(o,h.max),h.worldSpace="true"==this.getNode(s,"worldSpace").textContent,h.xBezier1=this.parseBezierData(this.getNode(s,"xBezier1")),h.yBezier1=this.parseBezierData(this.getNode(s,"yBezier1")),h.zBezier1=this.parseBezierData(this.getNode(s,"zBezier1")),h.xBezier2=this.parseBezierData(this.getNode(s,"xBezier2")),h.yBezier2=this.parseBezierData(this.getNode(s,"yBezier2")),h.zBezier2=this.parseBezierData(this.getNode(s,"zBezier2")),i.velocityForce=h}var l=this.getNode(e,"velocityLimit");if(l){var u=new t.VelocityLimitLifeTimeData;u.type=t.ParticleValueType[this.getNode(l,"type").textContent];var n=this.getNode(l,"min"),o=this.getNode(l,"max");u.min=Number(n.textContent),u.max=Number(o.textContent),u.bezier1=this.parseBezierData(this.getNode(l,"bezier1")),u.bezier2=this.parseBezierData(this.getNode(l,"bezier2")),i.velocityLimit=u}},e.prototype.parseFollowTarget=function(e){if(null!=e){var i=this._particleData.followTarget=new t.ParticleDataFollowTarget;i.followRotation="true"==this.getNode(e,"followRotation").textContent,i.followScale="true"==this.getNode(e,"followScale").textContent}},e.prototype.parseScaleBeizer=function(e){if(null!=e){var i=this._particleData.scaleBezier=new t.ParticleDataScaleBezier;i.data=this.parseBezierData(this.getNode(e,"bezier"))}},e.prototype.parseRotationSpeed=function(e){if(null!=e){var i=this._particleData.rotationSpeed=new t.ParticleDataRotationSpeed;i.type=t.ParticleValueType[this.getNode(e,"type").textContent];var a=this.getNode(e,"min"),r=this.getNode(e,"max");i.min=this.parseVector3D(a,i.min),i.max=this.parseVector3D(r,i.max),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2"))}},e.prototype.parseColorOffset=function(e){if(null!=e){var i=this._particleData.colorOffset=new t.ParticleDataColorOffset,a=this.getNodeList(e,"item");i.data=this.parseGradientsColor(a,i.data)}},e.prototype.parseTextureSheet=function(e){if(null==e)return null;var i=this._particleData.textureSheet=new t.ParticleDataTextureSheet;return i.frameType=t.ParticleValueType[this.getNode(e,"frameType").textContent],i.tileX=Number(this.getNode(e,"tileX").textContent),i.tileY=Number(this.getNode(e,"tileY").textContent),i.whole="true"==this.getNode(e,"whole").textContent,i.row=Number(this.getNode(e,"row").textContent),i.min=Number(this.getNode(e,"min").textContent),i.max=Number(this.getNode(e,"max").textContent),i.circles=Number(this.getNode(e,"circles").textContent),i.bezier1=this.parseBezierData(this.getNode(e,"bezier1")),i.bezier2=this.parseBezierData(this.getNode(e,"bezier2")),i},e.prototype.parseGradientsColor=function(e,i){i||(i=new t.ColorGradients);var a,r,n=0,o=0;for(n=0,o=e?e.length:0;o>n;n++)a=e[n],this.eachAttr(a,function(e,a){"time"==e?i.times.push(Number(a)):"color"==e&&(r=t.Color.createColor(Number(a)),i.colors.push(r))});var s=i.times.slice(),h=i.colors.slice();for(s.sort(function(t,e){return t-e}),n=0,o=i?i.times.length:0;o>n;n++){var l=s.indexOf(i.times[n]);i.colors[n]=h[l]}return i.times=s,i},e.prototype.parseBezierData=function(e){var i=new t.BezierData;if(null==e)return i;var a,r,n=this.getNodeList(e,"pos"),o=this.getNodeList(e,"ctrl"),s=0,h=0;for(s=0,h=n?n.length:0;h>s;s++)a=n[s],r=new t.Point,i.posPoints.push(r),this.eachAttr(a,function(t,e){"x"==t?r.x=Number(e):"y"==t&&(r.y=Number(e))});for(s=0,h=o?o.length:0;h>s;s++)a=o[s],r=new t.Point,i.ctrlPoints.push(r),this.eachAttr(a,function(t,e){"x"==t?r.x=Number(e):"y"==t&&(r.y=Number(e))});return i},e.prototype.parseVector3D=function(e,i){return null==i&&(i=new t.Vector3D),this.eachAttr(e,function(t,e){"x"==t?i.x=Number(e):"y"==t?i.y=Number(e):"z"==t&&(i.z=Number(e))}),i},e.prototype.getNode=function(t,e){if(null==t)return null;var i=t.getElementsByTagName(e);return null==i||0==i.length?null:i[0]},e.prototype.getNodeList=function(t,e){if(null==t)return null;var i=t.getElementsByTagName(e);return null==i||0==i.length?null:i},e.prototype.eachAttr=function(e,i){t.XMLParser.eachXmlAttr(e,i)},e}();t.ParticleXmlParser=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a){void 0===a&&(a=null),e.call(this,null,a),this._isEmitterDirty=!0,this._userNodes=[],this.tag.name="effect",this.type="particleEmit",this._data=i,this._externalGeometry=i.property.geometry,this.animation=this.particleAnimation=new t.ParticleAnimation(this),this.animation.particleAnimationController=this.particleAnimation,this._particleState=this.particleAnimation.particleAnimationState,this.particleAnimation.emit=this,this.buildParticle()}return __extends(i,e),Object.defineProperty(i.prototype,"drawOrder",{get:function(){return this._data.property.sortingFudge},enumerable:!0,configurable:!0}),i.prototype.addSubEmitter=function(t,e){e.animation.stop(),this._subEmitterNode.importSubEmitter(t,e)},i.prototype.buildParticle=function(){null==this._externalGeometry?this._geometryShape=this.createPlane():this._geometryShape=this._externalGeometry,this.initialize(),this.initBoudBox(this._data.property.bounds),this._isEmitterDirty=!1},i.prototype.createPlane=function(){var e,i=this._data.geometry,a=t.Vector3D.Z_AXIS;a=this._data.property.renderMode==t.ParticleRenderModeType.VerticalBillboard?t.Vector3D.Y_AXIS:this._data.property.renderMode==t.ParticleRenderModeType.HorizontalBillboard?t.Vector3D.Y_AXIS:t.Vector3D.Z_AXIS;var r=!0,n=!0;return this._data.property.renderMode==t.ParticleRenderModeType.StretchedBillboard&&(r=!1,n=!0),e=new t.PlaneGeometry(i.planeW,i.planeH,1,1,1,1,a,r,n)},Object.defineProperty(i.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"timeNode",{get:function(){return this._timeNode},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"positionNode",{get:function(){return this._positionNode},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"followTarget",{get:function(){return this._particleState.followTarget},set:function(t){this._particleState.followTarget=t},enumerable:!0,configurable:!0}),i.prototype.addAnimNode=function(t){var e=this._userNodes.indexOf(t);-1==e&&(this._userNodes.push(t),this._isEmitterDirty=!0)},i.prototype.removeAnimNode=function(t){var e=this._userNodes.indexOf(t);-1!=e&&(this._userNodes.slice(e),this._isEmitterDirty=!0)},i.prototype.play=function(t){void 0===t&&(t=!1),t?this.animation.play("",1,!1,!0):this.animation.play("",1,!0,!1)},i.prototype.stop=function(){this.animation.stop()},i.prototype.initialize=function(){this.particleAnimation.particleAnimationState.clean();var e=this._data.property.particleCount;this.geometry=new t.Geometry,this.geometry.buildDefaultSubGeometry(),this.geometry.subGeometrys[0].count=e*this._geometryShape.indexData.length;var i=0,a=new Array;this.geometry.vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0|t.VertexFormat.VF_COLOR,this.initMainAnimNode(),this.initUserAnimNode(),this.initEndNode(),this.geometry.verticesData=new Array;for(var r=0;e>r;++r)for(var n=0;n<this._geometryShape.vertexCount;++n){for(var o=0;o<this.geometry.vertexAttLength;++o)this.geometry.verticesData.push(0);i=r*this._geometryShape.vertexCount+n,a.length=0,this._geometryShape.getVertexForIndex(n,this.geometry.vertexFormat,a);for(var o=0;o<a.length;++o)this.geometry.verticesData[i*this.geometry.vertexAttLength+o]=a[o]}this.geometry.indexData=new Array;for(var r=0;e>r;++r)for(var n=0;n<this._geometryShape.indexData.length;++n)this.geometry.indexData[r*this._geometryShape.indexData.length+n]=this._geometryShape.indexData[n]+r*this._geometryShape.vertexCount;this.particleAnimation.particleAnimationState.fill(this.geometry,e)},i.prototype.initMainAnimNode=function(){var e=[];this._timeNode=new t.ParticleTime,this._timeNode.initNode(this._data.life),e.push(this._timeNode),this._positionNode=new t.ParticlePosition,this._positionNode.initNode(this._data.shape,this._data.property),e.push(this._positionNode);var i=new t.ParticleVelocityNode;i.initNode(this._data.moveSpeed),e.push(i),this._subEmitterNode=new t.ParticleSubEmitterNode,this._subEmitterNode.initNode(null,this),this.particleAnimation.particleAnimationState.addNode(this._subEmitterNode);var a=this._data.moveSpeed.velocityOver;if(a)if(a.type==t.ParticleValueType.Const||a.type==t.ParticleValueType.RandomConst){var r=new t.ParticleVelocityOverConstNode;r.initNode(this._data.moveSpeed),e.push(r)}else if(a.type==t.ParticleValueType.OneBezier){var n=new t.ParticleVelocityOverOneBezierNode;n.initNode(this._data.moveSpeed),e.push(n)}else if(a.type==t.ParticleValueType.TwoBezier){var o=new t.ParticleVelocityOverTwoBezierNode;o.initNode(this._data.moveSpeed),e.push(o)}var s=this._data.moveSpeed.velocityLimit;if(s)if(s.type==t.ParticleValueType.Const||s.type==t.ParticleValueType.RandomConst){var h=new t.ParticleVelocityLimitConstNode;h.initNode(this._data.moveSpeed),e.push(h)}else if(s.type==t.ParticleValueType.OneBezier){var l=new t.ParticleVelocityLimitOneBezierNode;l.initNode(this._data.moveSpeed),e.push(l)}else if(s.type==t.ParticleValueType.TwoBezier){var u=new t.ParticleVelocityLimitTwoBezierNode;u.initNode(this._data.moveSpeed),e.push(u)}var c=this._data.moveSpeed.velocityForce;if(c)if(c.type==t.ParticleValueType.Const||c.type==t.ParticleValueType.RandomConst){var d=new t.ParticleVelocityForceConstNode;d.initNode(this._data.moveSpeed),e.push(d)}else if(c.type==t.ParticleValueType.OneBezier){var p=new t.ParticleVelocityForceOneBezierNode;p.initNode(this._data.moveSpeed),e.push(p)}else if(c.type==t.ParticleValueType.TwoBezier){var f=new t.ParticleVelocityForceTwoBezierNode;f.initNode(this._data.moveSpeed),e.push(f)}var _=new t.ParticleRotation;_.initNode(this._data.rotationBirth),e.push(_);var m=new t.ParticleScale;m.initNode(this._data.scaleBirth),e.push(m);var v=new t.ParticleStartColor;if(v.initNode(this._data.property),e.push(v),this._data.followTarget){var g=new t.ParticleFollowNode;g.initNode(this._data.followTarget),e.push(g)}if(this._data.scaleBezier){var y=new t.ParticleSizeGlobalNode;
y.initNode(this._data.scaleBezier),e.push(y)}if(this._data.rotationSpeed)if(this._data.rotationSpeed.type==t.ParticleValueType.Const||this._data.rotationSpeed.type==t.ParticleValueType.RandomConst){var x=new t.ParticleRotationConstNode;x.initNode(this._data.rotationSpeed),e.push(x)}else if(this._data.rotationSpeed.type==t.ParticleValueType.OneBezier){var D=new t.ParticleRotationOneBezierNode;D.initNode(this._data.rotationSpeed),e.push(D)}else if(this._data.rotationSpeed.type==t.ParticleValueType.TwoBezier){var b=new t.ParticleRotationTwoBezierNode;b.initNode(this._data.rotationSpeed),e.push(b)}if(this._data.colorOffset){var w=new t.ParticleColorGlobalNode;w.initNode(this._data.colorOffset),e.push(w)}if(this._data.materialData)for(var T,P=0,S=this._data.materialData.methods;P<S.length;P++)if(T=S[P],T.type==t.MatMethodData.methodType.lightmapMethod);else if(T.type==t.MatMethodData.methodType.uvRollMethod){var C=new t.ParticleUVRollNode;C.initNode(null,T),e.push(C)}else T.type==t.MatMethodData.methodType.alphaMaskMethod||T.type==t.MatMethodData.methodType.streamerMethod;if(this._data.textureSheet){var A=new t.ParticleTextureSheetNode;A.initNode(null,this._data.textureSheet),e.push(A)}for(var E=0,L=e.length;L>E;E++)this.particleAnimation.particleAnimationState.addNode(e[E])},i.prototype.initUserAnimNode=function(){for(var t=0;t<this._userNodes.length;t++)this.particleAnimation.particleAnimationState.addNode(this._userNodes[t])},i.prototype.initEndNode=function(){var e=new t.ParticleEndNode;this.particleAnimation.particleAnimationState.addNode(e),this.particleAnimation.particleAnimationState.calculate(this.geometry)},i.prototype.initBoudBox=function(e){var i=new t.BoundBox(this);i.fillBox(new t.Vector3D(-e.x/2,-e.y/2,-e.z/2),new t.Vector3D(e.x/2,e.y/2,e.z/2)),this.bound=i,this.initAABB()},Object.defineProperty(i.prototype,"loopProgress",{get:function(){return this.animation.animTime/(1e3*this._particleState.circleTime)},enumerable:!0,configurable:!0}),i.prototype.update=function(t,i,a){this._isEmitterDirty&&this.buildParticle(),e.prototype.update.call(this,t,i,a)},i}(t.Mesh);t.ParticleEmitter=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._root=new t.Object3D,this._tree=new t.TreeBase(this._root)}return Object.defineProperty(e.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"quad",{get:function(){return this._quad},enumerable:!0,configurable:!0}),e.prototype.addChild3D=function(t){this._root.addChild(t)},e.prototype.removeChild3D=function(t){this._root.removeChild(t)},e.prototype.update=function(){},e.prototype.infrustumList=function(t){return this._tree.infrustumList(t)},e.prototype.createQuadTree=function(){this._quad=new t.QuadRoot(8,128);var e=new Array;this.collectQuadList(e,this.root),this._quad.createQuadTree(e)},e.prototype.collectQuadList=function(e,i){e=e||new Array;var a;i instanceof t.Mesh&&(a=i,a.aabb&&e.push(a));var r;if(i.childs&&i.childs.length>0)for(var n=0,o=i.childs;n<o.length;n++)r=o[n],this.collectQuadList(e,r);return e},e}();t.Scene3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t){this._searchList=new Array,this._root=t}return t.prototype.infrustumList=function(t){return this._searchList.length=0,this._searchList},t}();t.TreeBase=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.useMipmap=!0,this.smooth=!0,this.repeat=!1,this.premultiply_alpha=0,this.filp_y=0,this.hasMipmap=!1,this.ready=!1}return e.prototype.upload=function(t){},e.prototype.uploadForcing=function(t){},e.prototype.activeState=function(e){this.ready||(this.ready=!0,this.premultiply_alpha||t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this.useMipmap&&!this.hasMipmap&&(t.Context3DProxy.gl.generateMipmap(t.Context3DProxy.gl.TEXTURE_2D),this.hasMipmap=!0),this.smooth?this.hasMipmap?(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR_MIPMAP_LINEAR),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.NEAREST),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.NEAREST)),this.repeat?(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.REPEAT),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.REPEAT)):(e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),e.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)),this.filp_y&&t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_FLIP_Y_WEBGL,this.filp_y))},e}();t.ITexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){e.call(this),this.imageData=t}return __extends(i,e),Object.defineProperty(i.prototype,"width",{get:function(){return this.imageData.width},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this.imageData.height},enumerable:!0,configurable:!0}),i.prototype.upload=function(e){this.texture2D||(this.texture2D=e.creatTexture2D(),this.texture2D.internalFormat=t.InternalFormat.ImageData,this.texture2D.imageData=this.imageData,this.texture2D.colorFormat=t.ContextConfig.ColorFormat_RGBA8888,e.upLoadTextureData(0,this))},i.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},i}(t.ITexture);t.ImageTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this)}return __extends(e,t),e.prototype.upload=function(t){},e.prototype.uploadForcing=function(t){},e}(t.ITexture);t.PVRTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(){t.call(this),this.smooth=!0}return __extends(e,t),e.prototype.upload=function(t){if(!this.texture2D)if(this.texture2D=t.creatTexture2D(),this.texture2D.internalFormat=this.internalFormat,this.texture2D.colorFormat=this.colorFormat,this.texture2D.mimapData=this.mimapData,this.mimapData&&this.mimapData.length>0)for(var e=0;e<this.mimapData.length;e++)t.upLoadTextureData(e,this);else t.upLoadTextureData(0,this)},e.prototype.uploadForcing=function(t){t.upLoadTextureData(0,this)},e}(t.ITexture);t.MimapTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a,r,n,o){void 0===t&&(t=null),void 0===i&&(i=null),void 0===a&&(a=null),void 0===r&&(r=null),void 0===n&&(n=null),void 0===o&&(o=null),e.call(this),this.image_front=t,this.image_back=i,this.image_left=a,this.image_right=r,this.image_up=n,this.image_down=o}return __extends(i,e),i.createCubeTexture=function(e,a,r,n,o,s){var h=new t.Texture2D;h.imageData=e;var l=new t.Texture2D;l.imageData=a;var u=new t.Texture2D;u.imageData=r;var c=new t.Texture2D;c.imageData=n;var d=new t.Texture2D;d.imageData=o;var p=new t.Texture2D;p.imageData=s;var f=new i(h,l,u,c,d,p);return f},i.setCubeTexture=function(t,e,i,a,r,n,o){t.image_front=e.texture2D,t.image_back=i.texture2D,t.image_left=a.texture2D,t.image_right=r.texture2D,t.image_up=n.texture2D,t.image_down=o.texture2D},i.prototype.upload=function(t){this.image_front&&this.image_back&&this.image_left&&this.image_right&&this.image_up&&this.image_down&&(this.texture3D||(this.texture3D=t.creatCubeTexture(),this.texture3D.border=0,this.texture3D.image_front=this.image_front,this.texture3D.image_back=this.image_back,this.texture3D.image_left=this.image_left,this.texture3D.image_right=this.image_right,this.texture3D.image_up=this.image_up,this.texture3D.image_down=this.image_down,t.uploadCubetexture(this.texture3D)))},i.prototype.uploadForcing=function(t){},i}(t.ITexture);t.CubeTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){e.call(this),this.width=32,this.height=32,this.buildCheckerboard()}return __extends(i,e),i.prototype.upload=function(e){this.texture2D||(this.texture2D=e.creatTexture2D(),this.texture2D.border=0,this.texture2D.internalFormat=t.InternalFormat.PixelArray,this.texture2D.colorFormat=t.Context3DProxy.gl.RGBA,this.texture2D.mimapData=new Array,this.texture2D.mimapData.push(new t.MipmapData(this._pixelArray,this.width,this.height)),this.useMipmap=!1,this.texture2D.dataFormat=t.Context3DProxy.gl.FLOAT,e.upLoadTextureData(0,this))},i.prototype.buildCheckerboard=function(){if(!this._pixelArray){this._pixelArray=new Float32Array(this.width*this.height*4);for(var e=[t.Color.black(),t.Color.white()],i=0,a=4,r=0;r<this.height;r++)for(var n=0;n<this.width;n++){if(n%a==0&&(i=(i+1)%2),r%a==0&&0==n){var o=e[0];e[0]=e[1],e[1]=o,i=0}this._pixelArray[r*(4*this.width)+4*n+0]=n*r/1024,this._pixelArray[r*(4*this.width)+4*n+1]=n*r/1024,this._pixelArray[r*(4*this.width)+4*n+2]=n*r/1024,this._pixelArray[r*(4*this.width)+4*n+3]=n*r/1024}}},i.prototype.uploadForcing=function(t){},i.texture=new i,i}(t.ITexture);t.CheckerboardTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i){var a=this;void 0===t&&(t=256),void 0===i&&(i=256),e.call(this),this.canUpdataTexture=!1,this.width=t,this.height=i,this.tmpCanvas=document.createElement("canvas"),this.tmpCanvas.width=t,this.tmpCanvas.height=i,this.context=this.tmpCanvas.getContext("2d"),this.video=document.createElement("video"),this.video.msZoom=!0,this.video.width=t,this.video.height=i,this.video.videoWidth=t,this.video.videoHeight=i,this.video.controls=!1,this.video.autoplay=!0,this.video.addEventListener("canplaythrough",function(){return a.loadReady()},!0),this.tmpCanvas.hidden=!0}return __extends(i,e),i.prototype.loadReady=function(){this.canUpdataTexture=!0},Object.defineProperty(i.prototype,"source",{get:function(){return this.video.src},set:function(t){this.video.src=t},enumerable:!0,configurable:!0}),i.prototype.play=function(){this.video.play()},i.prototype.pause=function(){this.video.pause()},i.prototype.upload=function(e){this.texture2D||(this.texture2D=e.creatTexture2D(),this.context.drawImage(this.video,0,0,this.width,this.height),t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1),t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer),t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE)),this.canUpdataTexture&&(this.context.drawImage(this.video,0,0,this.width,this.height),t.Context3DProxy.gl.pixelStorei(t.Context3DProxy.gl.UNPACK_ALIGNMENT,1),t.Context3DProxy.gl.bindTexture(t.Context3DProxy.gl.TEXTURE_2D,this.texture2D.textureBuffer),t.Context3DProxy.gl.texImage2D(t.Context3DProxy.gl.TEXTURE_2D,0,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.RGB,t.Context3DProxy.gl.UNSIGNED_BYTE,this.tmpCanvas),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MIN_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_MAG_FILTER,t.Context3DProxy.gl.LINEAR),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_S,t.Context3DProxy.gl.CLAMP_TO_EDGE),t.Context3DProxy.gl.texParameteri(t.Context3DProxy.gl.TEXTURE_2D,t.Context3DProxy.gl.TEXTURE_WRAP_T,t.Context3DProxy.gl.CLAMP_TO_EDGE))},i.prototype.uploadForcing=function(t){},i}(t.ITexture);t.VideoTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r){void 0===i&&(i=512),void 0===a&&(a=512),void 0===r&&(r=t.FrameBufferFormat.UNSIGNED_BYTE_RGB),e.call(this),this.frameBufferFormat=t.FrameBufferFormat.UNSIGNED_BYTE_RGB,this.useMipmap=!1,this.width=i,this.height=a,this.frameBufferFormat=r}return __extends(i,e),i.prototype.upload=function(t){this.texture2D||(this.texture2D=t.createFramebuffer(this.width,this.height,this.frameBufferFormat))},i.prototype.uploadForcing=function(t){},i}(t.ITexture);t.RenderTexture=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.LITTLE_ENDIAN="littleEndian",t.BIG_ENDIAN="bigEndian",t}();t.Endian=e;var i=function(){function t(t){this.BUFFER_EXT_SIZE=0,this.EOF_byte=-1,this.EOF_code_point=-1,this._setArrayBuffer(t||new ArrayBuffer(this.BUFFER_EXT_SIZE)),this.endian=e.BIG_ENDIAN}return t.prototype._setArrayBuffer=function(t){this.write_position=t.byteLength,this.data=new DataView(t),this._position=0},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.data.buffer},set:function(t){this.data=new DataView(t)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataView",{get:function(){return this.data},set:function(t){this.data=t,this.write_position=t.byteLength},enumerable:!0,configurable:!0}),t.prototype.uncompress=function(t){void 0===t&&(t="7z")},Object.defineProperty(t.prototype,"bufferOffset",{get:function(){return this.data.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position<t&&!this.validate(t-this._position)||(this._position=t,this.write_position=t>this.write_position?t:this.write_position)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this.write_position},set:function(t){this.validateBuffer(t,!0)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"bytesAvailable",{get:function(){return this.data.byteLength-this._position},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this._setArrayBuffer(new ArrayBuffer(this.BUFFER_EXT_SIZE))},t.prototype.readBoolean=function(){return this.validate(t.SIZE_OF_BOOLEAN)?0!=this.data.getUint8(this.position++):null},t.prototype.readByte=function(){return this.validate(t.SIZE_OF_INT8)?this.data.getInt8(this.position++):null},t.prototype.readBytes=function(e,i,a){if(void 0===i&&(i=0),void 0===a&&(a=0),0==a)a=this.bytesAvailable;else if(!this.validate(a))return null;e?e.validateBuffer(a):e=new t(new ArrayBuffer(a));for(var r=0;a>r;r++)e.data.setUint8(r+i,this.data.getUint8(this.position++))},t.prototype.readDouble=function(){if(!this.validate(t.SIZE_OF_FLOAT64))return null;var i=this.data.getFloat64(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT64,i},t.prototype.readFloat=function(){if(!this.validate(t.SIZE_OF_FLOAT32))return null;var i=this.data.getFloat32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_FLOAT32,i},t.prototype.readInt=function(){if(!this.validate(t.SIZE_OF_INT32))return null;var i=this.data.getInt32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT32,i},t.prototype.readShort=function(){if(!this.validate(t.SIZE_OF_INT16))return null;var i=this.data.getInt16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_INT16,i},t.prototype.readUnsignedByte=function(){return this.validate(t.SIZE_OF_UINT8)?this.data.getUint8(this.position++):null},t.prototype.readUnsignedInt=function(){if(!this.validate(t.SIZE_OF_UINT32))return null;var i=this.data.getUint32(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT32,i},t.prototype.readUnsignedShort=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i},t.prototype.readUTF=function(){if(!this.validate(t.SIZE_OF_UINT16))return null;var i=this.data.getUint16(this.position,this.endian==e.LITTLE_ENDIAN);return this.position+=t.SIZE_OF_UINT16,i>0?this.readUTFBytes(i):""},t.prototype.readUTFBytes=function(t){if(!this.validate(t))return null;var e=new Uint8Array(this.buffer,this.bufferOffset+this.position,t);return this.position+=t,this.decodeUTF8(e)},t.prototype.readLine=function(){for(var t=0,e=this.position;e<this.length;++e)if(10==this.data.getUint8(e)){t=e-this.position+1;break}return this.readUTFBytes(t)},t.prototype.writeBoolean=function(e){this.validateBuffer(t.SIZE_OF_BOOLEAN),this.data.setUint8(this.position++,e?1:0)},t.prototype.writeByte=function(e){this.validateBuffer(t.SIZE_OF_INT8),this.data.setInt8(this.position++,e)},t.prototype.writeBytes=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0);var a;if(!(0>e)&&!(0>i)&&(a=0==i?t.length-e:Math.min(t.length-e,i),a>0)){this.validateBuffer(a);for(var r=new DataView(t.buffer),n=e;a+e>n;n++)this.data.setUint8(this.position++,r.getUint8(n))}},t.prototype.writeDouble=function(i){this.validateBuffer(t.SIZE_OF_FLOAT64),this.data.setFloat64(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT64},t.prototype.writeFloat=function(i){this.validateBuffer(t.SIZE_OF_FLOAT32),this.data.setFloat32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_FLOAT32},t.prototype.writeInt=function(i){this.validateBuffer(t.SIZE_OF_INT32),this.data.setInt32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT32},t.prototype.writeShort=function(i){this.validateBuffer(t.SIZE_OF_INT16),this.data.setInt16(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_INT16},t.prototype.writeUnsignedInt=function(i){this.validateBuffer(t.SIZE_OF_UINT32),this.data.setUint32(this.position,i,this.endian==e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT32},t.prototype.writeUTF=function(i){var a=this.encodeUTF8(i),r=a.length;this.validateBuffer(t.SIZE_OF_UINT16+r),this.data.setUint16(this.position,r,this.endian===e.LITTLE_ENDIAN),this.position+=t.SIZE_OF_UINT16,this._writeUint8Array(a,!1)},t.prototype.writeUTFBytes=function(t){this._writeUint8Array(this.encodeUTF8(t))},t.prototype.toString=function(){return"[ByteArray] length:"+this.length+", bytesAvailable:"+this.bytesAvailable},t.prototype._writeUint8Array=function(t,e){void 0===e&&(e=!0),e&&this.validateBuffer(this.position+t.length);for(var i=0;i<t.length;i++)this.data.setUint8(this.position++,t[i])},t.prototype.validate=function(t){return this.data.byteLength>0&&this._position+t<=this.data.byteLength?!0:void 0},t.prototype.validateBuffer=function(t,e){if(void 0===e&&(e=!1),this.write_position=t>this.write_position?t:this.write_position,t+=this._position,this.data.byteLength<t||e){var i=new Uint8Array(new ArrayBuffer(t+this.BUFFER_EXT_SIZE)),a=Math.min(this.data.buffer.byteLength,t+this.BUFFER_EXT_SIZE);i.set(new Uint8Array(this.data.buffer,0,a)),this.buffer=i.buffer}},t.prototype.encodeUTF8=function(t){for(var e=0,i=this.stringToCodePoints(t),a=[];i.length>e;){var r=i[e++];if(this.inRange(r,55296,57343))this.encoderError(r);else if(this.inRange(r,0,127))a.push(r);else{var n,o;for(this.inRange(r,128,2047)?(n=1,o=192):this.inRange(r,2048,65535)?(n=2,o=224):this.inRange(r,65536,1114111)&&(n=3,o=240),a.push(this.div(r,Math.pow(64,n))+o);n>0;){var s=this.div(r,Math.pow(64,n-1));a.push(128+s%64),n-=1}}}return new Uint8Array(a)},t.prototype.decodeUTF8=function(t){for(var e,i=!1,a=0,r="",n=0,o=0,s=0,h=0;t.length>a;){var l=t[a++];if(l===this.EOF_byte)e=0!==o?this.decoderError(i):this.EOF_code_point;else if(0===o)this.inRange(l,0,127)?e=l:(this.inRange(l,194,223)?(o=1,h=128,n=l-192):this.inRange(l,224,239)?(o=2,h=2048,n=l-224):this.inRange(l,240,244)?(o=3,h=65536,n=l-240):this.decoderError(i),n*=Math.pow(64,o),e=null);else if(this.inRange(l,128,191))if(s+=1,n+=(l-128)*Math.pow(64,o-s),s!==o)e=null;else{var u=n,c=h;n=0,o=0,s=0,h=0,e=this.inRange(u,c,1114111)&&!this.inRange(u,55296,57343)?u:this.decoderError(i,l)}else n=0,o=0,s=0,h=0,a--,e=this.decoderError(i,l);null!==e&&e!==this.EOF_code_point&&(65535>=e?e>0&&(r+=String.fromCharCode(e)):(e-=65536,r+=String.fromCharCode(55296+(e>>10&1023)),r+=String.fromCharCode(56320+(1023&e))))}return r},t.prototype.encoderError=function(t){},t.prototype.decoderError=function(t,e){return e||65533},t.prototype.inRange=function(t,e,i){return t>=e&&i>=t},t.prototype.div=function(t,e){return Math.floor(t/e)},t.prototype.stringToCodePoints=function(t){for(var e=[],i=0,a=t.length;i<t.length;){var r=t.charCodeAt(i);if(this.inRange(r,55296,57343))if(this.inRange(r,56320,57343))e.push(65533);else if(i===a-1)e.push(65533);else{var n=t.charCodeAt(i+1);if(this.inRange(n,56320,57343)){var o=1023&r,s=1023&n;i+=1,e.push(65536+(o<<10)+s)}else e.push(65533)}else e.push(r);i+=1}return e},t.SIZE_OF_BOOLEAN=1,t.SIZE_OF_INT8=1,t.SIZE_OF_INT16=2,t.SIZE_OF_INT32=4,t.SIZE_OF_UINT8=1,t.SIZE_OF_UINT16=2,t.SIZE_OF_UINT32=4,t.SIZE_OF_FLOAT32=4,t.SIZE_OF_FLOAT64=8,t}();t.ByteArray=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.isDebug=!1,this._console=document.createElement("console"),document.body.appendChild(this._console),this._console.style.color="red",this._console.style.zIndex="1000",this._console.style.position="absolute",this._console.style.top="10px",this._console.style.left="10px"}return t.prototype.trace=function(){for(var t=[],e=0;e<arguments.length;e++)t[e-0]=arguments[e];if(this.isDebug){this.reset();for(var i=t.length,a=0;i>a;a++)this._console.innerHTML+=t[a]+"</br>"}},t.prototype.reset=function(){this._console.innerHTML=""},Object.defineProperty(t,"instance",{get:function(){return null==this._instance&&(this._instance=new t),this._instance},enumerable:!0,configurable:!0}),t._instance=null,t}();t.Debug=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.parseContent=function(t){for(var e=new Array,i="",a=";",r=-1,n=0;n<t.length;++n)if("{"==t.charAt(n)&&(r=i.indexOf("="),0>r&&(a="}")),(""!=i||" "!=t.charAt(n)&&"    "!=t.charAt(n)&&"	"!=t.charAt(n))&&(i+=t.charAt(n),"\n"!=a&&i.indexOf("#extension")>=0&&(a="\n"),a==t.charAt(n))){if("}"==a){for(var o=0,s=0,h=0;h<i.length;++h)"{"==i.charAt(h)?o++:"}"==i.charAt(h)&&s++;if(o!=s)continue;if(i.indexOf("struct")>=0){a=";";continue}}i.length>0&&e.push(i),i="",a=";"}return e},e.parseLines=function(t){for(var e=new Array,i="",a=!1,r=0;r<t.length;++r)if(a){if(";"==t.charAt(r)){a=!1,i.length>0&&(e.push(i),i="");break}i+=t.charAt(r)}else if(" "!=t.charAt(r)&&"	"!=t.charAt(r)&&","!=t.charAt(r)&&"\r"!=t.charAt(r)&&"\n"!=t.charAt(r)&&":"!=t.charAt(r)){if(";"==t.charAt(r)){i.length>0&&(e.push(i),i="");break}if("="==t.charAt(r)){i.length>0&&(e.push(i),i=""),e.push("="),a=!0;continue}i+=t.charAt(r),r==t.length-1&&""!=t&&(e.push(i),i="")}else""!=i&&(e.push(i),i="");return e},e.hasString=function(t,e){for(var i=0;i<t.length;++i)if(t[i]==e)return i;return-1},e.getVarName=function(t){var e=this.hasString(t,"=");if(e>=0){if(e-=1,e>=0&&e<t.length)return t[e]}else if(e=t.length-1,e>=0&&e<t.length)return t[e];return""},e.getVarValue=function(t){var e=this.hasString(t,"=");return e>=0&&(e+=1,e>=0&&e<t.length)?t[e]:""},e.getVarType=function(t){var e=this.hasString(t,"=");if(e>=0){if(e-=2,e>=0&&e<t.length)return t[e]}else if(e=t.length-2,e>=0&&e<t.length)return t[e];return""},e.getVarKey=function(t){var e=this.hasString(t,"=");if(e>=0){if(e-=3,e>=0&&e<t.length)return t[e]}else if(e=t.length-3,e>=0&&e<t.length)return t[e];return""},e.processShaderFile=function(t){var e=["\n","\r"];e=[];for(var i=t,a=i;;){var r=i.indexOf("//");if(0>r)break;var n=i.indexOf("\r\n",r);-1==n&&(n=i.indexOf("\n",r));var o=i.slice(r,n);if(i=i.replace(o,""),i==a)break;a=i}for(var s=0;s<e.length;++s)for(;;){if(a=i.replace(e[s],""),i==a)break;i=a}return i},e.colorRgb=function(t){var e=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/,i=t.toLowerCase();if(i&&e.test(i)){if(4===i.length){for(var a="#",r=1;4>r;r+=1)a+=i.slice(r,r+1).concat(i.slice(r,r+1));i=a}for(var n=[],r=1;7>r;r+=2)n.push(parseInt("0x"+i.slice(r,r+2)));return"RGB("+n.join(",")+")"}return i},e.getLineType=function(t){var e=t.indexOf("{");if(e>0){var i=t.substr(0,e);if(i.indexOf("struct")>=0){var a=i.lastIndexOf(" ");a++;var r=i.substr(a,i.length-a);return"struct "+r}if(i.indexOf("=")<0){var n=t.indexOf("("),a=t.lastIndexOf(" ",n);a++;var o=t.substr(a,n-a);return"function "+o}}return"unknown"},e.processStruct=function(t,i,a){var r=i.lastIndexOf("}");r++;for(var n=i.lastIndexOf(";"),o=i.substr(r,n-r),s=e.parseLines(o),h=0;h<s.length;++h){var l=e.getTemper(t+" "+s[h]+";");l&&a.addVar(l)}},e.getAttribute=function(i){var a,r,n,o=i,s=e.parseLines(o);return a=e.getVarName(s),r=e.getVarType(s),n=new t.GLSL.Attribute(a,r),n.value=e.getVarValue(s),n},e.getTemper=function(i){var a,r,n,o=i,s=e.parseLines(o);return a=e.getVarName(s),r=e.getVarType(s),n=new t.GLSL.TmpVar(a,r),n.value=e.getVarValue(s),n},e.getVarying=function(i){var a,r,n,o=i,s=e.parseLines(o);return a=e.getVarName(s),r=e.getVarType(s),n=new t.GLSL.Varying(a,r)},e.getUniform=function(i){var a,r,n,o=i,s=e.parseLines(o);return a=e.getVarName(s),r=e.getVarType(s),n=new t.GLSL.Uniform(a,r)},e.getConst=function(i){var a,r,n,o,s=i,h=e.parseLines(s);return a=e.getVarName(h),r=e.getVarType(h),n=e.getVarValue(h),o=new t.GLSL.ConstVar(a,r,n)},e.getExtension=function(i){var a=i.indexOf("#"),r=i.indexOf(" "),n=(i.substr(a,r),i.indexOf(":")),o=i.substr(r,n-r);o=e.replaceCharacter(o,[" "],""),n+=1;var s=i.substr(n,i.length-n);s=e.replaceCharacter(s,[" ",":","\n","\r"],"");var h=new t.GLSL.Extension(o);return h.value=s,h},e.getSampler2D=function(i){var a,r,n=i,o=e.parseLines(n);return a=e.getVarName(o),r=new t.GLSL.Sampler2D(a)},e.getSampler3D=function(i){var a,r,n=i,o=e.parseLines(n);return a=e.getVarName(o),r=new t.GLSL.Sampler3D(a)},e.filterCharacter=function(t){for(var i=t,a=i,r=0;r<e._filterChar.length;++r)for(;;){if(a=i.replace(e._filterChar[r],""),i==a)break;i=a}return a},e.replaceCharacter=function(t,e,i){for(var a=t,r=!1;!r;){r=!0;for(var n=0;n<e.length;++n)if(a.indexOf(e[n])>=0){r=!1;break}for(var n=0;n<e.length;++n)a=a.replace(e[n],i)}return a},e.getURLName=function(t){var e=t.split(".");return e=e[0].split("/"),e[e.length-1]},e._filterChar=[" ","  ",";","\n","\r","	","\n","\r","	"],e}();t.StringUtil=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){void 0===i&&(i=100),e.call(this),this._xMat=new t.ColorMaterial(16711680),this._xMat.ambientColor=15790320,this._yMat=new t.ColorMaterial(65280),this._yMat.ambientColor=15790320,this._zMat=new t.ColorMaterial(255),this._zMat.ambientColor=15790320;var a,r=i/100;a=new t.CubeGeometry(i,r,r),this._lineX=new t.Mesh(a,this._xMat),this.addChild(this._lineX),a=new t.CubeGeometry(r,i,r),this._lineY=new t.Mesh(a,this._yMat),this.addChild(this._lineY),a=new t.CubeGeometry(r,r,i),this._lineZ=new t.Mesh(a,this._zMat),this.addChild(this._lineZ);var n=i/25,o=(i-n)/2;a=new t.CubeGeometry(n,n,n),this._boxX=new t.Mesh(a,this._xMat),this._boxX.position=new t.Vector3D(o,0,0),this.addChild(this._boxX),this._boxY=new t.Mesh(a,this._yMat),this._boxY.position=new t.Vector3D(0,o,0),this.addChild(this._boxY),this._boxZ=new t.Mesh(a,this._zMat),this._boxZ.position=new t.Vector3D(0,0,o),this.addChild(this._boxZ)}return __extends(i,e),i}(t.Object3D);t.AxisMesh=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e){void 0===e&&(e=null),this.cameraAnimationFrames=[],this._playing=!1,this._playTime=0,this._currentFrameIndex=0,this._loop=!0,this._smooth=!0,this._cameraAnimationFrame=new i,this._event=new t.Event3D,this._quatCurrentFrame=new t.Quaternion,this._quatnNextFrame=new t.Quaternion,this._quatn=new t.Quaternion,this._camera=e,this._cameraAnimationFrame.fov=45,this._cameraAnimationFrame.rotation=new t.Vector3D,this._cameraAnimationFrame.translation=new t.Vector3D}return e.prototype.bindCamera=function(t){this._camera=t},e.prototype.play=function(t){this.cameraAnimationFrames.length<=0||(this._loop=t,this._playTime=0,this._camera.isController=!1,this._playing=!0)},e.prototype.stop=function(){this._camera.isController=!0,this._playing=!1},e.prototype.update=function(t,i){if(this._playing){this._playTime+=5*i;var a=this._playTime%(this.cameraAnimationFrames[this.cameraAnimationFrames.length-1].time-this.cameraAnimationFrames[0].time+160),r=Math.floor(a/160)%this.cameraAnimationFrames.length;this._currentFrameIndex>r&&(this._loop||(this._playing=!1,this._camera.isController=!0),this._camera&&(this._event.eventType=e.EVENT_CAMERA_COMPLETE,this._event.target=this,this._camera.dispatchEvent(this._event))),this._currentFrameIndex=r;var n=this.cameraAnimationFrames[r];if(this._smooth){var o=(r+1)%this.cameraAnimationFrames.length,s=this.cameraAnimationFrames[o],h=(a-n.time)/Math.abs(s.time-n.time);this._cameraAnimationFrame.fov=(s.fov-n.fov)*h+n.fov,this._quatCurrentFrame.fromEulerAngles(n.rotation.x,n.rotation.y,n.rotation.z),this._quatnNextFrame.fromEulerAngles(s.rotation.x,s.rotation.y,s.rotation.z),this._quatn.lerp(this._quatCurrentFrame,this._quatnNextFrame,h),this._quatn.toEulerAngles(this._cameraAnimationFrame.rotation),this._cameraAnimationFrame.translation.lerp(n.translation,s.translation,h)}else this._cameraAnimationFrame.fov=n.fov,this._cameraAnimationFrame.rotation.copyFrom(n.rotation),this._cameraAnimationFrame.translation.copyFrom(n.translation);this._camera.rotation=this._cameraAnimationFrame.rotation,this._camera.position=this._cameraAnimationFrame.translation}},e.EVENT_CAMERA_COMPLETE="event_camera_complete",e}();t.CameraAnimationController=e;var i=function(){function t(){}return t}();t.CameraAnimationFrame=i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.cameras=new Array}return t.prototype.addCamera=function(t){this.cameras.push(t)},t.prototype.update=function(t,e){},t.instance=new t,t}();t.CameraManager=e}(egret3d||(egret3d={}));var egret3d;!function(t){!function(t){t[t.perspective=0]="perspective",t[t.orthogonal=1]="orthogonal",t[t.VR=2]="VR"}(t.CameraType||(t.CameraType={}));var e=t.CameraType;!function(t){t[t.left=0]="left",t[t.right=1]="right"}(t.VRType||(t.VRType={}));var i=t.VRType,a=function(a){function r(i){void 0===i&&(i=e.perspective),a.call(this),this.projectMatrix=new t.Matrix4_4,this.frustum=new t.Frustum,this.viewPort=new t.Rectangle,this._viewPort=new t.Rectangle,this._scissorRect=new t.Rectangle,this._aspectRatio=1,this._fovY=45,this._near=1,this._far=1e4,this.temp=new t.Matrix4_4,this._lookAtPosition=new t.Vector3D,this._up=new t.Vector3D(0,1,0),this._cameraType=0,this._cameraMatrixChange=!1,this._viewMatrix=new t.Matrix4_4,this._tempQuat=new t.Quaternion,this._normalMatrix=new t.Matrix4_4,this._unprojection=new t.Matrix4_4,this._animation=[],this.raw=new Float32Array(16),this.v=new t.Vector3D,this.p=new t.Vector3D,this.cameraType=i,t.CameraManager.instance.addCamera(this)}return __extends(r,a),Object.defineProperty(r.prototype,"cameraType",{set:function(i){switch(this._cameraType=i,i){case e.orthogonal:this.projectMatrix.ortho(this._viewPort.width,this._viewPort.height,this._near,this._far);break;case e.perspective:this.projectMatrix.perspective(this._fovY,this._aspectRatio,this._near,this._far);break;case e.VR:this.projectMatrix.perspective(this._fovY,1,this._near,this._far),this.eyeMatrix=this.eyeMatrix||new t.EyesMatrix}},enumerable:!0,configurable:!0}),r.prototype.tap=function(t,a){void 0===a&&(a=null),t==e.VR&&(this.eyeMatrix.update(this),a==i.left?this.viewMatrix.copyFrom(this.eyeMatrix.leftEyeMatrix):a==i.right&&this.viewMatrix.copyFrom(this.eyeMatrix.rightEyeMatrix),this.viewMatrix.invert())
},Object.defineProperty(r.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!=t&&(this._aspectRatio=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"fieldOfView",{get:function(){return this._fovY},set:function(t){this._fovY!=t&&(this._fovY=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"near",{get:function(){return this._near},set:function(t){this._near!=t&&(this._near=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"far",{get:function(){return this._far},set:function(t){this._far!=t&&(this._far=t,this.cameraType=this._cameraType)},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"viewProjectionMatrix",{get:function(){return this.temp.copyFrom(this.viewMatrix),this.temp.multiply(this.projectMatrix),this.temp},enumerable:!0,configurable:!0}),r.prototype.updateScissorRect=function(t,e,i,a){this._scissorRect.x=t,this._scissorRect.y=e,this._scissorRect.width=i,this._scissorRect.height=a},r.prototype.updateViewport=function(t,e,i,a){this._viewPort.x=t,this._viewPort.y=e,this._viewPort.width=i,this._viewPort.height=a},r.prototype.lookAt=function(e,i,a){void 0===a&&(a=t.Vector3D.Y_AXIS),this.position=e,this._lookAtPosition.copyFrom(i),this._up.copyFrom(a),this._viewMatrix.lookAt(this._pos,this._lookAtPosition,this._up),this._viewMatrix.invert();var r=this._viewMatrix.decompose(t.Orientation3D.QUATERNION);this._tempQuat.x=r[1].x,this._tempQuat.y=r[1].y,this._tempQuat.z=r[1].z,this._tempQuat.w=r[1].w,this.orientation=this._tempQuat},r.prototype.onUpdateTransform=function(){this._viewMatrix.copyFrom(this._modelMatrix3D),this._viewMatrix.invert()},Object.defineProperty(r.prototype,"viewMatrix",{get:function(){return this._transformChange&&this.modelMatrix,this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"lookAtPosition",{get:function(){return this._lookAtPosition},enumerable:!0,configurable:!0}),r.prototype.updataOrth=function(){var t,e,i,a,r=2e3,n=.5*r,o=n*this._aspectRatio;if(0==this._scissorRect.x&&0==this._scissorRect.y&&this._scissorRect.width==this._viewPort.width&&this._scissorRect.height==this._viewPort.height)t=-o,e=o,i=-n,a=n,this.raw[0]=2/(r*this._aspectRatio),this.raw[5]=2/r,this.raw[10]=1/(this._far-this._near),this.raw[14]=this._near/(this._near-this._far),this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=this.raw[12]=this.raw[13]=0,this.raw[15]=1;else{var s=o*(this._viewPort.width/this._scissorRect.width),h=n*(this._viewPort.height/this._scissorRect.height),l=o*(2*this._scissorRect.x-this._viewPort.width)/this._scissorRect.width+o,u=-n*(2*this._scissorRect.y-this._viewPort.height)/this._scissorRect.height-n;t=l-s,e=l+s,i=u-h,a=u+h,this.raw[0]=2/(e-t),this.raw[5]=-2/(i-a),this.raw[10]=1/(this._far-this._near),this.raw[12]=(e+t)/(e-t),this.raw[13]=(a+i)/(a-i),this.raw[14]=this._near/(this.near-this.far),this.raw[1]=this.raw[2]=this.raw[3]=this.raw[4]=this.raw[6]=this.raw[7]=this.raw[8]=this.raw[9]=this.raw[11]=0,this.raw[15]=1}this.projectMatrix.copyRawDataFrom(this.raw)},r.prototype.isVisibleToCamera=function(t){return t.modelMatrix,t.bound.inBound(this.frustum)},r.prototype.addAnimation=function(t,e){this._animation[t]=e},r.prototype.play=function(t,e){void 0===e&&(e=!1),this._animation[t]&&(this._animation[t].bindCamera(this),this._animation[t].play(e))},r.prototype.update=function(t,e,i){a.prototype.update.call(this,t,e,i);for(var r in this._animation)this._animation[r].update(t,e)},r.prototype.object3DToScreenRay=function(e,i){return void 0===i&&(i=null),i||(i=new t.Vector3D),this._halfw=.5*this.viewPort.width,this._halfh=.5*this.viewPort.height,i=this.viewMatrix.transformVector(e,i),this.project(i,i),i.x=this._halfw+i.x*this._halfw,i.y=this.viewPort.height-(this._halfh-i.y*this._halfh),i},r.prototype.ScreenRayToObject3D=function(e,i){return void 0===i&&(i=null),i||(i=new t.Vector3D),this._halfw=.5*this.viewPort.width,this._halfh=.5*this.viewPort.height,i.x=(e.x-this._halfw)/this._halfw,i.y=(this._halfh-(this.viewPort.height-e.y))/this._halfh,this.unproject(i.x,i.y,e.z,i),this.modelMatrix.transformVector(i,i),i},r.prototype.unproject=function(t,e,i,a){return a.x=t,a.y=-e,a.z=i,a.w=1,a.x*=i,a.y*=i,this._unprojection.copyFrom(this.projectMatrix),this._unprojection.invert(),this._unprojection.transformVector(a,a),a.z=i,a},r.prototype.project=function(t,e){return e=this.projectMatrix.transformVector(t,e),e.x=e.x/e.w,e.y=-e.y/e.w,e.z=t.z,e},r.prototype.onMakeTransform=function(){t.MathUtil.CALCULATION_VECTOR3D.x=1,t.MathUtil.CALCULATION_VECTOR3D.y=1,t.MathUtil.CALCULATION_VECTOR3D.z=1,this._modelMatrix3D.makeTransform(this._globalPos,t.MathUtil.CALCULATION_VECTOR3D,this._globalOrientation)},r}(t.Object3D);t.Camera3D=a}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.minPosX=0,this.minPosY=0,this.maxPosX=0,this.maxPosY=0,this.testID=0,this.points=new Array,this.offsetPosition=new t.Vector3D(0,0,0,0),this.clear()}return e.prototype.setAABox=function(t,i,a,r){this.minPosX=t-a/2-e.TINY,this.maxPosX=t+a/2+e.TINY,this.minPosY=i-r/2-e.TINY,this.maxPosY=i+r/2+e.TINY,this.offsetPosition.setTo(0,0,0)},e.prototype.setOffset=function(t){this.maxPosX+=t.x-this.offsetPosition.x,this.minPosX+=t.x-this.offsetPosition.x,this.minPosY+=t.z-this.offsetPosition.z,this.maxPosY+=t.z-this.offsetPosition.z,this.offsetPosition.copyFrom(t)},e.prototype.setContainRect=function(t,e,i,a){this.minPosX>t&&(this.minPosX=t),this.minPosY>e&&(this.minPosY=e),this.maxPosX<i&&(this.maxPosX=i),this.maxPosY<a&&(this.maxPosY=a)},e.prototype.clear=function(){var t=1e9;this.minPosX=this.minPosY=t,this.maxPosX=this.maxPosY=-t,this.points.length=0,this.testID=0,this.offsetPosition.setTo(0,0,0)},e.prototype.addPoint=function(t){-1==this.points.indexOf(t)&&(t.x<this.minPosX&&(this.minPosX=t.x-e.TINY),t.x>this.maxPosX&&(this.maxPosX=t.x+e.TINY),t.z<this.minPosY&&(this.minPosY=t.z-e.TINY),t.z>this.maxPosY&&(this.maxPosY=t.z+e.TINY),this.points.push(t))},e.prototype.clone=function(){var t=new e;return t.minPosX=this.minPosX,t.minPosY=this.minPosY,t.maxPosX=this.maxPosX,t.maxPosY=this.maxPosY,t},Object.defineProperty(e.prototype,"radius",{get:function(){return Math.sqrt((this.maxPosY-this.minPosY)*(this.maxPosY-this.minPosY)+(this.maxPosX-this.minPosX)*(this.maxPosX-this.minPosX))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sideX",{get:function(){return this.maxPosX-this.minPosX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sideY",{get:function(){return this.maxPosY-this.minPosY},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centreX",{get:function(){return.5*(this.maxPosX-this.minPosX)+this.minPosX},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centreY",{get:function(){return.5*(this.maxPosY-this.minPosY)+this.minPosY},enumerable:!0,configurable:!0}),e.prototype.overlapTest=function(t){return this.minPosY>=t.maxPosY||this.maxPosY<=t.minPosY||this.minPosX>=t.maxPosX||this.maxPosX<=t.minPosX?!1:!0},e.prototype.isPointInside=function(t){return t.x>=this.minPosX&&t.x<=this.maxPosX&&t.z>=this.minPosY&&t.z<=this.maxPosY},e.prototype.isIntersectLineSegment=function(t,e,i,a){var r=!1,n=e-a,o=i-t,s=t*a-i*e,h=(-s-n*this.minPosX)/o;h<=this.maxPosY&&h>=this.minPosY&&(r=!0),h=(-s-n*this.maxPosX)/o,h<=this.maxPosY&&h>=this.minPosY&&(r=!0);var l=(-s-o*this.minPosY)/n;return l<=this.maxPosX&&l>=this.minPosX&&(r=!0),l=(-s-o*this.maxPosY)/n,l<=this.maxPosX&&l>=this.minPosX&&(r=!0),r},e.TINY=1e-6,e}();t.QuadAABB=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.logDeep=0,this._testID=0,this._cells=new Array,this._quadNodes=new Array,this._cellsToTest=new Array,this._aabb=new t.QuadAABB}return e.prototype.getQuadNode=function(t){return this._quadNodes[t]},e.prototype.clear=function(){this._cells.length=0,this._quadNodes.length=0},e.prototype.initNodes=function(t){this.clear();for(var e=0,i=t.length;i>e;)this._quadNodes.push(t[e]),e++},e.prototype.buildQuadTree=function(e,i){this._aabb.clear();for(var a=0,r=this._quadNodes;a<r.length;a++){var n=r[a];if(n.isTriangle)for(var o=0,s=n.aabb.points;o<s.length;o++){var h=s[o];this._aabb.addPoint(h)}else this._aabb.setContainRect(n.aabb.minPosX,n.aabb.minPosY,n.aabb.maxPosX,n.aabb.maxPosY)}this._cells.length=0,this._rootCell=new t.QuadTreeCell(this._aabb),this._cells.push(this._rootCell);for(var l=this._quadNodes.length,u=0;l>u;u++)this._cells[0].nodeIndices[u]=u;var c=new Array;c.push(0);for(var d,p,f;0!=c.length;)if(p=c.pop(),!(this._cells[p].nodeIndices.length<=e||this._cells[p].aabb.radius<i)){for(u=0;u<t.QuadTreeCell.NUM_CHILDREN;u++){this._cells[p].childCellIndices[u]=this._cells.length,c.push(this._cells.length),this._cells.push(new t.QuadTreeCell(this.createAABox(this._cells[p].aabb,u))),f=this._cells[this._cells.length-1],l=this._cells[p].nodeIndices.length;for(var _=0,m=0;l>m;m++)d=this._cells[p].nodeIndices[m],this.doesNodeIntersectCell(this._quadNodes[d],f)&&(_++,f.nodeIndices.push(d))}this._cells[p].nodeIndices.length=0}},e.prototype.createAABox=function(e,i){var a=e.centreX,r=e.centreY,n=e.sideX,o=e.sideY,s=new t.QuadAABB;switch(i){case 0:s.setAABox(a+n/4,r+o/4,n/2,o/2);break;case 1:s.setAABox(a-n/4,r+o/4,n/2,o/2);break;case 2:s.setAABox(a-n/4,r-o/4,n/2,o/2);break;case 3:s.setAABox(a+n/4,r-o/4,n/2,o/2);break;default:s.setAABox(a+n/4,r-o/4,n/2,o/2)}return s},e.prototype.doesNodeIntersectCell=function(t,e){var i=t.aabb;if(!i.overlapTest(e.aabb))return!1;if(!t.isTriangle)return!0;var a=i.points,r=a[0],n=a[1],o=a[2];if(e.aabb.isPointInside(r)||e.aabb.isPointInside(n)||e.aabb.isPointInside(o))return!0;var s=this.pointInTriangle(e.aabb.minPosX,e.aabb.minPosY,r,n,o)||this.pointInTriangle(e.aabb.minPosX,e.aabb.maxPosY,r,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.maxPosY,r,n,o)||this.pointInTriangle(e.aabb.maxPosX,e.aabb.minPosY,r,n,o);return s?!0:s=e.aabb.isIntersectLineSegment(r.x,r.z,n.x,n.z)||e.aabb.isIntersectLineSegment(r.x,r.z,o.x,o.z)||e.aabb.isIntersectLineSegment(n.x,n.z,o.x,o.z)},e.prototype.getNodesIntersectingtAABox=function(e,i){if(0==this._cells.length)return 0;this._cellsToTest.length=0,this._cellsToTest.push(0),this.incrementTestCounter();for(var a,r,n,o,s=0;0!=this._cellsToTest.length;)if(a=this._cellsToTest.pop(),n=this._cells[a],i.overlapTest(n.aabb))if(n.isLeaf())for(r=n.nodeIndices.length,s=0;r>s;s++)o=this.getQuadNode(n.nodeIndices[s]).aabb,o.testID!=this._testID&&(o.testID=this._testID,i.overlapTest(o)&&e.push(n.nodeIndices[s]));else for(s=0;s<t.QuadTreeCell.NUM_CHILDREN;s++)this._cellsToTest.push(n.childCellIndices[s]);return e.length},e.prototype.pointInTriangle=function(t,e,i,a,r){var n=i,o=a,s=r,h=n.z-o.z,l=o.x-n.x,u=n.x*o.z-o.x*n.z,c=o.z-s.z,d=s.x-o.x,p=o.x*s.z-s.x*o.z,f=s.z-n.z,_=n.x-s.x,m=s.x*n.z-n.x*s.z,v=!1,g=h*t+l*e+u,y=c*t+d*e+p,x=f*t+_*e+m,D=.01;return(g>=-D&&y>=-D&&x>=-D||D>=g&&D>=y&&D>=x)&&(v=!0),v},e.prototype.incrementTestCounter=function(){if(++this._testID,0==this._testID){for(var t=this._quadNodes.length,e=0;t>e;e++)this._quadNodes[e].aabb.testID=0;this._testID=1}},e.prototype.logTree=function(t){if(!(0>t)){this.logDeep++;for(var e=this._cells[t],i="",a=0;a<this.logDeep-1;a++)i+="-|";console.log(i+"i="+t+" "+e.aabb.minPosX.toFixed(2)+" "+e.aabb.maxPosX.toFixed(2)+" "+e.aabb.minPosY.toFixed(2)+" "+e.aabb.maxPosY.toFixed(2));var r;for(r=0;r<e.nodeIndices.length;r++)if(e.nodeIndices[r]>=0){var n=this._quadNodes[e.nodeIndices[r]];console.log(i+" t="+e.nodeIndices[r]+" "+n.aabb.minPosX.toFixed(2)+" "+n.aabb.maxPosX.toFixed(2)+" "+n.aabb.minPosY.toFixed(2)+" "+n.aabb.maxPosY.toFixed(2))}for(r=0;r<e.childCellIndices.length;r++)e.childCellIndices[r]>=0&&this.logTree(e.childCellIndices[r]);this.logDeep--}},e}();t.QuadTree=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){void 0===e&&(e=10),void 0===i&&(i=500),this._maxNodesPerCell=e,this._minCellSize=i,this._segBox=new t.QuadAABB,this._collisionNodesIdx=new Array,this._collisionNodes=new Array}return e.prototype.createQuadTree=function(e){this._quadTree=new t.QuadTree,this._quadTree.initNodes(e),this._quadTree.buildQuadTree(this._maxNodesPerCell,this._minCellSize)},e.prototype.getNodesByAABB=function(t,e,i,a){this._segBox.clear(),this._segBox.maxPosX=i,this._segBox.maxPosY=a,this._segBox.minPosX=t,this._segBox.minPosY=e,this._collisionNodesIdx.length=0,this._collisionNodes.length=0;for(var r,n=(this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox),0);n<this._collisionNodesIdx.length;n++)r=this._quadTree.getQuadNode(this._collisionNodesIdx[n]),this._collisionNodes.push(r);return this._collisionNodes},e.prototype.getTriangleAtPoint=function(e,i){void 0===i&&(i=5),this._segBox.clear(),this._segBox.setAABox(e.x,e.z,1,1),this._collisionNodesIdx.length=0,this._collisionNodes.length=0;for(var a,r,n,o,s=(this._quadTree.getNodesIntersectingtAABox(this._collisionNodesIdx,this._segBox),Number.MAX_VALUE),h=0,l=0;l<this._collisionNodesIdx.length;l++)r=this._quadTree.getQuadNode(this._collisionNodesIdx[l]),o=r.aabb,t.Navi3DTriangle.pointInsideTriangle(e,o.points[0],o.points[1],o.points[2])&&(n=r,h=Math.abs(n.plane.distance(e)),h>i||(null==r||s>=h)&&(a=n,s=h));return a},e}();t.QuadRoot=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(i){this.childCellIndices=new Array,this.childCellIndices.length=e.NUM_CHILDREN,this.nodeIndices=new Array,this.clear(),i?this.aabb=i.clone():this.aabb=new t.QuadAABB}return e.prototype.isLeaf=function(){return-1==this.childCellIndices[0]},e.prototype.clear=function(){for(var t=0;t<e.NUM_CHILDREN;t++)this.childCellIndices[t]=-1;this.nodeIndices.splice(0,this.nodeIndices.length)},e.NUM_CHILDREN=4,e}();t.QuadTreeCell=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this._keys=new Array,this._values=new Array}return t.prototype.getIndexByKey=function(t){return this._keys.indexOf(t)},t.prototype.getValueByKey=function(t){var e=this.getIndexByKey(t);return e>-1?this._values[e]:null},t.prototype.put=function(t,e){if(null==t)return null;var i=this.remove(t);return this._keys.push(t),this._values.push(e),i},t.prototype.remove=function(t){var e,i=this._keys.indexOf(t);return i>-1&&(e=this._values[i],this._keys.splice(i,1),this._values.splice(i,1)),e},t.prototype.getValues=function(){return this._values},t.prototype.getKeys=function(){return this._keys},t.prototype.clear=function(){this._values.length=0,this._keys.length=0},t}();t.DoubleArray=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._findIndex=0,this._openedList=new Array,this._closedList=new Array}return e.prototype.findPath=function(t,e,i){return this._findIndex++,this._navMesh=t,this._startNode=e,this._endNode=i,this._openedList.length=0,this._closedList.length=0,this._startNode&&this._endNode?(this._startNode.g=0,this._startNode.h=0,this._startNode.f=0,this._startNode.parent=null,this.search()):!1},e.prototype.search=function(){for(var e,i=this._startNode,a=new Array;i!=this._endNode;){a=i.getNeibourTriangles(a,t.Navi3DMaskType.WalkAble,t.Navi3DMaskType.WalkAble);for(var r=0,n=a;r<n.length;r++)if(e=n[r],e.closeId!=this._findIndex&&e!=i&&e.walkAble){var o=i.g+t.Navi3DPoint.calcDistance(e,i)*e.costMultiplier,s=t.Navi3DPoint.calcDistance(e,this._endNode),h=o+s;e.openId==this._findIndex?e.f>h&&(e.f=h,e.g=o,e.h=s,e.parent=i):(e.f=h,e.g=o,e.h=s,e.parent=i,e.openId=this._findIndex,this._openedList.push(e))}if(i.closeId=this._findIndex,this._closedList.push(i),0==this._openedList.length)return!1;this._openedList.sort(function(t,e){return t.f-e.f}),i=this._openedList.shift()}return this.buildPath(),!0},e.prototype.buildPath=function(){this._triangleChannel=[];var t=this._endNode;for(this._triangleChannel.push(t);t!=this._startNode;)t=t.parent,this._triangleChannel.unshift(t)},Object.defineProperty(e.prototype,"channel",{get:function(){return this._triangleChannel},enumerable:!0,configurable:!0}),e}();t.Navi3DAstar=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){if(this._edgeMask=0,this._edgeSize=0,this._pointA=e,this._pointB=i,e.id>=i.id)throw new Error("edge point order error!!!");this._triangleOwners=new Array,this._centerPoint=new t.Vector3D,this._edgeMask=t.Navi3DMaskType.WalkAble,t.Navi3DPoint.CALC_VECTOR3D1.setTo(e.x-i.x,e.y-i.y,e.z-i.z),this._edgeSize=t.Navi3DPoint.CALC_VECTOR3D1.length,this._centerPoint.setTo((e.x+i.x)/2,(e.y+i.y)/2,(e.z+i.z)/2)}return Object.defineProperty(e.prototype,"size",{get:function(){return this._edgeSize},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangleOwners",{get:function(){return this._triangleOwners},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"centerPoint",{get:function(){return this._centerPoint},enumerable:!0,configurable:!0}),e.prototype.initFatPoints=function(i){this._edgeDirA2B=this._pointB.subtract(this._pointA),this._edgeDirA2B.normalize(),this.fatPointA=this.fatPointA||new t.Navi3DPointFat(this._pointA,this),this.fatPointB=this.fatPointB||new t.Navi3DPointFat(this._pointB,this),this.fatPointA.radius!=i&&(e.CALC_FAT_VECTOR.copyFrom(this._edgeDirA2B),e.CALC_FAT_VECTOR.scaleBy(i),e.CALC_FAT_VECTOR.incrementBy(this._pointA),this.fatPointA.copyFrom(e.CALC_FAT_VECTOR),this.fatPointA.radius=i),this.fatPointB.radius!=i&&(e.CALC_FAT_VECTOR.copyFrom(this._edgeDirA2B),e.CALC_FAT_VECTOR.scaleBy(-i),e.CALC_FAT_VECTOR.incrementBy(this._pointB),this.fatPointB.copyFrom(e.CALC_FAT_VECTOR),this.fatPointB.radius=i)},e.prototype.getFatPoint=function(t){return t==this._pointA?this.fatPointA:this.fatPointB},e.prototype.getAnotherFatPoint=function(t){return t==this._pointA?this.fatPointB:this.fatPointA},e.prototype.getAnotherPoint=function(t){return t==this._pointA?this._pointB:this._pointA},e.prototype.containsPoint=function(e){return t.Navi3DPoint.equalPoint(e,this._pointA)?this._pointA:t.Navi3DPoint.equalPoint(e,this._pointB)?this._pointB:null},e.prototype.addTriangleOwners=function(t){if(-1==t.edges.indexOf(this))throw new Error("the edge is not belong triangle!!!");-1==this._triangleOwners.indexOf(t)&&this._triangleOwners.push(t)},e.prototype.getPublicPoint=function(t){return this._pointA==t._pointA||this._pointA==t._pointB?this._pointA:this._pointB==t._pointA||this._pointB==t._pointB?this._pointB:null},e.prototype.getEqualPoint=function(e){return t.Navi3DPoint.equalPoint(e,this._pointA)?this._pointA:t.Navi3DPoint.equalPoint(e,this._pointB)?this._pointB:null},Object.defineProperty(e.prototype,"pointA",{get:function(){return this._pointA},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointB",{get:function(){return this._pointB},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"walkAble",{get:function(){return(this._edgeMask&t.Navi3DMaskType.WalkAble)==t.Navi3DMaskType.WalkAble},enumerable:!0,configurable:!0}),e.prototype.testMask=function(t){return(this._edgeMask&t)==t},e.CALC_FAT_VECTOR=new t.Vector3D,e}();t.Navi3DEdge=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.WalkAble=1,t}();t.Navi3DMaskType=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.prototype.setTo=function(t,e){this.x=t,this.y=e},t.prototype.equals=function(t,e){return t==this.x&&e==this.y},t.prototype.equalPoint=function(t){return this.equals(t.x,t.y)},Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},enumerable:!0,configurable:!0}),t.prototype.clone=function(){var e=new t;return e.setTo(this.x,this.y),e},t.prototype.normalize=function(){var t=length;0!=t&&this.setTo(this.x/t,this.y/t)},t}();t.Navi3DPoint2D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t,i,a,r){e.call(this,i,a,r,0),this._pointId=0,this._pointId=t}return __extends(i,e),Object.defineProperty(i.prototype,"id",{get:function(){return this._pointId},enumerable:!0,configurable:!0}),i.equalPoint=function(e,i){return(e.x-i.x)*(e.x-i.x)+(e.y-i.y)*(e.y-i.y)+(e.z-i.z)*(e.z-i.z)<t.Navi3DFunnel.POWER_EPSILON},i.calcDistance=function(t,e){return i.CALC_VECTOR3D3.setTo(t.x-e.x,t.y-e.y,t.z-e.z),i.CALC_VECTOR3D3.length},i.CALC_VECTOR3D1=new t.Vector3D,i.CALC_VECTOR3D2=new t.Vector3D,i.CALC_VECTOR3D3=new t.Vector3D,i.CALC_VECTOR3D4=new t.Vector3D,i.CALC_VECTOR3D5=new t.Vector3D,i}(t.Vector3D);t.Navi3DPoint=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i){t.call(this,e.id,0,0,0),this.radius=0,this._ownerEdge=i,this._ownerPoint=e}return __extends(e,t),Object.defineProperty(e.prototype,"ownerPoint",{get:function(){return this._ownerPoint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ownerEdge",{get:function(){return this._ownerEdge},enumerable:!0,configurable:!0}),e.prototype.scalePoint=function(t){void 0===t&&(t=.7);var i=new e(this._ownerPoint,this._ownerEdge);return i.copyFrom(this),i.decrementBy(this._ownerPoint),i.scaleBy(t),i.radius=i.length,i.incrementBy(this._ownerPoint),i},e}(t.Navi3DPoint);t.Navi3DPointFat=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n){e.call(this,0,0,0,0),this._id=0,this._points=new Array,this._edges=new Array,this._neibourTriangles=new t.DoubleArray,this._pointAgainstEdge=new t.DoubleArray,this._edgeAgainstPoint=new t.DoubleArray,this._mask=0,this.f=0,this.g=0,this.h=0,this.costMultiplier=1,this.openId=0,this.closeId=0,this._id=i,this._mask=t.Navi3DMaskType.WalkAble,this._edges.push(a,r,n);for(var o,s=0,h=this._edges;s<h.length;s++)o=h[s],-1==this._points.indexOf(o.pointA)&&this._points.push(o.pointA),-1==this._points.indexOf(o.pointB)&&this._points.push(o.pointB);this.x=(this._points[0].x+this._points[1].x+this._points[2].x)/3,this.y=(this._points[0].y+this._points[1].y+this._points[2].y)/3,this.z=(this._points[0].z+this._points[1].z+this._points[2].z)/3,this._plane=new t.Plane3D,this._plane.fromPoints(this._points[0],this._points[1],this._points[2]),this._plane.normalize(),this.genarateAgainstData(),this.initAABB()}return __extends(i,e),Object.defineProperty(i.prototype,"aabb",{get:function(){return this._aabbBox},enumerable:!0,configurable:!0}),i.prototype.initAABB=function(){this._aabbBox=new t.QuadAABB,this._aabbBox.addPoint(this._points[0]),this._aabbBox.addPoint(this._points[1]),this._aabbBox.addPoint(this._points[2])},Object.defineProperty(i.prototype,"isTriangle",{get:function(){return!0},enumerable:!0,configurable:!0}),i.prototype.genarateAgainstData=function(){for(var t,e,i=0,a=this._edges;i<a.length;i++){t=a[i];for(var r=0,n=this._points;r<n.length;r++)e=n[r],t.pointA!=e&&t.pointB!=e&&(this._edgeAgainstPoint.put(t,e),this._pointAgainstEdge.put(e,t))}},Object.defineProperty(i.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"plane",{get:function(){return this._plane},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"points",{get:function(){return this._points},enumerable:!0,configurable:!0}),i.prototype.addNeibour=function(t,e){if(!(this._edges.indexOf(t)>=0))throw new Error("the edge is not in triangle!!!");this._neibourTriangles.put(t,e)},i.prototype.getNeibourTriangles=function(t,e,i){void 0===t&&(t=null),void 0===e&&(e=1),void 0===i&&(i=1),t=t||new Array,t.length=0;for(var a,r,n,o=this._neibourTriangles.getKeys(),s=0,h=o;s<h.length;s++)n=h[s],r=n,r.testMask(e)&&(a=this._neibourTriangles.getValueByKey(r),a.testMask(i)&&t.push(a));return t},i.prototype.getEdges=function(t,e){void 0===t&&(t=null),void 0===e&&(e=1),t=t||new Array,t.length=0;for(var i,a=0,r=this._edges;a<r.length;a++)i=r[a],i.testMask(e)&&t.push(i);return t},Object.defineProperty(i.prototype,"walkAble",{get:function(){return this.testMask(t.Navi3DMaskType.WalkAble)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"edges",{get:function(){return this._edges},enumerable:!0,configurable:!0}),i.prototype.testMask=function(t){return(this._mask&t)==t},i.prototype.getEdgeAgainstPoint=function(t){return this._edgeAgainstPoint.getValueByKey(t)},i.prototype.getPointAgainstEdge=function(t){return this._pointAgainstEdge.getValueByKey(t)},i.prototype.getPublicEdge=function(t){if(t&&t!=this)for(var e,i=this._neibourTriangles.getKeys(),a=0,r=i;a<r.length;a++)if(e=r[a],this._neibourTriangles.getValueByKey(e)==t)return e;return null},i.prototype.loopPublicEdge=function(t){var e,i;if(t&&t!=this)for(var a=0,r=this._edges;a<r.length;a++){e=r[a];for(var n=0,o=t._edges;n<o.length;n++)if(i=o[n],e==i)return e}return null},i.prototype.randomPoint=function(){var t=this._points[2].subtract(this._points[0]);t.scaleBy(Math.random()),t.incrementBy(this._points[0]);var e=this._points[1].subtract(t);return e.scaleBy(Math.random()),e.incrementBy(t),e},i.pointInsideTriangle=function(t,e,a,r){return i.pp.setTo(t.x,t.z),i.p1.setTo(e.x,e.z),i.p2.setTo(a.x,a.z),i.p3.setTo(r.x,r.z),i.pointInsideTriangle2d()},i.pointInsideTriangle2d=function(){return i.product2d(i.p1,i.p2,i.p3)>=0?i.product2d(i.p1,i.p2,i.pp)>=0&&i.product2d(i.p2,i.p3,i.pp)>=0&&i.product2d(i.p3,i.p1,i.pp)>=0:i.product2d(i.p1,i.p2,i.pp)<=0&&i.product2d(i.p2,i.p3,i.pp)<=0&&i.product2d(i.p3,i.p1,i.pp)<=0},i.product2d=function(t,e,i){var a=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x);return a>-1e-5&&1e-5>a&&(a=0),a},i.p1=new t.Navi3DPoint2D,i.p2=new t.Navi3DPoint2D,i.p3=new t.Navi3DPoint2D,i.pp=new t.Navi3DPoint2D,i}(t.Vector3D);t.Navi3DTriangle=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i){this._nav3dPoints=new Array,this._nav3dEdges=new Array,this._nav3dTriangles=new Array,this._edgesDict=new t.DoubleArray,this.initPoints(e),this.initEdgesAndTriangles(i),this.createConnections(),this._nav3dAstar=new t.Navi3DAstar,this._nav3dFunnel=new t.Navi3DFunnel,this._terrainQuad=new t.QuadRoot(8,128),this._terrainQuad.createQuadTree(this._nav3dTriangles)}return Object.defineProperty(e.prototype,"edges",{get:function(){return this._nav3dEdges},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"points",{get:function(){return this._nav3dPoints},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"triangles",{get:function(){return this._nav3dTriangles},enumerable:!0,configurable:!0}),e.prototype.getTriangleAtPoint=function(t,e){return void 0===e&&(e=5),this._terrainQuad.getTriangleAtPoint(t,e)},e.prototype.findPath=function(t,e,i){void 0===i&&(i=5),this._path=null,this._triangleList=null;var a=this.getTriangleAtPoint(t,10),r=this.getTriangleAtPoint(e,10),n=this._nav3dAstar.findPath(this,a,r);return n?(this._triangleList=this._nav3dAstar.channel,n=this._nav3dFunnel.searchPath(this,t,e,this._triangleList,i),this._path=this._nav3dFunnel.path,n):!1},e.prototype.initPoints=function(e){for(var i,a,r=e.length,n=0;r>n;n++)i=e[n],a=new t.Navi3DPoint(n,i.x,i.y,i.z),this._nav3dPoints.push(a)},e.prototype.initEdgesAndTriangles=function(e){for(var i,a,r,n,o,s=e.length,h=0;s>h;h++)i=e[h],a=this.tryCreateEdge(i[0],i[1]),r=this.tryCreateEdge(i[1],i[2]),n=this.tryCreateEdge(i[2],i[0]),null!=a&&null!=r&&null!=n&&(o=new t.Navi3DTriangle(h,a,r,n),this._nav3dTriangles.push(o))},e.prototype.tryCreateEdge=function(e,i){if(e==i)throw new Error("edge point index error!!!");if(e>i){var a=e;e=i,i=a}var r=this._edgesDict.getValueByKey(e+"_"+i);return null==r&&(r=new t.Navi3DEdge(this._nav3dPoints[e],this._nav3dPoints[i]),this._nav3dEdges.push(r),this._edgesDict.put(e+"_"+i,r)),r},e.prototype.createConnections=function(){for(var t,e,i,a,r=this._nav3dTriangles.length,n=this._nav3dTriangles.length,o=0;r>o;o++){t=this._nav3dTriangles[o];for(var s=0,h=t.edges;s<h.length;s++)i=h[s],i.addTriangleOwners(t);for(var l=0;n>l;l++)e=this._nav3dTriangles[l],t!=e&&(a=t.loopPublicEdge(e),a&&(t.addNeibour(a,e),e.addNeibour(a,t)))}},e}();t.Navi3DMesh=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._aiRadius=0,this._tempPublicEdgeList=new Array,this._tempSamePlaneList=new Array,this._router=new t.Navi3DRouter}return e.prototype.searchPath=function(t,e,i,a,r){return void 0===r&&(r=0),0>=r&&(r=1),this._aiRadius=1.5*r,this._navMesh=t,this.searchEnable(e,i,a)?(this.search(e,i,a),!0):!1},Object.defineProperty(e.prototype,"path",{get:function(){return this._result},enumerable:!0,configurable:!0}),e.prototype.searchEnable=function(i,a,r){return null==i||null==a||null==this._navMesh||null==r?!1:r[0].plane.classifyPoint(i,e.EPSILON)!=t.PlaneClassification.INTERSECT?!1:r[r.length-1].plane.classifyPoint(a,e.EPSILON)!=t.PlaneClassification.INTERSECT?!1:!0},e.prototype.search=function(i,a,r){this._tempPublicEdgeList.length=0,this._tempSamePlaneList.length=0;var n,o,s,h,l=0,u=r.length-1;for(l=0;u>l;l++)o=r[l].getPublicEdge(r[l+1]),o.crossPoint=null,o.initFatPoints(this._aiRadius),this._tempPublicEdgeList.push(o),n=r[l],h=n.plane,n=r[l+1],s=n.getEdgeAgainstPoint(o),this._tempSamePlaneList.push(h.classifyPoint(s,e.EPSILON)==t.PlaneClassification.INTERSECT);this._router.continuePass(i,a,this._tempPublicEdgeList[0]),u=this._tempPublicEdgeList.length;var c,d,p,f;for(l=0;u>l;l++)o=this._tempPublicEdgeList[l],n=r[l+1],f=l==u-1,s=f?a:n.getEdgeAgainstPoint(o),p=this._router.passEdge(o,this._tempPublicEdgeList[l+1],s,f),p||(c=this._router.cornerPoint,d=this._router.cornerEdge,l=this._tempPublicEdgeList.indexOf(d),this._router.continuePass(c,a,this._tempPublicEdgeList[l+1]));this.pushAllPathPoint2(i,a),this._result.length>=3&&(this.optimusTerminusFat(),this.optimusByRadius())},e.prototype.optimusTerminusFat=function(){var e,i,a;a=this._result[1],a instanceof t.Navi3DPointFat&&(e=a),a=this._result[this._result.length-2],a instanceof t.Navi3DPointFat&&(i=a),e&&(this._result[1]=e.scalePoint()),i&&e!=i&&(this._result[this._result.length-2]=i.scalePoint())},e.prototype.pushAllPathPoint2=function(t,i){var a,r,n=this._tempPublicEdgeList.length;this._result=new Array,this._result.push(t);for(var o,s,h,l=t,u=0;n>u;u++)if(a=this._tempPublicEdgeList[u],s=null,a.crossPoint)s=this.getFatPoint(a,a.crossPoint),s?this._result.push(s):this._result.push(a.crossPoint),l=a.crossPoint;else{r=null,o=null;for(var c=u+1;n>c&&(r=this._tempPublicEdgeList[c],!(o=r.crossPoint));c++);null==o&&(o=i),s=this.getFatPoint(a,o),s?this._result.push(s):(e.CROSS_TEST_DIRECTION.setTo(o.x-l.x,0,o.z-l.z),h=this._router.calcCrossEdge(a,l,e.CROSS_TEST_DIRECTION),this._result.push(h))}this._result.push(i)},e.prototype.optimusByRadius=function(){var i=new Array;i.length=this._result.length;var a,r,n,o,s,h,l,u,c,d,p,f,_,m=this._result.length-2;for(_=0;m>_;_++)l=u=c=null,o=s=h=null,p=!1,f=null,a=this._result[_],r=this._result[_+1],n=this._result[_+2],a instanceof t.Navi3DPointFat&&(o=a),r instanceof t.Navi3DPointFat&&(s=r),n instanceof t.Navi3DPointFat&&(h=n),o&&(l=o.ownerPoint),s&&(u=s.ownerPoint),h&&(c=h.ownerPoint),l&&u&&l==u&&u!=c&&(p=!0),c&&u&&c==u&&l!=u&&(p=!0),p&&(e.CROSS_TEST_DIRECTION.copyFrom(a),e.CROSS_TEST_DIRECTION.decrementBy(n),d=s.ownerEdge,p=this._router.hasCrossPoint(d.pointA,d.pointB,n,e.CROSS_TEST_DIRECTION),p&&(f=this._router.calcCrossPointOut(u,r,n,e.CROSS_TEST_DIRECTION)),f&&(i[_+1]=f))},e.prototype.getFatPoint=function(e,i){if(null==e)return null;var a;i instanceof t.Navi3DPointFat&&(a=i);var r;return r=a?a.ownerPoint:e.getEqualPoint(i),null==r?null:a=e.getFatPoint(r)},e.EPSILON=5,e.POWER_EPSILON=e.EPSILON*e.EPSILON,e.CROSS_TEST_DIRECTION=new t.Vector3D,e}();t.Navi3DFunnel=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.prototype.continuePass=function(t,e,i){this.resetData(),this.curPoint=t,this.endPoint=e,this.cornerEdge=i},e.prototype.passEdge=function(i,a,r,n){if((null==this.rayA||null==this.rayB)&&(this.rayA=e.RAY_1,this.rayB=e.RAY_2,this.rayAPoint=i.pointA,this.rayBPoint=i.pointB,this.rayA.setTo(this.rayAPoint.x-this.curPoint.x,0,this.rayAPoint.z-this.curPoint.z),this.rayB.setTo(this.rayBPoint.x-this.curPoint.x,0,this.rayBPoint.z-this.curPoint.z)),n)return this.checkEndPoint(r);
if(e.TEST_RAY.setTo(r.x-this.curPoint.x,0,r.z-this.curPoint.z),this.isPointAtCenter(e.TEST_RAY,this.rayA,this.rayB)){this.hasCrossPoint(a.pointA,a.pointB,this.rayAPoint,this.rayA)?(this.rayB.copyFrom(e.TEST_RAY),r instanceof t.Navi3DPoint?this.rayBPoint=r:this.rayBPoint=null):(this.rayA.copyFrom(e.TEST_RAY),r instanceof t.Navi3DPoint?this.rayAPoint=r:this.rayAPoint=null);var o=a.getAnotherPoint(r);e.TEST_RAY.setTo(o.x-this.curPoint.x,0,o.z-this.curPoint.z),(o==this.rayAPoint||o==this.rayBPoint||this.isPointAtCenter(e.TEST_RAY,this.rayA,this.rayB))&&(this.cornerEdge=a)}else{var s;if(e.TEST_RAY_1.copyFrom(a.pointA),e.TEST_RAY_1.decrementBy(this.curPoint),e.TEST_RAY_2.copyFrom(a.pointB),e.TEST_RAY_2.decrementBy(this.curPoint),e.TEST_RAY_1.y=0,e.TEST_RAY_2.y=0,s=this.isPointAtCenter(this.rayA,e.TEST_RAY_1,e.TEST_RAY_2)||this.isPointAtCenter(this.rayB,e.TEST_RAY_1,e.TEST_RAY_2)?!1:!0)return this.isPointAtCenter(this.rayA,e.TEST_RAY,this.rayB)?this.cornerPoint=this.rayAPoint:this.cornerPoint=this.rayBPoint,this.cornerEdge.crossPoint=this.cornerPoint,!1}return!0},e.prototype.checkEndPoint=function(t){return e.TEST_RAY.setTo(t.x-this.curPoint.x,0,t.z-this.curPoint.z),this.isPointAtCenter(e.TEST_RAY,this.rayA,this.rayB)?!0:(this.isPointAtCenter(this.rayA,e.TEST_RAY,this.rayB)?this.cornerPoint=this.rayAPoint:this.cornerPoint=this.rayBPoint,this.cornerEdge.crossPoint=this.cornerPoint,!1)},e.prototype.calcCrossEdge=function(t,e,i){return this.calcCrossPoint(t.fatPointA,t.fatPointB,e,i)},e.prototype.calcCrossPoint=function(t,i,a,r){e.CALC_CROSS_POINT.copyFrom(i),e.CALC_CROSS_POINT.decrementBy(t);var n=((t.z-a.z)*r.x-(t.x-a.x)*r.z)/(e.CALC_CROSS_POINT.x*r.z-r.x*e.CALC_CROSS_POINT.z);return n>1?n=1:0>n&&(n=0),e.CALC_CROSS_POINT.scaleBy(n),e.CALC_CROSS_POINT.incrementBy(t),e.CALC_CROSS_POINT.clone()},e.prototype.calcCrossPointOut=function(t,i,a,r){e.CALC_CROSS_POINT.copyFrom(i),e.CALC_CROSS_POINT.decrementBy(t);var n=((t.z-a.z)*r.x-(t.x-a.x)*r.z)/(e.CALC_CROSS_POINT.x*r.z-r.x*e.CALC_CROSS_POINT.z);return 1>=n&&n>=0?null:(e.CALC_CROSS_POINT.scaleBy(n),e.CALC_CROSS_POINT.incrementBy(t),e.CALC_CROSS_POINT.clone())},e.prototype.hasCrossPoint=function(t,i,a,r){e.CALC_CROSS_TEST.copyFrom(i),e.CALC_CROSS_TEST.decrementBy(t);var n=((t.z-a.z)*r.x-(t.x-a.x)*r.z)/(e.CALC_CROSS_TEST.x*r.z-r.x*e.CALC_CROSS_TEST.z);return 1>=n&&n>=0},e.prototype.isPointAtCenter=function(t,e,i){var a=e.crossProduct(t);if(0==a.length&&t.length<e.length)return!0;var r=i.crossProduct(t);return 0==r.length&&t.length<i.length?!0:(a.normalize(),r.normalize(),a.incrementBy(r),a.length<.01)},e.prototype.resetData=function(){this.cornerEdge=null,this.cornerPoint=null,this.curPoint=null,this.rayA=this.rayB=null,this.rayAPoint=this.rayBPoint=null,e.RAY_1.setTo(0,0,0),e.RAY_2.setTo(0,0,0)},e.RAY_1=new t.Vector3D,e.RAY_2=new t.Vector3D,e.TEST_RAY=new t.Vector3D,e.TEST_RAY_1=new t.Vector3D,e.TEST_RAY_2=new t.Vector3D,e.CALC_CROSS_POINT=new t.Vector3D,e.CALC_CROSS_TEST=new t.Vector3D,e}();t.Navi3DRouter=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i,a,r){void 0===e&&(e=0),void 0===i&&(i=0),void 0===a&&(a=100),void 0===r&&(r=100),this._rectangle=new t.Rectangle,this._transformMatrix=new t.Matrix4_4,this._change=!1,this._rotation=new t.Vector3D,this._scale=new t.Vector3D(1,1,1),this._position=new t.Vector3D,this._transformComponents=[],this._changeTexture=!1,this._textureStage=!1,this._vertexFormat=t.VertexFormat.VF_POSITION|t.VertexFormat.VF_UV0,this._uv_scale=new Float32Array(2),this.name="",this.bothside=!1,this.cullMode=t.ContextConfig.BACK,this.visible=!0,this.vsShader="hud_vs",this.fsShader="hud_V_fs",this._passUsage=new t.PassUsage,this._attList=new Array,this._transformComponents.push(this._position),this._transformComponents.push(this._rotation),this._transformComponents.push(this._scale),this.x=e,this.y=i,this.width=a,this.height=r,this._uv_scale[0]=1,this._uv_scale[1]=1}return Object.defineProperty(e.prototype,"diffuseTexture",{get:function(){return this._diffuseTexture},set:function(t){this._changeTexture=!0,this._diffuseTexture=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._rectangle.x},set:function(t){this._change=!0,this._rectangle.x=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._rectangle.y},set:function(t){this._change=!0,this._rectangle.y=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._rectangle.width},set:function(t){this._change=!0,this._rectangle.width=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._rectangle.height},set:function(t){this._change=!0,this._rectangle.height=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationX",{get:function(){return this._rotation.x},set:function(t){this._change=!0,this._rotation.x!=t&&(this._rotation.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationY",{get:function(){return this._rotation.y},set:function(t){this._change=!0,this._rotation.y!=t&&(this._rotation.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rotationZ",{get:function(){return this._rotation.z},set:function(t){this._change=!0,this._rotation.z!=t&&(this._rotation.z=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewPort",{set:function(t){this._viewPort=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"uScale",{get:function(){return this._uv_scale[0]},set:function(t){this._uv_scale[0]=t,this._uv_scale[0]>1&&(this._uv_scale[0]=1),this._uv_scale[0]<0&&(this._uv_scale[0]=0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vScale",{get:function(){return this._uv_scale[1]},set:function(t){this._uv_scale[1]=t,this._uv_scale[1]>1&&(this._uv_scale[1]=1),this._uv_scale[1]<0&&(this._uv_scale[1]=0)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"transformMatrix",{get:function(){return this._viewPort?(this._change&&(this._scale.x=this._rectangle.width/this._viewPort.width,this._scale.y=this._rectangle.height/this._viewPort.height,this._position.x=t.MathUtil.ScreenToPosition(this._rectangle.x,this._rectangle.width,this._viewPort.width),this._position.y=-t.MathUtil.ScreenToPosition(this._rectangle.y,this._rectangle.height,this._viewPort.height),this._transformMatrix.recompose(this._transformComponents),this._change=!1),this._transformMatrix):this._transformMatrix},enumerable:!0,configurable:!0}),e.prototype.updateTexture=function(t){var e;for(var i in this._passUsage.sampler2DList)e=this._passUsage.sampler2DList[i],e.uniformIndex=t.getUniformLocation(this._passUsage.program3D,e.varName),e.texture=this[e.varName];this._changeTexture=!1},e.prototype.upload=function(i){this._vertexBuffer3D||(this._vertexBuffer3D=i.creatVertexBuffer(e.singleQuadData)),this._indexBuffer3D||(this._indexBuffer3D=i.creatIndexBuffer(e.singleQuadIndex)),this._passUsage.vertexShader.shaderType=t.Shader.vertex,this._passUsage.fragmentShader.shaderType=t.Shader.fragment,this._passUsage.vertexShader.addUseShaderName(this.vsShader),this._passUsage.fragmentShader.addUseShaderName(this.fsShader),this._passUsage.vertexShader.shader=this._passUsage.vertexShader.getShader(this._passUsage),this._passUsage.fragmentShader.shader=this._passUsage.fragmentShader.getShader(this._passUsage),this._passUsage.program3D=t.ShaderPool.getProgram(this._passUsage.vertexShader.shader.id,this._passUsage.fragmentShader.shader.id);for(var a in this._passUsage)-1!=a.indexOf("uniform")&&this._passUsage[a]&&(this._passUsage[a].uniformIndex=i.getUniformLocation(this._passUsage.program3D,a));this._attList.length=0;var r=0;this._passUsage.attribute_position&&(this._passUsage.attribute_position.uniformIndex||(this._passUsage.attribute_position.uniformIndex=i.getShaderAttribLocation(this._passUsage.program3D,this._passUsage.attribute_position.varName)),this._attList.push(this._passUsage.attribute_position),this._passUsage.attribute_position.size=t.Geometry.positionSize,this._passUsage.attribute_position.dataType=t.ContextConfig.FLOAT,this._passUsage.attribute_position.normalized=!1,this._passUsage.attribute_position.stride=e.vertexBytes,this._passUsage.attribute_position.offset=r,r+=t.Geometry.positionSize*Float32Array.BYTES_PER_ELEMENT),this._passUsage.attribute_uv0&&(this._passUsage.attribute_uv0.uniformIndex||(this._passUsage.attribute_uv0.uniformIndex=i.getShaderAttribLocation(this._passUsage.program3D,this._passUsage.attribute_uv0.varName)),this._attList.push(this._passUsage.attribute_uv0),this._passUsage.attribute_uv0.size=t.Geometry.uvSize,this._passUsage.attribute_uv0.dataType=t.ContextConfig.FLOAT,this._passUsage.attribute_uv0.normalized=!1,this._passUsage.attribute_uv0.stride=e.vertexBytes,this._passUsage.attribute_uv0.offset=r,r+=t.Geometry.uvSize*Float32Array.BYTES_PER_ELEMENT),this._passUsage.uv_scale=i.getUniformLocation(this._passUsage.program3D,"uv_scale")},e.prototype.draw=function(e){if(this.visible){this._passUsage.program3D||this.upload(e),e.setProgram(this._passUsage.program3D),e.bindVertexBuffer(this._vertexBuffer3D),e.bindIndexBuffer(this._indexBuffer3D),e.activeVertexFormat(this._vertexFormat);for(var i=0;i<this._attList.length;++i)e.vertexAttribPointer(this._attList[i].uniformIndex,this._attList[i].size,this._attList[i].dataType,this._attList[i].normalized,this._attList[i].stride,this._attList[i].offset);this._changeTexture&&this.updateTexture(e);var a;for(var r in this._passUsage.sampler2DList)a=this._passUsage.sampler2DList[r],a.texture&&(a.texture.upload(e),e.setTexture2DAt(a.activeTextureIndex,a.uniformIndex,a.index,a.texture.texture2D),this._textureStage&&(a.texture.activeState(e),this._textureStage=!1));this._passUsage.uniform_ViewProjectionMatrix&&e.uniformMatrix4fv(this._passUsage.uniform_ViewProjectionMatrix.uniformIndex,!1,this.transformMatrix.rawData),this._passUsage.uv_scale&&-1!=this._passUsage.uv_scale&&e.uniform2f(this._passUsage.uv_scale,this._uv_scale[0],this._uv_scale[1]),e.setCulling(this.cullMode),this.bothside?e.disableCullFace():e.enableCullFace(),e.enableBlend(),e.setBlendFactors(t.ContextConfig.SRC_ALPHA,t.ContextConfig.ONE_MINUS_SRC_ALPHA),e.drawElement(t.DrawMode.TRIANGLES,0,6),e.clear(t.ContextConfig.DEPTH_BUFFER_BIT)}},e.singleQuadData=[-1,-1,0,0,1,1,-1,0,1,1,1,1,0,1,0,-1,1,0,0,0],e.singleQuadIndex=[0,1,2,0,2,3],e.vertexBytes=20,e}();t.HUD=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(e,i,a,r,n){void 0===n&&(n=null),this._viewPort=new t.Rectangle,this._scene=new t.Scene3D,this._scissorRect=new t.Rectangle,this._viewMatrix=new t.Matrix4_4,this._backColor=new t.Vector3D(.3,.3,.6,1),this._cleanParmerts=t.Context3DProxy.gl.COLOR_BUFFER_BIT|t.Context3DProxy.gl.DEPTH_BUFFER_BIT,this._sizeDiry=!1,this._huds=new Array,this._postList=[],this.a=0,this._entityCollect=new t.EntityCollect,this._entityCollect.root=this._scene,this._render=new t.MultiRender(t.PassType.diffusePass),this._camera=n||new t.Camera3D(t.CameraType.perspective),this._camera.name="MainCamera",this._scene.addChild3D(this._camera),this._viewPort.x=e,this._viewPort.y=i,this._viewPort.width=a,this._viewPort.height=r,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height)}return Object.defineProperty(e.prototype,"render",{get:function(){return this._render},set:function(t){this._render=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"post",{set:function(e){this._postList=e,e.length>0&&(this._postProcessing=this._postProcessing||new t.PostProcessing,this._postHUD=this._postHUD||new t.HUD(0,0,512,512),this._postHUD.fsShader="hud_H_fs")},enumerable:!0,configurable:!0}),e.prototype.blender=function(e,i){this._cleanParmerts=(e?t.Context3DProxy.gl.COLOR_BUFFER_BIT:0)|(i?t.Context3DProxy.gl.DEPTH_BUFFER_BIT:0)},Object.defineProperty(e.prototype,"backColor",{get:function(){return 255*this._backColor.w<<24|255*this._backColor.x<<16|255*this._backColor.y<<8|255*this._backColor.z},set:function(t){this._backColor.w=(t>>24&255)/255,this._backColor.x=(t>>16&255)/255,this._backColor.y=(t>>8&255)/255,this._backColor.z=(255&t)/255},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"backImage",{get:function(){return this._backImg.diffuseTexture},set:function(e){e&&(this._backImg=this._backImg||new t.HUD,this._backImg.diffuseTexture=e,this._backImg.x=this.x,this._backImg.y=this.y,this._backImg.width=this.width,this._backImg.height=this.height)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"camera3D",{get:function(){return this._camera},set:function(t){this._camera=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(t){this._scene=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"x",{get:function(){return this._viewPort.x},set:function(t){this._viewPort.x=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.x=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return this._viewPort.y},set:function(t){this._viewPort.y=t,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.y=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this._viewPort.width},set:function(t){this._viewPort.width=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.width=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._viewPort.height},set:function(t){this._viewPort.height=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this._camera.updateViewport(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),this._backImg&&(this._backImg.height=t)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewPort",{get:function(){return this._viewPort},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"entityCollect",{get:function(){return this._entityCollect},enumerable:!0,configurable:!0}),e.prototype.addChild3D=function(t){this._scene.addChild3D(t)},e.prototype.removeChild3D=function(t){this._scene.removeChild3D(t)},e.prototype.inView3D=function(t,e){return this._viewPort.inner(t,e)},e.prototype.addHUD=function(t){-1==this._huds.indexOf(t)&&(t.viewPort=this._viewPort,this._huds.push(t))},e.prototype.findHud=function(t){for(var e=0;e<this._huds.length;++e)if(this._huds[e].name==t)return this._huds[e];return null},e.prototype.delHUD=function(t){var e=this._huds.indexOf(t);e>=0&&e<this._huds.length&&this._huds.splice(e,1)},e.prototype.update=function(e,i){if(this._camera.viewPort=this._viewPort,this._entityCollect.update(this._camera),t.Egret3DEngine.debug){t.Egret3DState.showDataInfo("drawCall : "+this._entityCollect.numberDraw.toString()),t.Egret3DState.showDataInfo("vertex : "+this._entityCollect.numberVertex.toString()),t.Egret3DState.showDataInfo("tris : "+this._entityCollect.numberFace.toString()),t.Egret3DState.showDataInfo("skin : "+this._entityCollect.numberSkin.toString()),t.Egret3DState.showDataInfo("proAnim : "+this._entityCollect.numberAnimation.toString()),t.Egret3DState.showDataInfo("particleEmiter : "+this._entityCollect.numberParticle.toString());for(var a,r=0;r<t.Layer.layerType.length;r++)a=t.Layer.layerType[r]+" layer: "+this._entityCollect.softRenderItems[t.Layer.layerType[r]].length.toString(),t.Egret3DState.showDataInfo(a)}if(this.updateObject3D(this._scene.root,e,i),t.Egret3DCanvas.context3DProxy.viewPort(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),t.Egret3DCanvas.context3DProxy.setScissorRectangle(this._viewPort.x,this._viewPort.y,this._viewPort.width,this._viewPort.height),t.ShadowCast.instance.shadowRender[0]){t.MathUtil.CALCULATION_QUATERNION.fromEulerAngles(0,this.a++,0);var n=new t.Vector3D(0,-1,-1);t.MathUtil.CALCULATION_QUATERNION.transformVector(n,t.ShadowCast.instance.dir),t.ShadowCast.instance.shadowRender[0].draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,t.ShadowCast.instance.shadowCamera,this._viewPort,!0)}this._cleanParmerts&t.Context3DProxy.gl.COLOR_BUFFER_BIT&&t.Egret3DCanvas.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),t.Egret3DCanvas.context3DProxy.clear(this._cleanParmerts),this._backImg&&this._backImg.draw(t.Egret3DCanvas.context3DProxy),this._postList.length>0?(this._postProcessing.postItem=this._postList,this._postProcessing.drawFrameBuffer(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._camera,this._viewPort),this._postHUD.diffuseTexture=this._postProcessing.endTexture,this._postHUD.draw(t.Egret3DCanvas.context3DProxy)):this._render.draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._camera,this._viewPort);for(var r=0;r<this._huds.length;++r)this._huds[r].draw(t.Egret3DCanvas.context3DProxy)},e.prototype.updateObject3D=function(t,e,i){if(t){t.update(e,i,this.camera3D);for(var a=0;a<t.childs.length;++a)this.updateObject3D(t.childs[a],e,i)}},e.requestFullScreen=function(){var t=document.documentElement;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()},e.exitFullscreen=function(){var t=document;t.exitFullscreen?t.exitFullscreen():t.webkitCancelFullScreen&&t.webkitCancelFullScreen()},e}();t.View3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,a,r,n){e.call(this,i,a,r,n,new t.Camera3D(t.CameraType.VR)),this.leftViewPort=new t.Rectangle,this.rightViewPort=new t.Rectangle,this.updateViewport()}return __extends(i,e),i.prototype.updateViewport=function(){this.leftViewPort.x=this._viewPort.x,this.leftViewPort.y=this._viewPort.y,this.leftViewPort.width=this._viewPort.width/2,this.leftViewPort.height=this._viewPort.height,this.rightViewPort.x=this._viewPort.x+this.leftViewPort.width,this.rightViewPort.y=this._viewPort.y,this.rightViewPort.width=this.leftViewPort.width,this.rightViewPort.height=this.leftViewPort.height},Object.defineProperty(i.prototype,"x",{set:function(t){this._viewPort.x=t,this.updateViewport()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{set:function(t){this._viewPort.y=t,this.updateViewport()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{set:function(t){this._viewPort.width=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this.updateViewport()},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{set:function(t){this._viewPort.height=t,this._camera.aspectRatio=this._viewPort.width/this._viewPort.height,this.updateViewport()},enumerable:!0,configurable:!0}),i.prototype.update=function(e,i){for(this._entityCollect.update(this._camera),this._numberEntity=this._entityCollect.renderList.length,this._index=0;this._index<this._numberEntity;this._index++)this._entityCollect.renderList[this._index].update(e,i,this._camera);var a=this.leftViewPort;this._camera.viewPort=a,this._camera.tap(t.CameraType.VR,t.VRType.left),t.Egret3DCanvas.context3DProxy.viewPort(a.x,a.y,a.width,a.height),t.Egret3DCanvas.context3DProxy.setScissorRectangle(a.x,a.y,a.width,a.height),this._cleanParmerts&t.Context3DProxy.gl.COLOR_BUFFER_BIT&&t.Egret3DCanvas.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),t.Egret3DCanvas.context3DProxy.clear(this._cleanParmerts),this._render.draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._camera),a=this.rightViewPort,this._camera.viewPort=a,this._camera.tap(t.CameraType.VR,t.VRType.right),t.Egret3DCanvas.context3DProxy.viewPort(a.x,a.y,a.width,a.height),t.Egret3DCanvas.context3DProxy.setScissorRectangle(a.x,a.y,a.width,a.height),this._cleanParmerts&t.Context3DProxy.gl.COLOR_BUFFER_BIT&&t.Egret3DCanvas.context3DProxy.clearColor(this._backColor.x,this._backColor.y,this._backColor.z,this._backColor.w),t.Egret3DCanvas.context3DProxy.clear(this._cleanParmerts),this._render.draw(e,i,t.Egret3DCanvas.context3DProxy,this._entityCollect,this._camera)},Object.defineProperty(i.prototype,"eyeDistance",{get:function(){return this._camera.eyeMatrix.eyeSpace},set:function(t){this._camera.eyeMatrix.eyeSpace=t},enumerable:!0,configurable:!0}),i}(t.View3D);t.VRView3D=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(a){void 0===a&&(a=!1),e.call(this),this.canvas3DRectangle=new t.Rectangle,this._view3DS=new Array,this.sizeDiry=!0,this._time=0,this._delay=0,this._renderer=0,this._timeDate=null,this.offsetX=0,this.offsetY=0,t.ShaderUtil.instance.load(),this._envetManager=new t.EventManager(this),this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.zIndex="-1",document.getElementsByClassName("egret-player").length>0?document.getElementsByClassName("egret-player")[0].appendChild(this.canvas):document.body.appendChild(this.canvas),this.canvas.id="egret3D",this.canvas.oncontextmenu=function(){return!1},i.context3DProxy=new t.Context3DProxy,t.Context3DProxy.gl=this.canvas.getContext("experimental-webgl"),t.Context3DProxy.gl||(t.Context3DProxy.gl=this.canvas.getContext("webgl")),t.Context3DProxy.gl||alert("you drivers not suport webgl"),i.context3DProxy.register(),console.log("this.context3D ==>",t.Context3DProxy.gl),t.Input.canvas=this,this.initEvent()}return __extends(i,e),i.prototype.initEvent=function(){this._enterFrameEvent3D=new t.Event3D(t.Event3D.ENTER_FRAME),this._enterFrameEvent3D.target=this},Object.defineProperty(i.prototype,"x",{get:function(){return this.canvas3DRectangle.x},set:function(t){this.canvas3DRectangle.x!=t&&this.resize(t,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"y",{get:function(){return this.canvas3DRectangle.y},set:function(t){this.canvas3DRectangle.y!=t&&this.resize(this.canvas3DRectangle.x,t,this.canvas3DRectangle.width,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"width",{get:function(){return this.canvas3DRectangle.width},set:function(t){this.canvas3DRectangle.width!=t&&this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,t,this.canvas3DRectangle.height)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"height",{get:function(){return this.canvas3DRectangle.height},set:function(t){this.canvas3DRectangle.height!=t&&this.resize(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"view3Ds",{get:function(){return this._view3DS},enumerable:!0,configurable:!0}),i.prototype.addView3D=function(t){var e=this._view3DS.indexOf(t);-1==e&&this._view3DS.push(t)},i.prototype.removeView3D=function(t){var e=this._view3DS.indexOf(t);-1!=e&&this._view3DS.splice(e)},i.prototype.start=function(){this.update(0)},i.prototype.update=function(e){var a=this;this._timeDate=new Date,this._delay=this._timeDate.getTime()-this._time,this._time=this._timeDate.getTime(),this._enterFrameEvent3D.time+=this._time,this._enterFrameEvent3D.delay=this._delay,this.dispatchEvent(this._enterFrameEvent3D),i.context3DProxy.enableBlend(),i.context3DProxy.enableCullFace(),t.Context3DProxy.gl.enable(t.Context3DProxy.gl.SCISSOR_TEST),i.context3DProxy.viewPort(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height),i.context3DProxy.setScissorRectangle(this.canvas3DRectangle.x,this.canvas3DRectangle.y,this.canvas3DRectangle.width,this.canvas3DRectangle.height),t.CameraManager.instance.update(this._time,this._delay);for(var r=0;r<this._view3DS.length;r++)this._view3DS[r].update(this._time,this._delay);t.Egret3DEngine.debug&&(this._renderer=(new Date).getTime()-this._time,t.Egret3DState.showTime(this._time,this._delay),t.Egret3DState.showDataInfo("renderer: "+this._renderer.toString()+" ms"),t.Egret3DState.show()),requestAnimationFrame(function(t){return a.update(t)})},i.prototype.resize=function(e,i,a,r){this.canvas3DRectangle.x=e,this.canvas3DRectangle.y=i,this.canvas3DRectangle.width=a,this.canvas3DRectangle.height=r,t.ContextConfig.canvasRectangle=this.canvas3DRectangle,this.canvas.style.left=this.canvas3DRectangle.x.toString()+"px",this.canvas.style.top=this.canvas3DRectangle.y.toString()+"px",this.canvas.width=this.canvas3DRectangle.width,this.canvas.height=this.canvas3DRectangle.height},i}(t.EventDispatcher);t.Egret3DCanvas=e}(egret3d||(egret3d={}));var egret3d;!function(egret3d){var Egret3DEngine=function(){function Egret3DEngine(){}return Egret3DEngine.getXHR=function(){var t=null;return t=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP")},Egret3DEngine.preload=function(t){return this._complete=t,null==this._xhr&&(this._xhr=this.getXHR()),null==this._xhr?void alert("Your browser does not support XMLHTTP."):(this._xhr.readyState>0&&this._xhr.abort(),this._xhr.open("GET",this._libUrl+"?"+1e5*Math.random(),!0),this._xhr.addEventListener("progress",function(t){return Egret3DEngine.onProgress(t)},!1),this._xhr.addEventListener("readystatechange",function(t){return Egret3DEngine.onReadyStateChange(t)},!1),this._xhr.addEventListener("error",function(t){return Egret3DEngine.onError(t)},!1),this._xhr.responseType="text",void this._xhr.send())},Egret3DEngine.onReadyStateChange=function(t){4==this._xhr.readyState&&(this._xhr.status>=400||0==this._xhr.status?console.log(this._libUrl,"load fail"):this.loadComplete())},Egret3DEngine.loadComplete=function(){var t=this._xhr.responseText;this.applyClass(t)},Egret3DEngine.onProgress=function(t){var e=t.loaded.toString()+t.total;console.log("progress event```"+e)},Egret3DEngine.onError=function(t){console.log("load error",t)},Egret3DEngine.applyClass=function(source){for(var obj=eval("("+source+")"),i=0;i<obj.files.length;++i)Egret3DEngine.importList[i]="/js/Egret3D/",Egret3DEngine.importList[i]+=obj.files[i],Egret3DEngine.importList[i]=Egret3DEngine.importList[i].replace(".ts",".js");Egret3DEngine.onTsconfig(),Egret3DEngine.startLoadScript(null)},Egret3DEngine.addImportScript=function(t){Egret3DEngine.importList.push(t)},Egret3DEngine.startLoadScript=function(t){var e=this;if(this.importList.length>0){var i=document.createElement("script");i.src=this.importList.shift(),i.onload=function(t){return e.startLoadScript(t)},i.onerror=function(t){return e.loadScriptError(t)},document.head.appendChild(i)}else console.log("all complete"),this._complete()},Egret3DEngine.loadScriptError=function(t){var e="load Script Error \r\n no file:"+t.srcElement.src;alert(e),this.startLoadScript(null)},Egret3DEngine.debug=!0,Egret3DEngine.djs="",Egret3DEngine.importList=new Array,Egret3DEngine._libUrl="/Egret3D/tsconfig.json",Egret3DEngine}();egret3d.Egret3DEngine=Egret3DEngine}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._debugHud=new t.HUD,this.mainPassRender=new t.MultiRender(t.PassType.diffusePass),this.mainPassRender.setRenderToTexture(2048,2048,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this._debugHud.fsShader="hud_H_fs",this._debugHud.x=512,this._debugHud.y=0,this._debugHud.width=256,this._debugHud.height=256}return e.prototype.drawTexture=function(t,e,i,a,r,n,o){this.mainPassRender.draw(t,e,i,a,r,n),o.mainPass=this.mainPassRender.renderTexture,o.end=this.mainPassRender.renderTexture,o.colorTexture=this.mainPassRender.renderTexture},e}();t.MainPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._debugHud=new t.HUD,this.postRender=new t.PostRender("hud_vs","bloom_fs"),this.postRender.setRenderToTexture(256,256,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this.gaussPass=new t.GaussPass,this._debugHud.fsShader="hud_H_fs",this._debugHud.x=768,this._debugHud.y=0,this._debugHud.width=128,this._debugHud.height=128}return e.prototype.drawTexture=function(t,e,i,a,r,n,o){this.postRender.draw(t,e,i,a,r,n,o),o.bloomPass=this.postRender.renderTexture,o.end=this.postRender.renderTexture,this.gaussPass.drawTexture(t,e,i,a,r,n,o)},e}();t.BloomPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._debugHud=new t.HUD,this._h_postRender=new t.PostRender("hud_vs","gaussian_H_fs"),this._h_postRender.setRenderToTexture(2048,2048,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this._v_postRender=new t.PostRender("hud_vs","gaussian_V_fs"),this._v_postRender.setRenderToTexture(2048,2048,t.FrameBufferFormat.UNSIGNED_BYTE_RGB),this._debugHud.fsShader="hud_H_fs",this._debugHud.x=768,this._debugHud.y=0,this._debugHud.width=128,this._debugHud.height=128}return e.prototype.drawTexture=function(t,e,i,a,r,n,o){this._h_postRender.draw(t,e,i,a,r,n,o),o.end=this._h_postRender.renderTexture,this._v_postRender.draw(t,e,i,a,r,n,o),o.end=this._v_postRender.renderTexture,o.bloomPass=this._v_postRender.renderTexture},e}();t.GaussPass=e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.posTex={},this.postItem=[],this.postRender=new t.MultiRender(t.PassType.diffusePass),this.postRender.setRenderToTexture(1024,1024,t.FrameBufferFormat.FLOAT_RGB),this.endTexture=this.posTex.end=this.postRender.renderTexture}return e.prototype.drawFrameBuffer=function(t,e,i,a,r,n){void 0===n&&(n=null);for(var o=0;o<this.postItem.length;o++)this.postItem[o].drawTexture(t,e,i,a,r,n,this.posTex),this.endTexture=this.posTex.end},e}();t.PostProcessing=e}(egret3d||(egret3d={}));